<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Teacher Timetables ‚Äì SMK Seri Pulai Perdana</title>

<!-- Tailwind (CDN) + Inter font -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  body{font-family:Inter,system-ui,sans-serif}
  summary::-webkit-details-marker{display:none}
  summary svg{transition:transform .2s}
  details[open] summary svg{transform:rotate(90deg)}
  .subject{font-weight:700}.venue{font-size:.75rem;color:#ef4444}

  /* day tint */
  .day-Monday   {background:#0ea5e90d}
  .day-Tuesday  {background:#22c55e0d}
  .day-Wednesday{background:#eab3080d}
  .day-Thursday {background:#3b82f60d}
  .day-Friday   {background:#ec48990d}
</style>
</head>

<body class="bg-gray-900 text-gray-100">
<div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

  <header class="text-center mb-6">
    <h1 class="text-3xl md:text-4xl font-bold text-white">SMK Seri Pulai Perdana</h1>
    <p class="text-lg text-gray-400">Verified Teacher Timetables</p>
  </header>

  <div class="flex flex-wrap items-center gap-3 mb-4">
    <button id="addBtn" class="px-4 py-2 bg-blue-600 rounded text-white">‚ûï Add slot</button>
    <input id="search" placeholder="Search teacher / class / subject‚Ä¶"
           class="flex-1 px-3 py-2 rounded bg-gray-800 focus:outline-none">
  </div>

  <!-- quick-add form -->
  <form id="slotForm" class="hidden flex flex-wrap gap-3 items-end mb-6">
    <input  class="flex-1 px-3 py-2 bg-gray-800 rounded" name="teacher" placeholder="Teacher" required>
    <select class="px-3 py-2 bg-gray-800 rounded" name="day" required>
      <option disabled selected value="">Day</option>
      <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
      <option>Thursday</option><option>Friday</option>
    </select>
    <input  class="px-3 py-2 bg-gray-800 rounded" name="block"   placeholder="07:45-08:15" required>
    <input  class="px-3 py-2 bg-gray-800 rounded" name="subject" placeholder="Subject">
    <input  class="px-3 py-2 bg-gray-800 rounded" name="classes" placeholder="Classes (comma / slash separated)">
    <input  class="px-3 py-2 bg-gray-800 rounded" name="venue"   placeholder="Venue">
    <button class="px-4 py-2 bg-blue-600 rounded text-white">Save</button>
  </form>

  <section id="timetableList" class="space-y-4"></section>

  <footer class="text-center mt-8 text-sm text-gray-500">
    Data migrated &amp; normalised ¬∑ Last update <span id="stamp"></span>
  </footer>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ EDIT BOTTOM-SHEET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="editWrap"
     class="fixed inset-0 z-50 flex items-end bg-black/40 backdrop-blur-sm
            invisible opacity-0 transition">
  <form id="editForm"
        class="w-full max-h-[90%] overflow-auto rounded-t-2xl bg-gray-900
               p-5 space-y-4 translate-y-full transition">
    <header class="text-center">
      <div class="w-12 h-1 mx-auto rounded bg-gray-600 mb-2"></div>
      <h2 class="font-semibold text-lg">Edit slot</h2>
    </header>

    <!-- Subject -->
    <label class="block">
      <span class="block text-sm text-gray-400">Subject</span>
      <select name="subject" required
              class="mt-1 w-full rounded bg-gray-800 p-2"></select>
    </label>

    <!-- Classes -->
    <label class="block">
      <span class="block text-sm text-gray-400">Classes</span>
      <input name="classes" list="classList"
             placeholder="Type or pick‚Ä¶"
             class="mt-1 w-full rounded bg-gray-800 p-2">
    </label>
    <datalist id="classList"></datalist>

    <!-- Venue -->
    <label class="block">
      <span class="block text-sm text-gray-400">Venue</span>
      <select name="venue"
              class="mt-1 w-full rounded bg-gray-800 p-2">
        <option value="">‚Äî</option>
      </select>
    </label>

    <!-- Day & Block -->
    <div class="flex gap-3">
      <label class="flex-1">
        <span class="block text-sm text-gray-400">Day</span>
        <select name="day" required
                class="mt-1 w-full rounded bg-gray-800 p-2">
          <option>Monday</option><option>Tuesday</option>
          <option>Wednesday</option><option>Thursday</option>
          <option>Friday</option>
        </select>
      </label>
      <label class="flex-1">
        <span class="block text-sm text-gray-400">Block</span>
        <select name="block" required
                class="mt-1 w-full rounded bg-gray-800 p-2"></select>
      </label>
    </div>

    <div class="flex justify-between pt-4">
      <button type="button" id="cancelEdit"
              class="px-4 py-2 rounded bg-gray-700 text-white">Cancel</button>
      <button class="px-4 py-2 rounded bg-blue-600 text-white">Save</button>
    </div>
  </form>
</div>
<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ /EDIT SHEET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->

<!--------------------  FIREBASE & APP  -------------------->
<script type="module">
import {initializeApp, getApps}
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {getFirestore, collection, doc,
        setDoc, deleteDoc, onSnapshot, serverTimestamp}
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {getAuth, signInAnonymously}
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* ------------------------------- CONFIG ------------------------------ */
const cfg = {
  apiKey            : "AIzaSyDtpSlQx8VxnqtI4wOJtAANfQ1grpd4_1o",
  authDomain        : "jadualharian-c1c02.firebaseapp.com",
  projectId         : "jadualharian-c1c02",
  storageBucket     : "jadualharian-c1c02.appspot.com",
  messagingSenderId : "69074885448",
  appId             : "1:69074885448:web:92de8875a7df9d4f47317d"
};

const app   = getApps().length ? getApps()[0] : initializeApp(cfg);
const auth  = getAuth(app);
const db    = getFirestore(app);
const col   = collection(db,"timetables_structured");
signInAnonymously(auth).catch(console.error);

/* ----------------------------- helpers ------------------------------ */
const list   = document.getElementById('timetableList');
const search = document.getElementById('search');
const form   = document.getElementById('slotForm');
const addBtn = document.getElementById('addBtn');
document.getElementById('stamp').textContent =
  new Date().toLocaleString('en-GB',{hour12:false});

function toArr(str){ return str.split(/[\/,]/).map(t=>t.trim()).filter(Boolean);}
function idFor(r){return `${r.teacher}_${r.day}_${r.block}`.replace(/[^\w-]/g,'');}
function buildLine(r){
  const subj = r.subject?.trim()||'‚Äì';
  const cls  = Array.isArray(r.classes)?r.classes.join(', '):(r.classes||'‚Äì');
  const ven  = r.venue?` <span class="venue">(${r.venue})</span>`:'';
  return {
    subjHTML:`<span class="subject">${subj}</span>`,
    clsHTML :`${cls}${ven}`
  };
}

/* --------------------- real-time display ---------------------- */
let cache=[];
onSnapshot(col,snap=>{
  cache=snap.docs.map(d=>({id:d.id,...d.data()}));
  render();
});
search.oninput=render;

function render(){
  const q = search.value.toLowerCase();
  list.innerHTML='';

  const map=new Map();
  cache.filter(r=>!q||JSON.stringify(r).toLowerCase().includes(q))
       .forEach(r=>{
         if(!map.has(r.teacher)) map.set(r.teacher,[]);
         map.get(r.teacher).push(r);
       });

  const dayIdx={Monday:0,Tuesday:1,Wednesday:2,Thursday:3,Friday:4};

  [...map.entries()].sort(([a],[b])=>a.localeCompare(b))
    .forEach(([teacher,rows])=>{
      rows.sort((a,b)=>dayIdx[a.day]-dayIdx[b.day]||
                       a.block.localeCompare(b.block));

      const details=document.createElement('details');
      details.className='bg-gray-800 rounded shadow';

      const ul=document.createElement('ul');
      ul.className='divide-y divide-gray-700';

      rows.forEach(r=>{
        const v=buildLine(r);
        const li=document.createElement('li');
        li.className=`flex justify-between px-4 py-2 day-${r.day}`;
        li.innerHTML=`<div>
            <p class="text-sm text-gray-400">${r.day} ‚Ä¢ ${r.block}</p>
            <p>${v.subjHTML}</p><p class="text-gray-200">${v.clsHTML}</p>
          </div>
          <div class="shrink-0 space-x-2">
            <button class="edit text-yellow-400" data-id="${r.id}">‚úèÔ∏è</button>
            <button class="del  text-red-400"  data-id="${r.id}">üóëÔ∏è</button>
          </div>`;
        ul.appendChild(li);
      });

      details.innerHTML=`<summary
          class="flex justify-between items-center px-4 py-3 cursor-pointer">
        <span class="font-semibold text-lg">${teacher}</span>
        <div class="flex items-center gap-2">
          <button class="add-slot text-green-400"
                  data-teacher="${teacher}">Ôºã</button>
          <svg class="w-4 h-4 text-gray-300" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2"><path d="M8 9l4 4 4-4"/></svg>
        </div></summary>`;
      details.appendChild(ul);
      list.appendChild(details);
    });
}

/* -------------------- quick-add form -------------------- */
addBtn.onclick=()=>{
  form.classList.toggle('hidden');
  form.reset();form.teacher.focus();
};
form.onsubmit=async ev=>{
  ev.preventDefault();
  const fd=Object.fromEntries(new FormData(form).entries());
  const payload={
    teacher :fd.teacher.trim(),
    day     :fd.day,
    block   :fd.block.trim(),
    subject :fd.subject.trim(),
    classes :toArr(fd.classes||''),
    venue   :fd.venue.trim(),
    lastEdit:serverTimestamp()
  };
  await setDoc(doc(col,idFor(payload)),payload,{merge:true});
  form.classList.add('hidden');form.reset();
};

/* ------------------ bottom-sheet editor ------------------ */
const SUBJECTS=['PH','KOKO','P','IV','MM','PNG','PI','LET','PM','BC','FIZ',
  'KKQ','RB','GE','NILAM','ASK','IB','PLC','SN','DBM','KIM','PD','RBT','TAW',
  'PPS','BI','MMT','D','NA','BA'];
const VENUES=['M.KOM1','M3','MAK.BIO','MAK.KIM','M2','BANGKEL E',
  'B. LUKISAN','B. DIGITAL','BANGKEL. P','B.NILAM','PAK21A','BANGKEL R'];
const BLOCKS=['07:15-07:45','07:45-08:15','08:15-08:45','08:45-09:15',
  '09:15-09:45','09:45-10:15','10:15-10:45','10:45-11:15'];

const wrap  = document.getElementById('editWrap');
const sheet = document.getElementById('editForm');
const cancelBtn=document.getElementById('cancelEdit');
const subjSel = sheet.querySelector('select[name=subject]');
const venueSel= sheet.querySelector('select[name=venue]');
const blockSel= sheet.querySelector('select[name=block]');
SUBJECTS.forEach(s=>subjSel.insertAdjacentHTML('beforeend',`<option>${s}</option>`));
VENUES.forEach(v=>venueSel.insertAdjacentHTML('beforeend',`<option>${v}</option>`));
BLOCKS.forEach(b=>blockSel.insertAdjacentHTML('beforeend',`<option>${b}</option>`));

let currentId=null;
function openSheet(r){
  currentId=r.id;
  sheet.subject.value=r.subject||'';
  sheet.classes.value=(r.classes||[]).join(',');
  sheet.venue.value=r.venue||'';
  sheet.day.value=r.day;
  sheet.block.value=r.block;

  wrap.classList.remove('invisible','opacity-0');
  sheet.classList.remove('translate-y-full');
}
function closeSheet(){
  wrap.classList.add('opacity-0');
  sheet.classList.add('translate-y-full');
  setTimeout(()=>wrap.classList.add('invisible'),200);
}

sheet.addEventListener('submit',async ev=>{
  ev.preventDefault();
  const fd=Object.fromEntries(new FormData(sheet).entries());
  await setDoc(doc(col,currentId),{
    subject :fd.subject.trim(),
    classes :toArr(fd.classes),
    venue   :fd.venue.trim(),
    day     :fd.day,
    block   :fd.block,
    lastEdit:serverTimestamp()
  },{merge:true});
  closeSheet();
});
cancelBtn.onclick=closeSheet;
wrap.onclick=e=>{if(e.target===wrap)closeSheet();};

/* build class datalist on every snapshot (keeps options fresh) */
const dl=document.getElementById('classList');
onSnapshot(col,s=>{
  const u=new Set();
  s.docs.forEach(d=>(d.data().classes||[]).forEach(c=>u.add(c)));
  dl.innerHTML='';u.forEach(c=>dl.insertAdjacentHTML('beforeend',`<option>${c}</option>`));
});

/* delegate edit / delete / inline add */
list.addEventListener('click',async e=>{
  const id=e.target.dataset.id;
  if(e.target.classList.contains('edit')){
    const r=cache.find(x=>x.id===id); if(r) openSheet(r);
  }else if(e.target.classList.contains('del')){
    if(confirm('Delete this slot?')) await deleteDoc(doc(col,id));
  }else if(e.target.classList.contains('add-slot')){
    form.classList.remove('hidden');form.reset();
    form.teacher.value=e.target.dataset.teacher;form.scrollIntoView({behavior:'smooth'});
  }
});
</script>
</body>
</html>