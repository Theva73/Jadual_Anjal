<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Teacher Timetables ‚Äì SMK Seri Pulai Perdana</title>

<!-- Tailwind (via CDN for convenience) -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  html,body{height:100%;background:#0f172a;color:#e2e8f0;font-family:Inter,system-ui,sans-serif}
  summary::-webkit-details-marker{display:none}
  summary svg{transition:transform .2s}
  details[open] summary svg{transform:rotate(90deg)}
  .subject{font-weight:600}
  .venue  {font-size:.75rem;color:#ef4444}
  /* subtle row tint by weekday (only used in list mode) */
  .day-Monday   {background:#0ea5e90d}
  .day-Tuesday  {background:#22c55e0d}
  .day-Wednesday{background:#eab3080d}
  .day-Thursday {background:#3b82f60d}
  .day-Friday   {background:#ec48990d}
  /* simple grid outline */
  .grid-cell{border:1px solid rgb(30 41 59/.6)}
</style>
</head>

<body class="flex flex-col items-center py-6 sm:py-10">
<h1 class="text-2xl sm:text-3xl font-bold mb-1">SMK Seri Pulai Perdana</h1>
<p class="text-gray-400 mb-6 text-center">Searchable timetable ‚Äì add / edit in real time</p>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Tabs (days) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<nav id="dayTabs" class="flex gap-2 mb-6">
  <button data-day="Monday"    class="tab px-4 py-1 rounded-md">Monday</button>
  <button data-day="Tuesday"   class="tab px-4 py-1 rounded-md">Tuesday</button>
  <button data-day="Wednesday" class="tab px-4 py-1 rounded-md">Wednesday</button>
  <button data-day="Thursday"  class="tab px-4 py-1 rounded-md">Thursday</button>
  <button data-day="Friday"    class="tab px-4 py-1 rounded-md">Friday</button>
</nav>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Top toolbar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="flex flex-wrap gap-3 items-center mb-4 max-w-6xl w-full">
  <button id="addBtn" class="px-5 py-2 bg-blue-600 rounded text-white shrink-0">Ôºã Add slot</button>
  <input id="search" placeholder="Search teacher / class / subject"
         class="flex-1 min-w-[12rem] px-3 py-2 rounded bg-slate-800 focus:outline-none">
  <button id="listBtn"  class="view px-4 py-2 rounded bg-slate-700">List</button>
  <button id="gridBtn"  class="view px-4 py-2 rounded bg-slate-700">Grid</button>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ quick-add / edit form ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<form id="slotForm" class="hidden flex flex-wrap gap-3 items-end mb-6 max-w-6xl w-full bg-slate-800 p-4 rounded">
  <input  class="flex-1 px-3 py-2 bg-slate-700 rounded" name="teacher" placeholder="Teacher" required>
  <select class="px-3 py-2 bg-slate-700 rounded"   name="day" required>
    <option disabled selected value="">Day</option>
    <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
    <option>Thursday</option><option>Friday</option>
  </select>
  <input  class="px-3 py-2 bg-slate-700 rounded w-28" name="block"   placeholder="07:45-08:15" required>
  <input  class="px-3 py-2 bg-slate-700 rounded w-28" name="subject" placeholder="Subject">
  <input  class="px-3 py-2 bg-slate-700 rounded w-40" name="classes" placeholder="Classes (comma/slash)">
  <input  class="px-3 py-2 bg-slate-700 rounded w-24" name="venue"   placeholder="Venue">
  <button class="px-5 py-2 bg-blue-600 rounded text-white">Save</button>
</form>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ timetable containers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<section id="timetableList" class="max-w-6xl w-full space-y-4"></section>
<section id="timetableGrid" class="hidden max-w-6xl w-full overflow-x-auto"></section>

<footer class="text-sm text-gray-500 mt-8">Last update <span id="stamp"></span></footer>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  FIREBASE + APP LOGIC  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<script type="module">
/*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  1. Firebase  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
import {initializeApp,getApps}            from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {getAuth,signInAnonymously}        from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {getFirestore,collection,doc,
        setDoc,deleteDoc,onSnapshot,
        serverTimestamp}                  from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* your project credentials */
const cfg={
  apiKey:"AIzaSyDtpSlQx8VxnqtI4wOJtAANfQ1grpd4_1o",
  authDomain:"jadualharian-c1c02.firebaseapp.com",
  projectId:"jadualharian-c1c02",
  storageBucket:"jadualharian-c1c02.appspot.com",
  messagingSenderId:"69074885448",
  appId:"1:69074885448:web:92de8875a7df9d4f47317d"
};
const app = getApps().length?getApps()[0]:initializeApp(cfg);
const auth= getAuth(app);
const db  = getFirestore(app);
const col = collection(db,"timetable_structure");
await signInAnonymously(auth).catch(console.error);

/*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  2. DOM refs & helpers  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
const listEl = document.getElementById("timetableList");
const gridEl = document.getElementById("timetableGrid");
const search = document.getElementById("search");
const form   = document.getElementById("slotForm");
const addBtn = document.getElementById("addBtn");
const stamp  = document.getElementById("stamp");
stamp.textContent=new Date().toLocaleString("en-GB");
const tabs=[...document.querySelectorAll(".tab")];
const views=[...document.querySelectorAll(".view")];

let activeDay="Monday";
let viewMode="Grid";

/* time blocks used in grid header (adjust as needed) */
const TIME_BLOCKS=[
 "07:45-08:15","08:15-08:45","08:45-09:15","09:15-09:45",
 "09:45-10:15","10:15-10:45","10:45-11:15","11:15-11:45",
 "11:45-12:15","12:15-12:45","12:45-13:15","13:15-13:45","13:45-14:15"
];
const dayIdx={Monday:0,Tuesday:1,Wednesday:2,Thursday:3,Friday:4};
const toArr=s=>s.split(/[\/,]/).map(t=>t.trim()).filter(Boolean);
const idFor=r=>`${r.teacher}_${r.day}_${r.block}`.replace(/[^\w-]/g,"");
const buildLine=r=>{
  const subj=r.subject?.trim()||"‚Äì";
  const cls =Array.isArray(r.classes)?r.classes.join(", "):(r.classes||"‚Äì");
  const ven =r.venue?` <span class="venue">(${r.venue})</span>`:"";
  return{ subj:`<span class="subject">${subj}</span>`, cls:`${cls}${ven}`};
};

/*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  3. Data & realtime listener  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
let cache=[];
onSnapshot(col,snap=>{
  cache=snap.docs.map(d=>({id:d.id,...d.data()}));
  render();
});
search.oninput=render;

tabs.forEach(btn=>{
  btn.onclick=()=>{
    tabs.forEach(t=>t.classList.remove("bg-blue-600","text-white"));
    btn.classList.add("bg-blue-600","text-white");
    activeDay=btn.dataset.day;
    render();
  };
});
views.forEach(btn=>{
  btn.onclick=()=>{
    views.forEach(v=>v.classList.remove("bg-blue-600","text-white"));
    btn.classList.add("bg-blue-600","text-white");
    viewMode=btn.textContent.trim();
    render();
  };
});
/* init default highlight */
tabs[0].click();       // Monday
views[1].click();      // Grid

function render(){
  const q=search.value.toLowerCase();
  const dayData=cache.filter(r=>r.day===activeDay && (!q||JSON.stringify(r).toLowerCase().includes(q)));

  if(viewMode==="List"){ renderList(dayData); }
  else                { renderGrid(dayData); }
}

function renderList(rows){
  gridEl.classList.add("hidden");
  listEl.classList.remove("hidden");
  listEl.innerHTML="";

  const grouped=new Map();
  rows.forEach(r=>{
    if(!grouped.has(r.teacher))grouped.set(r.teacher,[]);
    grouped.get(r.teacher).push(r);
  });

  [...grouped.entries()].sort(([a],[b])=>a.localeCompare(b)).forEach(([teacher,slots])=>{
    slots.sort((a,b)=>a.block.localeCompare(b.block));
    const details=document.createElement("details");
    details.className="bg-slate-800 rounded shadow";

    const ul=document.createElement("ul");
    ul.className="divide-y divide-slate-700";

    slots.forEach(r=>{
      const v=buildLine(r);
      ul.insertAdjacentHTML("beforeend",`
        <li class="flex justify-between px-4 py-2 day-${r.day}">
          <div>
            <p class="text-sm text-slate-400">${r.block}</p>
            <p>${v.subj}</p><p class="text-slate-200">${v.cls}</p>
          </div>
          <div class="shrink-0 space-x-2">
            <button class="edit text-yellow-400" data-id="${r.id}">‚úèÔ∏è</button>
            <button class="del  text-red-400"  data-id="${r.id}">üóëÔ∏è</button>
          </div>
        </li>`);
    });

    details.innerHTML=`
      <summary class="flex justify-between items-center px-4 py-3 cursor-pointer">
        <span class="font-semibold text-lg">${teacher}</span>
        <button class="add-slot text-green-400" data-teacher="${teacher}">Ôºã</button>
      </summary>`;
    details.appendChild(ul);
    listEl.appendChild(details);
  });
}

function renderGrid(rows){
  listEl.classList.add("hidden");
  gridEl.classList.remove("hidden");

  /* build header row */
  let html=`<table class="select-none border-collapse w-full text-center text-sm">
  <thead><tr>
    <th class="sticky left-0 bg-slate-900 z-10 w-44">Nama/Masa</th>`;
  TIME_BLOCKS.forEach(b=>html+=`<th class="px-1">${b.replace("-","<br>")}</th>`);
  html+="</tr></thead><tbody>";

  /* group by teacher */
  const grouped=new Map();
  rows.forEach(r=>{
    if(!grouped.has(r.teacher))grouped.set(r.teacher,[]);
    grouped.get(r.teacher).push(r);
  });

  [...grouped.entries()].sort(([a],[b])=>a.localeCompare(b)).forEach(([teacher,slots])=>{
    const map=new Map(slots.map(s=>[s.block,s]));           // quick lookup
    html+=`<tr>
      <th class="sticky left-0 bg-slate-900 text-left px-2">${teacher}</th>`;
    TIME_BLOCKS.forEach(b=>{
      const r=map.get(b)||{};
      const {subj,cls}=buildLine(r);
      html+=`<td class="grid-cell align-top px-1 py-0.5">
               ${r.subject?subj:""}${r.classes?`<br><span class="text-xs">${cls}</span>`:""}
             </td>`;
    });
    html+="</tr>";
  });

  html+="</tbody></table>";
  gridEl.innerHTML=html;
}

/*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  4. CRUD actions  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
addBtn.onclick=()=>{form.classList.toggle("hidden");form.reset();form.teacher.focus();};

form.onsubmit=async e=>{
  e.preventDefault();
  const fd=Object.fromEntries(new FormData(form).entries());
  const data={
    teacher:fd.teacher.trim(),
    day:fd.day,
    block:fd.block.trim(),
    subject:fd.subject.trim(),
    classes:toArr(fd.classes||""),
    venue:fd.venue.trim(),
    lastEdit:serverTimestamp()
  };
  await setDoc(doc(col,idFor(data)),data,{merge:true});
  form.classList.add("hidden");form.reset();
};

document.body.addEventListener("click",async e=>{
  const id=e.target.dataset.id;
  if(e.target.classList.contains("edit")){
    const r=cache.find(x=>x.id===id);
    if(!r)return;
    const val=prompt("Subject|Classes|Venue|Block",`${r.subject}|${(r.classes||[]).join(",")}|${r.venue||""}|${r.block}`);
    if(val){
      const [s,c,v,b]=val.split("|").map(t=>t.trim());
      await setDoc(doc(col,id),{subject:s,classes:toArr(c),venue:v,block:b,lastEdit:serverTimestamp()},{merge:true});
    }
  }else if(e.target.classList.contains("del")){
    if(confirm("Delete this slot?"))await deleteDoc(doc(col,id));
  }else if(e.target.classList.contains("add-slot")){
    form.classList.remove("hidden");form.reset();
    form.teacher.value=e.target.dataset.teacher;
    form.day.value=activeDay;
    form.scrollIntoView({behavior:"smooth"});
  }
});
</script>
</body>
</html>
