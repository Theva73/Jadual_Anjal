<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>Teacher Timetables â€“ SMK Seri Pulai Perdana</title>
<meta name="description" content="Searchable, verified teacher timetables for SMK Seri Pulai Perdana">

<!-- Tailwind (just-in-time from CDN) -->
<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  html{font-family:Inter,system-ui,sans-serif}
  summary::-webkit-details-marker{display:none}
  summary svg{transition:transform .2s}
  details[open] summary svg{transform:rotate(90deg)}
  .subject{font-weight:700}
  .venue{font-size:.75rem;color:#ef4444}
  /* day tint helpers --------------------------------------------------- */
  .day-Monday   {background:#0ea5e90d}
  .day-Tuesday  {background:#22c55e0d}
  .day-Wednesday{background:#eab3080d}
  .day-Thursday {background:#3b82f60d}
  .day-Friday   {background:#ec48990d}
</style>
</head>

<body class="bg-gray-900 text-gray-100">
<main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 space-y-6">

  <!-- ----------------------------------------------------------------- -->
  <!--  HEADER                                                           -->
  <!-- ----------------------------------------------------------------- -->
  <header class="text-center space-y-2">
    <h1 class="text-3xl sm:text-4xl font-bold text-white">
      SMK Seri Pulai Perdana
    </h1>
    <p class="text-lg text-gray-400">Verified Teacher Timetables</p>
  </header>

  <!-- ----------------------------------------------------------------- -->
  <!--  ACTION BAR                                                       -->
  <!-- ----------------------------------------------------------------- -->
  <section class="flex flex-wrap items-center gap-3">
    <button id="addBtn"
            type="button"
            class="px-4 py-2 bg-blue-600 rounded text-white font-medium
                   focus:outline-none focus:ring-2 focus:ring-blue-400">
      â• Add slot
    </button>

    <input id="search"
           type="search"
           placeholder="Search teacher / class / subjectâ€¦"
           class="flex-1 min-w-[12rem] px-3 py-2 rounded bg-gray-800
                  focus:outline-none focus:ring-2 focus:ring-blue-400"
           aria-label="Search timetable">
  </section>

  <!-- ----------------------------------------------------------------- -->
  <!--  QUICK-ADD / EDIT FORM                                            -->
  <!-- ----------------------------------------------------------------- -->
  <form id="slotForm"
        class="hidden flex flex-wrap gap-3 items-end bg-gray-800/60 p-4 rounded"
        autocomplete="off">
    <input  name="teacher" placeholder="Teacher" required
            class="flex-1 px-3 py-2 bg-gray-800 rounded">
    <select name="day" required
            class="px-3 py-2 bg-gray-800 rounded">
      <option disabled selected value="">Day</option>
      <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
      <option>Thursday</option><option>Friday</option>
    </select>
    <input  name="block" placeholder="07:45-08:15" required
            class="px-3 py-2 bg-gray-800 rounded">
    <input  name="subject" placeholder="Subject"
            class="px-3 py-2 bg-gray-800 rounded">
    <input  name="classes" placeholder="Classes (comma / slash separated)"
            class="px-3 py-2 bg-gray-800 rounded">
    <input  name="venue"   placeholder="Venue"
            class="px-3 py-2 bg-gray-800 rounded">

    <button class="px-4 py-2 bg-blue-600 rounded text-white font-medium">
      Save
    </button>
  </form>

  <!-- ----------------------------------------------------------------- -->
  <!--  MAIN LIST                                                        -->
  <!-- ----------------------------------------------------------------- -->
  <section id="timetableList" class="space-y-4"></section>

  <!-- ----------------------------------------------------------------- -->
  <!--  FOOTER                                                           -->
  <!-- ----------------------------------------------------------------- -->
  <footer class="text-center text-sm text-gray-500 pt-6">
    Data migrated &amp; normalised â€“ Last update
    <time id="stamp"></time>
  </footer>
</main>

<!-- ===========================  APP LOGIC  ============================ -->
<script type="module">
import {
  initializeApp, getApps
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
  getFirestore, collection, doc,
  setDoc, deleteDoc, onSnapshot,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import {
  getAuth, signInAnonymously
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” Firebase config  â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
const cfg = {
  apiKey            : "AIzaSyDtpSlQx8VxnqtI4wOJtAANfQ1grpd4_1o",
  authDomain        : "jadualharian-c1c02.firebaseapp.com",
  projectId         : "jadualharian-c1c02",
  storageBucket     : "jadualharian-c1c02.appspot.com",
  messagingSenderId : "69074885448",
  appId             : "1:69074885448:web:92de8875a7df9d4f47317d"
};
const app   = getApps().length ? getApps()[0] : initializeApp(cfg);
const auth  = getAuth(app);
const db    = getFirestore(app);
const col   = collection(db, "timetables_structured");    //  â† live data

await signInAnonymously(auth).catch(console.error);

/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” DOM refs & utils  â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
const $list   = document.getElementById('timetableList');
const $search = document.getElementById('search');
const $form   = document.getElementById('slotForm');
const $addBtn = document.getElementById('addBtn');
document.getElementById('stamp').textContent =
  new Date().toLocaleString('en-GB');

const dayOrder = {Monday:0,Tuesday:1,Wednesday:2,Thursday:3,Friday:4};
const toArr = s => s.split(/[\/,]/).map(t=>t.trim()).filter(Boolean);
const docId = r => `${r.teacher}_${r.day}_${r.block}`.replace(/[^\w-]/g,'');

let cache = [];

/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” Live listener  â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
onSnapshot(col, snap=>{
  cache = snap.docs.map(d=>({id:d.id, ...d.data()}));
  render();
});

$search.oninput = render;

/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” Render  â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
function render(){
  const q = $search.value.toLowerCase();
  $list.innerHTML = '';

  const grouped = {};
  cache
    .filter(r => !q || JSON.stringify(r).toLowerCase().includes(q))
    .forEach(r => {
      (grouped[r.teacher] ??= []).push(r);
    });

  for(const teacher of Object.keys(grouped).sort()){
    const rows = grouped[teacher]
      .sort((a,b)=>dayOrder[a.day]-dayOrder[b.day] || a.block.localeCompare(b.block));

    /* details wrapper */
    const $details = document.createElement('details');
    $details.className = 'bg-gray-800 rounded shadow';

    /* summary line */
    $details.innerHTML = `
      <summary class="flex justify-between items-center px-4 py-3 cursor-pointer select-none">
        <span class="font-semibold text-lg">${teacher}</span>
        <div class="flex items-center gap-2">
          <button type="button"
                  class="add-slot text-green-400"
                  data-teacher="${teacher}">ï¼‹</button>
          <svg class="w-4 h-4 text-gray-300"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 9l4 4 4-4"/>
          </svg>
        </div>
      </summary>`;
    const $ul = document.createElement('ul');
    $ul.className = 'divide-y divide-gray-700';

    for(const r of rows){
      const subj = r.subject?.trim() || 'â€“';
      const cls  = Array.isArray(r.classes) ? r.classes.join(', ') : (r.classes || 'â€“');
      const ven  = r.venue ? `<span class="venue">(${r.venue})</span>` : '';

      const $li = document.createElement('li');
      $li.className = `flex justify-between px-4 py-2 day-${r.day}`;
      $li.innerHTML = `
        <div>
          <p class="text-sm text-gray-400">${r.day} â€¢ ${r.block}</p>
          <p><span class="subject">${subj}</span></p>
          <p class="text-gray-200">${cls}${ven}</p>
        </div>
        <div class="shrink-0 space-x-2">
          <button type="button" class="edit text-yellow-400" data-id="${r.id}">âœï¸</button>
          <button type="button" class="del  text-red-400"    data-id="${r.id}">ğŸ—‘ï¸</button>
        </div>`;
      $ul.appendChild($li);
    }

    $details.appendChild($ul);
    $list.appendChild($details);
  }
}

/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” Add / edit / delete â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */
$addBtn.onclick = ()=>{
  $form.reset();
  $form.classList.toggle('hidden');
  $form.teacher.focus();
};

$form.onsubmit = async ev=>{
  ev.preventDefault();
  const fd = Object.fromEntries(new FormData($form).entries());

  /* guard: day + block + teacher are required for the composite key */
  if(!fd.teacher || !fd.day || !fd.block) return;

  const payload = {
    teacher  : fd.teacher.trim(),
    day      : fd.day,
    block    : fd.block.trim(),
    subject  : fd.subject.trim(),
    classes  : toArr(fd.classes||''),
    venue    : fd.venue.trim(),
    lastEdit : serverTimestamp()
  };
  await setDoc(doc(col, docId(payload)), payload, {merge:true});
  $form.classList.add('hidden');
};

$list.addEventListener('click', async ev=>{
  const {id} = ev.target.dataset;
  if(!id) return;

  if(ev.target.classList.contains('edit')){
    const r = cache.find(x=>x.id === id);
    if(!r) return;
    const val = prompt(
      'Subject | Classes (comma) | Venue | Day | Block',
      [r.subject, (r.classes||[]).join(','), r.venue||'', r.day, r.block].join('|')
    );
    if(!val) return;
    const [s,c,v,d,b] = val.split('|').map(t=>t.trim());
    await setDoc(doc(col,id), {
      subject:s, classes:toArr(c), venue:v, day:d, block:b, lastEdit:serverTimestamp()
    }, {merge:true});
  }

  if(ev.target.classList.contains('del')){
    if(confirm('Delete this slot?')) await deleteDoc(doc(col,id));
  }

  if(ev.target.classList.contains('add-slot')){
    $form.classList.remove('hidden');
    $form.reset();
    $form.teacher.value = ev.target.dataset.teacher;
    $form.scrollIntoView({behavior:'smooth'});
  }
});
</script>
</body>
</html>