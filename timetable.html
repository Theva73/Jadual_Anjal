<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Teacher Timetables ‚Äì SMK Seri Pulai Perdana</title>

<!-- Tailwind (stand-alone CDN for quick demos) -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  body{font-family:Inter,system-ui,sans-serif}
  summary::-webkit-details-marker{display:none}
  summary svg{transition:transform .2s}
  details[open] summary svg{transform:rotate(90deg)}
  .subject{font-weight:600}
  .venue{font-size:.75rem;color:#ef4444}
  /* tint by day ------------------------------------------------- */
  .day-Monday   {background:#0ea5e90d}
  .day-Tuesday  {background:#22c55e0d}
  .day-Wednesday{background:#eab3080d}
  .day-Thursday {background:#3b82f60d}
  .day-Friday   {background:#ec48990d}
  /* bottom-sheet ------------------------------------------------ */
  #sheetWrap{transition:opacity .2s ease,visibility .2s}
  #sheet   {transition:transform .25s ease}
  #sheetWrap.invisible{opacity:0;visibility:hidden}
  #sheet.translate-y-full{transform:translateY(100%)}
</style>
</head>

<body class="bg-gray-900 text-gray-100 min-h-full flex flex-col">
<main class="grow max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

  <header class="text-center mb-6">
    <h1 class="text-3xl md:text-4xl font-bold text-white">SMK Seri Pulai Perdana</h1>
    <p class="text-lg text-gray-400">Verified Teacher Timetables</p>
  </header>

  <div class="flex flex-wrap items-center gap-3 mb-4">
    <button id="addBtn" class="px-4 py-2 bg-blue-600 rounded text-white">‚ûï Add&nbsp;slot</button>
    <input id="search" placeholder="Search teacher / class / subject‚Ä¶"
           class="flex-1 px-3 py-2 rounded bg-gray-800 focus:outline-none">
  </div>

  <section id="timetableList" class="space-y-4"></section>

  <footer class="text-center mt-8 text-sm text-gray-500">
    Data migrated &middot; Last update <span id="stamp"></span>
  </footer>
</main>


<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Bottom-sheet (Add / Edit) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="sheetWrap" class="fixed inset-0 flex justify-center items-end bg-black/40 invisible opacity-0">
  <form id="sheet"
        class="w-full max-w-lg bg-gray-800 rounded-t-2xl p-6 translate-y-full">
    <div class="mx-auto h-1 w-16 rounded-full bg-gray-600 mb-4"></div>
    <h2 class="text-center font-semibold text-xl mb-6" id="sheetTitle">Add slot</h2>

    <label class="block mb-4">
      <span class="block text-sm text-gray-400">Subject</span>
      <input name="subject" list="subjList" class="mt-1 w-full p-2 rounded bg-gray-700">
    </label>
    <datalist id="subjList">
      <!-- quick list ‚Äì extend to taste -->
      <option>BM</option><option>BI</option><option>PH</option><option>MM</option>
      <option>PJ</option><option>KOKO</option><option>IB</option>
    </datalist>

    <label class="block mb-4">
      <span class="block text-sm text-gray-400">Classes (tap to pick ‚§¥)</span>
      <select name="classes" id="classesSel" multiple
              class="mt-1 w-full h-32 p-2 rounded bg-gray-700 overflow-y-auto"></select>
    </label>

    <label class="block mb-4">
      <span class="block text-sm text-gray-400">Venue</span>
      <input name="venue" list="venueList" class="mt-1 w-full p-2 rounded bg-gray-700">
    </label>
    <datalist id="venueList">
      <option>M.KOM1</option><option>M2</option><option>M3</option><option>BANGKEL E</option>
      <option>B.NILAM</option><option>MAK.BIO</option><option>MAK.KIM</option>
    </datalist>

    <div class="flex gap-4 mb-6">
      <label class="flex-1">
        <span class="block text-sm text-gray-400">Day</span>
        <select name="day" class="mt-1 w-full p-2 rounded bg-gray-700" required>
          <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
          <option>Thursday</option><option>Friday</option>
        </select>
      </label>
      <label class="flex-1">
        <span class="block text-sm text-gray-400">Block</span>
        <select name="block" class="mt-1 w-full p-2 rounded bg-gray-700" required>
          <option>07:15-07:45</option><option>07:45-08:15</option><option>08:15-08:45</option>
          <option>08:45-09:15</option><option>09:45-10:15</option><option>10:15-10:45</option>
        </select>
      </label>
    </div>

    <div class="flex justify-between">
      <button type="button" id="cancelBtn"
              class="px-4 py-2 rounded bg-gray-600 text-white">Cancel</button>
      <button class="px-4 py-2 rounded bg-blue-600 text-white">Save</button>
    </div>
  </form>
</div>


<!----------------------------  FIREBASE & APP LOGIC  --------------------------->
<script type="module">
import {initializeApp, getApps}        from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {getFirestore, collection, doc,
        setDoc, deleteDoc, onSnapshot,
        serverTimestamp}
       from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {getAuth, signInAnonymously}
       from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/*  Firebase  */
const cfg = {
  apiKey            : "AIzaSyDtpSlQx8VxnqtI4wOJtAANfQ1grpd4_1o",
  authDomain        : "jadualharian-c1c02.firebaseapp.com",
  projectId         : "jadualharian-c1c02",
  storageBucket     : "jadualharian-c1c02.appspot.com",
  messagingSenderId : "69074885448",
  appId             : "1:69074885448:web:92de8875a7df9d4f47317d"
};
const app   = getApps().length ? getApps()[0] : initializeApp(cfg);
const auth  = getAuth(app);
const db    = getFirestore(app);
const col   = collection(db, "timetables_structured");
signInAnonymously(auth).catch(console.error);

/* ------------ helpers / refs ------------ */
const list   = document.getElementById('timetableList');
const search = document.getElementById('search');
const stamp  = document.getElementById('stamp');
const addBtn = document.getElementById('addBtn');

/* bottom-sheet elements */
const wrap       = document.getElementById('sheetWrap');
const sheet      = document.getElementById('sheet');
const sheetTitle = document.getElementById('sheetTitle');
const cancelBtn  = document.getElementById('cancelBtn');
const classSel   = document.getElementById('classesSel');

stamp.textContent = new Date().toLocaleString('en-GB');

function toArr(str){ return str.split(/[\/,]/).map(t=>t.trim()).filter(Boolean); }
function idFor(r){ return `${r.teacher}_${r.day}_${r.block}`.replace(/[^\w-]/g,''); }
function buildLine(r){
  const subj = r.subject?.trim() || '‚Äì';
  const cls  = Array.isArray(r.classes) ? r.classes.join(', ') : (r.classes||'‚Äì');
  const ven  = r.venue ? ` <span class="venue">(${r.venue})</span>` : '';
  return { subjHTML:`<span class="subject">${subj}</span>`, clsHTML:`${cls}${ven}` };
}

/* ------------ live listener ------------ */
let cache=[];
onSnapshot(col,snap=>{
  cache=snap.docs.map(d=>({id:d.id,...d.data()}));
  rebuildClassPickers();
  render();
});
search.oninput=render;

function render(){
  const q=search.value.toLowerCase(); list.innerHTML='';
  const map=new Map();
  cache.filter(r=>!q||JSON.stringify(r).toLowerCase().includes(q))
       .forEach(r=>{ if(!map.has(r.teacher)) map.set(r.teacher,[]); map.get(r.teacher).push(r); });

  const dayIdx={Monday:0,Tuesday:1,Wednesday:2,Thursday:3,Friday:4};

  [...map.entries()].sort(([a],[b])=>a.localeCompare(b)).forEach(([t,rows])=>{
    rows.sort((a,b)=>dayIdx[a.day]-dayIdx[b.day]||a.block.localeCompare(b.block));

    const det=document.createElement('details');
    det.className='bg-gray-800 rounded shadow';
    const ul=document.createElement('ul');
    ul.className='divide-y divide-gray-700';

    rows.forEach(r=>{
      const v=buildLine(r);
      const li=document.createElement('li');
      li.className=`flex justify-between px-4 py-2 day-${r.day}`;
      li.innerHTML=`
        <div>
          <p class="text-sm text-gray-400">${r.day} ‚Ä¢ ${r.block}</p>
          <p>${v.subjHTML}</p><p class="text-gray-200">${v.clsHTML}</p>
        </div>
        <div class="shrink-0 space-x-2">
          <button class="edit text-yellow-400" data-id="${r.id}">‚úèÔ∏è</button>
          <button class="del  text-red-400"  data-id="${r.id}">üóëÔ∏è</button>
        </div>`;
      ul.appendChild(li);
    });

    det.innerHTML=`
      <summary class="flex justify-between items-center px-4 py-3 cursor-pointer">
        <span class="font-semibold text-lg">${t||'‚Äî'}</span>
        <div class="flex items-center gap-2">
          <button class="add-slot text-green-400" data-teacher="${t}">Ôºã</button>
          <svg class="w-4 h-4 text-gray-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 9l4 4 4-4"/></svg>
        </div>
      </summary>`;
    det.appendChild(ul); list.appendChild(det);
  });
}

/* ---------------- bottom-sheet logic ---------------- */
let currentId=null;

function openSheet(r={teacher:'',day:'Monday',block:'07:15-07:45',subject:'',classes:[],venue:''}){
  currentId=r.id||idFor(r);
  sheetTitle.textContent=r.id?'Edit slot':'Add slot';
  sheet.teacher   ?= document.createElement('input'); // dynamic field if missing
  /* fill fields */
  sheet.subject.value=r.subject||'';
  sheet.venue.value  =r.venue||'';
  sheet.day.value    =r.day;
  sheet.block.value  =r.block;
  [...classSel.options].forEach(o=>o.selected=(r.classes||[]).includes(o.value));
  /* show */
  wrap.classList.remove('invisible','opacity-0');
  sheet.classList.remove('translate-y-full');
}
function closeSheet(){
  wrap.classList.add('opacity-0');
  setTimeout(()=>wrap.classList.add('invisible'),200);
  sheet.classList.add('translate-y-full');
}
/* build class <option>s from cache */
function rebuildClassPickers(){
  const set=new Set();
  cache.forEach(r=>(r.classes||[]).forEach(c=>set.add(c)));
  if(classSel.options.length!==set.size){
    classSel.innerHTML=[...set].sort().map(c=>`<option>${c}</option>`).join('');
  }
}

addBtn.onclick = ()=>openSheet({teacher:''});  /* new teacher slot */

list.addEventListener('click',e=>{
  if(e.target.classList.contains('add-slot')){
    openSheet({teacher:e.target.dataset.teacher});
  }else if(e.target.classList.contains('edit')){
    const r=cache.find(x=>x.id===e.target.dataset.id);
    if(r) openSheet(r);
  }else if(e.target.classList.contains('del')){
    const id=e.target.dataset.id;
    if(id && confirm('Delete this slot?')) deleteDoc(doc(col,id));
  }
});

cancelBtn.onclick = closeSheet;
wrap.onclick = e=>{ if(e.target===wrap) closeSheet(); };

sheet.addEventListener('submit',async ev=>{
  ev.preventDefault();
  const cls=[...classSel.selectedOptions].map(o=>o.value);
  const payload={
    teacher   : currentId.split('_')[0],  // teacher segment from id
    day       : sheet.day.value,
    block     : sheet.block.value,
    subject   : sheet.subject.value.trim(),
    classes   : cls,
    venue     : sheet.venue.value.trim(),
    lastEdit  : serverTimestamp()
  };
  await setDoc(doc(col,currentId),payload,{merge:true});
  closeSheet();
});
</script>
</body>
</html>