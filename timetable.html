
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Timetables - SMK Seri Pulai Perdana</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-gray-900 text-gray-100">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <header class="mb-8 text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-white">SMK Seri Pulai Perdana</h1>
      <p class="text-lg text-gray-400 mt-2">Complete & Verified Teacher Timetables</p>
    </header>

    <div class="flex justify-end mb-4">
      <button id="addBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">â• Add New</button>
    </div>

    <form id="slotForm" class="hidden mt-6 flex flex-wrap gap-4 items-end">
      <input class="px-3 py-2 rounded bg-gray-800 flex-1" name="teacher" placeholder="Teacher" required>
      <input class="px-3 py-2 rounded bg-gray-800 flex-1" name="day" placeholder="Day" required>
      <input class="px-3 py-2 rounded bg-gray-800 flex-1" name="block" placeholder="Block" required>
      <input class="px-3 py-2 rounded bg-gray-800 flex-1" name="class" placeholder="Class" required>
      <input class="px-3 py-2 rounded bg-gray-800 flex-1" name="venue" placeholder="Venue" required>
      <button class="px-4 py-2 bg-blue-600 rounded text-white" type="submit">Save</button>
    </form>

    <section id="timetable-cards" class="grid gap-6 mt-8"></section>

    <footer class="text-center mt-10 text-sm text-gray-500">
      <p>Data manually reviewed and corrected from PDF source for all teachers.</p>
    </footer>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtpSlQx8VxnqtI4wOJtAANfQ1grpd4_1o",
      authDomain: "jadualharian-c1c02.firebaseapp.com",
      projectId: "jadualharian-c1c02",
      storageBucket: "jadualharian-c1c02.firebasestorage.app",
      messagingSenderId: "69074885448",
      appId: "1:69074885448:web:92de8875a7df9d4f47317d",
      measurementId: "G-0T6V0EP48J"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const col = collection(db, "timetables");
    const cards = document.getElementById("timetable-cards");

    const teachersData = [
      { teacher: "Sample Teacher", times: ["07:15-07:45"], schedule: { Monday: ["Math"] } }
    ];

    async function populateIfEmpty() {
      const snapshot = await getDocs(col);
      if (snapshot.empty) {
        console.log("Firestore empty â€” populating with default teachersData...");
        for (const teacher of teachersData) {
          for (const [day, activities] of Object.entries(teacher.schedule)) {
            activities.forEach((activity, idx) => {
              if (activity && activity !== "REHAT") {
                const id = `${teacher.teacher}_${day}_${teacher.times[idx]}`.replace(/\s+/g, '');
                const docData = {
                  teacher: teacher.teacher,
                  day: day,
                  block: teacher.times[idx],
                  class: activity,
                  venue: "",
                  lastEdit: serverTimestamp()
                };
                setDoc(doc(col, id), docData, { merge: true });
              }
            });
          }
        }
      } else {
        console.log("Firestore already has data.");
      }
    }

    signInAnonymously(auth).catch(console.error).then(async () => {
      await populateIfEmpty();
    });

    onSnapshot(col, snap => {
      cards.innerHTML = '';
      snap.forEach(docSnap => {
        const d = docSnap.data();
        cards.insertAdjacentHTML('beforeend', `
          <article class="bg-gray-800 rounded-lg p-4 space-y-2 shadow">
            <div class="flex justify-between items-center">
              <h3 class="text-lg font-semibold">${d.teacher}</h3>
              <div class="space-x-2">
                <button class="edit text-yellow-400" data-id="${docSnap.id}">âœï¸</button>
                <button class="del text-red-400" data-id="${docSnap.id}">ğŸ—‘ï¸</button>
              </div>
            </div>
            <p class="text-gray-300 text-sm">${d.day} â€¢ ${d.block}</p>
            <p class="text-gray-200">${d.class} @ ${d.venue}</p>
          </article>`);
      });
    });

    cards.addEventListener('click', async e => {
      const id = e.target.dataset.id;
      if (e.target.classList.contains('edit')) {
        const val = prompt('New Class | Venue', '');
        if (!val) return;
        const [cls, ven] = val.split('|');
        const obj = {};
        if (cls) obj.class = cls.trim();
        if (ven) obj.venue = ven.trim();
        if (Object.keys(obj).length) await setDoc(doc(col, id), obj, { merge: true });
      }
      if (e.target.classList.contains('del')) {
        if (confirm('Delete this slot?')) await deleteDoc(doc(col, id));
      }
    });

    document.getElementById('addBtn').addEventListener('click', () => {
      const form = document.getElementById('slotForm');
      form.classList.toggle('hidden');
      form.scrollIntoView({ behavior: 'smooth' });
      form.reset();
      form.querySelector('input[name=teacher]').focus();
    });

    document.getElementById('slotForm').addEventListener('submit', async e => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      data.lastEdit = serverTimestamp();
      await setDoc(doc(col, `${data.teacher}_${data.day}_${data.block}`.replace(/\s+/g, '')), data, { merge: true });
      e.target.reset();
      e.target.classList.add('hidden');
    });
  </script>
</body>
</html>
