<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Weekly Schedule</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 20px; [span_0](start_span)/*[span_0](end_span) */
            background-color: #f9f9f9;
        }
        h2, h3 {
            color: #333;
        [span_1](start_span)} /*[span_1](end_span) */
        table {
            border-collapse: collapse;
            width: 100%; [span_2](start_span)/*[span_2](end_span) */
            margin-top: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background-color: #fff;
        [span_3](start_span)} /*[span_3](end_span) */
        #tablesContainer > table {
            display: none;
        [span_4](start_span)} /*[span_4](end_span) */
        #tablesContainer > table.active {
            display: table;
        [span_5](start_span)} /*[span_5](end_span) */
        #summaryTable {
            display: table;
            margin-top: 20px; [span_6](start_span)/*[span_6](end_span) */
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px; [span_7](start_span)/*[span_7](end_span) */
            text-align: center;
            min-width: 100px; 
        }
        table th { 
            background-color: #e9ecef;
            color: #495057; [span_8](start_span)/*[span_8](end_span) */
            font-weight: bold;
        }
        td.selected, th.selected { 
            outline: 3px solid #007bff;
            background-color: #cfe2ff; [span_9](start_span)/*[span_9](end_span) */
        }
        .merged { 
            font-style: italic;
            background-color: #f8f9fa; [span_10](start_span)/*[span_10](end_span) */
        }
        .bar {
            display: flex;
            flex-wrap: wrap; [span_11](start_span)/*[span_11](end_span) */
            gap: 8px;
            margin-bottom: 15px;
            align-items: center;
        }
        .bar button, .table-tabs button {
            padding: 10px 15px;
            font-size: 14px; [span_12](start_span)/*[span_12](end_span) */
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #adb5bd;
            background-color: #fff;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); [span_13](start_span)/*[span_13](end_span) */
        }
        .bar button:hover, .table-tabs button:hover {
            background-color: #f1f3f5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); [span_14](start_span)/*[span_14](end_span) */
        }
        #directCopyFullHtmlBtn { background-color: #545b62; color: white;
            border-color: #545b62; [span_15](start_span)} /*[span_15](end_span) */
        #excelBtnTrigger, #importExcelBtn { background-color: #28a745; color: white;
            [span_16](start_span)border-color: #28a745;} /*[span_16](end_span) */
        #saveDraftBtn { background-color: #007bff; color: white;
            [span_17](start_span)border-color: #007bff;} /*[span_17](end_span) */
        #loadDraftBtn { background-color: #ffc107; color: #212529;
            [span_18](start_span)border-color: #ffc107;} /*[span_18](end_span) */
        #clearActiveTableContentBtn { background-color: #fd7e14; color: white;
            [span_19](start_span)border-color: #fd7e14;} /*[span_19](end_span) */ 
        #selectBtn { background-color: #17a2b8; color: white;
            [span_20](start_span)border-color: #17a2b8;} /*[span_20](end_span) */
        #selectBtn.active { background-color: #fd7e14;
            [span_21](start_span)border-color: #fd7e14;} /*[span_21](end_span) */
        #mergeBtn { background-color: #6f42c1; color: white;
            [span_22](start_span)border-color: #6f42c1;} /*[span_22](end_span) */
        #unmergeBtn { background-color: #e83e8c; color: white;
            [span_23](start_span)border-color: #e83e8c;} /*[span_23](end_span) */
        #addTableBtn { background-color: #20c997; color: white;
            [span_24](start_span)border-color: #20c997;} /*[span_24](end_span) */
        #renameTableBtn { background-color: #6c757d; color: white;
            [span_25](start_span)border-color: #6c757d;} /*[span_25](end_span) */
        #deleteTableBtn { background-color: #dc3545; color: white;
            [span_26](start_span)border-color: #dc3545;} /*[span_26](end_span) */
        #nameListBtn { background-color: #fd7e14; color: white;
            [span_27](start_span)border-color: #fd7e14;} /*[span_27](end_span) */
        #deselectBtn { background-color: #6c757d; color: white;
            [span_28](start_span)border-color: #6c757d;} /*[span_28](end_span) */
        .table-tabs { margin-bottom: 10px;
        [span_29](start_span)} /*[span_29](end_span) */
        .table-tabs button { background-color: #f8f9fa; border-bottom-left-radius: 0; border-bottom-right-radius: 0;
        [span_30](start_span)} /*[span_30](end_span) */
        .table-tabs button.active { background-color: #007bff; color: white; border-color: #007bff;
        [span_31](start_span)} /*[span_31](end_span) */
        #summaryTable th { background-color: #ffeeba;
        [span_32](start_span)} /*[span_32](end_span) */
        #summaryTable td { background-color: #fff3cd;
        [span_33](start_span)} /*[span_33](end_span) */
        .modal {
            display: none;
            position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; [span_34](start_span)/*[span_34](end_span) */
            overflow: hidden; 
            background-color: rgba(0,0,0,0.4); 
            align-items: center; 
            justify-content: center;
        [span_35](start_span)} /*[span_35](end_span) */
        .modal-content {
            background-color: #fff;
            padding: 20px; border: 1px solid #888; [span_36](start_span)/*[span_36](end_span) */
            width: 90%; max-width: 400px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: fixed;
            top: 50%; left: 50%; [span_37](start_span)/*[span_37](end_span) */
            transform: translate(-50%, -50%); 
        }
        .modal-content.dragging { 
            transform: none;
        [span_38](start_span)} /*[span_38](end_span) */
        .modal-header {
            padding-bottom: 10px;
            border-bottom: 1px solid #eee; margin-bottom: 15px; [span_39](start_span)/*[span_39](end_span) */
            font-size: 1.2em; color: #333; display: flex; justify-content: space-between; align-items: center;
            cursor: move; 
            user-select: none;
        [span_40](start_span)} /*[span_40](end_span) */
        .modal-close-btn {
            font-size: 1.5rem;
            font-weight: bold; line-height: 1; color: #000; [span_41](start_span)/*[span_41](end_span) */
            text-shadow: 0 1px 0 #fff; opacity: .5; background: transparent; border: 0; cursor: pointer;
        [span_42](start_span)} /*[span_42](end_span) */
        .modal-close-btn:hover { opacity: .75;
        [span_43](start_span)} /*[span_43](end_span) */
        .name-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px;
            border-bottom: 1px solid #eee; [span_44](start_span)} /*[span_44](end_span) */
        .name-item:last-child { border-bottom: none;
        [span_45](start_span)} /*[span_45](end_span) */
        .name-item span { flex-grow: 1; cursor: pointer; color: #007bff;
        [span_46](start_span)} /*[span_46](end_span) */
        .name-item span:hover { text-decoration: underline;
        [span_47](start_span)} /*[span_47](end_span) */
        .name-item button { background-color: #dc3545; color: white; border: none; border-radius: 4px;
            padding: 5px 10px; font-size: 0.9em; [span_48](start_span)} /*[span_48](end_span) */
        .highlighted { background-color: #cfe2ff !important; font-weight: bold;
        [span_49](start_span)} /*[span_49](end_span) */
        #draftList { border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; border-radius: 5px;
            background-color: #fff; [span_50](start_span)} /*[span_50](end_span) */
        .draft-item { display: flex; justify-content: space-between; align-items: center;
            padding: 8px 5px; border-bottom: 1px solid #eee; [span_51](start_span)} /*[span_51](end_span) */
        .draft-item:last-child { border-bottom: none;
        [span_52](start_span)} /*[span_52](end_span) */
        .draft-item span { cursor: pointer; color: #007bff;
        [span_53](start_span)} /*[span_53](end_span) */
        .draft-item span:hover { text-decoration: underline;
        [span_54](start_span)} /*[span_54](end_span) */
        .draft-item button { background-color: #dc3545; color: white; border: none; border-radius: 4px;
            padding: 5px 10px; font-size: 0.9em; [span_55](start_span)} /*[span_55](end_span) */
        #newNameInput { padding: 8px; margin-right: 5px;
            border: 1px solid #ccc; border-radius: 4px; flex-grow: 1; [span_56](start_span)} /*[span_56](end_span) */
        .input-group { display: flex;
            margin-bottom: 10px; [span_57](start_span)} /*[span_57](end_span) */
        .input-group button { background-color: #28a745; color: white; border-color: #28a745;
        [span_58](start_span)} /*[span_58](end_span) */
        .custom-message-box {
            display: none;
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); [span_59](start_span)/*[span_59](end_span) */
            background-color: #333; color: white; padding: 15px 25px; border-radius: 5px;
            z-index: 2000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 1em; [span_60](start_span)/*[span_60](end_span) */
        }
        .custom-message-box.success { background-color: #28a745;
        [span_61](start_span)} /*[span_61](end_span) */
        .custom-message-box.error { background-color: #dc3545;
        [span_62](start_span)} /*[span_62](end_span) */
        .custom-message-box.info { background-color: #007bff;
        [span_63](start_span)} /*[span_63](end_span) */
    </style>
</head>
<body>
    <h2 contenteditable="true" id="scheduleTitle">Weekly Schedule</h2>
    <div class="bar">
        <button id="directCopyFullHtmlBtn">📋 Copy Full HTML (Direct)</button> 
    </div>
    <div class="bar">
        <button id="excelBtnTrigger">💾 Export Active Table to Excel</button>
        <button id="importExcelBtn">📂 Import from Excel</button>
        <input type="file" id="fileInput" accept=".xlsx" style="display:none"> 
    </div>
    <div class="bar">
        <button id="saveDraftBtn">💠 Save All as 
            Draft</button> <button id="loadDraftBtn">📂 Load Draft</button>
        <button id="clearActiveTableContentBtn">🧹 Clear Active Table</button> 
    </div>
    <div class="bar">
        <button id="selectBtn">✨ Select Cells</button>
        <button id="mergeBtn">🔗 Merge Cells</button>
        <button id="deselectBtn">🚫 Deselect All</button>
        <button id="unmergeBtn">💔 Unmerge Cell</button>
    </div>
    <div class="bar">
        <button id="addTableBtn">➕ Add New Table</button>
  
              <button id="renameTableBtn">📝 Rename Active Table</button> <button id="deleteTableBtn">❌ Delete Active Table</button>
        <button id="nameListBtn">👥 Manage Names</button>
    </div>
    <div id="draftList" style="display:none;"></div>
    <div class="bar table-tabs" id="tableTabs"></div>
    <div id="tablesContainer">
        <table id="tbl_1" class="active" data-table-name="Table 1">
            <thead>
                <tr>
     
                                   <th contenteditable="true"></th> <th contenteditable="true"></th> 
                    <th contenteditable="true"></th> 
                    <th contenteditable="true"></th> 
                 
                       <th contenteditable="true"></th> <th contenteditable="true"></th> 
                    <th contenteditable="true"></th> 
                </tr>
            </thead>
            <tbody>
           
                 <tr> <td contenteditable="true">08:00-09:00</td>
                    <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
                    <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
                </tr>
            
                 <tr> <td contenteditable="true">09:00-10:00</td>
                    <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
                    <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
                </tr>
            </tbody>
 
               </table> </div>
    <div class="bar" id="rowColManipulationBar">
        <button>⬆️ Add Row Above</button>
        <button>⬇️ Add Row Below</button>
        <button>⬅️ Add Column Left</button>
        <button>➡️ Add Column Right</button>
    </div>
    <div id="nameModal" class="modal">
        <div class="modal-content" id="nameModalContent"> 
            <div class="modal-header" id="nameModalHeader"> 
   
                             <h3>Name List</h3> <button type="button" class="modal-close-btn" id="closeNameModalBtnStandard">×</button>
            </div>
            <div class="input-group">
                <input id="newNameInput" placeholder="Add new name">
                <button id="addNameBtnInModal">Add</button>
     
               </div> <div id="nameList" style="margin-top:10px;max-height:200px;overflow-y:auto;"></div>
        </div>
    </div>
    <h3 style="margin-top:32px">Teacher/Subject Attendance Summary</h3>
    <table id="summaryTable"></table>
    <div id="customMessageBox" class="custom-message-box"></div>

<script>
    // --- Global State and Configuration ---
    const DRAFTS_KEY = 'jadual_drafts_v3';
    const NAMES_KEY = 'jadual_names_v3'; [span_64](start_span)/*[span_64](end_span) */
    const SCHEDULE_TITLE_KEY = 'jadual_title_v3';
    let activeTableId = 'tbl_1'; 
    let tableCount = 1; 
    let selectionMode = false;
    let selectedCells = []; [span_65](start_span)/*[span_65](end_span) */
    let lastClickedCell = null; // FIX: Added to track the last clicked cell for unmerging
    let selectedNameFromList = null; 
    let names = []; 
    let isDraggingModal = false;
    let modalDragOffsetX, modalDragOffsetY;
    let scheduleTitleElement, tablesContainer, tableTabs, nameModal, nameModalContent, nameModalHeader, nameListContainer, newNameInput, draftListElement, summaryTableElement, customMessageBox, fileInputElement, directCopyFullHtmlButtonElement, closeNameModalButtonStandardElement; [span_66](start_span)/*[span_66](end_span) */
    
    // --- Utility Functions ---
    function showMessage(message, type = 'info', duration = 3000) {
        if (!customMessageBox) return;
        customMessageBox.textContent = message; [span_67](start_span)/*[span_67](end_span) */
        customMessageBox.className = `custom-message-box ${type}`;
        customMessageBox.style.display = 'block';
        setTimeout(() => { if (customMessageBox) customMessageBox.style.display = 'none'; }, duration);
    [span_68](start_span)} /*[span_68](end_span) */
    function customPrompt(message, defaultValue = "") { return prompt(message, defaultValue);
    [span_69](start_span)} /*[span_69](end_span) */
    function customConfirm(message) { return confirm(message); }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        scheduleTitleElement = document.getElementById('scheduleTitle');
        tablesContainer = document.getElementById('tablesContainer');
        tableTabs = document.getElementById('tableTabs');
        nameModal = document.getElementById('nameModal');
        nameModalContent = document.getElementById('nameModalContent'); 
        nameModalHeader = document.getElementById('nameModalHeader');   
        nameListContainer = document.getElementById('nameList');
   
             [span_70](start_span)newNameInput = document.getElementById('newNameInput'); /*[span_70](end_span) */
        draftListElement = document.getElementById('draftList');
        summaryTableElement = document.getElementById('summaryTable');
        customMessageBox = document.getElementById('customMessageBox');
        fileInputElement = document.getElementById('fileInput');
        directCopyFullHtmlButtonElement = document.getElementById('directCopyFullHtmlBtn');
        closeNameModalButtonStandardElement = document.getElementById('closeNameModalBtnStandard');
        [span_71](start_span)if (!tablesContainer || !tableTabs || !nameModal || !nameModalContent || !nameModalHeader || !summaryTableElement || !customMessageBox || !scheduleTitleElement || !fileInputElement || !directCopyFullHtmlButtonElement || !closeNameModalButtonStandardElement) { /*[span_71](end_span) */
            console.error("Critical DOM elements missing. Application might not function correctly.");
            document.body.innerHTML = "<p style='color:red; text-align:center; font-size:1.2em; padding:20px;'>Error: Application failed to initialize due to missing page elements.</p>"; [span_72](start_span)/*[span_72](end_span) */
            return;
        [span_73](start_span)} /*[span_73](end_span) */
        
        loadScheduleTitle();
        loadNames(); 
        initializeEventListeners();
        setupInitialTableState();
        renderNameList(); [span_74](start_span)/*[span_74](end_span) */
        rebuildAndRenderSummary(); 
    });

    function setupInitialTableState() {
        const existingTables = tablesContainer.querySelectorAll('table');
        [span_75](start_span)if (existingTables.length > 0) { /*[span_75](end_span) */
            tableTabs.innerHTML = '';
            [span_76](start_span)existingTables.forEach((table, index) => { /*[span_76](end_span) */
                const tableId = table.id || `tbl_init_${Date.now()}_${index + 1}`; 
                table.id = tableId;
                const tableName = table.dataset.tableName || `Table ${index + 1}`;
                table.dataset.tableName = tableName; 
            
            addTabButton(tableId, tableName); [span_77](start_span)/*[span_77](end_span) */
                if (index === 0) activeTableId = tableId;
            });
        } else { addNewTable(true); [span_78](start_span)} /*[span_78](end_span) */
        
        if (activeTableId && document.getElementById(activeTableId)) {
            switchTable(activeTableId);
        [span_79](start_span)} else if (tablesContainer.querySelector('table')) { /*[span_79](end_span) */
            switchTable(tablesContainer.querySelector('table').id);
        [span_80](start_span)} /*[span_80](end_span) */
    }
    
    function loadScheduleTitle() {
        const savedTitle = localStorage.getItem(SCHEDULE_TITLE_KEY);
        if (savedTitle && scheduleTitleElement) scheduleTitleElement.textContent = savedTitle; [span_81](start_span)/*[span_81](end_span) */
        if (scheduleTitleElement) {
            scheduleTitleElement.addEventListener('blur', () => {
                localStorage.setItem(SCHEDULE_TITLE_KEY, scheduleTitleElement.textContent);
                showMessage('Schedule title saved!', 'success');
            });
        [span_82](start_span)} /*[span_82](end_span) */
    }
    // --- Event Listener Initialization ---
    function initializeEventListeners() {
        directCopyFullHtmlButtonElement.addEventListener('click', attemptDirectCopyToClipboard);
        
        // FIX: Use a dedicated close function for the modal's close button
        closeNameModalButtonStandardElement.addEventListener('click', closeNameModal);

        nameModalHeader.addEventListener('mousedown', startDragModal);
        document.addEventListener('mousemove', dragModal);
        document.addEventListener('mouseup', stopDragModal);
        nameModalHeader.addEventListener('touchstart', startDragModal, { passive: false }); 
        document.addEventListener('touchmove', dragModal, { passive: false });
        document.addEventListener('touchend', stopDragModal); [span_83](start_span)/*[span_83](end_span) */

        document.getElementById('excelBtnTrigger').addEventListener('click', exportActiveTableToExcel);
        document.getElementById('importExcelBtn').addEventListener('click', () => fileInputElement.click()); 
        fileInputElement.addEventListener('change', handleExcelFileImport);
        
        document.getElementById('saveDraftBtn').addEventListener('click', promptAndSaveDraft);
        document.getElementById('loadDraftBtn').addEventListener('click', toggleDraftListVisibility);
        document.getElementById('clearActiveTableContentBtn').addEventListener('click', confirmAndClearActiveTableContent); 

        document.getElementById('selectBtn').addEventListener('click', toggleCellSelectionMode);
        document.getElementById('mergeBtn').addEventListener('click', mergeSelectedTableCells);
        document.getElementById('deselectBtn').addEventListener('click', deselectAllTableCells); [span_84](start_span)/*[span_84](end_span) */
        document.getElementById('unmergeBtn').addEventListener('click', unmergeActiveCellIfMerged);

        document.getElementById('addTableBtn').addEventListener('click', () => addNewTable());
        document.getElementById('renameTableBtn').addEventListener('click', promptAndRenameActiveTable);
        document.getElementById('deleteTableBtn').addEventListener('click', confirmAndDeleteActiveTable);
        document.getElementById('nameListBtn').addEventListener('click', toggleNameListModalVisibility);

        const rowColBar = document.getElementById('rowColManipulationBar');
        [span_85](start_span)if (rowColBar) { /*[span_85](end_span) */
            const buttons = rowColBar.getElementsByTagName('button');
            if (buttons[0]) buttons[0].addEventListener('click', addRowAboveToActiveTable);
            if (buttons[1]) buttons[1].addEventListener('click', addRowBelowToActiveTable); [span_86](start_span)/*[span_86](end_span) */
            if (buttons[2]) buttons[2].addEventListener('click', addColumnLeftToActiveTable);
            if (buttons[3]) buttons[3].addEventListener('click', addColumnRightToActiveTable);
        }

        document.getElementById('addNameBtnInModal').addEventListener('click', addNewNameToList);
        [span_87](start_span)draftListElement.addEventListener('click', (e) => { /*[span_87](end_span) */
            const targetSpan = e.target.closest('.draft-item span');
            const targetButton = e.target.closest('.draft-item button');
            if (targetSpan) loadSelectedDraft(targetSpan.textContent);
            else if (targetButton) confirmAndDeleteDraft(targetButton.parentElement.querySelector('span').textContent);
        });
        [span_88](start_span)nameListContainer.addEventListener('click', (e) => { /*[span_88](end_span) */
            const nameItemSpan = e.target.closest('.name-item span[data-name]');
            const deleteButton = e.target.closest('.name-item button');
            if (nameItemSpan) selectNameForCellInsertion(nameItemSpan.dataset.name);
            else if (deleteButton) deleteNameFromListAndStorage(deleteButton.parentElement.querySelector('span[data-name]').dataset.name);
        });
        tablesContainer.addEventListener('click', handleTableCellClick); [span_89](start_span)/*[span_89](end_span) */
        tablesContainer.addEventListener('blur', (e) => { 
            if ((e.target.tagName === 'TD' || e.target.tagName === 'TH') && e.target.isContentEditable) {
                setTimeout(rebuildAndRenderSummary, 0); 
            }
        }, true);
        [span_90](start_span)tablesContainer.addEventListener('input', (e) => { /*[span_90](end_span) */
            if ((e.target.tagName === 'TD' || e.target.tagName === 'TH') && e.target.isContentEditable) {
                setTimeout(rebuildAndRenderSummary, 300); 
            }
        });
    [span_91](start_span)} /*[span_91](end_span) */

    // --- Draggable Modal Functionality ---
    function startDragModal(e) {
        isDraggingModal = true;
        nameModalContent.classList.add('dragging'); 
        const clientX = e.clientX ||
        (e.changedTouches && e.changedTouches[0].clientX); [span_92](start_span)/*[span_92](end_span) */
        const clientY = e.clientY || (e.changedTouches && e.changedTouches[0].clientY);
        [span_93](start_span)if (nameModalContent.style.position !== 'fixed' || nameModalContent.style.transform === 'translate(-50%, -50%)' || nameModalContent.style.transform === '') { /*[span_93](end_span) */
            const rect = nameModalContent.getBoundingClientRect();
            nameModalContent.style.position = 'fixed'; [span_94](start_span)/*[span_94](end_span) */
            nameModalContent.style.left = `${rect.left}px`;
            nameModalContent.style.top = `${rect.top}px`;
            nameModalContent.style.transform = 'none'; 
            nameModalContent.style.margin = '0';
        [span_95](start_span)} /*[span_95](end_span) */
        modalDragOffsetX = clientX - nameModalContent.offsetLeft;
        modalDragOffsetY = clientY - nameModalContent.offsetTop;
        if (e.type === 'touchstart') e.preventDefault();
    [span_96](start_span)} /*[span_96](end_span) */
    function dragModal(e) {
        if (!isDraggingModal) return;
        const clientX = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
        const clientY = e.clientY || (e.changedTouches && e.changedTouches[0].clientY); [span_97](start_span)/*[span_97](end_span) */
        let newLeft = clientX - modalDragOffsetX;
        let newTop = clientY - modalDragOffsetY;
        const modalRect = nameModalContent.getBoundingClientRect(); [span_98](start_span)/*[span_98](end_span) */
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        if (newLeft < 0) newLeft = 0;
        if (newTop < 0) newTop = 0; [span_99](start_span)/*[span_99](end_span) */
        if (newLeft + modalRect.width > viewportWidth) newLeft = viewportWidth - modalRect.width;
        if (newTop + modalRect.height > viewportHeight) newTop = viewportHeight - modalRect.height; [span_100](start_span)/*[span_100](end_span) */
        nameModalContent.style.left = `${newLeft}px`;
        nameModalContent.style.top = `${newTop}px`;
        if (e.type === 'touchmove') e.preventDefault(); [span_101](start_span)/*[span_101](end_span) */
    }
    function stopDragModal() {
        if (isDraggingModal) isDraggingModal = false;
    [span_102](start_span)} /*[span_102](end_span) */
    // --- Direct Copy Full HTML Functionality ---
    async function attemptDirectCopyToClipboard() {
        const fullHtml = document.documentElement.outerHTML;
        [span_103](start_span)try { /*[span_103](end_span) */
            await navigator.clipboard.writeText(fullHtml);
            showMessage('Full HTML copied to clipboard!', 'success');
        [span_104](start_span)} catch (err) { /*[span_104](end_span) */
            console.warn('navigator.clipboard.writeText failed, trying execCommand: ', err);
            const textarea = document.createElement('textarea'); [span_105](start_span)/*[span_105](end_span) */
            textarea.value = fullHtml;
            textarea.style.position = 'fixed'; textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            [span_106](start_span)try { /*[span_106](end_span) */
                const successful = document.execCommand('copy');
                if (successful) showMessage('Full HTML copied! (using fallback method)', 'success'); [span_107](start_span)/*[span_107](end_span) */
                else showMessage('Direct copy failed. Please try copying manually.', 'error', 5000);
            [span_108](start_span)} catch (execErr) { /*[span_108](end_span) */
                console.error('execCommand copy failed: ', execErr);
                showMessage('Direct copy failed. Please try copying manually.', 'error', 5000); [span_109](start_span)/*[span_109](end_span) */
            }
            document.body.removeChild(textarea);
        [span_110](start_span)} /*[span_110](end_span) */
    }

    // --- Draft Management ---
    function promptAndSaveDraft() {
        if (tablesContainer.children.length === 0) { showMessage('No schedule data to save.', 'error');
        return; [span_111](start_span)} /*[span_111](end_span) */
        const allTablesData = tablesContainer.innerHTML; 
        const allTableMeta = {};
        [span_112](start_span)tablesContainer.querySelectorAll('table').forEach(table => { /*[span_112](end_span) */
            allTableMeta[table.id] = { name: table.dataset.tableName || table.id };
        });
        const draftName = customPrompt('Enter draft name:', `Draft ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`); [span_113](start_span)/*[span_113](end_span) */
        [span_114](start_span)if (draftName) { /*[span_114](end_span) */
            const drafts = JSON.parse(localStorage.getItem(DRAFTS_KEY) || '{}');
            drafts[draftName] = { html: allTablesData, meta: allTableMeta, active: activeTableId }; [span_115](start_span)/*[span_115](end_span) */
            localStorage.setItem(DRAFTS_KEY, JSON.stringify(drafts));
            showMessage(`Draft "${draftName}" saved!`, 'success');
            if (draftListElement.style.display === 'block') renderDraftList(); [span_116](start_span)/*[span_116](end_span) */
        }
    }
    function toggleDraftListVisibility() {
        const isVisible = draftListElement.style.display === 'block';
        draftListElement.style.display = isVisible ? 'none' : 'block'; [span_117](start_span)/*[span_117](end_span) */
        if (!isVisible) renderDraftList(); 
    }
    function renderDraftList() {
        draftListElement.innerHTML = '';
        const drafts = JSON.parse(localStorage.getItem(DRAFTS_KEY) || '{}'); [span_118](start_span)/*[span_118](end_span) */
        if (Object.keys(drafts).length === 0) { draftListElement.innerHTML = '<p>No drafts saved yet.</p>'; return;
        [span_119](start_span)} /*[span_119](end_span) */
        for (const name in drafts) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'draft-item'; [span_120](start_span)/*[span_120](end_span) */
            itemDiv.innerHTML = `<span>${name}</span><button>Delete</button>`;
            draftListElement.appendChild(itemDiv);
        }
    }
    function loadSelectedDraft(draftName) {
        const drafts = JSON.parse(localStorage.getItem(DRAFTS_KEY) || '{}');
        [span_121](start_span)if (drafts[draftName]) { /*[span_121](end_span) */
            tablesContainer.innerHTML = drafts[draftName].html;
            const tableMeta = drafts[draftName].meta || {};
            tableTabs.innerHTML = ''; [span_122](start_span)/*[span_122](end_span) */
            tablesContainer.querySelectorAll('table').forEach(table => {
                const id = table.id;
                const metaInfo = tableMeta[id] || {}; 
                const name = metaInfo.name || `Table ${tableTabs.children.length + 1}`; 
                table.dataset.tableName = name; 
                addTabButton(id, name);
                [span_123](start_span)table.querySelectorAll('td, th').forEach(cell => cell.contentEditable = 'true'); /*[span_123](end_span) */
            });
            activeTableId = drafts[draftName].active || tablesContainer.querySelector('table')?.id || 'tbl_1';
            if (document.getElementById(activeTableId)) switchTable(activeTableId); [span_124](start_span)/*[span_124](end_span) */
            else if (tablesContainer.querySelector('table')) switchTable(tablesContainer.querySelector('table').id);
            else addNewTable(true);
            showMessage(`Draft "${draftName}" loaded!`, 'success');
            draftListElement.style.display = 'none'; 
            rebuildAndRenderSummary();
        } else { showMessage(`Draft "${draftName}" not found.`, 'error'); [span_125](start_span)} /*[span_125](end_span) */
    }
    function confirmAndDeleteDraft(draftName) { 
        if (customConfirm(`Are you sure you want to delete saved draft "${draftName}"?`)) {
            const drafts = JSON.parse(localStorage.getItem(DRAFTS_KEY) || '{}');
            delete drafts[draftName]; [span_126](start_span)/*[span_126](end_span) */
            localStorage.setItem(DRAFTS_KEY, JSON.stringify(drafts));
            showMessage(`Saved draft "${draftName}" deleted.`, 'success');
            renderDraftList(); 
        }
    }

    function confirmAndClearActiveTableContent() {
        const activeTableElement = document.getElementById(activeTableId);
        [span_127](start_span)if (!activeTableElement) { /*[span_127](end_span) */
            showMessage('No active table to clear.', 'error');
            return;
        [span_128](start_span)} /*[span_128](end_span) */
        const tableName = activeTableElement.dataset.tableName || `Table ${activeTableId.split('_').pop()}`;
        [span_129](start_span)if (customConfirm(`Are you sure you want to clear all content and unmerge cells in "${tableName}"? This will not delete saved drafts.`)) { /*[span_129](end_span) */
            activeTableElement.querySelectorAll('thead th, tbody td, tbody th').forEach(cell => {
                cell.innerHTML = ''; 
                if (cell.tagName === 'TH') cell.textContent = ''; 
                cell.rowSpan = 1;
                cell.colSpan = 1;
  
                          [span_130](start_span)cell.classList.remove('merged'); /*[span_130](end_span) */
                cell.classList.remove('selected');
            });
            selectedCells = []; [span_131](start_span)/*[span_131](end_span) */
            rebuildAndRenderSummary();
            showMessage(`Content of "${tableName}" cleared.`, 'success');
        }
    }

    // --- Table Management ---
    function addTabButton(id, label) {
        const button = document.createElement('button');
        button.textContent = label; [span_132](start_span)/*[span_132](end_span) */
        button.onclick = () => switchTable(id); 
        tableTabs.appendChild(button);
        return button;
    [span_133](start_span)} /*[span_133](end_span) */
    function switchTable(id) {
        const targetTable = document.getElementById(id);
        [span_134](start_span)if (!targetTable) { /*[span_134](end_span) */
            const firstTableInDOM = tablesContainer.querySelector('table');
            if (firstTableInDOM) id = firstTableInDOM.id;
            [span_135](start_span)else { /*[span_135](end_span) */
                showMessage('Cannot switch: Target table not found.', 'error');
                if (tablesContainer.children.length === 0) addNewTable(true); [span_136](start_span)/*[span_136](end_span) */
                return;
            }
        }
        activeTableId = id;
        tablesContainer.querySelectorAll('table').forEach(t => t.classList.toggle('active', t.id === id)); [span_137](start_span)/*[span_137](end_span) */
        tableTabs.querySelectorAll('button').forEach(b => b.classList.toggle('active', b.getAttribute('onclick').includes(`'${id}'`)));
        deselectAllTableCells(); 
        rebuildAndRenderSummary();
    [span_138](start_span)} /*[span_138](end_span) */
    function addNewTable(isInitial = false) {
        tableCount++; 
        const defaultTableName = `Schedule ${tableTabs.children.length + 1}`;
        const label = isInitial ? defaultTableName : customPrompt('Enter new table name:', defaultTableName); [span_139](start_span)/*[span_139](end_span) */
        if (!label && !isInitial) return;
        const newTable = document.createElement('table'); [span_140](start_span)/*[span_140](end_span) */
        const newTableId = `tbl_${Date.now()}_${tableCount}`; 
        newTable.id = newTableId;
        newTable.dataset.tableName = label || defaultTableName; 
        const thead = newTable.createTHead();
        const headerRow = thead.insertRow(); [span_141](start_span)/*[span_141](end_span) */
        for (let i = 0; i < 7; i++) { 
            const th = document.createElement('th');
            th.contentEditable = 'true'; [span_142](start_span)/*[span_142](end_span) */
            th.textContent = ''; 
            headerRow.appendChild(th);
        }
        const tbody = newTable.createTBody();
        [span_143](start_span)for (let r = 0; r < 2; r++) { /*[span_143](end_span) */
            const dataRow = tbody.insertRow();
            [span_144](start_span)for (let c = 0; c < headerRow.cells.length; c++) { /*[span_144](end_span) */
                const td = dataRow.insertCell();
                td.contentEditable = 'true'; [span_145](start_span)/*[span_145](end_span) */
                if (c === 0 && r === 0) td.textContent = `Sample A`;
                if (c === 0 && r === 1) td.textContent = `Sample B`; [span_146](start_span)/*[span_146](end_span) */
            [span_147](start_span)} /*[span_147](end_span) */
        }
        tablesContainer.appendChild(newTable);
        addTabButton(newTableId, label || defaultTableName);
        switchTable(newTableId);
        if (!isInitial) showMessage(`Table "${label || defaultTableName}" added.`, 'success'); [span_148](start_span)/*[span_148](end_span) */
    }
    function promptAndRenameActiveTable() {
        const currentTab = tableTabs.querySelector(`button.active`);
        if (!currentTab) { showMessage('No active table to rename.', 'error'); return; [span_149](start_span)} /*[span_149](end_span) */
        const oldName = currentTab.textContent;
        const newName = customPrompt('Enter new table name:', oldName); [span_150](start_span)/*[span_150](end_span) */
        if (newName && newName.trim() !== oldName) {
            currentTab.textContent = newName.trim();
            const tableElement = document.getElementById(activeTableId); [span_151](start_span)/*[span_151](end_span) */
            if (tableElement) tableElement.dataset.tableName = newName.trim(); 
            showMessage(`Table renamed to "${newName.trim()}".`, 'success');
        [span_152](start_span)} /*[span_152](end_span) */
    }
    function confirmAndDeleteActiveTable() {
        if (tablesContainer.children.length <= 1) { showMessage('Cannot delete the last table.', 'error'); return;
        [span_153](start_span)} /*[span_153](end_span) */
        const activeTab = tableTabs.querySelector(`button.active`);
        const tableName = activeTab ? activeTab.textContent : activeTableId;
        [span_154](start_span)if (customConfirm(`Delete table "${tableName}"?`)) { /*[span_154](end_span) */
            document.getElementById(activeTableId)?.remove(); 
            activeTab?.remove(); 
            const firstRemainingTab = tableTabs.querySelector('button');
            if (firstRemainingTab) firstRemainingTab.click(); [span_155](start_span)/*[span_155](end_span) */
            else { activeTableId = null; addNewTable(true); }
            showMessage('Table deleted.', 'success');
        [span_156](start_span)} /*[span_156](end_span) */
    }

    // --- Row/Column Operations ---
    function addRowToTable(tableBody, rowIndex, numCols) {
        const row = tableBody.insertRow(rowIndex);
        for (let i = 0; i < numCols; i++) { const cell = row.insertCell(); cell.contentEditable = 'true';
        [span_157](start_span)} /*[span_157](end_span) */
    [span_158](start_span)} /*[span_158](end_span) */
    function addRowAboveToActiveTable() {
        const table = document.getElementById(activeTableId);
        if (!table || !table.tBodies[0] || table.rows.length === 0) return;
        addRowToTable(table.tBodies[0], 0, table.rows[0].cells.length); [span_159](start_span)/*[span_159](end_span) */
        rebuildAndRenderSummary();
    }
    function addRowBelowToActiveTable() {
        const table = document.getElementById(activeTableId);
        if (!table || !table.tBodies[0] || table.rows.length === 0) return; [span_160](start_span)/*[span_160](end_span) */
        addRowToTable(table.tBodies[0], -1, table.rows[0].cells.length); 
        rebuildAndRenderSummary();
    [span_161](start_span)} /*[span_161](end_span) */
    function addColumnToTable(table, colIndex) {
        for (const row of table.rows) {
            const isHeaderRow = row.parentElement.tagName === 'THEAD';
            const cell = isHeaderRow ? document.createElement('th') : row.insertCell(colIndex === -1 ? row.cells.length : colIndex); [span_162](start_span)/*[span_162](end_span) */
            cell.contentEditable = 'true';
            [span_163](start_span)if (isHeaderRow) { /*[span_163](end_span) */
                if (colIndex === -1 || colIndex >= row.cells.length) row.appendChild(cell);
                else row.insertBefore(cell, row.cells[colIndex]); [span_164](start_span)/*[span_164](end_span) */
                cell.textContent = ""; 
            }
        }
    }
    function addColumnLeftToActiveTable() {
        const table = document.getElementById(activeTableId);
        if (table) { addColumnToTable(table, 0); rebuildAndRenderSummary(); [span_165](start_span)} /*[span_165](end_span) */
    }
    function addColumnRightToActiveTable() {
        const table = document.getElementById(activeTableId);
        if (table) { addColumnToTable(table, -1); rebuildAndRenderSummary(); [span_166](start_span)} /*[span_166](end_span) */
    }

    // --- Cell Selection, Merging, Unmerging ---
    function toggleCellSelectionMode() {
        selectionMode = !selectionMode;
        const btn = document.getElementById('selectBtn'); [span_167](start_span)/*[span_167](end_span) */
        btn.classList.toggle('active', selectionMode);
        btn.textContent = selectionMode ? '✨ Selecting...' : '✨ Select Cells';
        if (!selectionMode) deselectAllTableCells();
    [span_168](start_span)} /*[span_168](end_span) */
    function handleTableCellClick(event) {
        const cell = event.target.closest('td, th'); 
        if (!cell || !cell.closest(`#${activeTableId}`)) return;
        
        lastClickedCell = cell; // FIX: Store the most recently clicked cell
        
        [span_169](start_span)if (selectedNameFromList) { /*[span_169](end_span) */
            if (cell.tagName === 'TD' || (cell.tagName === 'TH' && cell.closest('tbody'))) {
                cell.textContent = selectedNameFromList;
                selectedNameFromList = null; [span_170](start_span)/*[span_170](end_span) */
                rebuildAndRenderSummary(); 
            } else { showMessage('Click an editable data cell to insert name.', 'info');
            [span_171](start_span)} /*[span_171](end_span) */
            return; 
        }
        if (selectionMode) { 
            cell.classList.toggle('selected');
            if (cell.classList.contains('selected')) selectedCells.push(cell); [span_172](start_span)/*[span_172](end_span) */
            else selectedCells = selectedCells.filter(c => c !== cell);
        }
    }
    function deselectAllTableCells() {
        selectedCells.forEach(c => c.classList.remove('selected'));
        selectedCells = []; [span_173](start_span)/*[span_173](end_span) */
    }
    function mergeSelectedTableCells() {
        if (selectedCells.length < 2) { showMessage('Select at least two cells to merge.', 'error');
        return; [span_174](start_span)} /*[span_174](end_span) */
        const table = document.getElementById(activeTableId);
        let minR = Infinity, maxR = -Infinity, minC = Infinity, maxC = -Infinity;
        [span_175](start_span)selectedCells.forEach(cell => { /*[span_175](end_span) */
            const r = cell.parentNode.rowIndex; const c = cell.cellIndex;          
            minR = Math.min(minR, r); maxR = Math.max(maxR, r + (cell.rowSpan || 1) - 1); 
            minC = Math.min(minC, c); maxC = Math.max(maxC, c + (cell.colSpan || 1) - 1); 
        });
        const firstCell = table.rows[minR]?.cells[minC]; [span_176](start_span)/*[span_176](end_span) */
        if (!firstCell) { showMessage('Error finding merge starting cell.', 'error'); return;
        [span_177](start_span)} /*[span_177](end_span) */
        let contentToKeep = firstCell.innerHTML; 
        let cellsToRemove = [];
        [span_178](start_span)for (let r = minR; r <= maxR; r++) { /*[span_178](end_span) */
            for (let c = minC; c <= maxC; c++) {
                if (table.rows[r]?.cells[c]) {
                    const currentCell = table.rows[r].cells[c];
                    if (currentCell !== firstCell && selectedCells.includes(currentCell)) cellsToRemove.push(currentCell); [span_179](start_span)/*[span_179](end_span) */
                }
            }
        }
        cellsToRemove.forEach(cell => cell.remove());
        firstCell.rowSpan = maxR - minR + 1; firstCell.colSpan = maxC - minC + 1; [span_180](start_span)/*[span_180](end_span) */
        firstCell.innerHTML = contentToKeep; firstCell.classList.add('merged');
        deselectAllTableCells();
        if (selectionMode) toggleCellSelectionMode(); [span_181](start_span)/*[span_181](end_span) */
        rebuildAndRenderSummary(); showMessage('Cells merged.', 'success');
    }
    
    // FIX: Corrected function to reliably identify the cell to unmerge
    function unmergeActiveCellIfMerged() {
        let cellToUnmerge = null;

        // First, check if a single merged cell is selected in selection mode
        if (selectedCells.length === 1 && (selectedCells[0].rowSpan > 1 || selectedCells[0].colSpan > 1)) {
            cellToUnmerge = selectedCells[0];
        }
        // Otherwise, use the last cell the user clicked on
        else if (lastClickedCell && (lastClickedCell.rowSpan > 1 || lastClickedCell.colSpan > 1) && lastClickedCell.closest(`#${activeTableId}`)) {
            cellToUnmerge = lastClickedCell;
        }

        if (cellToUnmerge) {
            unmergeGivenCell(cellToUnmerge);
        } else {
            showMessage('Click a merged cell to unmerge it.', 'error');
        }
    }

    function unmergeGivenCell(cellToUnmerge) {
        const table = cellToUnmerge.closest('table');
        [span_182](start_span)if (!table) { /*[span_182](end_span) */
            showMessage('No table found for cell.', 'error');
            return;
        [span_183](start_span)} /*[span_183](end_span) */
        const rowIndex = cellToUnmerge.parentNode.rowIndex;
        const cellIndex = cellToUnmerge.cellIndex;
        const rowSpan = cellToUnmerge.rowSpan || 1;
        const colSpan = cellToUnmerge.colSpan || 1; [span_184](start_span)/*[span_184](end_span) */
        if (rowSpan === 1 && colSpan === 1) {
            showMessage('Cell is not merged.', 'info');
            return; [span_185](start_span)/*[span_185](end_span) */
        }
        const content = cellToUnmerge.innerHTML;
        cellToUnmerge.rowSpan = 1;
        cellToUnmerge.colSpan = 1;
        cellToUnmerge.classList.remove('merged');
        cellToUnmerge.innerHTML = content;
        [span_186](start_span)for (let r = rowIndex; r < rowIndex + rowSpan; r++) { /*[span_186](end_span) */
            const row = table.rows[r];
            if (!row) continue; [span_187](start_span)/*[span_187](end_span) */
            let visualCol = 0;
            let insertIndex = cellIndex;
            [span_188](start_span)for (let i = 0; i < row.cells.length; i++) { /*[span_188](end_span) */
                if (visualCol >= cellIndex) {
                    insertIndex = i;
                    break; [span_189](start_span)/*[span_189](end_span) */
                }
                visualCol += row.cells[i].colSpan || 1;
                insertIndex = i + 1; [span_190](start_span)/*[span_190](end_span) */
            }
            for (let c = 0; c < colSpan; c++) {
                if (r === rowIndex && c === 0) continue;
                const newCell = row.insertCell(insertIndex + c); [span_191](start_span)/*[span_191](end_span) */
                newCell.contentEditable = 'true';
                newCell.innerHTML = '';
            [span_192](start_span)} /*[span_192](end_span) */
        }
        deselectAllTableCells();
        rebuildAndRenderSummary();
        showMessage('Cell unmerged.', 'success');
    [span_193](start_span)} /*[span_193](end_span) */
    // --- Name List Management (Modal) ---
    function loadNames() { names = JSON.parse(localStorage.getItem(NAMES_KEY) || '["Teacher A", "Subject B", "Class C"]');
    [span_194](start_span)} /*[span_194](end_span) */
    function saveNames() { localStorage.setItem(NAMES_KEY, JSON.stringify(names)); }

    // FIX: Dedicated function to close the modal to prevent event conflicts
    function closeNameModal(event) {
        event.stopPropagation(); // Prevents the drag event on the header from firing
        nameModal.style.display = 'none';
        console.log('Close button clicked, modal closed.');
    }

    // FIX: Simplified function to toggle modal visibility (now it only opens)
    function toggleNameListModalVisibility() {
        const isDisplayed = nameModal.style.display === 'flex';
        if (isDisplayed) {
            nameModal.style.display = 'none';
        } else {
            nameModalContent.style.position = 'fixed'; [span_195](start_span)/*[span_195](end_span) */
            nameModalContent.style.left = '50%';
            nameModalContent.style.top = '50%';
            nameModalContent.style.transform = 'translate(-50%, -50%)'; [span_196](start_span)/*[span_196](end_span) */
            nameModalContent.style.margin = ''; 
            nameModalContent.classList.remove('dragging'); 
            nameModal.style.display = 'flex'; 
            renderNameList(); 
            newNameInput.focus();
        [span_197](start_span)} /*[span_197](end_span) */
    }

    function renderNameList() {
        nameListContainer.innerHTML = ''; 
        if (names.length === 0) { nameListContainer.innerHTML = '<p>No names. Add some!</p>';
        return; [span_198](start_span)} /*[span_198](end_span) */
        names.forEach(name => {
            const itemDiv = document.createElement('div'); itemDiv.className = 'name-item';
            itemDiv.innerHTML = `<span data-name="${name}">${name}</span><button>Delete</button>`;
            nameListContainer.appendChild(itemDiv);
        });
    [span_199](start_span)} /*[span_199](end_span) */
    function addNewNameToList() {
        const newName = newNameInput.value.trim();
        if (!newName) { showMessage('Enter a name.', 'error'); return;
        [span_200](start_span)} /*[span_200](end_span) */
        if (names.includes(newName)) { showMessage('Name already exists.', 'error'); return; }
        names.push(newName); saveNames(); renderNameList();
        newNameInput.value = ''; newNameInput.focus(); [span_201](start_span)/*[span_201](end_span) */
        rebuildAndRenderSummary(); showMessage(`"${newName}" added.`, 'success');
    }
    function deleteNameFromListAndStorage(nameToDelete) {
        if (customConfirm(`Delete "${nameToDelete}"?`)) {
            names = names.filter(n => n !== nameToDelete);
            saveNames(); renderNameList(); [span_202](start_span)/*[span_202](end_span) */
            rebuildAndRenderSummary(); showMessage(`"${nameToDelete}" removed.`, 'success');
        }
    }
    function selectNameForCellInsertion(name) {
        selectedNameFromList = name;
        showMessage(`Selected "${name}". Click a cell to insert.`, 'info', 4000); [span_203](start_span)/*[span_203](end_span) */
    }

    // --- Excel Export/Import ---
    function handleExcelFileImport(event) {
        const file = event.target.files[0];
        if (!file) return; [span_204](start_span)/*[span_204](end_span) */
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const sheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[sheetName]; [span_205](start_span)/*[span_205](end_span) */
                const htmlTableString = XLSX.utils.sheet_to_html(worksheet, { editable: true, raw: false });
                tableCount++;
                const newTableId = `tbl_imported_${Date.now()}_${tableCount}`; [span_206](start_span)/*[span_206](end_span) */
                const importedTableName = file.name.replace(/\.xlsx?/i, '') || `Imported ${tableCount}`;
                const tempDiv = document.createElement('div'); tempDiv.innerHTML = htmlTableString;
                const importedTableElement = tempDiv.querySelector('table'); [span_207](start_span)/*[span_207](end_span) */
                if (importedTableElement) {
                    importedTableElement.id = newTableId;
                    importedTableElement.dataset.tableName = importedTableName; [span_208](start_span)/*[span_208](end_span) */
                    importedTableElement.querySelectorAll('td, th').forEach(cell => cell.contentEditable = 'true');
                    tablesContainer.appendChild(importedTableElement); 
                    addTabButton(newTableId, importedTableName); switchTable(newTableId);
                    showMessage('Excel data imported into a new table!', 'success'); [span_209](start_span)/*[span_209](end_span) */
                } else { showMessage('Could not parse table from Excel.', 'error');
                [span_210](start_span)} /*[span_210](end_span) */
            } catch (error) { console.error("Excel import error:", error);
                showMessage('Error processing Excel file.', 'error'); [span_211](start_span)} /*[span_211](end_span) */
            finally { event.target.value = '';
            [span_212](start_span)} /*[span_212](end_span) */
        };
        reader.readAsArrayBuffer(file);
    }
    function exportActiveTableToExcel() {
        const tableToExport = document.getElementById(activeTableId);
        if (!tableToExport) { showMessage('No active table to export.', 'error'); return; [span_213](start_span)} /*[span_213](end_span) */
        const tableName = tableToExport.dataset.tableName || activeTableId;
        const wb = XLSX.utils.table_to_book(tableToExport, { sheet: tableName }); [span_214](start_span)/*[span_214](end_span) */
        XLSX.writeFile(wb, `${tableName}_${new Date().toISOString().split('T')[0]}.xlsx`);
        showMessage(`Table "${tableName}" exported.`, 'success');
    [span_215](start_span)} /*[span_215](end_span) */

    // --- Summary Table Logic ---
    function rebuildAndRenderSummary() { buildSummaryTableSkeleton(); updateSummaryTableData();
    [span_216](start_span)} /*[span_216](end_span) */
    function buildSummaryTableSkeleton() {
        if (!summaryTableElement) { console.error("Summary table element not found."); return;
        [span_217](start_span)} /*[span_217](end_span) */
        summaryTableElement.innerHTML = ''; 
        const summaryRowItems = new Set(names);
        [span_218](start_span)tablesContainer.querySelectorAll('table').forEach(table => { /*[span_218](end_span) */
            table.querySelectorAll('tbody tr').forEach(dataRow => {
                Array.from(dataRow.cells).forEach((cell, cellIndex) => {
                    if (cellIndex > 0) { 
                        const text = cell.textContent.trim();
                        if (text && isNaN(text) && text.length > 1) 
                        [span_219](start_span)summaryRowItems.add(text); /*[span_219](end_span) */
                    }
                });
            });
        });
        const sortedSummaryRowHeaders = Array.from(summaryRowItems).sort(); [span_220](start_span)/*[span_220](end_span) */
        const activeScheduleTable = document.getElementById(activeTableId);
        let summaryColumnHeaders = ['Name/Subject'];
        [span_221](start_span)if (activeScheduleTable?.tHead?.rows.length > 0) { /*[span_221](end_span) */
            summaryColumnHeaders.push(...Array.from(activeScheduleTable.tHead.rows[0].cells).slice(1).map(th => th.textContent.trim() || 'Period'));
        } else { summaryColumnHeaders.push('Period 1', 'Period 2', 'Period 3', 'Period 4', 'Period 5'); [span_222](start_span)/*[span_222](end_span) */
        [span_223](start_span)} /*[span_223](end_span) */
        const thead = summaryTableElement.createTHead();
        const headerRowForSummary = thead.insertRow();
        summaryColumnHeaders.forEach(headerText => { const th = document.createElement('th'); th.textContent = headerText; headerRowForSummary.appendChild(th); }); [span_224](start_span)/*[span_224](end_span) */
        const tbody = summaryTableElement.createTBody();
        [span_225](start_span)if (sortedSummaryRowHeaders.length === 0) { /*[span_225](end_span) */
            const tr = tbody.insertRow(); const td = tr.insertCell();
            td.colSpan = summaryColumnHeaders.length || 1; [span_226](start_span)/*[span_226](end_span) */
            td.textContent = 'No items to summarize.'; td.style.textAlign = 'center'; td.style.padding = '10px';
        [span_227](start_span)} else { /*[span_227](end_span) */
            sortedSummaryRowHeaders.forEach(name => {
                const tr = tbody.insertRow(); tr.insertCell().textContent = name; 
                for (let i = 1; i < summaryColumnHeaders.length; i++) tr.insertCell().textContent = ''; 
            });
        [span_228](start_span)} /*[span_228](end_span) */
    }
    function updateSummaryTableData() {
        if (!summaryTableElement?.tBodies[0] || summaryTableElement.tBodies[0].rows.length === 0) {
            buildSummaryTableSkeleton();
            if (!summaryTableElement?.tBodies[0] || summaryTableElement.tBodies[0].rows.length === 0 || (summaryTableElement.tBodies[0].rows[0].cells.length === 1 && summaryTableElement.tBodies[0].rows[0].cells[0].colSpan > 1) ) return; [span_229](start_span)/*[span_229](end_span) */
        [span_230](start_span)} /*[span_230](end_span) */
        const summaryBody = summaryTableElement.tBodies[0];
        const summaryTableActualColumnHeaders = Array.from(summaryTableElement.tHead.rows[0].cells).map(th => th.textContent.trim());
        Array.from(summaryBody.rows).forEach(summaryRow => Array.from(summaryRow.cells).slice(1).forEach(cell => cell.textContent = '')); [span_231](start_span)/*[span_231](end_span) */
        const activeScheduleTable = document.getElementById(activeTableId);
        if (!activeScheduleTable || !activeScheduleTable.tHead?.rows.length > 0 || !activeScheduleTable.tBodies[0]) { console.warn("Active schedule table not found/malformed for summary."); return; [span_232](start_span)/*[span_232](end_span) */
        [span_233](start_span)} /*[span_233](end_span) */
        const activeScheduleTableHeaders = Array.from(activeScheduleTable.tHead.rows[0].cells).map(th => th.textContent.trim());
        [span_234](start_span)Array.from(activeScheduleTable.tBodies[0].rows).forEach(scheduleDataRow => { /*[span_234](end_span) */
            Array.from(scheduleDataRow.cells).forEach((scheduleCell, scheduleCellIndex) => {
                if (scheduleCellIndex === 0) return; 
                const entryInScheduleCell = scheduleCell.textContent.trim(); 
                if (entryInScheduleCell) {
                    const targetSummaryRow = Array.from(summaryBody.rows).find(sr => sr.cells[0]?.textContent === entryInScheduleCell);
                    [span_235](start_span)if (targetSummaryRow) { /*[span_235](end_span) */
                        const currentScheduleColumnHeader = activeScheduleTableHeaders[scheduleCellIndex];
                        const targetSummaryColumnCellIndex = summaryTableActualColumnHeaders.findIndex(h => h === currentScheduleColumnHeader);
                        if (targetSummaryColumnCellIndex > 0) targetSummaryRow.cells[targetSummaryColumnCellIndex].textContent += '✱'; 
                    }
      
                  [span_236](start_span)} /*[span_236](end_span) */
            });
        });
    }
</script>
</body>
</html>
