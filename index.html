<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Weekly Schedule</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* ————— (UNCHANGED CSS CUT FOR BREVITY) ————— */
</style>
</head>
<body>

<h2 contenteditable="true" id="scheduleTitle">Weekly Schedule</h2>

<!-- ————— (UNCHANGED TOOL-BAR HTML) ————— -->

<!-- Name-list modal -->
<div id="nameModal" class="modal">
  <div class="modal-content" id="nameModalContent">
    <div class="modal-header" id="nameModalHeader">
      <h3>Name List</h3>
      <button type="button" class="modal-close-btn" id="closeNameModalBtnStandard">×</button>
    </div>
    <div class="input-group">
      <input id="newNameInput" placeholder="Add new name">
      <button id="addNameBtnInModal">Add</button>
    </div>
    <div id="nameList" style="margin-top:10px;max-height:200px;overflow-y:auto;"></div>
  </div>
</div>

<h3 style="margin-top:32px">Teacher/Subject Attendance Summary</h3>
<table id="summaryTable"></table>

<div id="customMessageBox" class="custom-message-box"></div>

<script>
/* ========== GLOBALS ========== */
const DRAFTS_KEY='jadual_drafts_v3';
const NAMES_KEY='jadual_names_v3';
const SCHEDULE_TITLE_KEY='jadual_title_v3';
let activeTableId='tbl_1',tableCount=1,
    selectionMode=false,selectedCells=[],
    selectedNameFromList=null,names=[],
    isDraggingModal=false,modalDragOffsetX,modalDragOffsetY,
    lastClickedCell=null;           // <—— NEW

/* ========== DOM refs ========== */
let scheduleTitleElement,tablesContainer,tableTabs,nameModal,
    nameModalContent,nameModalHeader,nameListContainer,newNameInput,
    draftListElement,summaryTableElement,customMessageBox,
    fileInputElement,directCopyFullHtmlBtn,closeNameModalBtn;

/* ========== UTILS ========== */
function showMessage(msg,type='info',ms=3000){/* unchanged */}

/* ========== INITIALISATION ========== */
document.addEventListener('DOMContentLoaded',()=>{
  /* — grab elements — */
  scheduleTitleElement=document.getElementById('scheduleTitle');
  tablesContainer=document.getElementById('tablesContainer');
  tableTabs=document.getElementById('tableTabs');
  nameModal=document.getElementById('nameModal');
  nameModalContent=document.getElementById('nameModalContent');
  nameModalHeader=document.getElementById('nameModalHeader');
  nameListContainer=document.getElementById('nameList');
  newNameInput=document.getElementById('newNameInput');
  draftListElement=document.getElementById('draftList');
  summaryTableElement=document.getElementById('summaryTable');
  customMessageBox=document.getElementById('customMessageBox');
  fileInputElement=document.getElementById('fileInput');
  directCopyFullHtmlBtn=document.getElementById('directCopyFullHtmlBtn');
  closeNameModalBtn=document.getElementById('closeNameModalBtnStandard');

  loadScheduleTitle();
  loadNames();
  initialiseEventListeners();
  setupInitialTableState();
  renderNameList();
  rebuildAndRenderSummary();
});

/* ========== EVENT LISTENERS ========== */
function initialiseEventListeners(){
  /* —— modal —— */
  document.getElementById('nameListBtn').addEventListener('click',openNameModal);
  closeNameModalBtn.addEventListener('click',closeNameModal);
  nameModal.addEventListener('click',e=>{ if(e.target===nameModal) closeNameModal(); });
  document.addEventListener('keydown',e=>{ if(e.key==='Escape'&&nameModal.style.display==='flex') closeNameModal(); });

  nameModalHeader.addEventListener('mousedown',startDragModal);
  document.addEventListener('mousemove',dragModal);
  document.addEventListener('mouseup',stopDragModal);
  nameModalHeader.addEventListener('touchstart',startDragModal,{passive:false});
  document.addEventListener('touchmove',dragModal,{passive:false});
  document.addEventListener('touchend',stopDragModal);

  /* —— unmerge —— */
  document.getElementById('unmergeBtn').addEventListener('click',unmergeActiveCellIfMerged);

  /* —— cell click —— */
  tablesContainer.addEventListener('click',handleTableCellClick);

  /* —— (all other existing listeners unchanged) —— */
}

/* ========== NAME-LIST MODAL HELPERS ========== */
function openNameModal(){
  nameModalContent.style.left='50%';nameModalContent.style.top='50%';
  nameModalContent.style.transform='translate(-50%,-50%)';
  nameModal.style.display='flex';
  renderNameList();newNameInput.focus();
}
function closeNameModal(){
  nameModal.style.display='none';
  isDraggingModal=false;nameModalContent.classList.remove('dragging');
}

/* ========== CELL CLICK ========== */
function handleTableCellClick(event){
  const cell=event.target.closest('td,th');
  if(!cell||!cell.closest(`#${activeTableId}`)) return;
  lastClickedCell=cell;            // <—— remember for un-merge

  /* —— (existing logic kept) —— */
  if(selectedNameFromList){
    if(cell.tagName==='TD'||cell.closest('tbody')){
      cell.textContent=selectedNameFromList;
      selectedNameFromList=null;
      rebuildAndRenderSummary();
    }else showMessage('Click an editable data cell to insert name.','info');
    return;
  }
  if(selectionMode){
    cell.classList.toggle('selected');
    if(cell.classList.contains('selected')) selectedCells.push(cell);
    else selectedCells=selectedCells.filter(c=>c!==cell);
  }
}

/* ========== UNMERGE ========== */
function unmergeActiveCellIfMerged(){
  let cell=document.activeElement;
  if(!(cell&&cell.tagName&&/TD|TH/.test(cell.tagName)&&cell.closest(`#${activeTableId}`))){
    /* focus isn’t on a cell – fall back to last clicked */
    cell=lastClickedCell;
  }
  if(!cell){ showMessage('Click on a merged cell first.','error'); return; }
  if(cell.rowSpan===1&&cell.colSpan===1){
    showMessage('Cell is not merged.','info');return;
  }
  unmergeGivenCell(cell);
}

/* ========== unmergeGivenCell, mergeSelectedTableCells, etc. remain UNCHANGED ========== */

/* ——— rest of your original JS is unchanged, apart from using the new helpers above ——— */
</script>
</body>
</html>