<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.1, maximum-scale=5.0">
    <title>Shared Weekly Schedule with Firestore</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif; /* Modern font stack */
            margin: 0;
            background-color: #f0f2f5; /* Lighter grey background */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box; /* Ensure padding doesn't add to width */
        }
        .main-container {
            width: 100%;
            max-width: 1400px; /* Increased max-width */
            background-color: #ffffff;
            padding: 25px;
            border-radius: 12px; /* Softer radius */
            box-shadow: 0 6px 20px rgba(0,0,0,0.08); /* More subtle shadow */
            box-sizing: border-box;
        }
        h2, h3 {
            color: #1c1e21; /* Darker, less harsh color */
            text-align: center;
            margin-bottom: 20px;
        }
        #scheduleTitle {
            font-size: 2.2em;
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 10px;
        }
        #userIdDisplay {
            text-align: center;
            font-size: 0.9em;
            color: #555;
            margin-bottom: 20px;
            min-height: 1.2em; /* Prevent layout shift while loading */
        }

        /* --- Styles for Collapsible Button Controls --- */
        #controlsToggler {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            font-size: 1em;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid #007bff;
            background-color: #007bff;
            color: white;
            margin-bottom: 15px; /* Space before the button bars container */
            transition: background-color 0.2s ease, border-color 0.2s ease;
            width: auto; /* Fit content */
        }
        #controlsToggler:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        #controlsToggler .toggler-icon {
            transition: transform 0.3s ease-out;
            width: 20px; /* Ensure icon has a size */
            height: 20px;
        }
        #controlsToggler[aria-expanded="false"] .toggler-icon {
            transform: rotate(180deg);
        }

        #collapsibleButtonBars {
            max-height: 1000px; 
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, margin-top 0.4s ease-in-out, padding-top 0.4s ease-in-out, padding-bottom 0.4s ease-in-out;
            padding-top: 5px; 
            padding-bottom: 5px;
        }
        #collapsibleButtonBars:not(.open) {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0; 
        }
        /* --- End of Styles for Collapsible Button Controls --- */

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background-color: #fff;
            table-layout: auto; 
        }
        #tablesContainer, #summaryTableContainer {
            overflow-x: auto; 
            position: relative;
            width: 100%;
        }
        #tablesContainer > table {
            display: none; 
        }
        #tablesContainer > table.active {
            display: table; 
        }
        #summaryTable {
            margin-top: 25px;
        }
        th, td {
            border: 1px solid #dee2e6; 
            padding: 12px 15px; 
            text-align: center;
            min-width: 100px; 
            box-sizing: border-box;
            position: relative; 
        }
        table th {
            background-color: #f8f9fa;
            color: #343a40;
            font-weight: 600;
            white-space: nowrap;
        }
        #tablesContainer > table > thead > tr > th {
            font-weight: bold;
            background-color: lightgrey; 
            color: #343a40;
        }
        #tablesContainer > table > thead > tr > th:first-child,
        #tablesContainer > table > tbody > tr > td:first-child,
        #tablesContainer > table > tbody > tr > th:first-child { 
            font-weight: bold;
            background-color: aliceblue; 
            color: #1c1e21; 
        }
        #summaryTable > thead > tr > th {
            font-weight: bold;
            background-color: lightgrey; 
            color: #212529;
        }
        #summaryTable > thead > tr > th:first-child,
        #summaryTable > tbody > tr > td:first-child {
            font-weight: bold;
            background-color: aliceblue; 
            color: #1c1e21; 
        }
        td.selected, th.selected { 
            outline: 3px solid #007bff;
            background-color: #dbeafe; 
        }
        .bar {
            display: flex;
            flex-wrap: wrap; 
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            justify-content: center; 
        }
        .bar button, .table-tabs button, .name-session-tabs button {
            padding: 10px 18px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid #ced4da;
            background-color: #fff;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0; 
        }
        .bar button:hover, .table-tabs button:hover, .name-session-tabs button:hover {
            background-color: #f8f9fa;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .bar button:active, .table-tabs button:active, .name-session-tabs button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        #rowColManipulationBar button {
            background-image: linear-gradient(to bottom, #ffffff 0%, #f1f3f5 100%);
            border: 1px solid #ced4da;
            color: #343a40;
            box-shadow: 0 2px 3px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.2);
            padding: 8px 14px;
        }
        #rowColManipulationBar button:hover {
            background-image: linear-gradient(to bottom, #e9ecef 0%, #dee2e6 100%);
            border-color: #adb5bd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.1);
        }
         #rowColManipulationBar button.delete-btn {
            background-image: linear-gradient(to bottom, #f8d7da 0%, #f1c6cb 100%);
            border-color: #f5c6cb;
            color: #721c24;
        }
        #rowColManipulationBar button.delete-btn:hover {
            background-image: linear-gradient(to bottom, #f5c6cb 0%, #ebaeb3 100%);
            border-color: #f1b0b7;
        }
        #directCopyFullHtmlBtn { background-color: #545b62; color: white; border-color: #545b62;}
        #excelBtnTrigger, #importExcelBtn { background-color: #28a745; color: white; border-color: #28a745;}
        #saveSharedScheduleBtn { background-color: #007bff; color: white; border-color: #007bff;}
        #loadSharedScheduleBtn { background-color: #ffc107; color: #212529; border-color: #ffc107;}
        #clearActiveTableContentBtn { background-color: #fd7e14; color: white; border-color: #fd7e14;}
        #selectBtn { background-color: #17a2b8; color: white; border-color: #17a2b8;}
        #selectBtn.active { background-color: #fd7e14; border-color: #fd7e14;}
        #mergeBtn { background-color: #6f42c1; color: white; border-color: #6f42c1;}
        #unmergeBtn { background-color: #e83e8c; color: white; border-color: #e83e8c;}
        #addTableBtn { background-color: #20c997; color: white; border-color: #20c997;}
        #renameTableBtn { background-color: #6c757d; color: white; border-color: #6c757d;}
        #deleteTableBtn { background-color: #dc3545; color: white; border-color: #dc3545;}
        #nameListBtn { background-color: #fd7e14; color: white; border-color: #fd7e14;}
        #deselectBtn { background-color: #6c757d; color: white; border-color: #6c757d;}
        #exportSharedSchedulesBtn { background-color: #4e54c8; color: white; border-color: #4e54c8;}
        #importSharedSchedulesBtn { background-color: #8f94fb; color: white; border-color: #8f94fb;}
        #downloadPdfBtn { background-color: #dc3545; color: white; border-color: #dc3545;}
        .table-tabs {
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 0;
            display: flex; 
            flex-wrap: wrap; 
            gap: 5px; 
        }
        .table-tabs button {
            background-color: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            border-radius: 6px 6px 0 0;
            color: #0056b3;
            font-weight: 500;
            padding: 10px 15px; 
        }
        .table-tabs button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .name-session-tabs {
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 8px;
            display: flex; 
            flex-wrap: wrap; 
            gap: 5px;
        }
        .name-session-tabs button {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: none;
            margin-bottom: -2px; 
            padding: 10px 15px;
            font-size: 1em;
        }
        .name-session-tabs button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff #007bff #fff; 
            font-weight: bold;
        }
        #summaryTable td { 
            background-color: #fff9e6;
        }
        #summaryTable > tbody > tr > td:first-child {
             background-color: aliceblue !important; 
        }
        .highlight-conflict { 
            background-color: #f8d7da !important;
            font-weight: bold;
            color: #721c24 !important;
        }
        #summaryTable > tbody > tr > td.highlight-conflict:first-child {
            background-color: aliceblue !important;
            color: #721c24 !important; 
        }
        .modal {
            display: none; 
            position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: hidden; 
            background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
            pointer-events: none;
        }
        .modal-content {
            background-color: #fff;
            padding: 25px; border: 1px solid #ccc; width: 90%; max-width: 650px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3); position: relative;
            pointer-events: auto;
            max-height: 90vh; 
            overflow-y: auto; 
            box-sizing: border-box;
        }
        .modal-content.dragging { transform: none; }
        .modal-header {
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef; margin-bottom: 20px;
            font-size: 1.3em; color: #333; display: flex; justify-content: space-between; align-items: center;
            cursor: move; user-select: none;
        }
        .modal-close-btn {
            font-size: 1.8rem;
            font-weight: bold; line-height: 1; color: #555;
            text-shadow: none; opacity: .7; background: transparent; border: 0; cursor: pointer;
            padding: 0 5px;
            transition: color 0.2s;
        }
        .modal-close-btn:hover { opacity: 1; color: #dc3545; }
        .name-item {
            display: flex;
            justify-content: space-between; align-items: center;
            padding: 10px 8px; border-bottom: 1px solid #f1f3f5;
            transition: background-color 0.2s;
        }
        .name-item:hover { background-color: #f8f9fa; }
        .name-item:last-child { border-bottom: none; }
        .name-item span { flex-grow: 1; cursor: pointer; color: #007bff; font-weight: 500; }
        .name-item span:hover { text-decoration: none; color: #0056b3; }
        .name-item button { background-color: #dc3545; color: white; border: none; border-radius: 5px;
            padding: 6px 12px; font-size: 0.9em; transition: background-color 0.2s; }
        .name-item button:hover { background-color: #c82333; }
        .highlighted { background-color: #cfe2ff !important; font-weight: bold; }
        #sharedScheduleListContainer {
            border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 8px;
            background-color: #f8f9fa;
            max-height: 300px;
            overflow-y: auto;
        }
        .shared-schedule-item { display: flex; justify-content: space-between; align-items: center;
            padding: 10px 8px; border-bottom: 1px solid #e9ecef; }
        .shared-schedule-item:last-child { border-bottom: none; }
        .shared-schedule-item span { cursor: pointer; color: #007bff; flex-grow: 1; margin-right: 10px; }
        .shared-schedule-item span:hover { text-decoration: underline; }
        .shared-schedule-item .schedule-date { font-size: 0.8em; color: #6c757d; margin-right: 10px; white-space: nowrap;}
        .shared-schedule-item button { background-color: #dc3545; color: white; border: none; border-radius: 5px;
            padding: 6px 12px; font-size: 0.9em; flex-shrink: 0; }
        #newNameInput, #searchNameInput {
            padding: 10px;
            margin-right: 8px; border: 1px solid #ccc; border-radius: 5px; flex-grow: 1;
            width: calc(100% - 120px); 
            box-sizing: border-box;
        }
         #searchNameInput {
            margin-bottom: 15px;
            width: 100%; 
            box-sizing: border-box;
            margin-right: 0;
         }
        .input-group {
            display: flex;
            margin-bottom: 15px;
            width: 100%;
        }
        .input-group button, #importNameListBtn {
            background-color: #28a745;
            color: white; border-color: #28a745; padding: 10px 15px;
            font-size: 1em; border-radius: 5px; cursor: pointer; flex-shrink: 0;
            transition: background-color 0.2s;
        }
        .input-group button:hover, #importNameListBtn:hover { background-color: #218838; }
        #importNameListBtn {
            margin-top: 10px;
            width: 100%;
        }
        #nameList {
            margin-top:15px;
            max-height:250px; 
            overflow-y:auto;
        }
        @media (min-width: 480px) {
            #nameList {
                column-count: 2;
                column-gap: 20px;
            }
        }
        .custom-message-box {
            display: none;
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background-color: #333; color: white; padding: 15px 25px; border-radius: 8px;
            z-index: 2000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25); font-size: 1.05em;
            text-align: center; 
            width: 90%; 
            max-width: 400px;
        }
        .custom-message-box.success { background-color: #28a745; }
        .custom-message-box.error { background-color: #dc3545; }
        .custom-message-box.info { background-color: #007bff; }
        .merged-cell-container { position: relative; z-index: 2; vertical-align: top; }
        .merged-cell-overlay {
            position: absolute;
            top: 0; left: 0; width: var(--merged-width); height: var(--merged-height);
            background-color: rgba(240, 248, 255, 0.95); font-style: italic; border: 1px solid #add8e6;
            display: flex; align-items: center;
            justify-content: center; overflow: hidden;
            box-sizing: border-box; z-index: 5;
        }
        .subsumed-cell { visibility: hidden; }
        #loadingIndicatorModal, #generalLoadingIndicator {
            position: absolute; 
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.85);
            display: flex; align-items: center; justify-content: center;
            z-index: 10; 
            border-radius: 10px; 
        }
        #generalLoadingIndicator {
            position: fixed; 
            z-index: 3000; 
            border-radius: 0; 
        }
        .spinner {
            border: 5px solid rgba(0, 0, 0, 0.1);
            width: 40px; height: 40px;
            border-radius: 50%;
            border-left-color: #007bff; 
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        input[type="file"][style*="display:none"],
        input[type="file"][style*="display: none"] {
            position: absolute;
            left: -9999px;
            width: 1px;
            height: 1px;
            opacity: 0;
        }
        #autocompleteSuggestions {
            display: none; 
            position: absolute;
            border: 1px solid #ccc;
            background-color: white;
            z-index: 1001; 
            max-height: 150px;
            overflow-y: auto;
            min-width: 120px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            border-radius: 4px;
        }
        .suggestion-item {
            padding: 8px 10px;
            cursor: pointer;
            font-size: 0.9em;
            white-space: nowrap;
        }
        .suggestion-item:hover, .suggestion-item.active-suggestion {
            background-color: #e9ecef; 
            color: #0056b3;
        }

        /* Enhanced styles for PDF content container */
        #pdfContent {
            padding: 30px;
            background-color: #fff; 
            color: #333;
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            box-sizing: border-box;
            width: 100%; 
            display: none; 
            page-break-inside: avoid;
        }
        #pdfContent .pdf-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #0056b3;
            padding-bottom: 20px;
        }
        #pdfContent .pdf-title {
            font-size: 2.5em;
            color: #0056b3;
            margin: 0 0 10px 0;
            font-weight: bold;
        }
        #pdfContent .pdf-subtitle {
            font-size: 1.2em;
            color: #666;
            margin: 0;
        }
        #pdfContent .pdf-table-section {
            margin-bottom: 40px;
            page-break-inside: avoid;
        }
        #pdfContent .pdf-table-title {
            text-align: center;
            color: #1c1e21;
            margin-bottom: 20px;
            font-size: 1.8em;
            font-weight: bold;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }
        #pdfContent table {
            width: 100%;
            border-collapse: collapse; 
            margin-bottom: 25px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            background-color: #fff; 
            table-layout: fixed; 
            page-break-inside: avoid;
        }
        #pdfContent th, #pdfContent td {
            border: 2px solid #333 !important; 
            padding: 12px 8px; 
            text-align: center;
            font-size: 0.9em; 
            word-wrap: break-word; 
            background-color: #fff; 
            vertical-align: middle;
        }
        #pdfContent table th { 
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%) !important; 
            color: #212529;
            font-weight: bold; 
            font-size: 1em;
        }
        #pdfContent table tbody tr td:first-child, 
        #pdfContent table thead tr th:first-child { 
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%) !important; 
            font-weight: bold;
            color: #1c1e21;
        }
        #pdfContent .pdf-footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #dee2e6;
            font-size: 0.9em;
            color: #666;
        }
        #pdfContent .pdf-footer .generated-date {
            font-weight: bold;
            color: #0056b3;
        }
        
        /* Page break controls for PDF */
        @media print {
            #pdfContent .pdf-table-section {
                page-break-before: auto;
                page-break-after: auto;
                page-break-inside: avoid;
            }
            #pdfContent table {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
<div class="main-container">
    <h2 contenteditable="true" id="scheduleTitle">Shared Weekly Schedule</h2>
    <div id="userIdDisplay">User ID: Loading...</div>

    <button id="controlsToggler" aria-expanded="true" aria-controls="collapsibleButtonBars" title="Toggle button controls visibility">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="toggler-icon"><polyline points="18 15 12 9 6 15"></polyline></svg> <span>Hide Controls</span>
    </button>

    <div id="collapsibleButtonBars" class="open"> 
        <div class="bar">
            <button id="directCopyFullHtmlBtn" title="Copy the entire page's HTML to clipboard">📋 Copy Full HTML (Direct)</button>
            <button id="downloadPdfBtn" title="Download schedule tables as PDF">📄 Download PDF</button> </div>
        <div class="bar">
            <button id="excelBtnTrigger" title="Export the currently active table to an Excel file">💾 Export Active Table to Excel</button>
            <button id="importExcelBtn" title="Import data from an Excel file into a new table">📂 Import from Excel</button>
            <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none">
        </div>
        <div class="bar">
            <button id="saveSharedScheduleBtn" title="Save current schedule to the shared Cloud space">💠 Save Shared Schedule</button>
            <button id="loadSharedScheduleBtn" title="Show list of shared schedules from Cloud to load">☁️ Load Shared Schedule</button>
            <button id="exportSharedSchedulesBtn" title="Export all shared schedules from Cloud to a JSON file">📤 Export All Shared Schedules</button>
            <button id="importSharedSchedulesBtn" title="Import schedules from a JSON file to the shared Cloud space">📥 Import Shared Schedules</button>
            <input type="file" id="sharedScheduleImportFile" accept=".json" style="display:none;">
            <button id="clearActiveTableContentBtn" title="Clear all data from the cells of the active table">🧹 Clear Active Table</button>
        </div>
        <div class="bar">
            <button id="selectBtn" title="Toggle cell selection mode on/off">✨ Select Cells</button>
            <button id="mergeBtn" title="Merge the currently selected cells">🔗 Merge Cells</button>
            <button id="deselectBtn" title="Clear current cell selection">🚫 Deselect All</button>
            <button id="unmergeBtn" title="Unmerge the cell that was last clicked if it's part of a merge">💔 Unmerge Cell</button>
        </div>
        <div class="bar">
            <button id="addTableBtn" title="Add a new, empty table/sheet">➕ Add New Table</button>
            <button id="renameTableBtn" title="Rename the currently active table/sheet">📝 Rename Active Table</button>
            <button id="deleteTableBtn" title="Delete the currently active table/sheet">❌ Delete Active Table</button>
            <button id="nameListBtn" title="Open a dialog to manage the shared list of names (Firestore)">👥 Manage Shared Names</button>
        </div>
        <div class="bar" id="rowColManipulationBar">
            <button id="addRowAboveBtn" title="Add a new row above the currently selected/clicked row">⬆️ Add Row Above</button>
            <button id="addRowBelowBtn" title="Add a new row below the currently selected/clicked row">⬇️ Add Row Below</button>
            <button id="addColLeftBtn" title="Add a new column to the left of the currently selected/clicked column">⬅️ Add Column Left</button>
            <button id="addColRightBtn" title="Add a new column to the right of the currently selected/clicked column">➡️ Add Column Right</button>
            <button id="deleteRowBtn" class="delete-btn" title="Delete the currently selected/clicked row">🗑️ Delete Row</button>
            <button id="deleteColBtn" class="delete-btn" title="Delete the currently selected/clicked column">🗑️ Delete Column</button>
        </div>
    </div> 
    
    <div id="sharedScheduleListContainer" style="display:none;"></div>
    <div class="bar table-tabs" id="tableTabs"></div>
    <div id="tablesContainer">
        <table id="tbl_1" class="active" data-table-name="Kelas 3 & 5">
            <thead>
                <tr>
                    <th contenteditable="true">Class</th>
                    <th contenteditable="true">08:00</th>
                    <th contenteditable="true">09:00</th>
                    <th contenteditable="true">10:00</th>
                    <th contenteditable="true" data-merge-id="rehat_tbl1_col4" class="merged-cell-container">
                        <div class="merged-cell-overlay" style="--merged-width: 200px; --merged-height: 50px;" contenteditable="true">REHAT</div>
                    </th>
                    <th contenteditable="true" data-merge-id="rehat_tbl1_col4" class="subsumed-cell">11:00</th>
                    <th contenteditable="true">12:00</th>
                    <th contenteditable="true">13:00</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td contenteditable="true">5S1</td>
                    <td contenteditable="true"></td><td contenteditable="true">JAMES *ReportDue // Sick leave</td><td contenteditable="true"></td>
                    <td contenteditable="true" data-merge-id="rehat_tbl1_col4_row1" class="merged-cell-container">
                         <div class="merged-cell-overlay" style="--merged-width: 200px; --merged-height: 50px;" contenteditable="true"></div>
                    </td>
                    <td contenteditable="true" data-merge-id="rehat_tbl1_col4_row1" class="subsumed-cell"></td>
                    <td contenteditable="true"></td><td contenteditable="true"></td>
                </tr>
                 <tr>
                    <td contenteditable="true">5S2</td>
                    <td contenteditable="true">*SpecialAssembly</td><td contenteditable="true"></td><td contenteditable="true">LILY</td>
                     <td contenteditable="true" data-merge-id="rehat_tbl1_col4_row2" class="merged-cell-container">
                         <div class="merged-cell-overlay" style="--merged-width: 200px; --merged-height: 50px;" contenteditable="true"></div>
                    </td>
                    <td contenteditable="true" data-merge-id="rehat_tbl1_col4_row2" class="subsumed-cell"></td>
                    <td contenteditable="true"></td><td contenteditable="true"></td>
                </tr>
            </tbody>
        </table>
        <table id="tbl_2" data-table-name="Kelas 1, 2 & 4">
            <thead>
                <tr>
                    <th contenteditable="true">Class</th>
                    <th contenteditable="true">08:00</th>
                    <th contenteditable="true">09:00</th>
                    <th contenteditable="true">10:00</th>
                    <th contenteditable="true" data-merge-id="rehat_tbl2_col4" class="merged-cell-container">
                        <div class="merged-cell-overlay" style="--merged-width: 200px; --merged-height: 50px;" contenteditable="true">REHAT</div>
                    </th>
                    <th contenteditable="true" data-merge-id="rehat_tbl2_col4" class="subsumed-cell">11:00</th>
                    <th contenteditable="true">12:00</th>
                    <th contenteditable="true">13:00</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td contenteditable="true">1A</td>
                    <td contenteditable="true">MATH</td><td contenteditable="true"></td><td contenteditable="true">SCIENCE</td>
                    <td contenteditable="true" data-merge-id="rehat_tbl2_col4_row1" class="merged-cell-container">
                         <div class="merged-cell-overlay" style="--merged-width: 200px; --merged-height: 50px;" contenteditable="true"></div>
                    </td>
                    <td contenteditable="true" data-merge-id="rehat_tbl2_col4_row1" class="subsumed-cell"></td>
                    <td contenteditable="true"></td><td contenteditable="true"></td>
                </tr>
                 <tr>
                    <td contenteditable="true">2B</td>
                    <td contenteditable="true"></td><td contenteditable="true">HISTORY</td><td contenteditable="true"></td>
                    <td contenteditable="true" data-merge-id="rehat_tbl2_col4_row2" class="merged-cell-container">
                         <div class="merged-cell-overlay" style="--merged-width: 200px; --merged-height: 50px;" contenteditable="true"></div>
                    </td>
                    <td contenteditable="true" data-merge-id="rehat_tbl2_col4_row2" class="subsumed-cell"></td>
                    <td contenteditable="true">ART</td><td contenteditable="true"></td>
                </tr>
                <tr>
                    <td contenteditable="true">4C</td>
                    <td contenteditable="true">PHYSICS</td><td contenteditable="true"></td><td contenteditable="true">CHEMISTRY</td>
                    <td contenteditable="true" data-merge-id="rehat_tbl2_col4_row3" class="merged-cell-container">
                         <div class="merged-cell-overlay" style="--merged-width: 200px; --merged-height: 50px;" contenteditable="true"></div>
                    </td>
                    <td contenteditable="true" data-merge-id="rehat_tbl2_col4_row3" class="subsumed-cell"></td>
                    <td contenteditable="true"></td><td contenteditable="true"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="nameModal" class="modal">
        <div class="modal-content" id="nameModalContent">
            <div class="modal-header" id="nameModalHeader">
                <h3 id="nameModalTitle">Shared Name List Manager</h3>
                <button type="button" class="modal-close-btn" id="closeNameModalBtnStandard" title="Close name manager">×</button>
            </div>
            <div class="name-session-tabs">
                <button id="namePagiTab" data-session="pagi" class="active">Pagi (Morning)</button>
                <button id="namePetangTab" data-session="petang">Petang (Afternoon)</button>
            </div>
             <div class="input-group">
                <input id="newNameInput" placeholder="Add new name to current shared session">
                <button id="addNameBtnInModal" title="Add the name to the shared list">Add</button>
             </div>
            <button id="importNameListBtn" title="Import names from a .txt file (one name per line) to current shared session">📂 Import Names (.txt) to Shared Session</button>
            <input type="file" id="nameListImportFile" accept=".txt" style="display:none;">
            <input type="text" id="searchNameInput" placeholder="🔍 Search names in current shared session..." title="Filter the list of names">
            <div id="nameList"></div>
            <div id="loadingIndicatorModal" style="display:none;"><div class="spinner"></div></div>
        </div>
    </div>

    <h3 style="margin-top:32px">Teacher/Subject Attendance Summary</h3>
    <div id="summaryTableContainer">
        <table id="summaryTable"></table>
    </div>
    <div id="customMessageBox" class="custom-message-box"></div>
    <div id="generalLoadingIndicator" style="display:none;"><div class="spinner"></div></div>
</div>

<div id="pdfContent"></div>

<script type="module">
    // Firebase App (the core Firebase SDK) is always required and must be listed first
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    // Add SDKs for Firebase products that you want to use
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, getDocs, getDoc, deleteDoc, updateDoc, query, serverTimestamp, orderBy, where, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

    // --- Firebase Configuration ---
    const userProvidedFirebaseConfig = {
      apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4", 
      authDomain: "jadual-3f0aa.firebaseapp.com",
      projectId: "jadual-3f0aa",
      storageBucket: "jadual-3f0aa.appspot.com",
      messagingSenderId: "496526436851",
      appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
    };

    let firebaseConfig;
    if (typeof __firebase_config !== 'undefined' && __firebase_config !== null && __firebase_config.trim() !== '') {
        try {
            firebaseConfig = JSON.parse(__firebase_config);
            console.log("Using injected Firebase config (__firebase_config).");
        } catch (e) {
            console.error("Error parsing injected __firebase_config. Falling back to userProvidedFirebaseConfig. Error:", e);
            firebaseConfig = userProvidedFirebaseConfig;
        }
    } else {
        firebaseConfig = userProvidedFirebaseConfig;
        console.warn("Firebase Auth: __firebase_config is not defined or empty. Using userProvidedFirebaseConfig from the script.");
        if (firebaseConfig.apiKey === "YOUR_API_KEY" || firebaseConfig.projectId === "YOUR_PROJECT_ID") { 
            console.error("Firebase Auth: CRITICAL - The userProvidedFirebaseConfig contains placeholder values. Firebase will NOT work. Please update the firebaseConfig object in the script with your actual Firebase project details if not running in an environment that injects __firebase_config.");
        }
    }
    
    const appId = typeof __app_id !== 'undefined' ? __app_id : (firebaseConfig.appId || 'default-shared-scheduler-app');
    
    if (typeof __app_id === 'undefined') {
        console.warn("Firebase Auth: __app_id is not defined. Using App ID from Firebase config or a default value. This appId scopes your shared data in Firestore.");
    }

    // --- Initialize Firebase ---
    let fbApp, fbAuth, fbDb;
    let fbUserId = null;
    let fbIsAuthReady = false;
    let unsubscribePagiShared = null;
    let unsubscribePetangShared = null;

    try {
        fbApp = initializeApp(firebaseConfig);
        fbAuth = getAuth(fbApp);
        fbDb = getFirestore(fbApp);
        console.log("Firebase services initialized for Shared Scheduler with Project ID:", firebaseConfig.projectId);
    } catch (e) {
        console.error("CRITICAL Error initializing Firebase services:", e);
        showMessage("Critical Error: Firebase initialization failed. Cloud features will not work.", "error", 10000);
        const userIdDisplayInitError = document.getElementById('userIdDisplay');
        if (userIdDisplayInitError) userIdDisplayInitError.textContent = "User ID: Firebase Init Error!";
    }

    // --- Global State and Configuration ---
    const SCHEDULE_TITLE_KEY = `shared_jadual_title_${appId}`;
    let activeTableId = 'tbl_1'; 
    let tableCount = 1; 
    let selectionMode = false;
    let selectedCells = [];
    let lastClickedCell = null;
    let selectedNameFromList = null; 

    let currentNameListSession = 'pagi'; 
    let namesPagiShared = [];
    let namesPetangShared = [];

    let isDraggingModal = false;
    let modalDragOffsetX, modalDragOffsetY;

    let autocompleteSuggestionsDiv = null;
    let activeCellForAutocomplete = null;
    let currentAutocompleteIndex = -1; 

    let currentWorkingScheduleDocId = null; 
    let autoSaveIntervalId = null;
    const AUTO_SAVE_INTERVAL = 60000; 

    // DOM Element Cache
    let scheduleTitleElement, tablesContainer, tableTabs, nameModal, nameModalContent, nameModalHeader, nameListContainer, newNameInput, sharedScheduleListContainerElement, summaryTableElement, summaryTableContainerElement, customMessageBox, fileInputElement, directCopyFullHtmlButtonElement, closeNameModalButtonStandardElement, nameListImportFileInputElement, searchNameInputElement, sharedScheduleImportFileInputElement, userIdDisplayElement, namePagiTabElement, namePetangTabElement, loadingIndicatorModalElement, nameModalTitleElement, generalLoadingIndicatorElement, controlsTogglerElement, collapsibleButtonBarsElement, downloadPdfButtonElement, pdfContentElement;

    // --- Utility Functions ---
    function showMessage(message, type = 'info', duration = 3000) {
        if (!customMessageBox) {
            customMessageBox = document.getElementById('customMessageBox');
            if (!customMessageBox) {
                console.warn("showMessage called but customMessageBox element not found. Message:", message);
                return;
            }
        }
        customMessageBox.textContent = message;
        customMessageBox.className = `custom-message-box ${type}`;
        customMessageBox.style.display = 'block';
        setTimeout(() => { if (customMessageBox) customMessageBox.style.display = 'none'; }, duration);
    }

    function customPrompt(message, defaultValue = "") {
        return prompt(message, defaultValue);
    }

    function customConfirm(message) {
        return new Promise((resolve) => {
            const confirmModalId = 'customConfirmModal';
            let existingModal = document.getElementById(confirmModalId);
            if (existingModal) existingModal.remove();
            const modal = document.createElement('div');
            modal.id = confirmModalId;
            modal.style.cssText = `display: flex; position: fixed; z-index: 2001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;`;
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `background-color: #fff; padding: 25px; border-radius: 8px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); min-width: 300px; max-width: 90%;`;
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.style.marginBottom = '20px'; messageP.style.fontSize = '1.1em';
            const yesButton = document.createElement('button');
            yesButton.textContent = 'Yes';
            yesButton.style.cssText = `padding: 10px 20px; margin: 0 10px; border-radius: 5px; cursor: pointer; background-color: #28a745; color: white; border: none; font-size: 1em;`;
            const noButton = document.createElement('button');
            noButton.textContent = 'No';
            noButton.style.cssText = `padding: 10px 20px; margin: 0 10px; border-radius: 5px; cursor: pointer; background-color: #dc3545; color: white; border: none; font-size: 1em;`;
            const closeModal = (value) => { modal.remove(); resolve(value); };
            yesButton.onclick = () => closeModal(true);
            noButton.onclick = () => closeModal(false);
            modalContent.appendChild(messageP);
            modalContent.appendChild(yesButton);
            modalContent.appendChild(noButton);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        });
    }

    function showGeneralLoading(isLoading) {
        if (generalLoadingIndicatorElement) {
            generalLoadingIndicatorElement.style.display = isLoading ? 'flex' : 'none';
        }
    }

    function toggleButtonBarsVisibility() {
        if (!collapsibleButtonBarsElement || !controlsTogglerElement) return;
        const isOpen = collapsibleButtonBarsElement.classList.toggle('open');
        controlsTogglerElement.setAttribute('aria-expanded', isOpen.toString());
        const textSpan = controlsTogglerElement.querySelector('span');
        if (textSpan) {
            textSpan.textContent = isOpen ? 'Hide Controls' : 'Show Controls';
        }
    }

    function showNameModalLoading(isLoading) {
        if (loadingIndicatorModalElement) {
            loadingIndicatorModalElement.style.display = isLoading ? 'flex' : 'none';
        }
    }

    // --- ENHANCED PDF GENERATION FUNCTION ---
    async function generateSchedulePdf() {
        if (!pdfContentElement || !tablesContainer) { 
            showMessage('PDF generation elements not found.', 'error');
            console.error("PDF Generation Error: pdfContentElement or tablesContainer not found.");
            return;
        }

        showGeneralLoading(true);
        showMessage('Generating PDF with all tables, please wait...', 'info', 15000); 

        // Clear previous content
        pdfContentElement.innerHTML = '';

        // Get current date for footer
        const currentDate = new Date().toLocaleDateString('en-MY', {
            weekday: 'long',
            year: 'numeric', 
            month: 'long', 
            day: 'numeric'
        });

        // Create PDF header
        const pdfHeader = document.createElement('div');
        pdfHeader.className = 'pdf-header';
        
        const pdfTitle = document.createElement('h1');
        pdfTitle.className = 'pdf-title';
        pdfTitle.textContent = scheduleTitleElement ? scheduleTitleElement.textContent : 'Weekly Schedule';
        
        const pdfSubtitle = document.createElement('div');
        pdfSubtitle.className = 'pdf-subtitle';
        pdfSubtitle.textContent = 'Complete Teaching Schedule Overview';
        
        pdfHeader.appendChild(pdfTitle);
        pdfHeader.appendChild(pdfSubtitle);
        pdfContentElement.appendChild(pdfHeader);

        console.log("PDF Generation: Processing all tables in tablesContainer...");

        // Get all tables from tablesContainer
        const allTables = tablesContainer.querySelectorAll('table');
        let processedTables = 0;

        if (allTables.length === 0) {
            showMessage('No tables found to include in PDF.', 'error');
            showGeneralLoading(false);
            return;
        }

        // Process each table
        allTables.forEach((originalTable, index) => {
            console.log(`PDF Generation: Processing table ${index + 1}: ${originalTable.id} (${originalTable.dataset.tableName || 'Unknown'})`);
            
            // Create table section
            const tableSection = document.createElement('div');
            tableSection.className = 'pdf-table-section';
            
            // Create table title
            const tableTitle = document.createElement('div');
            tableTitle.className = 'pdf-table-title';
            tableTitle.textContent = originalTable.dataset.tableName || `Table ${index + 1}`;
            
            tableSection.appendChild(tableTitle);
            
            // Clone and process the table
            const clonedTable = cloneTableForPdf(originalTable);
            if (clonedTable) {
                tableSection.appendChild(clonedTable);
                processedTables++;
                console.log(`PDF Generation: Successfully processed table ${index + 1}`);
            } else {
                console.error(`PDF Generation Error: Failed to clone table ${index + 1}`);
            }
            
            pdfContentElement.appendChild(tableSection);
        });

        // Add footer with current date
        const pdfFooter = document.createElement('div');
        pdfFooter.className = 'pdf-footer';
        pdfFooter.innerHTML = `
            <div>Generated on: <span class="generated-date">${currentDate}</span></div>
            <div>Total Tables: ${processedTables}</div>
        `;
        pdfContentElement.appendChild(pdfFooter);

        if (processedTables === 0) {
            showMessage('No tables could be processed for PDF generation.', 'error');
            pdfContentElement.innerHTML = '';
            showGeneralLoading(false);
            return;
        }

        console.log(`PDF Generation: Successfully processed ${processedTables} out of ${allTables.length} tables`);
        
        // Make pdfContentElement visible for capture
        pdfContentElement.style.display = 'block';

        // Enhanced PDF options
        const pdfOptions = {
            margin: [10, 8, 10, 8],
            filename: `${(scheduleTitleElement ? scheduleTitleElement.textContent : 'Weekly_Schedule').replace(/\s/g, '_')}_Complete_${new Date().toISOString().split('T')[0]}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
                scale: 2.5,
                useCORS: true,
                logging: false,
                scrollX: 0,
                scrollY: -window.scrollY,
                windowWidth: pdfContentElement.scrollWidth,
                windowHeight: pdfContentElement.scrollHeight,
                backgroundColor: '#ffffff'
            },
            jsPDF: { 
                unit: 'mm', 
                format: 'a4', 
                orientation: 'landscape',
                compress: true
            },
            pagebreak: { 
                mode: ['avoid-all', 'css', 'legacy'],
                before: '.pdf-table-section',
                after: '.pdf-table-section',
                avoid: 'table'
            }
        };

        try {
            console.log("PDF Generation: Calling html2pdf()...");
            await html2pdf().from(pdfContentElement).set(pdfOptions).save();
            showMessage(`PDF with ${processedTables} tables downloaded successfully!`, 'success');
            console.log("PDF Generation: html2pdf save() completed successfully.");
        } catch (error) {
            console.error('Error generating PDF with html2pdf:', error);
            showMessage(`Failed to generate PDF. Error: ${error.message}`, 'error', 10000);
        } finally {
            console.log("PDF Generation: Hiding pdfContentElement and stopping loading indicator.");
            pdfContentElement.style.display = 'none';
            showGeneralLoading(false);
        }
    }

    // Helper function to clone tables for PDF generation, handling merged cells
    function cloneTableForPdf(originalTable) {
        if (!originalTable || typeof originalTable.cloneNode !== 'function') {
            console.error("cloneTableForPdf Error: Invalid originalTable provided:", originalTable);
            return null;
        }
        
        const tableIdForLog = originalTable.id || 'Unknown ID';
        console.log(`cloneTableForPdf: Starting clone for table: ${tableIdForLog}, Name: ${originalTable.dataset.tableName || 'N/A'}`);

        const clonedTable = originalTable.cloneNode(true);
        clonedTable.removeAttribute('id');
        clonedTable.classList.remove('active');
        clonedTable.style.width = '100%';
        clonedTable.style.tableLayout = 'fixed';

        // Remove contenteditable attributes
        clonedTable.querySelectorAll('[contenteditable="true"]').forEach(el => {
            el.removeAttribute('contenteditable');
        });

        // Process merged cells
        const mergeGroups = {};
        Array.from(originalTable.rows).forEach((originalRow, rowIndex) => {
            Array.from(originalRow.cells).forEach((originalCell, colIndex) => {
                const mergeId = originalCell.dataset.mergeId;
                if (!mergeId) return;

                if (!mergeGroups[mergeId]) {
                    mergeGroups[mergeId] = {
                        minRow: rowIndex, maxRow: rowIndex,
                        minCol: colIndex, maxCol: colIndex,
                        primaryCellOriginal: null,
                        allOriginalCellsInGroup: []
                    };
                }
                
                const group = mergeGroups[mergeId];
                group.allOriginalCellsInGroup.push(originalCell);
                group.minRow = Math.min(group.minRow, rowIndex);
                group.maxRow = Math.max(group.maxRow, rowIndex);
                group.minCol = Math.min(group.minCol, colIndex);
                group.maxCol = Math.max(group.maxCol, colIndex);

                if (originalCell.classList.contains('merged-cell-container')) {
                    group.primaryCellOriginal = originalCell;
                }
            });
        });

        // Apply rowspan and colspan to merged cells
        for (const mergeId in mergeGroups) {
            const group = mergeGroups[mergeId];
            if (!group.primaryCellOriginal) continue;

            const rowSpan = group.maxRow - group.minRow + 1;
            const colSpan = group.maxCol - group.minCol + 1;

            // Find primary cell in cloned table
            let primaryCellOriginalRowIndex = -1;
            let primaryCellOriginalColIndex = -1;
            
            for(let rIdx = 0; rIdx < originalTable.rows.length; rIdx++) {
                const r = originalTable.rows[rIdx];
                for(let cIdx = 0; cIdx < r.cells.length; cIdx++) {
                    if (r.cells[cIdx] === group.primaryCellOriginal) {
                        primaryCellOriginalRowIndex = rIdx;
                        primaryCellOriginalColIndex = cIdx;
                        break;
                    }
                }
                if (primaryCellOriginalRowIndex !== -1) break;
            }
            
            if (primaryCellOriginalRowIndex === -1 || primaryCellOriginalColIndex === -1) continue;
            
            const clonedPrimaryCell = clonedTable.rows[primaryCellOriginalRowIndex]?.cells[primaryCellOriginalColIndex];

            if (clonedPrimaryCell) {
                const overlayOriginal = group.primaryCellOriginal.querySelector('.merged-cell-overlay');
                clonedPrimaryCell.textContent = overlayOriginal ? overlayOriginal.textContent : group.primaryCellOriginal.textContent;
                
                // Remove overlay from cloned cell
                const overlayCloned = clonedPrimaryCell.querySelector('.merged-cell-overlay');
                if (overlayCloned) overlayCloned.remove();

                clonedPrimaryCell.rowSpan = rowSpan;
                clonedPrimaryCell.colSpan = colSpan;

                // Remove subsumed cells
                const cellsToRemoveFromClonedTable = [];
                group.allOriginalCellsInGroup.forEach(originalSubsumedCell => {
                    if (originalSubsumedCell === group.primaryCellOriginal) return;

                    let subsumedOriginalRowIndex = -1;
                    let subsumedOriginalColIndex = -1;
                    for(let rIdx = 0; rIdx < originalTable.rows.length; rIdx++) {
                        const r = originalTable.rows[rIdx];
                        for(let cIdx = 0; cIdx < r.cells.length; cIdx++) {
                             if (r.cells[cIdx] === originalSubsumedCell) {
                                subsumedOriginalRowIndex = rIdx;
                                subsumedOriginalColIndex = cIdx;
                                break;
                            }
                        }
                        if (subsumedOriginalRowIndex !== -1) break;
                    }

                    if (subsumedOriginalRowIndex !== -1 && subsumedOriginalColIndex !== -1) {
                         const clonedSubsumedCell = clonedTable.rows[subsumedOriginalRowIndex]?.cells[subsumedOriginalColIndex];
                         if (clonedSubsumedCell && clonedSubsumedCell !== clonedPrimaryCell) { 
                            cellsToRemoveFromClonedTable.push(clonedSubsumedCell);
                         }
                    }
                });
                cellsToRemoveFromClonedTable.forEach(cell => cell.remove());
            }
        }
        
        console.log(`cloneTableForPdf: Finished cloning table ID: ${tableIdForLog}.`);
        return clonedTable;
    }

    async function saveSharedNameListToFirestore(session, namesArray) {
        if (!fbDb || !fbIsAuthReady) {
            showMessage("Firebase not ready. Cannot save shared name list.", "error");
            return;
        }
        showNameModalLoading(true);
        const uniqueSortedNames = [...new Set(namesArray.map(n => String(n||'').trim()).filter(n => n))]
                                .sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
        if (!appId || appId === 'default-shared-scheduler-app') {
            showMessage("Configuration error: App ID is missing or default. Cannot save shared name list.", "error");
            showNameModalLoading(false);
            return;
        }
        const docRef = doc(fbDb, "artifacts", appId, "public/data/sharedNameLists", session);
        try {
            await setDoc(docRef, { names: uniqueSortedNames, lastUpdatedBy: fbUserId || "anonymous", updatedAt: serverTimestamp() });
            showMessage(`Shared name list for ${session} session updated.`, "success");
        } catch (error) {
            console.error(`Error saving shared list to ${session}:`, error);
            showMessage(`Failed to save shared list to ${session}. Error: ${error.message}`, "error");
        } finally {
            showNameModalLoading(false);
        }
    }

    async function addNameToSharedSessionInFirestore(name) {
        if (!fbDb || !fbIsAuthReady) {
            showMessage("Firebase not ready. Cannot add name to shared list.", "error");
            return;
        }
        const trimmedName = String(name || '').trim();
        if (!trimmedName) {
            showMessage("Name cannot be empty.", "info");
            return;
        }
        showNameModalLoading(true);
        const sessionNames = currentNameListSession === 'pagi' ? namesPagiShared : namesPetangShared;
        if (sessionNames.map(n => String(n || '').toLowerCase()).includes(trimmedName.toLowerCase())) {
            showMessage(`Name "${trimmedName}" already exists in shared ${currentNameListSession} session.`, "info");
            showNameModalLoading(false);
            return;
        }
        if (!appId || appId === 'default-shared-scheduler-app') {
            showMessage("Configuration error: App ID is missing or default. Cannot add name.", "error");
            showNameModalLoading(false);
            return;
        }
        const updatedNames = [...sessionNames, trimmedName].sort((a, b) => String(a).localeCompare(String(b), undefined, { sensitivity: 'base' }));
        const docRef = doc(fbDb, "artifacts", appId, "public/data/sharedNameLists", currentNameListSession);
        try {
            await setDoc(docRef, { names: updatedNames, lastUpdatedBy: fbUserId || "anonymous", updatedAt: serverTimestamp() });
            if(newNameInput) {
                newNameInput.value = '';
                newNameInput.focus();
            }
        } catch (error) {
            console.error(`Error adding name to shared ${currentNameListSession}:`, error);
            showMessage(`Failed to add name to shared list. Error: ${error.message}`, "error");
        } finally {
            showNameModalLoading(false);
        }
    }

    async function deleteNameFromSharedSessionInFirestore(nameToDelete) {
        if (!fbDb || !fbIsAuthReady) {
            showMessage("Firebase not ready. Cannot delete name from shared list.", "error");
            return;
        }
        const nameToDeleteStr = String(nameToDelete || '');
        if (await customConfirm(`Delete "${nameToDeleteStr}" from shared ${currentNameListSession} session? This also removes it from all schedule tables for everyone.`)) {
            showNameModalLoading(true);
            if (!appId || appId === 'default-shared-scheduler-app') {
                showMessage("Configuration error: App ID is missing or default. Cannot delete name.", "error");
                showNameModalLoading(false);
                return;
            }
            const currentNames = currentNameListSession === 'pagi' ? namesPagiShared : namesPetangShared;
            const updatedNames = currentNames.filter(name => String(name || '') !== nameToDeleteStr);
            const docRef = doc(fbDb, "artifacts", appId, "public/data/sharedNameLists", currentNameListSession);
            try {
                await setDoc(docRef, { names: updatedNames, lastUpdatedBy: fbUserId || "anonymous", updatedAt: serverTimestamp() });
                tablesContainer.querySelectorAll('table').forEach(table => {
                    table.querySelectorAll('tbody td, tbody th, .merged-cell-overlay').forEach(cell => {
                        const cellText = cell.textContent.trim();
                        const parts = cellText.split(' // ');
                        let mainContent = parts[0];
                        const remarkContent = parts.length > 1 ? ` // ${parts.slice(1).join(' // ')}` : '';
                        const wordsInMain = mainContent.split(/\s+/);
                        const newWordsInMain = wordsInMain.filter(word => {
                            if (word.startsWith('*') && mainContent.includes(nameToDeleteStr)) {
                                return !mainContent.includes(word.substring(1)); 
                            }
                            return word !== nameToDeleteStr;
                        });
                        const newMainContent = newWordsInMain.join(' ').trim();
                        if (newMainContent || remarkContent) {
                            cell.textContent = (newMainContent + remarkContent).trim();
                        } else {
                            cell.textContent = '';
                        }
                    });
                });
                rebuildAndRenderSummary();
                if (selectedNameFromList === nameToDeleteStr) clearNameSelection();
            } catch (error) {
                console.error(`Error deleting name from shared ${currentNameListSession}:`, error);
                showMessage(`Failed to delete name from shared list. Error: ${error.message}`, "error");
            } finally {
                showNameModalLoading(false);
            }
        }
    }

    function listenToSharedNameList(sessionToListen) {
        if (!fbDb || !fbIsAuthReady) {
            console.warn(`listenToSharedNameList (${sessionToListen}): Firestore not ready.`);
            return () => {};
        }
        if (!appId || appId === 'default-shared-scheduler-app') {
            console.error(`listenToSharedNameList (${sessionToListen}): Invalid appId.`);
            return () => {};
        }
        const docRef = doc(fbDb, "artifacts", appId, "public/data/sharedNameLists", sessionToListen);
        return onSnapshot(docRef, (docSnap) => {
            showNameModalLoading(true);
            if (docSnap.exists()) {
                const data = docSnap.data();
                const namesFromDb = data.names || [];
                const sanitizedNames = namesFromDb.map(name => String(name || '').trim()).filter(name => name.length > 0);
                if (sessionToListen === 'pagi') namesPagiShared = sanitizedNames;
                else namesPetangShared = sanitizedNames;
            } else {
                if (sessionToListen === 'pagi') namesPagiShared = [];
                else namesPetangShared = [];
                 console.log(`No shared name list found for ${sessionToListen} under appId ${appId}. A new one will be created on save.`);
            }
            if (sessionToListen === currentNameListSession && nameModal && nameModal.style.display === 'flex' && searchNameInputElement) {
                renderNameListFromFirestore(searchNameInputElement.value);
            }
            rebuildAndRenderSummary(); 
            showNameModalLoading(false);
        }, (error) => {
            console.error(`Error listening to shared ${sessionToListen} names:`, error);
            showMessage(`Error fetching shared ${sessionToListen} names.`, "error");
            showNameModalLoading(false);
        });
    }

    async function attemptDirectCopyToClipboard() {
        const fullHtml = document.documentElement.outerHTML;
        try {
            await navigator.clipboard.writeText(fullHtml);
            showMessage('Full HTML copied to clipboard!', 'success');
        } catch (err) {
            console.warn('Direct copy to clipboard failed, trying fallback:', err);
            const textarea = document.createElement('textarea');
            textarea.value = fullHtml;
            textarea.style.position = 'fixed'; textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                const success = document.execCommand('copy');
                success ? showMessage('Full HTML copied! (fallback)', 'success') : showMessage('Direct copy using execCommand failed.', 'error', 5000);
            } catch (execErr) {
                console.error('execCommand copy failed:', execErr);
                showMessage('Direct copy failed completely.', 'error', 5000);
            }
            document.body.removeChild(textarea);
        }
    }

    // Initialize DOM elements and event listeners when document loads
    document.addEventListener('DOMContentLoaded', () => {
        scheduleTitleElement = document.getElementById('scheduleTitle');
        tablesContainer = document.getElementById('tablesContainer');
        tableTabs = document.getElementById('tableTabs');
        nameModal = document.getElementById('nameModal');
        nameModalContent = document.getElementById('nameModalContent');
        nameModalHeader = document.getElementById('nameModalHeader');
        nameListContainer = document.getElementById('nameList');
        newNameInput = document.getElementById('newNameInput');
        sharedScheduleListContainerElement = document.getElementById('sharedScheduleListContainer');
        summaryTableElement = document.getElementById('summaryTable');
        summaryTableContainerElement = document.getElementById('summaryTableContainer');
        customMessageBox = document.getElementById('customMessageBox');
        fileInputElement = document.getElementById('fileInput');
        directCopyFullHtmlButtonElement = document.getElementById('directCopyFullHtmlBtn');
        closeNameModalButtonStandardElement = document.getElementById('closeNameModalBtnStandard');
        nameListImportFileInputElement = document.getElementById('nameListImportFile');
        searchNameInputElement = document.getElementById('searchNameInput');
        sharedScheduleImportFileInputElement = document.getElementById('sharedScheduleImportFile');
        userIdDisplayElement = document.getElementById('userIdDisplay');
        namePagiTabElement = document.getElementById('namePagiTab');
        namePetangTabElement = document.getElementById('namePetangTab');
        loadingIndicatorModalElement = document.getElementById('loadingIndicatorModal');
        nameModalTitleElement = document.getElementById('nameModalTitle');
        generalLoadingIndicatorElement = document.getElementById('generalLoadingIndicator');
        controlsTogglerElement = document.getElementById('controlsToggler'); 
        collapsibleButtonBarsElement = document.getElementById('collapsibleButtonBars'); 
        downloadPdfButtonElement = document.getElementById('downloadPdfBtn'); 
        pdfContentElement = document.getElementById('pdfContent'); 
        
        autocompleteSuggestionsDiv = document.createElement('div');
        autocompleteSuggestionsDiv.id = 'autocompleteSuggestions';
        document.body.appendChild(autocompleteSuggestionsDiv);
        
        if (!tablesContainer || !tableTabs || !nameModal || !summaryTableElement || !scheduleTitleElement || !sharedScheduleListContainerElement || !generalLoadingIndicatorElement || !summaryTableContainerElement || !controlsTogglerElement || !collapsibleButtonBarsElement || !downloadPdfButtonElement || !pdfContentElement) { 
            console.error("CRITICAL DOM elements missing. App cannot initialize correctly.");
            document.body.innerHTML = "<p style='color:red; text-align:center; font-size:1.2em;'>Error: Application failed to initialize due to missing critical page elements. Please check the console for details.</p>";
            return;
        }

        // Initialize Firebase Auth
        if (fbAuth) {
            console.log("Firebase Auth: Setting up onAuthStateChanged listener.");
            onAuthStateChanged(fbAuth, async (user) => {
                if (user) {
                    console.log("Firebase Auth: User is authenticated. UID:", user.uid);
                    fbUserId = user.uid;
                    fbIsAuthReady = true;
                    if(userIdDisplayElement) userIdDisplayElement.textContent = `User ID: ${fbUserId}`;
                    
                    if (unsubscribePagiShared) unsubscribePagiShared();
                    if (unsubscribePetangShared) unsubscribePetangShared();
                    unsubscribePagiShared = listenToSharedNameList('pagi');
                    unsubscribePetangShared = listenToSharedNameList('petang');
                    
                    setupInitialTableState(); 
                    rebuildAndRenderSummary(); 
                } else {
                    console.log("Firebase Auth: No user is currently signed in. Attempting to sign in.");
                    fbIsAuthReady = false; fbUserId = null;
                    if(userIdDisplayElement) userIdDisplayElement.textContent = "User ID: Authenticating...";
                    
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && __initial_auth_token.trim() !== '') {
                            await signInWithCustomToken(fbAuth, __initial_auth_token);
                        } else {
                            await signInAnonymously(fbAuth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth: Error during sign-in:", error);
                        showMessage(`Firebase Auth failed. Cloud features may not work. Error: ${error.message}`, "error", 7000);
                        if(userIdDisplayElement) userIdDisplayElement.textContent = `User ID: Auth Error`;
                        setupInitialTableState(); 
                        rebuildAndRenderSummary();
                    }
                }
            });
        } else {
             if(userIdDisplayElement) userIdDisplayElement.textContent = "User ID: Firebase Auth Not Initialized";
             setupInitialTableState(); 
             rebuildAndRenderSummary();
        }

        // Initialize event listeners
        if(controlsTogglerElement) controlsTogglerElement.addEventListener('click', toggleButtonBarsVisibility); 
        if(directCopyFullHtmlButtonElement) directCopyFullHtmlButtonElement.addEventListener('click', attemptDirectCopyToClipboard);
        if(downloadPdfButtonElement) downloadPdfButtonElement.addEventListener('click', generateSchedulePdf); 
        
        // Setup initial table state
        setupInitialTableState();
        rebuildAndRenderSummary();
    });

    function setupInitialTableState() {
        console.log("Running setupInitialTableState...");
        tableTabs.innerHTML = ''; 
        
        const table1 = document.getElementById('tbl_1');
        const table2 = document.getElementById('tbl_2');
        
        if (table1) {
            addTabButton(table1.id, table1.dataset.tableName || 'Kelas 3 & 5');
        }
        if (table2) {
            addTabButton(table2.id, table2.dataset.tableName || 'Kelas 1, 2 & 4');
        }
        
        if (table1) {
            switchTable(table1.id);
        } else if (tablesContainer.querySelector('table')) {
            switchTable(tablesContainer.querySelector('table').id);
        }
    }

    function addTabButton(id, label) {
        if (!tableTabs) return null;
        const button = document.createElement('button');
        button.textContent = label; 
        button.dataset.tableId = id;
        button.title = `Switch to table: ${label}`;
        button.onclick = () => switchTable(id);
        tableTabs.appendChild(button);
        return button;
    }

    function switchTable(id) {
        activeTableId = id;
        if(tablesContainer) tablesContainer.querySelectorAll('table').forEach(t => t.classList.toggle('active', t.id === id));
        if(tableTabs) tableTabs.querySelectorAll('button').forEach(b => { b.classList.toggle('active', b.dataset.tableId === id); });
        rebuildAndRenderSummary();
    }

    function rebuildAndRenderSummary() {
        const scheduledNames = new Set(); 
        if (tablesContainer) {
            tablesContainer.querySelectorAll('table').forEach(scheduleTable => { 
                if (!scheduleTable.tBodies[0]) return; 
                scheduleTable.tBodies[0].querySelectorAll('tr').forEach(row => {
                    Array.from(row.cells).forEach((cell, cellIndex) => {
                        if (cellIndex > 0) { 
                            const overlay = cell.querySelector('.merged-cell-overlay');
                            const nameFromCell = String(overlay ? overlay.textContent : cell.textContent || '').trim();
                            const actualNameForSummary = getTextForSummary(nameFromCell); 
                            if (actualNameForSummary) { 
                                scheduledNames.add(actualNameForSummary);
                            }
                        }
                    });
                });
            });
        }
        const allSummaryNames = [...scheduledNames].sort((a, b) => String(a).localeCompare(String(b), undefined, { sensitivity: 'base' }));
        buildSummaryTableSkeleton(allSummaryNames);
        updateSummaryTableData(allSummaryNames);
    }

    function getTextForSummary(cellText) {
        if (typeof cellText !== 'string') return '';
        let textForSummary = cellText.split(' // ')[0]; 
        const words = textForSummary.split(/\s+/); 
        const filteredWords = words.filter(word => !word.startsWith('*'));
        return filteredWords.join(' ').trim(); 
    }

    function buildSummaryTableSkeleton(allAvailableNames) { 
        if (!summaryTableElement) return;
        summaryTableElement.innerHTML = ''; 
        
        let activeTableHeaders = [];
        const activeTableElement = document.getElementById(activeTableId); 
        if (activeTableElement && activeTableElement.tHead && activeTableElement.tHead.rows.length > 0) {
            for (let hIdx = 1; hIdx < activeTableElement.tHead.rows[0].cells.length; hIdx++) { 
                const headerText = String(activeTableElement.tHead.rows[0].cells[hIdx].textContent || '').trim();
                if (headerText) activeTableHeaders.push(headerText);
            }
        }

        const finalSummaryColumnHeaders = ['Nama/Masa', ...activeTableHeaders];
        const thead = summaryTableElement.createTHead();
        const headerRowForSummary = thead.insertRow();
        finalSummaryColumnHeaders.forEach(headerText => {
            const th = document.createElement('th'); 
            th.textContent = headerText;
            headerRowForSummary.appendChild(th);
        });

        const tbody = summaryTableElement.createTBody();
        if (allAvailableNames.length === 0) {
            const tr = tbody.insertRow(); 
            const td = tr.insertCell();
            td.textContent = "No names scheduled yet.";
            td.colSpan = finalSummaryColumnHeaders.length || 1;
            td.style.textAlign = 'center'; 
            td.style.fontStyle = 'italic';
        } else {
            allAvailableNames.forEach(name => {
                const tr = tbody.insertRow();
                tr.insertCell().textContent = String(name || '');
                for (let i = 1; i < finalSummaryColumnHeaders.length; i++) tr.insertCell().textContent = '';
            });
        }
    }

    function updateSummaryTableData(allAvailableNames) { 
        // Summary table update logic would go here
        // This is a simplified version - full implementation would match original
    }
</script>
</body>
</html>