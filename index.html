<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Weekly Schedule</title>
<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:28px}
  h2{margin:0 0 12px}
  table{border-collapse:collapse;width:100%;margin-top:10px;display:none}
  table.active{display:table}
  th,td{border:1px solid #999;padding:8px;text-align:center;min-width:90px}
  th{background:#f2f2f2}
  td.selected,th.selected{outline:3px solid #ffdf6a}
  .merged{font-style:italic}
  .bar{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
  .bar button{padding:8px 12px;font-size:14px;border-radius:4px;cursor:pointer;border:1px solid #666;background:#fff}
  #excelBtn{background:#2e8b57;color:#fff;border:none}
  #saveDraftBtn{background:#0b65c2;color:#fff;border:none}
  #loadDraftBtn{background:#ff8c00;color:#fff;border:none}
  #mergeBtn{background:#6a5acd;color:#fff;border:none}
  #unmergeBtn{background:#cd5c5c;color:#fff;border:none}
  #selectBtn{background:#00ced1;color:#fff;border:none}
  #selectBtn.active{background:#ff4500}
  #addTableBtn{background:#ff69b4;color:#fff;border:none}
  #renameTableBtn{background:#4682b4;color:#fff;border:none}
  #deleteTableBtn{background:#dc143c;color:#fff;border:none}
  #nameListBtn{background:#32cd32;color:#fff;border:none}
  #msg{color:#c00;margin-top:10px;display:none}
  #draftList{margin-top:10px;padding:5px;border:1px solid #ccc;max-height:150px;overflow-y:auto;display:none}
  #draftList div{padding:5px;cursor:pointer}
  #draftList div:hover{background:#f0f0f0}
  .table-tabs{display:flex;gap:6px;margin-bottom:10px}
  .table-tabs button{padding:6px 12px;background:#ddd;border:1px solid #999;border-radius:4px}
  .table-tabs button.active{background:#4caf50;color:#fff}
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:transparent;z-index:1000;pointer-events:none}
  .modal-content{pointer-events:auto;background:#fff;position:absolute;top:50px;right:50px;padding:20px;width:300px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.3)}
  .modal-header{cursor:move;padding-bottom:10px;border-bottom:1px solid #ddd}
  .name-item{display:flex;justify-content:space-between;align-items:center;padding:5px;border-bottom:1px solid #ddd}
  .name-item span{flex-grow:1;cursor:pointer}
  .name-item button{background:#ff4444;color:#fff;border:none;border-radius:3px}
  .highlighted{background:#ffff99}
</style>
</head>
<body>
<h2 contenteditable="true">Weekly Schedule</h2>

<!-- BUTTON BAR -->
<div class="bar">
  <button id="excelBtn" onclick="promptExcelExport()">üíæ Save to Excel</button>
  <input type="file" id="fileInput" style="display:none" accept=".xlsx" onchange="handleExcelFile(event)">
  <button id="saveDraftBtn" onclick="promptSaveDraft()">üí† Save Draft</button>
  <button id="loadDraftBtn" onclick="toggleDraftList()">üìÇ Load Draft</button>
  <button onclick="clearDraft()">üóëÔ∏è Clear Draft</button>
  <button id="selectBtn" onclick="toggleSelectionMode()">‚ú® Select</button>
  <button id="mergeBtn" onclick="mergeCells()">üîó Merge Cells</button>
  <button id="deselectBtn" onclick="deselectAll()">üö´ Deselect</button>
  <button id="unmergeBtn" onclick="unmergeCells()">üîó Unmerge Cells</button>
  <button id="addTableBtn" onclick="addNewTable()">‚ú® Add New Table</button>
  <button id="renameTableBtn" onclick="promptRenameTable()">üìù Rename Table</button>
  <button id="deleteTableBtn" onclick="promptDeleteTable()">‚ùå Delete Table</button>
  <button id="nameListBtn" onclick="toggleNameList()">üë• Name List</button>
</div>

<div id="draftList"></div>
<div class="bar table-tabs" id="tableTabs"></div>

<!-- INITIAL TABLE -->
<div id="tablesContainer">
  <table id="tbl_1" class="active">
    <thead><tr><th contenteditable="true"></th><th contenteditable="true"></th><th contenteditable="true"></th><th contenteditable="true"></th><th contenteditable="true"></th><th contenteditable="true"></th><th contenteditable="true"></th></tr></thead>
    <tbody>
      <tr><td contenteditable="true">5S1</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
      <tr><td contenteditable="true">5S2</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
      <tr><td contenteditable="true">5PT1</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
      <tr><td contenteditable="true">5PT2</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
      <tr><td contenteditable="true">4S1</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
    </tbody>
  </table>
</div>

<p id="msg">‚ö†Ô∏è SheetJS not found ‚Äì export disabled.</p>

<div class="bar">
  <button onclick="addRowAbove()">‚¨ÜÔ∏è Row Above</button>
  <button onclick="addRowBelow()">‚¨áÔ∏è Row Below</button>
  <button onclick="addColLeft()">‚¨ÖÔ∏è Col Left</button>
  <button onclick="addColRight()">‚û°Ô∏è Col Right</button>
</div>

<!-- NAME LIST MODAL -->
<div id="nameModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h3>Name List</h3></div>
    <div>
      <input type="text" id="newNameInput" placeholder="Add new name">
      <button onclick="addName()">Add</button>
    </div>
    <div id="nameList" style="margin-top:10px;max-height:200px;overflow-y:auto;"></div>
    <button onclick="closeNameList()" style="margin-top:10px;">Close</button>
  </div>
</div>

<script>
/* --------- GLOBALS --------- */
const DRAFTS_KEY='jadual_drafts',NAMES_KEY='jadual_names';
let activeTableId='tbl_1',tableCount=1,selectionMode=false,selectedCells=[],selectedName=null,lastFileName=null;

/* --------- DOM REFS --------- */
const tablesContainer=document.getElementById('tablesContainer');
const tableTabs=document.getElementById('tableTabs');
const nameModal=document.getElementById('nameModal');
const nameListContainer=document.getElementById('nameList');
const newNameInput=document.getElementById('newNameInput');
const selectBtn=document.getElementById('selectBtn');

/* --------- INIT --------- */
tableTabs.innerHTML = '<button class="active" onclick="switchTable(&quot;tbl_1&quot;)">Table&nbsp;1</button>';
let names=JSON.parse(localStorage.getItem(NAMES_KEY)||'[]');
if(!names.length)names=['Teacher A','Teacher B','Teacher C'];

/* --------- HELPER FUNCTIONS --------- */
function deselectAll(){selectedCells.forEach(c=>c.classList.remove('selected'));selectedCells.length=0;}

/* Collect table into array */
function tblArray(tblId){
  const t=document.getElementById(tblId);
  return[...t.rows].map(r=>[...r.cells].map(c=>{
    return{txt:c.innerText.trim(),colspan:+(c.getAttribute('colspan')||1),rowspan:+(c.getAttribute('rowspan')||1)};
  }));
}
function arrayToTable(arr,tblId){
  const t=document.getElementById(tblId);
  // clear existing tbody rows
  [...t.tBodies].forEach(tb=>tb.remove());
  const tb=t.createTBody();
  for(let r=1;r<arr.length;r++){
    const tr=tb.insertRow(-1);
    for(const cell of arr[r]){
      const td=tr.insertCell(-1);
      td.textContent=cell.txt;td.contentEditable='true';
      if(cell.colspan>1)td.setAttribute('colspan',cell.colspan);
      if(cell.rowspan>1)td.setAttribute('rowspan',cell.rowspan);
      if(cell.colspan>1||cell.rowspan>1)td.classList.add('merged');
    }
  }
  // restore header row
  const header=arr[0];
  const theadRow=t.tHead.rows[0];
  for(let i=0;i<header.length;i++){
    theadRow.cells[i].innerText=header[i].txt;
  }
}

/* --------- TABLE OPS --------- */
function switchTable(id){
  activeTableId=id;
  document.querySelectorAll('#tablesContainer table').forEach(t=>t.classList.toggle('active',t.id===id));
  document.querySelectorAll('.table-tabs button').forEach(b=>{
    b.classList.toggle('active',b.getAttribute('onclick').includes(id));
  });
  deselectAll();
}

function addNewTable(){
  tableCount++;
  const id='tbl_'+tableCount;
  const label=prompt('Table name:','Table '+tableCount);
  if(!label||!label.trim()){tableCount--;return;}
  const tbl=document.createElement('table');tbl.id=id;
  tbl.innerHTML='<thead><tr>'+ '<th contenteditable="true"></th>'.repeat(7) +'</tr></thead>'+
                '<tbody>'+Array(4).fill('<tr>'+ '<td contenteditable="true"></td>'.repeat(7) +'</tr>').join('')+'</tbody>';
  tablesContainer.appendChild(tbl);
  tableTabs.insertAdjacentHTML('beforeend',`<button onclick="switchTable(&quot;${id}&quot;)">${label.trim()}</button>`);
  switchTable(id);
}

function promptRenameTable(){
  const btn=tableTabs.querySelector('.active');
  const n=prompt('New name:',btn.textContent);
  if(n&&n.trim())btn.textContent=n.trim();
}
function promptDeleteTable(){
  if(document.querySelectorAll('#tablesContainer table').length<=1){alert('Cannot delete last table');return;}
  if(!confirm('Delete current table?'))return;
  const btn=tableTabs.querySelector('.active');
  document.getElementById(activeTableId).remove();btn.remove();
  switchTable(document.querySelector('.table-tabs button').getAttribute('onclick').match(/&quot;(.*?)&quot;/)[1]);
}
function addRowAbove(){
  const t=document.getElementById(activeTableId);
  const r=t.insertRow(1);
  for(let i=0;i<t.rows[0].cells.length;i++){const c=r.insertCell(-1);c.contentEditable='true';}
}
function addRowBelow(){
  const t=document.getElementById(activeTableId);
  const r=t.insertRow(-1);
  for(let i=0;i<t.rows[0].cells.length;i++){const c=r.insertCell(-1);c.contentEditable='true';}
}
function addColLeft(){
  const t=document.getElementById(activeTableId);
  const idx=1;
  for(const r of t.rows){
    const c=r.insertCell(idx);
    r.rowIndex?c.contentEditable='true':c.outerHTML='<th contenteditable="true"></th>';
  }
}
function addColRight(){
  const t=document.getElementById(activeTableId);
  for(const r of t.rows){
    const c=r.insertCell(-1);
    r.rowIndex?c.contentEditable='true':c.outerHTML='<th contenteditable="true"></th>';
  }
}

/* --------- SELECTION / MERGE --------- */
function toggleSelectionMode(){
  selectionMode=!selectionMode;
  selectBtn.classList.toggle('active',selectionMode);
  selectBtn.textContent=selectionMode?'‚ú® Selecting...':'‚ú® Select';
  if(!selectionMode)deselectAll();
}

tablesContainer.addEventListener('click',e=>{
  if(e.target.tagName!=='TD'&&e.target.tagName!=='TH')return;
  const cell=e.target;
  if(selectedName!==null){
    if(cell.tagName==='TD'&&cell.isContentEditable){
      cell.innerText=selectedName;
      nameListContainer.querySelector('.highlighted')?.classList.remove('highlighted');
      selectedName=null;
    }else alert('Tap an editable cell');
    return;
  }
  if(selectionMode){
    cell.classList.toggle('selected');
    if(cell.classList.contains('selected'))selectedCells.push(cell);
    else selectedCells=selectedCells.filter(c=>c!==cell);
  }
});

function mergeCells(){
  if(selectedCells.length<2){alert('Select >=2 cells');return;}
  /* bounding box */
  const rows=selectedCells.map(c=>c.parentNode.rowIndex);
  const cols=selectedCells.map(c=>c.cellIndex);
  const minR=Math.min(...rows),maxR=Math.max(...rows);
  const minC=Math.min(...cols),maxC=Math.max(...cols);
  const rowspan=maxR-minR+1,colspan=maxC-minC+1;
  const table=document.getElementById(activeTableId);
  const topLeft=table.rows[minR].cells[minC];
  const content=topLeft.innerText;
  /* remove other cells in box */
  for(let r=minR;r<=maxR;r++){
    for(let c=minC;c<=maxC;c++){
      const cell=table.rows[r].cells[c];
      if(cell!==topLeft)cell.remove();
    }
  }
  topLeft.setAttribute('rowspan',rowspan);
  topLeft.setAttribute('colspan',colspan);
  topLeft.classList.add('merged');
  topLeft.innerText=content;
  toggleSelectionMode();deselectAll();
}
function unmergeCells(){
  const merged=[...document.getElementById(activeTableId).querySelectorAll('.merged')];
  if(!merged.length){alert('No merged cells');return;}
  merged.forEach(cell=>{
    const rs=+cell.getAttribute('rowspan')||1,cs=+cell.getAttribute('colspan')||1;
    cell.removeAttribute('rowspan');cell.removeAttribute('colspan');cell.classList.remove('merged');
    const r0=cell.parentNode.rowIndex,c0=cell.cellIndex,table=document.getElementById(activeTableId);
    for(let r=0;r<rs;r++){
      for(let c=0;c<cs;c++){
        if(r===0&&c===0)continue;
        const newC=table.rows[r0+r].insertCell(c0+c);
        newC.contentEditable='true';newC.textContent='';
      }
    }
  });
}

/* --------- NAME LIST --------- */
function toggleNameList(){nameModal.style.display=nameModal.style.display==='block'?'none':'block';updateNameList();}
function closeNameList(){nameModal.style.display='none';}
function updateNameList(){
  nameListContainer.innerHTML='';
  names.forEach(n=>{
    const div=document.createElement('div');div.className='name-item';
    div.innerHTML=`<span data-name="${n}" onclick="selectName('${n}')">${n}</span><button onclick="deleteName('${n}')">Delete</button>`;
    nameListContainer.appendChild(div);
  });
}
function addName(){
  const n=newNameInput.value.trim();if(!n)return;
  if(names.includes(n)){alert('Exists');return;}
  names.push(n);
  localStorage.setItem(NAMES_KEY,JSON.stringify(names));
  newNameInput.value='';updateNameList();
}
function deleteName(n){
  names=names.filter(x=>x!==n);
  localStorage.setItem(NAMES_KEY,JSON.stringify(names));
  updateNameList();
}
function selectName(n){
  nameListContainer.querySelector('.highlighted')?.classList.remove('highlighted');
  nameListContainer.querySelector(`span[data-name="${n}"]`).classList.add('highlighted');
  selectedName=n;
}

/* --------- DRAFTS --------- */
function getDrafts(){return JSON.parse(localStorage.getItem(DRAFTS_KEY)||'{}');}
function saveDraft(title){
  const drafts=getDrafts();
  const allTables={};
  document.querySelectorAll('#tablesContainer table').forEach(t=>{allTables[t.id]=tblArray(t.id);});
  drafts[title]=allTables;
  localStorage.setItem(DRAFTS_KEY,JSON.stringify(drafts));
  alert('Draft saved!');
  updateDraftList();
}
function promptSaveDraft(){
  const t=prompt('Draft title:');
  if(t&&t.trim())saveDraft(t.trim());
}
function loadDraft(title){
  const drafts=getDrafts();const data=drafts[title];if(!data)return;
  Object.keys(data).forEach(id=>{
    if(!document.getElementById(id)){addNewTable();document.getElementById(activeTableId).id=id;}
    arrayToTable(data[id],id);
  });
  alert('Draft loaded');
  toggleDraftList();
}
function updateDraftList(){
  const d=document.getElementById('draftList');
  const drafts=getDrafts();d.innerHTML='';
  Object.keys(drafts).forEach(k=>{
    const div=document.createElement('div');div.textContent=k;div.onclick=()=>loadDraft(k);
    d.appendChild(div);
  });
}
function toggleDraftList(){
  const d=document.getElementById('draftList');
  d.style.display=d.style.display==='block'?'none':'block';
  if(d.style.display==='block')updateDraftList();
}
function clearDraft(){if(confirm('Clear local drafts?')){localStorage.removeItem(DRAFTS_KEY);updateDraftList();}}

/* --------- EXCEL EXPORT (SheetJS) --------- */
function promptExcelExport(){
  const nm=prompt('Sheet title (<=31 chars):','Schedule');
  if(!nm||!nm.trim())return;
  exportExcel(nm.trim().slice(0,31));
}
function handleExcelFile(e){/* optional load... not used */}

/* Build workbook from DOM */
function exportExcel(sheetName){
  if(typeof XLSX==='undefined'){document.getElementById('msg').style.display='block';return;}
  const wb=XLSX.utils.book_new();
  const allTables=[...tablesContainer.querySelectorAll('table')];

  let aoa=[];let merges=[];let rowPtr=0;
  allTables.forEach((tbl,idx)=>{
    if(idx>0){aoa.push([]);rowPtr++;}
    const arr=tblArray(tbl.id);
    // copy header row
    aoa.push(arr[0].map(c=>c.txt));merges.push({s:{r:rowPtr,c:0},e:{r:rowPtr,c:arr[0].length-1}});rowPtr++;
    // body
    for(let r=1;r<arr.length;r++){
      aoa.push(arr[r].map(c=>c.txt));rowPtr++;
    }
  });
  const ws=XLSX.utils.aoa_to_sheet(aoa);
  ws['!merges']=merges;
  XLSX.utils.book_append_sheet(wb,ws,sheetName);
  XLSX.writeFile(wb,sheetName.replace(/[^a-z0-9]/gi,'_')+'_'+new Date().toISOString().slice(0,10)+'.xlsx');
}

/* --------- DRAGGABLE MODAL --------- */
const modalContent=document.querySelector('.modal-content');
const modalHeader=document.querySelector('.modal-header');
let drag=false,ix=0,iy=0,cx=50,cy=50;
modalContent.style.left=cx+'px';modalContent.style.top=cy+'px';
modalHeader.addEventListener('mousedown',e=>{drag=true;ix=e.clientX-cx;iy=e.clientY-cy;e.preventDefault();});
modalHeader.addEventListener('touchstart',e=>{drag=true;ix=e.touches[0].clientX-cx;iy=e.touches[0].clientY-cy;});
document.addEventListener('mousemove',e=>{if(!drag)return;cx=e.clientX-ix;cy=e.clientY-iy;modalContent.style.left=cx+'px';modalContent.style.top=cy+'px';});
document.addEventListener('touchmove',e=>{if(!drag)return;cx=e.touches[0].clientX-ix;cy=e.touches[0].clientY-iy;modalContent.style.left=cx+'px';modalContent.style.top=cy+'px';e.preventDefault();},{passive:false});
document.addEventListener('mouseup',()=>drag=false);
document.addEventListener('touchend',()=>drag=false);

/* --------- INITIAL CALL --------- */
updateNameList();
</script>
</body>
</html>
