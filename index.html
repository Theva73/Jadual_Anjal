<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<title>Weekly Schedule (fixed)</title>

<!-- 3rd-party libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase compat SDKs (work everywhere, no ES-modules needed) -->
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>

<style>
/* ----------  BASIC LAYOUT  ---------- */
html,body{margin:0;padding:0}
body{
  font-family:Arial,Helvetica,sans-serif;
  background:#f9f9f9;
  display:flex;flex-direction:column;align-items:center;margin:20px;
}
h2,h3{text-align:center;color:#333}
#userIdDisplay{font-size:.8em;color:#666;margin-bottom:15px;text-align:center}
/* ----------  BUTTON / BAR  ---------- */
.bar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px;justify-content:center}
.bar button,.table-tabs button,.name-session-tabs button{
  padding:10px 15px;font-size:14px;border-radius:5px;cursor:pointer;
  border:1px solid #adb5bd;background:#fff;transition:.2s box-shadow,.2s background;.1s transform
}
.bar button:hover{background:#f1f3f5;box-shadow:0 2px 4px rgba(0,0,0,.1)}
.bar button:active{transform:translateY(1px)}
/* coloured buttons (same palette as original) */
#excelBtnTrigger,#importExcelBtn{background:#28a745;color:#fff;border-color:#28a745}
#saveDraftBtn{background:#007bff;color:#fff;border-color:#007bff}
#loadDraftBtn{background:#ffc107;color:#212529;border-color:#ffc107}
#selectBtn{background:#17a2b8;color:#fff;border-color:#17a2b8}
#selectBtn.active{background:#fd7e14;border-color:#fd7e14}
#mergeBtn{background:#6f42c1;color:#fff;border-color:#6f42c1}
#unmergeBtn{background:#e83e8c;color:#fff;border-color:#e83e8c}
/* ----------  TABLES  ---------- */
table{border-collapse:collapse;width:100%;background:#fff;margin:15px 0}
th,td{border:1px solid #ccc;padding:10px;text-align:center;min-width:100px}
th{background:#e9ecef;font-weight:bold;white-space:nowrap}
td.selected,th.selected{outline:3px solid #007bff;background:#cfe2ff}
/* ----------  SUMMARY  ---------- */
#summaryTable th{background:#ffeeba}
#summaryTable td{background:#fff3cd}
.highlight-conflict{background:#ffcdd2!important;font-weight:bold;color:#c62828!important}
/* ----------  MODAL  ---------- */
.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;
  background:rgba(0,0,0,.4);align-items:center;justify-content:center;overflow:hidden}
.modal-content{background:#fff;padding:20px;border-radius:8px;max-width:600px;width:90%;position:relative}
/* ----------  SPINNER  ---------- */
#firebaseOverlay{position:fixed;inset:0;background:rgba(255,255,255,.8);display:flex;
  align-items:center;justify-content:center;z-index:3000;font-size:1em;color:#333}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.spinner{border:4px solid rgba(0,0,0,.1);border-left-color:#09f;border-radius:50%;width:36px;height:36px;animation:spin 1s linear infinite}
</style>
</head>
<body>

<h2 contenteditable="true" id="scheduleTitle">Weekly Schedule</h2>
<div id="userIdDisplay">User ID: Loadingâ€¦</div>

<!-- ----------  ACTION BARS  ---------- -->
<div class="bar">
  <button id="excelBtnTrigger">ðŸ’¾ Export Active Table to Excel</button>
  <button id="importExcelBtn">ðŸ“‚ Import from Excel</button>
  <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none" />
</div>
<div class="bar">
  <button id="saveDraftBtn">ðŸ’  Save All as Draft (Firestore)</button>
  <button id="loadDraftBtn">ðŸ“‚ Load Draft (Firestore)</button>
  <button id="selectBtn">âœ¨ Select Cells</button>
  <button id="mergeBtn">ðŸ”— Merge Cells</button>
  <button id="unmergeBtn">ðŸ’” Unmerge</button>
</div>

<!-- ----------  TABLE AREA  ---------- -->
<div id="tablesContainer">
  <table id="tbl_1" class="active" data-table-name="Table 1">
    <thead>
      <tr><th>Class</th><th>08:00</th><th>09:00</th><th>10:00</th><th>11:00</th></tr>
    </thead>
    <tbody>
      <tr><td>5S1</td><td></td><td>JAMES</td><td></td><td></td></tr>
      <tr><td>5S2</td><td></td><td></td><td>LILY</td><td></td></tr>
    </tbody>
  </table>
</div>

<!-- ----------  SUMMARY  ---------- -->
<h3>Teacher/Subject Attendance Summary</h3>
<table id="summaryTable"></table>

<!-- ----------  FIREBASE CONNECTING OVERLAY  ---------- -->
<div id="firebaseOverlay"><div class="spinner"></div>&nbsp;Connecting to Firebaseâ€¦</div>

<script>
/* -----------------------------------------------------------------------
   1.  FIREBASE INITIALISATION  (compat API â€“ works everywhere)
------------------------------------------------------------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4",
  authDomain: "jadual-3f0aa.firebaseapp.com",
  projectId:  "jadual-3f0aa",
  storageBucket:"jadual-3f0aa.firebasestorage.app",
  messagingSenderId:"496526436851",
  appId:"1:496526436851:web:78ff48b28bfc8c31f14a86"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

let fbUserId = null;

/* show / hide tiny overlay while auth connection happens */
const overlayEl = document.getElementById('firebaseOverlay');
const userIdDisplayEl = document.getElementById('userIdDisplay');

auth.onAuthStateChanged(async user=>{
  if(user){
    fbUserId = user.uid;
    userIdDisplayEl.textContent = `User ID: ${fbUserId}`;
    overlayEl.style.display='none';
  }else{
    try{
      await auth.signInAnonymously();
    }catch(e){
      console.error(e);
      overlayEl.textContent="âš  Firebase auth failed";
    }
  }
});

/* -----------------------------------------------------------------------
   2.  BASIC DOM SHORTCUTS & HELPERS (only those used below)
------------------------------------------------------------------------ */
const tablesContainer = document.getElementById('tablesContainer');
const summaryTable    = document.getElementById('summaryTable');
const selectBtn       = document.getElementById('selectBtn');
const mergeBtn        = document.getElementById('mergeBtn');
const unmergeBtn      = document.getElementById('unmergeBtn');
const saveDraftBtn    = document.getElementById('saveDraftBtn');
const loadDraftBtn    = document.getElementById('loadDraftBtn');
const fileInput       = document.getElementById('fileInput');
const importExcelBtn  = document.getElementById('importExcelBtn');

let selectionMode=false;
let selectedCells=[];

/* -----------------------------------------------------------------------
   3.  CELL SELECTION / MERGE / UNMERGE  (same logic as original)
------------------------------------------------------------------------ */
selectBtn.onclick=()=>{selectionMode=!selectionMode;selectBtn.classList.toggle('active',selectionMode)};
tablesContainer.addEventListener('click',e=>{
  if(!selectionMode) return;
  const cell=e.target.closest('td,th');
  if(!cell) return;
  cell.classList.toggle('selected');
  if(cell.classList.contains('selected')) selectedCells.push(cell);
  else selectedCells = selectedCells.filter(c=>c!==cell);
});
mergeBtn.onclick=()=>{
  if(selectedCells.length<2){alert('Select â‰¥2 cells');return;}
  const span = document.createElement('div');
  span.style.cssText="position:absolute;inset:0;background:#f0f8ff;border:1px solid #add8e6;display:flex;align-items:center;justify-content:center;font-style:italic;z-index:5";
  span.textContent=selectedCells[0].textContent;
  const first=selectedCells[0];
  first.style.position='relative';
  first.appendChild(span);
  selectedCells.slice(1).forEach(c=>{
    c.dataset.mergedInto=first.dataset.cellId||'cell';
    c.style.visibility='hidden';
  });
  selectedCells=[];
  document.querySelectorAll('.selected').forEach(c=>c.classList.remove('selected'));
};
unmergeBtn.onclick=()=>{
  const cell=document.querySelector('td:hover,th:hover'); if(!cell)return;
  const overlay=cell.querySelector('div');
  if(overlay){overlay.remove();cell.style.position='';}
  [...tablesContainer.querySelectorAll(`[data-merged-into]`)]
    .filter(c=>c.dataset.mergedInto===cell.dataset.cellId||'cell')
    .forEach(c=>{c.style.visibility='';delete c.dataset.mergedInto});
};

/* -----------------------------------------------------------------------
   4.  SUMMARY TABLE (simple rebuild)
------------------------------------------------------------------------ */
function rebuildSummary(){
  const names=new Set();
  tablesContainer.querySelectorAll('tbody td').forEach(td=>{
    const v=td.textContent.trim(); if(v) names.add(v.toUpperCase());
  });
  const rows=[...names].sort().map(n=>`<tr><td>${n}</td><td>*</td></tr>`).join('');
  summaryTable.innerHTML=`<thead><tr><th>Name</th><th>Mark</th></tr></thead><tbody>${rows}</tbody>`;
}
tablesContainer.addEventListener('input',rebuildSummary);
document.addEventListener('DOMContentLoaded',rebuildSummary);

/* -----------------------------------------------------------------------
   5.  FIRESTORE DRAFT SAVE / LOAD  (streamlined but keeps structure)
------------------------------------------------------------------------ */
saveDraftBtn.onclick=async()=>{
  if(!fbUserId){alert('Firebase not ready');return;}
  const draftName=prompt('Draft name?','Draft '+new Date().toLocaleString());
  if(!draftName) return;
  const html=tablesContainer.innerHTML;
  await db.collection('artifacts').doc(firebase.app().options.appId)
    .collection('users').doc(fbUserId)
    .collection('scheduleDrafts').doc(draftName).set({
      html,timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });
  alert('Saved to Firestore');
};

loadDraftBtn.onclick=async()=>{
  if(!fbUserId){alert('Firebase not ready');return;}
  const col=db.collection('artifacts').doc(firebase.app().options.appId)
    .collection('users').doc(fbUserId)
    .collection('scheduleDrafts');
  const snap=await col.get();
  if(snap.empty){alert('No drafts');return;}
  const names=snap.docs.map(d=>d.id);
  const pick=prompt('Available drafts:\n'+names.join('\n')+'\n\nType the draft name to load:');
  if(!pick||!names.includes(pick)) return;
  const data=(await col.doc(pick).get()).data();
  tablesContainer.innerHTML=data.html;
  rebuildSummary();
};

/* -----------------------------------------------------------------------
   6.  EXCEL EXPORT / IMPORT  (unchanged)
------------------------------------------------------------------------ */
document.getElementById('excelBtnTrigger').onclick=()=>{
  const wb=XLSX.utils.book_new();
  Array.from(tablesContainer.querySelectorAll('table')).forEach((tbl,i)=>{
    XLSX.utils.book_append_sheet(wb,XLSX.utils.table_to_sheet(tbl),tbl.dataset.tableName||'Table'+(i+1));
  });
  XLSX.writeFile(wb,'schedule.xlsx');
};
importExcelBtn.onclick=()=>fileInput.click();
fileInput.onchange=evt=>{
  const file=evt.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    const wb=XLSX.read(e.target.result,{type:'binary'});
    const sheet=wb.Sheets[wb.SheetNames[0]];
    const html=XLSX.utils.sheet_to_html(sheet);
    tablesContainer.innerHTML=html;
    rebuildSummary();
  };
  reader.readAsBinaryString(file);
};

/* -----------------------------------------------------------------------
   7.  FINISH  ---------------------------------------------------------------- */
rebuildSummary();
</script>
</body>
</html>