<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Weekly Schedule with Firestore Names & Drafts</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            [span_0](start_span)margin: 20px;[span_0](end_span)
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            [span_1](start_span)align-items: center;[span_1](end_span)
        }
        .main-container {
            width: 100%;
            [span_2](start_span)max-width: 1200px;[span_2](end_span)
            background-color: #fff;
            [span_3](start_span)padding: 20px;[span_3](end_span)
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h2, h3 {
            color: #333;
            [span_4](start_span)text-align: center;[span_4](end_span)
        }
        #userIdDisplay {
            text-align: center;
            [span_5](start_span)font-size: 0.8em;[span_5](end_span)
            color: #666;
            margin-bottom: 15px;
        }
        table {
            border-collapse: collapse;
            [span_6](start_span)width: 100%;[span_6](end_span)
            margin-top: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background-color: #fff;
            table-layout: auto;
        }
        #tablesContainer {
            overflow-x: auto;
            [span_7](start_span)position: relative;[span_7](end_span)
        }
        #tablesContainer > table {
            display: none;
        }
        #tablesContainer > table.active {
            display: table;
        }
        #summaryTable {
            display: table;
            [span_8](start_span)margin-top: 20px;[span_8](end_span)
        }
        th, td {
            border: 1px solid #ccc;
            [span_9](start_span)padding: 10px;[span_9](end_span)
            text-align: center;
            min-width: 100px;
        }
        table th {
            background-color: #e9ecef;
            [span_10](start_span)color: #495057;[span_10](end_span)
            font-weight: bold;
            white-space: nowrap;
        }
        td.selected, th.selected {
            outline: 3px solid #007bff;
            [span_11](start_span)background-color: #cfe2ff;[span_11](end_span)
        }
        .bar {
            display: flex;
            [span_12](start_span)flex-wrap: wrap;[span_12](end_span)
            gap: 8px;
            margin-bottom: 15px;
            align-items: center;
            justify-content: center;
        }
        .bar button, .table-tabs button, .name-session-tabs button {
            padding: 10px 15px;
            [span_13](start_span)font-size: 14px;[span_13](end_span)
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #adb5bd;
            background-color: #fff;
            [span_14](start_span)transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;[span_14](end_span)
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: inline-flex;
            align-items: center;
            [span_15](start_span)gap: 5px;[span_15](end_span)
        }
        .bar button:hover, .table-tabs button:hover, .name-session-tabs button:hover {
            background-color: #f1f3f5;
            [span_16](start_span)box-shadow: 0 2px 4px rgba(0,0,0,0.1);[span_16](end_span)
        }
        .bar button:active, .table-tabs button:active, .name-session-tabs button:active {
            transform: translateY(1px);
            [span_17](start_span)box-shadow: 0 1px 1px rgba(0,0,0,0.1);[span_17](end_span)
        }

        #rowColManipulationBar button {
            background-image: linear-gradient(to bottom, #fdfbfb 0%, #ebedee 100%);
            [span_18](start_span)border: 1px solid #ced4da;[span_18](end_span)
            color: #343a40;
            box-shadow: 0 2px 3px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.2);
            padding: 8px 12px;
        }
        #rowColManipulationBar button:hover {
            background-image: linear-gradient(to bottom, #e2e6ea 0%, #d4d9df 100%);
            [span_19](start_span)border-color: #b8c0c6;[span_19](end_span)
            box-shadow: 0 2px 5px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.1);
        }
         #rowColManipulationBar button.delete-btn {
            background-image: linear-gradient(to bottom, #f8d7da 0%, #f1c6cb 100%);
            [span_20](start_span)border-color: #f5c6cb;[span_20](end_span)
            color: #721c24;
        }
        #rowColManipulationBar button.delete-btn:hover {
            background-image: linear-gradient(to bottom, #f5c6cb 0%, #ebaeb3 100%);
            [span_21](start_span)border-color: #f1b0b7;[span_21](end_span)
        }
        #directCopyFullHtmlBtn { background-color: #545b62; color: white; border-color: #545b62;
        }
        #excelBtnTrigger, #importExcelBtn { background-color: #28a745; color: white;
        [span_22](start_span)border-color: #28a745;}[span_22](end_span)
        #saveDraftBtn { background-color: #007bff; color: white;
        [span_23](start_span)border-color: #007bff;}[span_23](end_span)
        #loadDraftBtn { background-color: #ffc107; color: #212529;
        [span_24](start_span)border-color: #ffc107;}[span_24](end_span)
        #clearActiveTableContentBtn { background-color: #fd7e14; color: white;
        [span_25](start_span)border-color: #fd7e14;}[span_25](end_span)
        #selectBtn { background-color: #17a2b8; color: white;
        [span_26](start_span)border-color: #17a2b8;}[span_26](end_span)
        #selectBtn.active { background-color: #fd7e14;
        [span_27](start_span)border-color: #fd7e14;}[span_27](end_span)
        #mergeBtn { background-color: #6f42c1; color: white;
        [span_28](start_span)border-color: #6f42c1;}[span_28](end_span)
        #unmergeBtn { background-color: #e83e8c; color: white;
        [span_29](start_span)border-color: #e83e8c;}[span_29](end_span)
        #addTableBtn { background-color: #20c997; color: white;
        [span_30](start_span)border-color: #20c997;}[span_30](end_span)
        #renameTableBtn { background-color: #6c757d; color: white;
        [span_31](start_span)border-color: #6c757d;}[span_31](end_span)
        #deleteTableBtn { background-color: #dc3545; color: white;
        [span_32](start_span)border-color: #dc3545;}[span_32](end_span)
        #nameListBtn { background-color: #fd7e14; color: white;
        [span_33](start_span)border-color: #fd7e14;}[span_33](end_span)
        #deselectBtn { background-color: #6c757d; color: white;
        [span_34](start_span)border-color: #6c757d;}[span_34](end_span)
        #exportDraftsBtn { background-color: #4e54c8; color: white;
        [span_35](start_span)border-color: #4e54c8;}[span_35](end_span)
        #importDraftsBtn { background-color: #8f94fb; color: white;
        [span_36](start_span)border-color: #8f94fb;}[span_36](end_span)

        .table-tabs { margin-bottom: 10px;
        }
        .table-tabs button { background-color: #f8f9fa; border-bottom-left-radius: 0; border-bottom-right-radius: 0;
        }
        .table-tabs button.active { background-color: #007bff; color: white; border-color: #007bff;
        }
        
        .name-session-tabs { margin-bottom: 15px;
        border-bottom: 2px solid #dee2e6; padding-bottom: 5px; [span_37](start_span)}
        .name-session-tabs button {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;[span_37](end_span)
            border-bottom: none;
            margin-bottom: -2px; /* Overlap with parent border */
            padding: 8px 12px;
            [span_38](start_span)font-size: 0.95em;[span_38](end_span)
        }
        .name-session-tabs button.active {
            background-color: #007bff;
            [span_39](start_span)color: white;[span_39](end_span)
            border-color: #007bff #007bff #fff; /* Bottom border transparent to merge */
            font-weight: bold;
        }


        #summaryTable th { background-color: #ffeeba;
        }
        #summaryTable td { background-color: #fff3cd;
        }
        .highlight-conflict { background-color: #ffcdd2 !important; font-weight: bold; color: #c62828 !important;
        }

        .modal {
            display: none;
            [span_40](start_span)position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;[span_40](end_span)
            overflow: hidden; background-color: rgba(0,0,0,0.4); align-items: center; justify-content: center;
            [span_41](start_span)pointer-events: none;[span_41](end_span)
        }
        .modal-content {
            background-color: #fff;
            [span_42](start_span)padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px;[span_42](end_span)
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative;
            [span_43](start_span)pointer-events: auto;[span_43](end_span)
        }
        .modal-content.dragging { transform: none;
        }
        .modal-header {
            padding-bottom: 10px;
            [span_44](start_span)border-bottom: 1px solid #eee; margin-bottom: 15px;[span_44](end_span)
            font-size: 1.2em; color: #333; display: flex; justify-content: space-between; align-items: center;
            cursor: move; user-select: none;
        }
        .modal-close-btn {
            font-size: 1.5rem;
            [span_45](start_span)font-weight: bold; line-height: 1; color: #000;[span_45](end_span)
            text-shadow: 0 1px 0 #fff; opacity: .5; background: transparent; border: 0; cursor: pointer;
        }
        .modal-close-btn:hover { opacity: .75;
        }
        .name-item, .draft-item-firestore { /* Combined for similar styling */
            display: flex;
            [span_46](start_span)justify-content: space-between; align-items: center;[span_46](end_span)
            padding: 8px 5px; border-bottom: 1px solid #eee; break-inside: avoid-column; page-break-inside: avoid;
        }
        .name-item:last-child, .draft-item-firestore:last-child { border-bottom: none;
        }
        .name-item span, .draft-item-firestore span { flex-grow: 1; cursor: pointer; color: #007bff;
        }
        .name-item span:hover, .draft-item-firestore span:hover { text-decoration: underline;
        }
        .name-item button, .draft-item-firestore button { background-color: #dc3545; color: white; border: none;
        border-radius: 4px; padding: 5px 10px; font-size: 0.9em; [span_47](start_span)}
        
        .highlighted { background-color: #cfe2ff !important;
        font-weight: bold; }[span_47](end_span)
        
        #draftListContainer { /* Changed ID from draftList to avoid confusion with localStorage one if it were still there */
             border: 1px solid #ddd;
             [span_48](start_span)padding: 10px; margin-bottom: 15px; border-radius: 5px;[span_48](end_span)
             background-color: #fff; max-height: 300px; overflow-y: auto;
        }
        #newNameInput, #searchNameInput {
            padding: 8px;
            [span_49](start_span)margin-right: 5px; border: 1px solid #ccc; border-radius: 4px; flex-grow: 1;[span_49](end_span)
            width: calc(100% - 100px);
        }
         #searchNameInput { margin-bottom: 10px; width: 100%; box-sizing: border-box;
         }
        .input-group { display: flex; margin-bottom: 10px;
        }
        .input-group button, #importNameListBtn {
            background-color: #28a745;
            [span_50](start_span)color: white; border-color: #28a745; padding: 8px 12px;[span_50](end_span)
            font-size: 1em; border-radius: 4px; cursor: pointer; flex-shrink: 0;
        }
        #importNameListBtn { margin-top: 10px; width: 100%;
        }
        #nameList { margin-top:10px; max-height:250px; overflow-y:auto; column-count: 2; column-gap: 20px;
        }
        .custom-message-box {
            display: none;
            [span_51](start_span)position: fixed; top: 20px; left: 50%; transform: translateX(-50%);[span_51](end_span)
            background-color: #333; color: white; padding: 15px 25px; border-radius: 5px;
            z-index: 2000;
            [span_52](start_span)box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 1em;[span_52](end_span)
        }
        .custom-message-box.success { background-color: #28a745;
        }
        .custom-message-box.error { background-color: #dc3545;
        }
        .custom-message-box.info { background-color: #007bff;
        }
        .merged-cell-container { position: relative; z-index: 2; vertical-align: top;
        }
        .merged-cell-overlay {
            position: absolute;
            [span_53](start_span)top: 0; left: 0; width: var(--merged-width); height: var(--merged-height);[span_53](end_span)
            background-color: #f0f8ff; font-style: italic; border: 1px solid #add8e6;
            display: flex; align-items: center;
            [span_54](start_span)justify-content: center; overflow: hidden;[span_54](end_span)
            box-sizing: border-box; z-index: 5;
        }
        .subsumed-cell { visibility: hidden;
        }
        #loadingIndicatorModal, #loadingIndicatorDraftList { /* Added draft list loader */
            position: absolute;
            [span_55](start_span)top: 0; left: 0; width: 100%; height: 100%;[span_55](end_span)
            background-color: rgba(255, 255, 255, 0.8);
            display: flex; align-items: center; justify-content: center;
            [span_56](start_span)z-index: 10;[span_56](end_span)
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            [span_57](start_span)width: 36px; height: 36px;[span_57](end_span)
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg);
            }
            100% { transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
<div class="main-container">
    <h2 contenteditable="true" id="scheduleTitle">Weekly Schedule</h2>
    <div id="userIdDisplay">User ID: Loading...</div>

    <div class="bar">
        <button id="directCopyFullHtmlBtn" title="Copy the entire page's HTML to clipboard">üìã Copy Full HTML (Direct)</button>
    </div>
    <div class="bar">
        <button id="excelBtnTrigger" title="Export the currently active table to an Excel file">üíæ Export Active Table to Excel</button>
        [span_58](start_span)<button id="importExcelBtn" title="Import data from an Excel file into a new table">üìÇ Import from Excel</button>[span_58](end_span)
        <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none">
    </div>
    <div class="bar">
        <button id="saveDraftBtn" title="Save all current tables and their state as a named draft to Firestore">üí† Save All as Draft (Firestore)</button>
        <button id="loadDraftBtn" title="Show list of saved drafts from Firestore to load">üìÇ Load Draft (Firestore)</button>
        <button id="exportDraftsBtn" title="Export all saved drafts from Firestore to a JSON file">üì§ Export All Drafts (Firestore)</button>
 
        [span_59](start_span)<button id="importDraftsBtn" title="Import drafts from a JSON file to Firestore">üì• Import Drafts File (Firestore)</button>[span_59](end_span)
        <input type="file" id="draftImportFile" accept=".json" style="display:none;">
        <button id="clearActiveTableContentBtn" title="Clear all data from the cells of the active table">üßπ Clear Active Table</button>
    </div>
    <div class="bar">
        <button id="selectBtn" title="Toggle cell selection mode on/off">‚ú® Select Cells</button>
        <button id="mergeBtn" title="Merge the currently selected cells">üîó Merge Cells</button>
     
        [span_60](start_span)<button id="deselectBtn" title="Clear current cell selection">üö´ Deselect All</button>[span_60](end_span)
        <button id="unmergeBtn" title="Unmerge the cell that was last clicked if it's part of a merge">üíî Unmerge Cell</button>
    </div>
    <div class="bar">
        <button id="addTableBtn" title="Add a new, empty table/sheet">‚ûï Add New Table</button>
        <button id="renameTableBtn" title="Rename the currently active table/sheet">üìù Rename Active Table</button>
        <button id="deleteTableBtn" title="Delete the currently active table/sheet">‚ùå Delete Active Table</button>
      
       [span_61](start_span)<button id="nameListBtn" title="Open a dialog to manage a list of names for quick insertion">üë• Manage Names (Firestore)</button>[span_61](end_span)
    </div>

    [span_62](start_span)<div id="draftListContainer" style="display:none; position:relative;"> <div id="loadingIndicatorDraftList" style="display:none;"><div class="spinner"></div></div>[span_62](end_span)
        </div>
    <div class="bar table-tabs" id="tableTabs"></div>
    <div id="tablesContainer">
        <table id="tbl_1" class="active" data-table-name="Table 1">
            <thead>
                <tr>
                    <th contenteditable="true">Class</th> <th contenteditable="true">08:00</th>
             
                    [span_63](start_span)<th contenteditable="true">09:00</th> <th contenteditable="true">10:00</th>[span_63](end_span)
                    <th contenteditable="true">11:00</th> <th contenteditable="true">12:00</th>
                    <th contenteditable="true">13:00</th>
                </tr>
            </thead>
            <tbody>
      
                [span_64](start_span)<tr> <td contenteditable="true">5S1</td>[span_64](end_span)
                    <td contenteditable="true"></td><td contenteditable="true">JAMES</td><td contenteditable="true"></td>
                    <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
                </tr>
                 <tr> <td contenteditable="true">5S2</td>
      
                   [span_65](start_span)<td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true">LILY</td>[span_65](end_span)
                    <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="bar" id="rowColManipulationBar">
        [span_66](start_span)<button id="addRowAboveBtn" title="Add a new row above the currently selected/clicked row">‚¨ÜÔ∏è Add Row Above</button>[span_66](end_span)
        <button id="addRowBelowBtn" title="Add a new row below the currently selected/clicked row">‚¨áÔ∏è Add Row Below</button>
        <button id="addColLeftBtn" title="Add a new column to the left of the currently selected/clicked column">‚¨ÖÔ∏è Add Column Left</button>
        <button id="addColRightBtn" title="Add a new column to the right of the currently selected/clicked column">‚û°Ô∏è Add Column Right</button>
        <button id="deleteRowBtn" class="delete-btn" title="Delete the currently selected/clicked row">üóëÔ∏è Delete Row</button>
       
         [span_67](start_span)<button id="deleteColBtn" class="delete-btn" title="Delete the currently selected/clicked column">üóëÔ∏è Delete Column</button>[span_67](end_span)
    </div>

    <div id="nameModal" class="modal">
        <div class="modal-content" id="nameModalContent">
            <div class="modal-header" id="nameModalHeader">
                <h3 id="nameModalTitle">Name List Manager</h3> <button type="button" class="modal-close-btn" id="closeNameModalBtnStandard" title="Close name manager">√ó</button>
            </div>
            <div class="name-session-tabs">
     
                [span_68](start_span)<button id="namePagiTab" data-session="pagi" class="active">Pagi (Morning)</button>[span_68](end_span)
                <button id="namePetangTab" data-session="petang">Petang (Afternoon)</button>
            </div>
             <div class="input-group">
                <input id="newNameInput" placeholder="Add new name to current session">
                [span_69](start_span)<button id="addNameBtnInModal" title="Add the name to the list">Add</button>[span_69](end_span)
            </div>
            <button id="importNameListBtn" title="Import names from a .txt file (one name per line) to current session">üìÇ Import Names (.txt) to Session</button>
            <input type="file" id="nameListImportFile" accept=".txt" style="display:none;">
            <input type="text" id="searchNameInput" placeholder="üîç Search names in current session..." style="margin-top: 10px;" title="Filter the list of names">
        
             [span_70](start_span)<div id="nameList" style="margin-top:10px;max-height:250px;overflow-y:auto;">[span_70](end_span)
                </div>
            <div id="loadingIndicatorModal" style="display:none;"><div class="spinner"></div></div>
        </div>
    </div>

    <h3 style="margin-top:32px">Teacher/Subject Attendance Summary</h3>
    <table id="summaryTable"></table>
    <div id="customMessageBox" class="custom-message-box"></div>
</div>

<script type="module">
    // Firebase App (the core Firebase SDK) is always required and must be listed first
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    // Add SDKs for Firebase products that you want to use
    [span_71](start_span)import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";[span_71](end_span)
    [span_72](start_span)import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc, serverTimestamp, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";[span_72](end_span)

    // --- Firebase Configuration ---
    // IMPORTANT: Replace "YOUR_API_KEY" with your actual Firebase API key.
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "jadual-3f0aa.firebaseapp.com",
      projectId: "jadual-3f0aa",
      storageBucket: "jadual-3f0aa.firebasestorage.app",
      messagingSenderId: "496526436851",
      appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
    };
    const appId = firebaseConfig.appId;


    // --- Initialize Firebase ---
    let fbApp, fbAuth, fbDb;
    let fbUserId = null;
    [span_73](start_span)let fbIsAuthReady = false;[span_73](end_span)
    let unsubscribePagi = null;
    let unsubscribePetang = null;
    try {
        fbApp = initializeApp(firebaseConfig);
        fbAuth = getAuth(fbApp);
        fbDb = getFirestore(fbApp);
    } catch (e) {
        console.error("Error initializing Firebase:", e);
        [span_74](start_span)showMessage("Critical Error: Firebase initialization failed. Core features will not work.", "error", 10000);[span_74](end_span)
    }

    // --- Global State and Configuration ---
    [span_75](start_span)const SCHEDULE_TITLE_KEY = 'jadual_title_v3';[span_75](end_span)
    let activeTableId = 'tbl_1';
    [span_76](start_span)let tableCount = 1;[span_76](end_span)
    let selectionMode = false;
    let selectedCells = [];
    let lastClickedCell = null;
    let selectedNameFromList = null;
    // Firestore Name List State
    [span_77](start_span)let currentNameListSession = 'pagi';[span_77](end_span)
    let namesPagi = [];
    let namesPetang = [];
    [span_78](start_span)let isDraggingModal = false;[span_78](end_span)
    let modalDragOffsetX, modalDragOffsetY;

    // DOM Element Cache
    let scheduleTitleElement, tablesContainer, tableTabs, nameModal, nameModalContent, nameModalHeader, nameListContainer, newNameInput, draftListContainerElement, summaryTableElement, customMessageBox, fileInputElement, directCopyFullHtmlButtonElement, closeNameModalButtonStandardElement, nameListImportFileInputElement, searchNameInputElement, draftImportFileInputElement, userIdDisplayElement, namePagiTabElement, namePetangTabElement, loadingIndicatorModalElement, nameModalTitleElement, loadingIndicatorDraftListElement;
    
    // --- Utility Functions (Existing) ---
    function showMessage(message, type = 'info', duration = 3000) { /* ... existing code ... */ }
    function customPrompt(message, defaultValue = "") { /* ... existing code ... */ }
    function customConfirm(message) { /* ... existing code ... */ }
    
    // --- Firestore Name List Functions ---
    function showNameModalLoading(isLoading) { /* ... existing code ... */ }
    async function saveNameListToFirestore(session, namesArray) { /* ... existing code ... */ }
    async 
    function addNameToCurrentSessionInFirestore(name) { /* ... existing code ... */ }
    async function deleteNameFromCurrentSessionInFirestore(nameToDelete) { /* ... existing code ... */ }
    function listenToNameList(sessionToListen) { /* ... existing code ... */ }

    // --- Firestore Draft Functions ---
    function showDraftListLoading(isLoading) {
        if (loadingIndicatorDraftListElement) {
            loadingIndicatorDraftListElement.style.display = isLoading ? [span_79](start_span)'flex' : 'none';[span_79](end_span)
        }
    }

    async function saveDraftToFirestore() {
        if (!fbDb || !fbUserId || !fbIsAuthReady) {
            showMessage("Firebase not ready. Cannot save draft.", "error");
            [span_80](start_span)return;[span_80](end_span)
        }
        if (tablesContainer.children.length === 0) {
            showMessage('No schedule data to save.', 'error');
            [span_81](start_span)return;[span_81](end_span)
        }
        
        const draftName = customPrompt('Enter draft name:', `Draft ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`);
        if (!draftName || draftName.trim() === "") {
            showMessage('Draft name cannot be empty. Save cancelled.', 'info');
            [span_82](start_span)return;[span_82](end_span)
        }

        showDraftListLoading(true);
        [span_83](start_span)const allTablesData = tablesContainer.innerHTML;[span_83](end_span)
        const allTableMeta = {};
        tablesContainer.querySelectorAll('table').forEach(table => {
            allTableMeta[table.id] = { name: table.dataset.tableName || table.id };
        });
        const draftData = {
            html: allTablesData,
            meta: allTableMeta,
            activeTableId: activeTableId,
            timestamp: serverTimestamp() // For ordering by date
        };
        [span_84](start_span)const draftDocRef = doc(fbDb, "artifacts", appId, "users", fbUserId, "scheduleDrafts", draftName.trim());[span_84](end_span)
        try {
            await setDoc(draftDocRef, draftData);
            [span_85](start_span)showMessage(`Draft "${draftName.trim()}" saved to Firestore!`, 'success');[span_85](end_span)
            if (draftListContainerElement.style.display === 'block') { // If list is visible, refresh it
                await renderDraftListFromFirestore();
            }
        } catch (error) {
            console.error("Error saving draft to Firestore:", error);
            [span_86](start_span)showMessage(`Failed to save draft. Error: ${error.message}`, "error");[span_86](end_span)
        } finally {
            showDraftListLoading(false);
        }
    }

    async function renderDraftListFromFirestore() {
        if (!fbDb || !fbUserId || !fbIsAuthReady) {
            draftListContainerElement.innerHTML = '<p>Firebase not ready. [span_87](start_span)Cannot load drafts.</p>'; return;[span_87](end_span)
        }
        showDraftListLoading(true);
        [span_88](start_span)draftListContainerElement.innerHTML = '';[span_88](end_span)
        
        const draftsCollectionRef = collection(fbDb, "artifacts", appId, "users", fbUserId, "scheduleDrafts");
        [span_89](start_span)const q = query(draftsCollectionRef, orderBy("timestamp", "desc"));[span_89](end_span)
        try {
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                draftListContainerElement.innerHTML = '<p>No drafts saved in Firestore yet.</p>';
            } else {
                querySnapshot.forEach((docSnap) => {
                    const draftName = docSnap.id;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'draft-item-firestore'; // Use new class for styling if needed
    
                    [span_90](start_span)itemDiv.innerHTML = `<span data-draft-name="${draftName}" title="Load draft: ${draftName}">${draftName}</span><button data-draft-delete="${draftName}" title="Delete draft '${draftName}' from Firestore">Delete</button>`;[span_90](end_span)
                    draftListContainerElement.appendChild(itemDiv);
                });
            }
        } catch (error) {
            console.error("Error fetching drafts from Firestore:", error);
            draftListContainerElement.innerHTML = '<p>Error loading drafts. [span_91](start_span)Check console.</p>';[span_91](end_span)
            showMessage(`Failed to load drafts. Error: ${error.message}`, "error");
        } finally {
            showDraftListLoading(false);
        }
    }

    async function loadSelectedDraftFromFirestore(draftName) {
        if (!fbDb || !fbUserId || !fbIsAuthReady) {
            showMessage("Firebase not ready. Cannot load draft.", "error");
            [span_92](start_span)return;[span_92](end_span)
        }
        showDraftListLoading(true);
        const draftDocRef = doc(fbDb, "artifacts", appId, "users", fbUserId, "scheduleDrafts", draftName);
        try {
            [span_93](start_span)const docSnap = await getDoc(draftDocRef);[span_93](end_span)
            if (docSnap.exists()) {
                const draftData = docSnap.data();
                [span_94](start_span)tablesContainer.innerHTML = draftData.html;[span_94](end_span)
                const tableMeta = draftData.meta || {};
                tableTabs.innerHTML = '';
                tablesContainer.querySelectorAll('table').forEach(table => {
                    const id = table.id;
                    const metaInfo = tableMeta[id] || {};
                    const name = metaInfo.name || `Table ${tableTabs.children.length + 1}`;
                    [span_95](start_span)table.dataset.tableName = name;[span_95](end_span)
                    addTabButton(id, name);
                    table.querySelectorAll('td, th').forEach(cell => cell.contentEditable = 'true');
                });
                activeTableId = draftData.activeTableId || tablesContainer.querySelector('table')?.id || [span_96](start_span)'tbl_1';[span_96](end_span)

                if (document.getElementById(activeTableId)) {
                    switchTable(activeTableId);
                } else if (tablesContainer.querySelector('table')) {
                    switchTable(tablesContainer.querySelector('table').id);
                } else {
                    addNewTable(true);
                }
                showMessage(`Draft "${draftName}" loaded from Firestore!`, 'success');
                [span_97](start_span)draftListContainerElement.style.display = 'none';[span_97](end_span)
                rebuildAndRenderSummary();
                updateAllMergeOverlays();
            } else {
                showMessage(`Draft "${draftName}" not found in Firestore.`, 'error');
            }
        } catch (error) {
            console.error("Error loading draft from Firestore:", error);
            [span_98](start_span)showMessage(`Failed to load draft. Error: ${error.message}`, "error");[span_98](end_span)
        } finally {
            showDraftListLoading(false);
        }
    }

    async function deleteDraftFromFirestore(draftName) {
        if (!fbDb || !fbUserId || !fbIsAuthReady) {
            showMessage("Firebase not ready. Cannot delete draft.", "error");
            [span_99](start_span)return;[span_99](end_span)
        }
        if (await customConfirm(`Are you sure you want to delete draft "${draftName}" from Firestore? This action cannot be undone.`)) {
            showDraftListLoading(true);
            [span_100](start_span)const draftDocRef = doc(fbDb, "artifacts", appId, "users", fbUserId, "scheduleDrafts", draftName);[span_100](end_span)
            try {
                await deleteDoc(draftDocRef);
                [span_101](start_span)showMessage(`Draft "${draftName}" deleted from Firestore.`, 'success');[span_101](end_span)
                await renderDraftListFromFirestore(); // Refresh the list
            } catch (error) {
                console.error("Error deleting draft from Firestore:", error);
                [span_102](start_span)showMessage(`Failed to delete draft. Error: ${error.message}`, "error");[span_102](end_span)
            } finally {
                showDraftListLoading(false);
            }
        }
    }
    
    async function exportAllDraftsFromFirestore() {
        if (!fbDb || !fbUserId || !fbIsAuthReady) {
            showMessage("Firebase not ready. Cannot export drafts.", "error");
            [span_103](start_span)return;[span_103](end_span)
        }
        showDraftListLoading(true);
        [span_104](start_span)const draftsCollectionRef = collection(fbDb, "artifacts", appId, "users", fbUserId, "scheduleDrafts");[span_104](end_span)
        const draftsToExport = {};
        try {
            const querySnapshot = await getDocs(draftsCollectionRef);
            if (querySnapshot.empty) {
                showMessage('No drafts in Firestore to export.', 'info');
                [span_105](start_span)return;[span_105](end_span)
            }
            querySnapshot.forEach((docSnap) => {
                draftsToExport[docSnap.id] = docSnap.data(); // Store data by draft name (doc ID)
            });
            const draftsJson = JSON.stringify(draftsToExport, (key, value) => {
                // Convert Firestore Timestamps to ISO strings for JSON compatibility
                if (value && typeof value.toDate === 'function') {
                    return value.toDate().toISOString();
                }
        
                [span_106](start_span)return value;[span_106](end_span)
            }, 2);

            const blob = new Blob([draftsJson], { type: 'application/json' });
            [span_107](start_span)const url = URL.createObjectURL(blob);[span_107](end_span)
            const a = document.createElement('a');
            a.href = url;
            a.download = 'firestore_schedule_drafts.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            [span_108](start_span)showMessage('All drafts from Firestore exported successfully!', 'success');[span_108](end_span)

        } catch (error) {
            console.error("Error exporting drafts from Firestore:", error);
            [span_109](start_span)showMessage(`Failed to export drafts. Error: ${error.message}`, "error");[span_109](end_span)
        } finally {
            showDraftListLoading(false);
        }
    }

    async function importDraftsToFirestore(event) {
        if (!fbDb || !fbUserId || !fbIsAuthReady) {
            showMessage("Firebase not ready. Cannot import drafts.", "error");
            [span_110](start_span)return;[span_110](end_span)
        }
        const file = event.target.files[0];
        if (!file) { showMessage('No file selected for import.', 'info'); return; [span_111](start_span)}
        if (file.type !== 'application/json') {
            showMessage('Invalid file type. Please select a .json file.', 'error');
            event.target.value = ''; return;[span_111](end_span)
        }
        showDraftListLoading(true);
        [span_112](start_span)const reader = new FileReader();[span_112](end_span)
        reader.onload = async (e) => {
            try {
                const importedDraftsText = e.target.result;
                [span_113](start_span)const importedDraftsData = JSON.parse(importedDraftsText);[span_113](end_span)

                if (typeof importedDraftsData !== 'object' || importedDraftsData === null) {
                    showMessage('Invalid draft file format.', 'error');
                    [span_114](start_span)return;[span_114](end_span)
                }

                let importedCount = 0;
                [span_115](start_span)let overwrittenCount = 0; let skippedCount = 0;[span_115](end_span)
                const draftsCollectionRef = collection(fbDb, "artifacts", appId, "users", fbUserId, "scheduleDrafts");
                for (const draftName in importedDraftsData) {
                    if (Object.prototype.hasOwnProperty.call(importedDraftsData, draftName)) {
                        const draftData = importedDraftsData[draftName];
                        // Basic validation of draft data structure
                        if (draftData && typeof draftData.html === 'string' && typeof draftData.meta === 'object' && typeof draftData.activeTableId === 'string') {
                            
                         
                           [span_116](start_span)const draftDocRef = doc(draftsCollectionRef, draftName);[span_116](end_span)
                            const docSnap = await getDoc(draftDocRef);

                            let dataToSave = { ...draftData };
                            // If timestamp was stringified, try to convert back or use serverTimestamp
                            if (typeof dataToSave.timestamp === 'string') {
                                // Attempt to parse, otherwise fallback to serverTimestamp
                 
                               [span_117](start_span)const parsedDate = new Date(dataToSave.timestamp);[span_117](end_span)
                                if (!isNaN(parsedDate)) {
                                     dataToSave.timestamp = serverTimestamp();
                                } else {
                                    dataToSave.timestamp = serverTimestamp();
                                }
                            } else {
                                dataToSave.timestamp = serverTimestamp();
                            }


                            if (docSnap.exists()) {
                                [span_118](start_span)if (await customConfirm(`Draft "${draftName}" already exists in Firestore. Overwrite?`)) {[span_118](end_span)
                                    await setDoc(draftDocRef, dataToSave);
                                    [span_119](start_span)overwrittenCount++;[span_119](end_span)
                                } else {
                                    skippedCount++;
                                }
                            } else {
                                await setDoc(draftDocRef, dataToSave);
                                [span_120](start_span)importedCount++;[span_120](end_span)
                            }
                        } else {
                            console.warn(`Skipping invalid draft data for "${draftName}" during import.`);
                            [span_121](start_span)skippedCount++;[span_121](end_span)
                        }
                    }
                }
                showMessage(`Firestore drafts import: ${importedCount} new, ${overwrittenCount} overwritten, ${skippedCount} skipped.`, 'success', 5000);
                if (draftListContainerElement.style.display === 'block' || importedCount > 0 || overwrittenCount > 0) {
                    await renderDraftListFromFirestore();
                }
            } catch (error) {
                console.error("Error importing drafts to Firestore:", error);
                [span_122](start_span)showMessage(`Error processing draft file for Firestore. Error: ${error.message}`, 'error', 5000);[span_122](end_span)
            } finally {
                [span_123](start_span)event.target.value = '';[span_123](end_span)
                showDraftListLoading(false);
            }
        };
        reader.onerror = () => {
            showMessage('Failed to read the draft file.', 'error');
            [span_124](start_span)event.target.value = '';[span_124](end_span)
            showDraftListLoading(false);
        };
        reader.readAsText(file);
    }


    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        // Cache DOM Elements
        scheduleTitleElement = document.getElementById('scheduleTitle');
        tablesContainer = document.getElementById('tablesContainer');
        tableTabs = document.getElementById('tableTabs');
        nameModal = document.getElementById('nameModal');
        nameModalContent = document.getElementById('nameModalContent');
        nameModalHeader = document.getElementById('nameModalHeader');
        [span_125](start_span)nameListContainer = document.getElementById('nameList');[span_125](end_span)
        newNameInput = document.getElementById('newNameInput');
        draftListContainerElement = document.getElementById('draftListContainer'); // Updated ID
        summaryTableElement = document.getElementById('summaryTable');
        customMessageBox = document.getElementById('customMessageBox');
        fileInputElement = document.getElementById('fileInput');
        directCopyFullHtmlButtonElement = document.getElementById('directCopyFullHtmlBtn');
        [span_126](start_span)closeNameModalButtonStandardElement = document.getElementById('closeNameModalBtnStandard');[span_126](end_span)
        nameListImportFileInputElement = document.getElementById('nameListImportFile');
        searchNameInputElement = document.getElementById('searchNameInput');
        draftImportFileInputElement = document.getElementById('draftImportFile');
        userIdDisplayElement = document.getElementById('userIdDisplay');
        namePagiTabElement = document.getElementById('namePagiTab');
        [span_127](start_span)namePetangTabElement = document.getElementById('namePetangTab');[span_127](end_span)
        loadingIndicatorModalElement = document.getElementById('loadingIndicatorModal');
        nameModalTitleElement = document.getElementById('nameModalTitle');
        loadingIndicatorDraftListElement = document.getElementById('loadingIndicatorDraftList');
        if (!tablesContainer || !tableTabs || !nameModal || !nameModalContent || !nameModalHeader || !summaryTableElement || !customMessageBox || !scheduleTitleElement || !fileInputElement || !directCopyFullHtmlButtonElement || !closeNameModalButtonStandardElement || !nameListImportFileInputElement || !searchNameInputElement || !draftImportFileInputElement || !userIdDisplayElement || !namePagiTabElement || !namePetangTabElement || !loadingIndicatorModalElement || !nameModalTitleElement || !draftListContainerElement || !loadingIndicatorDraftListElement) {
            console.error("Critical DOM elements missing. Application might not function correctly.");
            [span_128](start_span)document.body.innerHTML = "<p style='color:red; text-align:center; font-size:1.2em; padding:20px;'>Error: Application failed to initialize due to missing page elements. Please ensure the HTML structure is correct.</p>";[span_128](end_span)
            return;
        }

        if (fbAuth) {
            onAuthStateChanged(fbAuth, async (user) => {
                if (user) {
                    fbUserId = user.uid;
                    fbIsAuthReady = true;
           
                     [span_129](start_span)if(userIdDisplayElement) userIdDisplayElement.textContent = `User ID: ${fbUserId}`;[span_129](end_span)
                    console.log("Firebase User is signed in with UID:", fbUserId);

                    if (unsubscribePagi) unsubscribePagi();
                    if (unsubscribePetang) unsubscribePetang();

               
                     [span_130](start_span)unsubscribePagi = listenToNameList('pagi');[span_130](end_span)
                    unsubscribePetang = listenToNameList('petang');
                    
                    if (nameModal.style.display === 'flex') {
                        renderNameListFromFirestore(searchNameInputElement.value);
   
                    }
                    // If draft list is already visible on load (e.g. due to user action before full load)
                    if (draftListContainerElement.style.display === 'block') {
                       
                         [span_131](start_span)await renderDraftListFromFirestore();[span_131](end_span)
                    }

                } else {
                    fbIsAuthReady = false;
                    [span_132](start_span)fbUserId = null;[span_132](end_span)
                    if(userIdDisplayElement) userIdDisplayElement.textContent = "User ID: Not authenticated";
                    console.log("Firebase User is signed out or auth not yet complete.");
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(fbAuth, __initial_auth_token);
                        } else {
                            await signInAnonymously(fbAuth);
                        }
                    } catch (error) {
                        console.error("Error during Firebase sign-in:", error);
                        [span_133](start_span)showMessage("Firebase Authentication failed. Core features may not work.", "error", 5000);[span_133](end_span)
                        if(userIdDisplayElement) userIdDisplayElement.textContent = `User ID: Auth Error`;
                    }
                }
            });
        } else {
             if(userIdDisplayElement) userIdDisplayElement.textContent = "User ID: Firebase Error";
        }


        loadScheduleTitle();
        initializeEventListeners();
        setupInitialTableState();
        rebuildAndRenderSummary(); 
        handleNameListSessionSwitch('pagi'); 
    });
    function setupInitialTableState() { /* ... existing code ... */ }
    function loadScheduleTitle() { /* ... existing code ... */ }
    function initializeEventListeners() {
        directCopyFullHtmlButtonElement.addEventListener('click', attemptDirectCopyToClipboard);
        [span_134](start_span)closeNameModalButtonStandardElement.addEventListener('click', closeNameModal);[span_134](end_span)
        nameModalHeader.addEventListener('mousedown', startDragModal);
        document.addEventListener('mousemove', dragModal);
        document.addEventListener('mouseup', stopDragModal);
        nameModalHeader.addEventListener('touchstart', startDragModal, { passive: false });
        document.addEventListener('touchmove', dragModal, { passive: false });
        [span_135](start_span)document.addEventListener('touchend', stopDragModal);[span_135](end_span)
        document.getElementById('excelBtnTrigger').addEventListener('click', exportActiveTableToExcel);
        document.getElementById('importExcelBtn').addEventListener('click', () => fileInputElement.click());
        fileInputElement.addEventListener('change', handleExcelFileImport);
        // Draft buttons now point to Firestore functions
        document.getElementById('saveDraftBtn').addEventListener('click', saveDraftToFirestore);
        document.getElementById('loadDraftBtn').addEventListener('click', async () => { // Modified for Firestore
            const isVisible = draftListContainerElement.style.display === 'block';
            draftListContainerElement.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                await renderDraftListFromFirestore();
            }
        });
        [span_136](start_span)document.getElementById('exportDraftsBtn').addEventListener('click', exportAllDraftsFromFirestore);[span_136](end_span)
        document.getElementById('importDraftsBtn').addEventListener('click', () => draftImportFileInputElement.click());
        draftImportFileInputElement.addEventListener('change', importDraftsToFirestore);


        document.getElementById('clearActiveTableContentBtn').addEventListener('click', confirmAndClearActiveTableContent);
        document.getElementById('selectBtn').addEventListener('click', toggleCellSelectionMode);
        document.getElementById('mergeBtn').addEventListener('click', mergeSelectedTableCells);
        document.getElementById('deselectBtn').addEventListener('click', deselectAllTableCells);
        document.getElementById('unmergeBtn').addEventListener('click', unmergeActiveCellIfMerged);
        [span_137](start_span)document.getElementById('addTableBtn').addEventListener('click', () => addNewTable());[span_137](end_span)
        document.getElementById('renameTableBtn').addEventListener('click', promptAndRenameActiveTable);
        document.getElementById('deleteTableBtn').addEventListener('click', confirmAndDeleteActiveTable);
        
        document.getElementById('nameListBtn').addEventListener('click', toggleNameListModalVisibility);
        [span_138](start_span)document.getElementById('addNameBtnInModal').addEventListener('click', () => {[span_138](end_span)
            if(newNameInput) addNameToCurrentSessionInFirestore(newNameInput.value);
        });
        [span_139](start_span)document.getElementById('importNameListBtn').addEventListener('click', () => nameListImportFileInputElement.click());[span_139](end_span)
        nameListImportFileInputElement.addEventListener('change', handleNameListImportFirestore);
        if(searchNameInputElement) searchNameInputElement.addEventListener('input', () => renderNameListFromFirestore(searchNameInputElement.value));
        
        namePagiTabElement.addEventListener('click', () => handleNameListSessionSwitch('pagi'));
        namePetangTabElement.addEventListener('click', () => handleNameListSessionSwitch('petang'));
        draftListContainerElement.addEventListener('click', async (e) => { // Event listener for Firestore draft list
            const targetSpan = e.target.closest('.draft-item-firestore span[data-draft-name]');
            const targetButton = e.target.closest('.draft-item-firestore button[data-draft-delete]');
            if (targetSpan) {
                await loadSelectedDraftFromFirestore(targetSpan.dataset.draftName);
            } else if (targetButton) {
          
                   [span_140](start_span)await deleteDraftFromFirestore(targetButton.dataset.draftDelete);[span_140](end_span)
            }
        });
        nameListContainer.addEventListener('click', async (e) => { /* ... existing code ... */ });

        document.getElementById('addRowAboveBtn').addEventListener('click', addRowAboveToActiveTable);
        document.getElementById('addRowBelowBtn').addEventListener('click', addRowBelowToActiveTable);
        document.getElementById('addColLeftBtn').addEventListener('click', addColumnLeftToActiveTable);
        document.getElementById('addColRightBtn').addEventListener('click', addColumnRightToActiveTable);
        [span_141](start_span)document.getElementById('deleteRowBtn').addEventListener('click', deleteClickedRowFromActiveTable);[span_141](end_span)
        document.getElementById('deleteColBtn').addEventListener('click', deleteClickedColumnFromActiveTable);

        tablesContainer.addEventListener('click', handleTableCellClick);
        tablesContainer.addEventListener('blur', (e) => { /* ... existing code ... */ }, true);
        tablesContainer.addEventListener('input', (e) => { /* ... existing code ... */ });
        window.addEventListener('resize', updateAllMergeOverlays);
    }

    // --- Draggable Modal Functionality (Existing) ---
    function startDragModal(e) { /* ... existing code ... */ }
    function dragModal(e) { /* ... existing code ... */ }
    function stopDragModal() { /* ... existing code ... */ }

    // --- Direct Copy Full HTML Functionality (Existing) ---
    async function attemptDirectCopyToClipboard() { /* ... existing code ... */ }

    // --- Draft Management (MODIFIED FOR FIRESTORE) ---
    // promptAndSaveDraft -> saveDraftToFirestore
    // toggleDraftListVisibility -> 
    // Modified in initializeEventListeners to call renderDraftListFromFirestore
    // renderDraftList -> renderDraftListFromFirestore
    // loadSelectedDraft -> loadSelectedDraftFromFirestore
    // confirmAndDeleteDraft -> deleteDraftFromFirestore
    // exportAllDrafts -> exportAllDraftsFromFirestore
    // handleDraftsFileImport -> importDraftsToFirestore
    
    async function confirmAndClearActiveTableContent() { /* ... existing code ... */ }
    
    // --- Table Management (Existing, Unchanged) ---
    function addTabButton(id, label) { /* ... existing code ... */ }
    function switchTable(id) { /* ... existing code ... */ }
 
       function addNewTable(isInitial = false) { /* ... existing code ... */ }
    async function promptAndRenameActiveTable() { /* ... existing code ... */ }
    async function confirmAndDeleteActiveTable() { /* ... existing code ... */ }

    // --- Row/Column Operations (Existing, Unchanged) ---
    function addRowToTable(tableBody, rowIndex, numCols) { /* ... existing code ... */ }
    function addRowAboveToActiveTable() { /* ... existing code ... */ }
    function addRowBelowToActiveTable() { /* ... existing code ... */ }
    [span_142](start_span)function addColumnToTable(table, colIndex) { /* ... existing code ... */ }[span_142](end_span)
    function addColumnLeftToActiveTable() { /* ... existing code ... */ }
    function addColumnRightToActiveTable() { /* ... existing code ... */ }
    async function deleteClickedRowFromActiveTable() { /* ... existing code ... */ }
    async function deleteClickedColumnFromActiveTable() { /* ... existing code ... */ }

    // --- Cell Selection, Merging, Unmerging (Existing, Unchanged) ---
    function toggleCellSelectionMode() { /* ... existing code ... */ }
    function handleTableCellClick(event) { /* ... existing code ... */ }
 
       function deselectAllTableCells() { /* ... existing code ... */ }
    function mergeSelectedTableCells() { /* ... existing code ... */ }
    function unmergeActiveCellIfMerged() { /* ... existing code ... */ }
    function updateAllMergeOverlays() { /* ... existing code ... */ }

    // --- Name List Management (Modal) - Firestore (Existing) ---
    function handleNameListSessionSwitch(session) { /* ... existing code ... */ }
    function highlightSelectedNameInList(nameToHighlight) { /* ... existing code ... */ }
    function clearNameSelection() { /* ... existing code ... */ }
    function closeNameModal() { /* ... existing code ... */ }
    function toggleNameListModalVisibility() { /* ... existing code ... */ }
    function renderNameListFromFirestore(filterText = '') { /* ... existing code ... */ }
    function selectNameForCellInsertion(name) { /* ... existing code ... */ }
    function handleNameListImportFirestore(event) { /* ... existing code ... */ }

    // --- Excel Export/Import (Existing, Unchanged) ---
    function handleExcelFileImport(event) { /* ... existing code ... */ }
    function exportActiveTableToExcel() { /* ... existing code ... */ }

    // --- Summary Table Logic (Existing, Unchanged by draft storage method) ---
    function rebuildAndRenderSummary() { /* ... existing code ... */ }
    function parseTimeToMinutes(timeStr) { /* ... existing code ... */ }
    function buildSummaryTableSkeleton(allAvailableNames) { /* ... existing code ... */ }
    function updateSummaryTableData(allAvailableNames) { /* ... existing code ... */ }

    // Ensure existing utility functions are complete in the actual script
    // For brevity, their full code is not repeated here if unchanged.
    // Make sure showMessage, customPrompt, customConfirm are fully present.

</script>
</body>
</html>
