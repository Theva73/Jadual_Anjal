<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
Â  Â  <title>Weekly Schedule</title>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
Â  Â  <style>
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: Arial, Helvetica, sans-serif;
Â  Â  Â  Â  Â  Â  margin: 20px;
Â  Â  Â  Â  Â  Â  background-color: #f9f9f9;
Â  Â  Â  Â  }
Â  Â  Â  Â  h2, h3 {
Â  Â  Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  }
Â  Â  Â  Â  table {
Â  Â  Â  Â  Â  Â  border-collapse: collapse;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
Â  Â  Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  }
Â  Â  Â  Â  #tablesContainer > table {
Â  Â  Â  Â  Â  Â  display: none; 
Â  Â  Â  Â  }
Â  Â  Â  Â  #tablesContainer > table.active {
Â  Â  Â  Â  Â  Â  display: table;
Â  Â  Â  Â  }
Â  Â  Â  Â  #summaryTable {
Â  Â  Â  Â  Â  Â  display: table; 
Â  Â  Â  Â  Â  Â  margin-top: 20px; 
Â  Â  Â  Â  }
Â  Â  Â  Â  th, td {
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  min-width: 100px;
Â  Â  Â  Â  }
Â  Â  Â  Â  table th { 
Â  Â  Â  Â  Â  Â  background-color: #e9ecef;
Â  Â  Â  Â  Â  Â  color: #495057;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â  td.selected, th.selected { 
Â  Â  Â  Â  Â  Â  outline: 3px solid #007bff;
Â  Â  Â  Â  Â  Â  background-color: #cfe2ff;
Â  Â  Â  Â  }
Â  Â  Â  Â  .merged { 
Â  Â  Â  Â  Â  Â  font-style: italic;
Â  Â  Â  Â  Â  Â  background-color: #f8f9fa;
Â  Â  Â  Â  }
Â  Â  Â  Â  .bar {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .bar button, .table-tabs button {
Â  Â  Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  border: 1px solid #adb5bd;
Â  Â  Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s ease, box-shadow 0.2s ease;
Â  Â  Â  Â  Â  Â  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
Â  Â  Â  Â  }
Â  Â  Â  Â  .bar button:hover, .table-tabs button:hover {
Â  Â  Â  Â  Â  Â  background-color: #f1f3f5;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â  #directCopyFullHtmlBtn { background-color: #545b62; color: white; border-color: #545b62; } /* Updated ID */
Â  Â  Â  Â  #excelBtnTrigger, #importExcelBtn { background-color: #28a745; color: white; border-color: #28a745;}
Â  Â  Â  Â  #saveDraftBtn { background-color: #007bff; color: white; border-color: #007bff;}
Â  Â  Â  Â  #loadDraftBtn { background-color: #ffc107; color: #212529; border-color: #ffc107;}
Â  Â  Â  Â  #clearDraft { background-color: #dc3545; color: white; border-color: #dc3545;}
Â  Â  Â  Â  #selectBtn { background-color: #17a2b8; color: white; border-color: #17a2b8;}
Â  Â  Â  Â  #selectBtn.active { background-color: #fd7e14; border-color: #fd7e14;}
Â  Â  Â  Â  #mergeBtn { background-color: #6f42c1; color: white; border-color: #6f42c1;}
Â  Â  Â  Â  #unmergeBtn { background-color: #e83e8c; color: white; border-color: #e83e8c;}
Â  Â  Â  Â  #addTableBtn { background-color: #20c997; color: white; border-color: #20c997;}
Â  Â  Â  Â  #renameTableBtn { background-color: #6c757d; color: white; border-color: #6c757d;}
Â  Â  Â  Â  #deleteTableBtn { background-color: #dc3545; color: white; border-color: #dc3545;}
Â  Â  Â  Â  #nameListBtn { background-color: #fd7e14; color: white; border-color: #fd7e14;}
Â  Â  Â  Â  #deselectBtn { background-color: #6c757d; color: white; border-color: #6c757d;}

Â  Â  Â  Â  .table-tabs { margin-bottom: 10px; }
Â  Â  Â  Â  .table-tabs button { background-color: #f8f9fa; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
Â  Â  Â  Â  .table-tabs button.active { background-color: #007bff; color: white; border-color: #007bff; }
Â  Â  Â  Â  #summaryTable th { background-color: #ffeeba; }
Â  Â  Â  Â  #summaryTable td { background-color: #fff3cd; }

Â  Â  Â  Â  .modal {
Â  Â  Â  Â  Â  Â  display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
Â  Â  Â  Â  Â  Â  overflow: auto; background-color: rgba(0,0,0,0.4); align-items: center; justify-content: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-content {
Â  Â  Â  Â  Â  Â  background-color: #fff; margin: auto; padding: 20px; border: 1px solid #888;
Â  Â  Â  Â  Â  Â  width: 90%; max-width: 400px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-header {
Â  Â  Â  Â  Â  Â  padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  font-size: 1.2em; color: #333; display: flex; justify-content: space-between; align-items: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-close-btn {
Â  Â  Â  Â  Â  Â  font-size: 1.5rem; font-weight: bold; line-height: 1; color: #000;
Â  Â  Â  Â  Â  Â  text-shadow: 0 1px 0 #fff; opacity: .5; background: transparent; border: 0; cursor: pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-close-btn:hover { opacity: .75; }

Â  Â  Â  Â  .name-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid #eee; }
Â  Â  Â  Â  .name-item:last-child { border-bottom: none; }
Â  Â  Â  Â  .name-item span { flex-grow: 1; cursor: pointer; color: #007bff; }
Â  Â  Â  Â  .name-item span:hover { text-decoration: underline; }
Â  Â  Â  Â  .name-item button { background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; font-size: 0.9em; }
Â  Â  Â  Â  .highlighted { background-color: #cfe2ff !important; font-weight: bold; }
Â  Â  Â  Â  #draftList { border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; border-radius: 5px; background-color: #fff; }
Â  Â  Â  Â  .draft-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid #eee; }
Â  Â  Â  Â  .draft-item:last-child { border-bottom: none; }
Â  Â  Â  Â  .draft-item span { cursor: pointer; color: #007bff; }
Â  Â  Â  Â  .draft-item span:hover { text-decoration: underline; }
Â  Â  Â  Â  .draft-item button { background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; font-size: 0.9em; }
Â  Â  Â  Â  #newNameInput { padding: 8px; margin-right: 5px; border: 1px solid #ccc; border-radius: 4px; flex-grow: 1; }
Â  Â  Â  Â  .input-group { display: flex; margin-bottom: 10px; }
Â  Â  Â  Â  .input-group button { background-color: #28a745; color: white; border-color: #28a745; }

Â  Â  Â  Â  .custom-message-box {
Â  Â  Â  Â  Â  Â  display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
Â  Â  Â  Â  Â  Â  background-color: #333; color: white; padding: 15px 25px; border-radius: 5px;
Â  Â  Â  Â  Â  Â  z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 1em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .custom-message-box.success { background-color: #28a745; }
Â  Â  Â  Â  .custom-message-box.error { background-color: #dc3545; }
Â  Â  Â  Â  .custom-message-box.info { background-color: #007bff; }

Â  Â  </style>
</head>
<body>
Â  Â  <h2 contenteditable="true" id="scheduleTitle">Weekly Schedule</h2>

Â  Â  <div class="bar">
Â  Â  Â  Â  <button id="directCopyFullHtmlBtn">ğŸ“‹ Copy Full HTML (Direct)</button> 
Â  Â  </div>

Â  Â  <div class="bar">
Â  Â  Â  Â  <button id="excelBtnTrigger">ğŸ’¾ Export Active Table to Excel</button>
Â  Â  Â  Â  <button id="importExcelBtn">ğŸ“‚ Import from Excel</button>
Â  Â  Â  Â  <input type="file" id="fileInput" accept=".xlsx" style="display:none"> 
Â  Â  </div>
Â  Â  <div class="bar">
Â  Â  Â  Â  <button id="saveDraftBtn">ğŸ’  Save All as Draft</button>
Â  Â  Â  Â  <button id="loadDraftBtn">ğŸ“‚ Load Draft</button>
Â  Â  Â  Â  <button id="clearDraft">ğŸ—‘ï¸ Clear All Drafts</button>
Â  Â  </div>
Â  Â  <div class="bar">
Â  Â  Â  Â  <button id="selectBtn">âœ¨ Select Cells</button>
Â  Â  Â  Â  <button id="mergeBtn">ğŸ”— Merge Cells</button>
Â  Â  Â  Â  <button id="deselectBtn">ğŸš« Deselect All</button>
Â  Â  Â  Â  <button id="unmergeBtn">ğŸ’” Unmerge Cell</button>
Â  Â  </div>
Â  Â  <div class="bar">
Â  Â  Â  Â  <button id="addTableBtn">â• Add New Table</button>
Â  Â  Â  Â  <button id="renameTableBtn">ğŸ“ Rename Active Table</button>
Â  Â  Â  Â  <button id="deleteTableBtn">âŒ Delete Active Table</button>
Â  Â  Â  Â  <button id="nameListBtn">ğŸ‘¥ Manage Names</button>
Â  Â  </div>

Â  Â  <div id="draftList" style="display:none;"></div>
Â  Â  <div class="bar table-tabs" id="tableTabs"></div>

Â  Â  <div id="tablesContainer">
Â  Â  Â  Â  <table id="tbl_1" class="active" data-table-name="Table 1">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th contenteditable="true">Class/Time</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th contenteditable="true">Monday</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th contenteditable="true">Tuesday</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th contenteditable="true">Wednesday</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th contenteditable="true">Thursday</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th contenteditable="true">Friday</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th contenteditable="true">Saturday</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td contenteditable="true">08:00-09:00</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
 Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td contenteditable="true">09:00-10:00</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  </div>

Â  Â  <div class="bar" id="rowColManipulationBar">
Â  Â  Â  Â  <button>â¬†ï¸ Add Row Above</button>
Â  Â  Â  Â  <button>â¬‡ï¸ Add Row Below</button>
Â  Â  Â  Â  <button>â¬…ï¸ Add Column Left</button>
Â  Â  Â  Â  <button>â¡ï¸ Add Column Right</button>
Â  Â  </div>

Â  Â  <div id="nameModal" class="modal">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Name List</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="modal-close-btn" id="closeNameModalBtnStandard">Ã—</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  <input id="newNameInput" placeholder="Add new name">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="addNameBtnInModal">Add</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="nameList" style="margin-top:10px;max-height:200px;overflow-y:auto;"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <h3 style="margin-top:32px">Teacher/Subject Attendance Summary</h3>
Â  Â  <table id="summaryTable"></table>
Â  Â  <div id="customMessageBox" class="custom-message-box"></div>

<script>
Â  Â  // --- Global State and Configuration ---
Â  Â  const DRAFTS_KEY = 'jadual_drafts_v3'; 
Â  Â  const NAMES_KEY = 'jadual_names_v3';
Â  Â  const SCHEDULE_TITLE_KEY = 'jadual_title_v3';

Â  Â  let activeTableId = 'tbl_1'; 
Â  Â  let tableCount = 1; 
Â  Â  let selectionMode = false;
Â  Â  let selectedCells = [];
Â  Â  let selectedNameFromList = null; 
Â  Â  let names = []; 

Â  Â  // --- DOM Element References ---
Â  Â  let scheduleTitleElement, tablesContainer, tableTabs, nameModal, nameListContainer, newNameInput, draftListElement, summaryTableElement, customMessageBox, fileInputElement, directCopyFullHtmlButtonElement, closeNameModalButtonStandardElement;

Â  Â  // --- Utility Functions ---
Â  Â  function showMessage(message, type = 'info', duration = 3000) {
Â  Â  Â  Â  if (!customMessageBox) return;
Â  Â  Â  Â  customMessageBox.textContent = message;
Â  Â  Â  Â  customMessageBox.className = `custom-message-box ${type}`;
Â  Â  Â  Â  customMessageBox.style.display = 'block';
Â  Â  Â  Â  setTimeout(() => { if (customMessageBox) customMessageBox.style.display = 'none'; }, duration);
Â  Â  }
Â  Â  function customPrompt(message, defaultValue = "") { return prompt(message, defaultValue); }
Â  Â  function customConfirm(message) { return confirm(message); }

Â  Â  // --- Initialization ---
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  scheduleTitleElement = document.getElementById('scheduleTitle');
Â  Â  Â  Â  tablesContainer = document.getElementById('tablesContainer');
Â  Â  Â  Â  tableTabs = document.getElementById('tableTabs');
Â  Â  Â  Â  nameModal = document.getElementById('nameModal');
Â  Â  Â  Â  nameListContainer = document.getElementById('nameList');
Â  Â  Â  Â  newNameInput = document.getElementById('newNameInput');
Â  Â  Â  Â  draftListElement = document.getElementById('draftList');
Â  Â  Â  Â  summaryTableElement = document.getElementById('summaryTable');
Â  Â  Â  Â  customMessageBox = document.getElementById('customMessageBox');
Â  Â  Â  Â  fileInputElement = document.getElementById('fileInput');
Â  Â  Â  Â  directCopyFullHtmlButtonElement = document.getElementById('directCopyFullHtmlBtn');
Â  Â  Â  Â  closeNameModalButtonStandardElement = document.getElementById('closeNameModalBtnStandard');

Â  Â  Â  Â  if (!tablesContainer || !tableTabs || !nameModal || !summaryTableElement || !customMessageBox || !scheduleTitleElement || !fileInputElement || !directCopyFullHtmlButtonElement || !closeNameModalButtonStandardElement) {
Â  Â  Â  Â  Â  Â  console.error("Critical DOM elements missing. Application might not function correctly.");
Â  Â  Â  Â  Â  Â  document.body.innerHTML = "<p style='color:red; text-align:center; font-size:1.2em; padding:20px;'>Error: Application failed to initialize due to missing page elements.</p>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  loadScheduleTitle();
Â  Â  Â  Â  loadNames(); 
Â  Â  Â  Â  initializeEventListeners();
Â  Â  Â  Â  setupInitialTableState(); 
Â  Â  Â  Â  renderNameList(); 
Â  Â  Â  Â  rebuildAndRenderSummary(); 
Â  Â  });

Â  Â  function setupInitialTableState() {
Â  Â  Â  Â  const existingTables = tablesContainer.querySelectorAll('table');
Â  Â  Â  Â  if (existingTables.length > 0) {
Â  Â  Â  Â  Â  Â  tableTabs.innerHTML = ''; 
Â  Â  Â  Â  Â  Â  existingTables.forEach((table, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const tableId = table.id || `tbl_init_${Date.now()}_${index + 1}`; 
Â  Â  Â  Â  Â  Â  Â  Â  table.id = tableId;
Â  Â  Â  Â  Â  Â  Â  Â  const tableName = table.dataset.tableName || `Table ${index + 1}`;
Â  Â  Â  Â  Â  Â  Â  Â  table.dataset.tableName = tableName; 
Â  Â  Â  Â  Â  Â  Â  Â  addTabButton(tableId, tableName);
Â  Â  Â  Â  Â  Â  Â  Â  if (index === 0) activeTableId = tableId;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else { addNewTable(true); }
Â  Â  Â  Â  if (activeTableId && document.getElementById(activeTableId)) switchTable(activeTableId);
Â  Â  Â  Â  else if (tablesContainer.querySelector('table')) switchTable(tablesContainer.querySelector('table').id);
Â  Â  }
Â  Â  
Â  Â  function loadScheduleTitle() {
Â  Â  Â  Â  const savedTitle = localStorage.getItem(SCHEDULE_TITLE_KEY);
Â  Â  Â  Â  if (savedTitle && scheduleTitleElement) scheduleTitleElement.textContent = savedTitle;
Â  Â  Â  Â  if (scheduleTitleElement) {
Â  Â  Â  Â  Â  Â  scheduleTitleElement.addEventListener('blur', () => {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(SCHEDULE_TITLE_KEY, scheduleTitleElement.textContent);
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('Schedule title saved!', 'success');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- Event Listener Initialization ---
Â  Â  function initializeEventListeners() {
Â  Â  Â  Â  directCopyFullHtmlButtonElement.addEventListener('click', attemptDirectCopyToClipboard);
Â  Â  Â  Â  closeNameModalButtonStandardElement.addEventListener('click', toggleNameListModalVisibility);

Â  Â  Â  Â  document.getElementById('excelBtnTrigger').addEventListener('click', exportActiveTableToExcel);
Â  Â  Â  Â  document.getElementById('importExcelBtn').addEventListener('click', () => fileInputElement.click()); 
Â  Â  Â  Â  fileInputElement.addEventListener('change', handleExcelFileImport);
Â  Â  Â  Â  
Â  Â  Â  Â  document.getElementById('saveDraftBtn').addEventListener('click', promptAndSaveDraft);
Â  Â  Â  Â  document.getElementById('loadDraftBtn').addEventListener('click', toggleDraftListVisibility);
Â  Â  Â  Â  document.getElementById('clearDraft').addEventListener('click', confirmAndClearAllDrafts);

Â  Â  Â  Â  document.getElementById('selectBtn').addEventListener('click', toggleCellSelectionMode);
Â  Â  Â  Â  document.getElementById('mergeBtn').addEventListener('click', mergeSelectedTableCells);
Â  Â  Â  Â  document.getElementById('deselectBtn').addEventListener('click', deselectAllTableCells);
Â  Â  Â  Â  document.getElementById('unmergeBtn').addEventListener('click', unmergeActiveCellIfMerged);

Â  Â  Â  Â  document.getElementById('addTableBtn').addEventListener('click', () => addNewTable());
Â  Â  Â  Â  document.getElementById('renameTableBtn').addEventListener('click', promptAndRenameActiveTable);
Â  Â  Â  Â  document.getElementById('deleteTableBtn').addEventListener('click', confirmAndDeleteActiveTable);
Â  Â  Â  Â  document.getElementById('nameListBtn').addEventListener('click', toggleNameListModalVisibility);

Â  Â  Â  Â  const rowColBar = document.getElementById('rowColManipulationBar');
Â  Â  Â  Â  if (rowColBar) {
Â  Â  Â  Â  Â  Â  const buttons = rowColBar.getElementsByTagName('button');
Â  Â  Â  Â  Â  Â  if (buttons[0]) buttons[0].addEventListener('click', addRowAboveToActiveTable);
Â  Â  Â  Â  Â  Â  if (buttons[1]) buttons[1].addEventListener('click', addRowBelowToActiveTable);
Â  Â  Â  Â  Â  Â  if (buttons[2]) buttons[2].addEventListener('click', addColumnLeftToActiveTable);
Â  Â  Â  Â  Â  Â  if (buttons[3]) buttons[3].addEventListener('click', addColumnRightToActiveTable);
Â  Â  Â  Â  }

Â  Â  Â  Â  document.getElementById('addNameBtnInModal').addEventListener('click', addNewNameToList);

Â  Â  Â  Â  draftListElement.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  const targetSpan = e.target.closest('.draft-item span');
Â  Â  Â  Â  Â  Â  const targetButton = e.target.closest('.draft-item button');
Â  Â  Â  Â  Â  Â  if (targetSpan) loadSelectedDraft(targetSpan.textContent);
Â  Â  Â  Â  Â  Â  else if (targetButton) confirmAndDeleteDraft(targetButton.parentElement.querySelector('span').textContent);
Â  Â  Â  Â  });

Â  Â  Â  Â  nameListContainer.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  const nameItemSpan = e.target.closest('.name-item span[data-name]');
Â  Â  Â  Â  Â  Â  const deleteButton = e.target.closest('.name-item button');
Â  Â  Â  Â  Â  Â  if (nameItemSpan) selectNameForCellInsertion(nameItemSpan.dataset.name);
Â  Â  Â  Â  Â  Â  else if (deleteButton) deleteNameFromListAndStorage(deleteButton.parentElement.querySelector('span[data-name]').dataset.name);
Â  Â  Â  Â  });

Â  Â  Â  Â  tablesContainer.addEventListener('click', handleTableCellClick);
Â  Â  Â  Â  tablesContainer.addEventListener('blur', (e) => { 
Â  Â  Â  Â  Â  Â  if ((e.target.tagName === 'TD' || e.target.tagName === 'TH') && e.target.isContentEditable) {
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(rebuildAndRenderSummary, 0); 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, true); 
Â  Â  Â  Â  tablesContainer.addEventListener('input', (e) => { 
Â  Â  Â  Â  Â  Â  if ((e.target.tagName === 'TD' || e.target.tagName === 'TH') && e.target.isContentEditable) {
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(rebuildAndRenderSummary, 300); 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  window.addEventListener('click', (event) => { // Close Name modal if clicked outside
Â  Â  Â  Â  Â  Â  if (event.target === nameModal) nameModal.style.display = 'none';
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- Direct Copy Full HTML Functionality ---
Â  Â  async function attemptDirectCopyToClipboard() {
Â  Â  Â  Â  const fullHtml = document.documentElement.outerHTML;
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // Try modern clipboard API first
Â  Â  Â  Â  Â  Â  await navigator.clipboard.writeText(fullHtml);
Â  Â  Â  Â  Â  Â  showMessage('Full HTML copied to clipboard!', 'success');
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  console.warn('navigator.clipboard.writeText failed, trying execCommand: ', err);
Â  Â  Â  Â  Â  Â  // Fallback to execCommand
Â  Â  Â  Â  Â  Â  const textarea = document.createElement('textarea');
Â  Â  Â  Â  Â  Â  textarea.value = fullHtml;
Â  Â  Â  Â  Â  Â  textarea.style.position = 'fixed'; // Prevent scrolling to bottom
Â  Â  Â  Â  Â  Â  textarea.style.left = '-9999px'; // Move off-screen
Â  Â  Â  Â  Â  Â  document.body.appendChild(textarea);
Â  Â  Â  Â  Â  Â  textarea.select();
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const successful = document.execCommand('copy');
Â  Â  Â  Â  Â  Â  Â  Â  if (successful) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage('Full HTML copied! (using fallback method)', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage('Direct copy failed. Please try copying manually.', 'error', 5000);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (execErr) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('execCommand copy failed: ', execErr);
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('Direct copy failed. Please try copying manually.', 'error', 5000);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.body.removeChild(textarea);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- Draft Management ---
Â  Â  function promptAndSaveDraft() {
Â  Â  Â  Â  if (tablesContainer.children.length === 0) { showMessage('No schedule data to save.', 'error'); return; }
Â  Â  Â  Â  const allTablesData = tablesContainer.innerHTML; 
Â  Â  Â  Â  const allTableMeta = {}; 
Â  Â  Â  Â  tablesContainer.querySelectorAll('table').forEach(table => {
Â  Â  Â  Â  Â  Â  allTableMeta[table.id] = { name: table.dataset.tableName || table.id };
Â  Â  Â  Â  });
Â  Â  Â  Â  const draftName = customPrompt('Enter draft name:', `Draft ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`);
Â  Â  Â  Â  if (draftName) {
Â  Â  Â  Â  Â  Â  const drafts = JSON.parse(localStorage.getItem(DRAFTS_KEY) || '{}');
Â  Â  Â  Â  Â  Â  drafts[draftName] = { html: allTablesData, meta: allTableMeta, active: activeTableId };
Â  Â  Â  Â  Â  Â  localStorage.setItem(DRAFTS_KEY, JSON.stringify(drafts));
Â  Â  Â  Â  Â  Â  showMessage(`Draft "${draftName}" saved!`, 'success');
Â  Â  Â  Â  Â  Â  if (draftListElement.style.display === 'block') renderDraftList(); 
Â  Â  Â  Â  }
Â  Â  }
Â  Â  function toggleDraftListVisibility() {
Â  Â  Â  Â  const isVisible = draftListElement.style.display === 'block';
Â  Â  Â  Â  draftListElement.style.display = isVisible ? 'none' : 'block';
Â  Â  Â  Â  if (!isVisible) renderDraftList(); 
Â  Â  }
Â  Â  function renderDraftList() {
Â  Â  Â  Â  draftListElement.innerHTML = ''; 
Â  Â  Â  Â  const drafts = JSON.parse(localStorage.getItem(DRAFTS_KEY) || '{}');
Â  Â  Â  Â  if (Object.keys(drafts).length === 0) { draftListElement.innerHTML = '<p>No drafts saved yet.</p>'; return; }
Â  Â  Â  Â  for (const name in drafts) {
Â  Â  Â  Â  Â  Â  const itemDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  itemDiv.className = 'draft-item';
Â  Â  Â  Â  Â  Â  itemDiv.innerHTML = `<span>${name}</span><button>Delete</button>`;
Â  Â  Â  Â  Â  Â  draftListElement.appendChild(itemDiv);
Â  Â  Â  Â  }
Â  Â  }
Â  Â  function loadSelectedDraft(draftName) {
Â  Â  Â  Â  const drafts = JSON.parse(localStorage.getItem(DRAFTS_KEY) || '{}');
Â  Â  Â  Â  if (drafts[draftName]) {
Â  Â  Â  Â  Â  Â  tablesContainer.innerHTML = drafts[draftName].html;
Â  Â  Â  Â  Â  Â  const tableMeta = drafts[draftName].meta || {};
Â  Â  Â  Â  Â  Â  tableTabs.innerHTML = ''; 
Â  Â  Â  Â  Â  Â  tablesContainer.querySelectorAll('table').forEach(table => {
Â  Â  Â  Â  Â  Â  Â  Â  const id = table.id;
Â  Â  Â  Â  Â  Â  Â  Â  const metaInfo = tableMeta[id] || {}; 
Â  Â  Â  Â  Â  Â  Â  Â  const name = metaInfo.name || `Table ${tableTabs.children.length + 1}`; 
Â  Â  Â  Â  Â  Â  Â  Â  table.dataset.tableName = name; 
Â  Â  Â  Â  Â  Â  Â  Â  addTabButton(id, name);
Â  Â  Â  Â  Â  Â  Â  Â  table.querySelectorAll('td, th').forEach(cell => cell.contentEditable = 'true');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  activeTableId = drafts[draftName].active || tablesContainer.querySelector('table')?.id || 'tbl_1'; 
Â  Â  Â  Â  Â  Â  if (document.getElementById(activeTableId)) switchTable(activeTableId);
Â  Â  Â  Â  Â  Â  else if (tablesContainer.querySelector('table')) switchTable(tablesContainer.querySelector('table').id);
Â  Â  Â  Â  Â  Â  else addNewTable(true);
Â  Â  Â  Â  Â  Â  showMessage(`Draft "${draftName}" loaded!`, 'success');
Â  Â  Â  Â  Â  Â  draftListElement.style.display = 'none'; 
Â  Â  Â  Â  Â  Â  rebuildAndRenderSummary();
Â  Â  Â  Â  } else { showMessage(`Draft "${draftName}" not found.`, 'error'); }
Â  Â  }
Â  Â  function confirmAndDeleteDraft(draftName) {
Â  Â  Â  Â  if (customConfirm(`Are you sure you want to delete draft "${draftName}"?`)) {
Â  Â  Â  Â  Â  Â  const drafts = JSON.parse(localStorage.getItem(DRAFTS_KEY) || '{}');
Â  Â  Â  Â  Â  Â  delete drafts[draftName];
Â  Â  Â  Â  Â  Â  localStorage.setItem(DRAFTS_KEY, JSON.stringify(drafts));
Â  Â  Â  Â  Â  Â  showMessage(`Draft "${draftName}" deleted.`, 'success');
Â  Â  Â  Â  Â  Â  renderDraftList(); 
Â  Â  Â  Â  }
Â  Â  }
Â  Â  function confirmAndClearAllDrafts() {
Â  Â  Â  Â  if (customConfirm('Are you sure you want to delete ALL drafts? This cannot be undone.')) {
Â  Â  Â  Â  Â  Â  localStorage.removeItem(DRAFTS_KEY);
Â  Â  Â  Â  Â  Â  showMessage('All drafts cleared!', 'success');
Â  Â  Â  Â  Â  Â  renderDraftList(); 
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- Table Management ---
Â  Â  function addTabButton(id, label) {
Â  Â  Â  Â  const button = document.createElement('button');
Â  Â  Â  Â  button.textContent = label;
Â  Â  Â  Â  button.onclick = () => switchTable(id); 
Â  Â  Â  Â  tableTabs.appendChild(button);
Â  Â  Â  Â  return button;
Â  Â  }
Â  Â  function switchTable(id) {
Â  Â  Â  Â  const targetTable = document.getElementById(id);
Â  Â  Â  Â  if (!targetTable) {
Â  Â  Â  Â  Â  Â  const firstTableInDOM = tablesContainer.querySelector('table');
Â  Â  Â  Â  Â  Â  if (firstTableInDOM) id = firstTableInDOM.id;
Â  Â  Â  Â  Â  Â  else { 
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('Cannot switch: Target table not found.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  if (tablesContainer.children.length === 0) addNewTable(true); 
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  activeTableId = id;
Â  Â  Â  Â  tablesContainer.querySelectorAll('table').forEach(t => t.classList.toggle('active', t.id === id));
Â  Â  Â  Â  tableTabs.querySelectorAll('button').forEach(b => b.classList.toggle('active', b.getAttribute('onclick').includes(`'${id}'`)));
Â  Â  Â  Â  deselectAllTableCells(); 
Â  Â  Â  Â  rebuildAndRenderSummary(); 
Â  Â  }
Â  Â  function addNewTable(isInitial = false) {
Â  Â  Â  Â  tableCount++; 
Â  Â  Â  Â  const defaultTableName = `Schedule ${tableTabs.children.length + 1}`;
Â  Â  Â  Â  const label = isInitial ? defaultTableName : customPrompt('Enter new table name:', defaultTableName);
Â  Â  Â  Â  if (!label && !isInitial) return; 
Â  Â  Â  Â  const newTable = document.createElement('table');
Â  Â  Â  Â  const newTableId = `tbl_${Date.now()}_${tableCount}`; 
Â  Â  Â  Â  newTable.id = newTableId;
Â  Â  Â  Â  newTable.dataset.tableName = label || defaultTableName; 
Â  Â  Â  Â  const thead = newTable.createTHead();
Â  Â  Â  Â  const headerRow = thead.insertRow();
Â  Â  Â  Â  ['Period/Subject', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri'].forEach(text => {
Â  Â  Â  Â  Â  Â  const th = document.createElement('th');
Â  Â  Â  Â  Â  Â  th.contentEditable = 'true'; th.textContent = text; headerRow.appendChild(th);
Â  Â  Â  Â  });
Â  Â  Â  Â  const tbody = newTable.createTBody();
Â  Â  Â  Â  for (let r = 0; r < 2; r++) { 
Â  Â  Â  Â  Â  Â  const dataRow = tbody.insertRow();
Â  Â  Â  Â  Â  Â  for (let c = 0; c < headerRow.cells.length; c++) {
Â  Â  Â  Â  Â  Â  Â  Â  const td = dataRow.insertCell();
Â  Â  Â  Â  Â  Â  Â  Â  td.contentEditable = 'true';
Â  Â  Â  Â  Â  Â  Â  Â  if (c === 0) td.textContent = `Sample Row ${r+1}`; 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  tablesContainer.appendChild(newTable);
Â  Â  Â  Â  addTabButton(newTableId, label || defaultTableName);
Â  Â  Â  Â  switchTable(newTableId); 
Â  Â  Â  Â  if (!isInitial) showMessage(`Table "${label || defaultTableName}" added.`, 'success');
Â  Â  }
Â  Â  function promptAndRenameActiveTable() {
Â  Â  Â  Â  const currentTab = tableTabs.querySelector(`button.active`);
Â  Â  Â  Â  if (!currentTab) { showMessage('No active table to rename.', 'error'); return; }
Â  Â  Â  Â  const oldName = currentTab.textContent;
Â  Â  Â  Â  const newName = customPrompt('Enter new table name:', oldName);
Â  Â  Â  Â  if (newName && newName.trim() !== oldName) {
Â  Â  Â  Â  Â  Â  currentTab.textContent = newName.trim();
Â  Â  Â  Â  Â  Â  const tableElement = document.getElementById(activeTableId);
Â  Â  Â  Â  Â  Â  if (tableElement) tableElement.dataset.tableName = newName.trim(); 
Â  Â  Â  Â  Â  Â  showMessage(`Table renamed to "${newName.trim()}".`, 'success');
Â  Â  Â  Â  }
Â  Â  }
Â  Â  function confirmAndDeleteActiveTable() {
Â  Â  Â  Â  if (tablesContainer.children.length <= 1) { showMessage('Cannot delete the last table.', 'error'); return; }
Â  Â  Â  Â  const activeTab = tableTabs.querySelector(`button.active`);
Â  Â  Â  Â  const tableName = activeTab ? activeTab.textContent : activeTableId; 
Â  Â  Â  Â  if (customConfirm(`Delete table "${tableName}"?`)) {
Â  Â  Â  Â  Â  Â  document.getElementById(activeTableId)?.remove(); 
Â  Â  Â  Â  Â  Â  activeTab?.remove(); 
Â  Â  Â  Â  Â  Â  const firstRemainingTab = tableTabs.querySelector('button');
Â  Â  Â  Â  Â  Â  if (firstRemainingTab) firstRemainingTab.click(); 
Â  Â  Â  Â  Â  Â  else { activeTableId = null; addNewTable(true); }
Â  Â  Â  Â  Â  Â  showMessage('Table deleted.', 'success');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- Row/Column Operations ---
Â  Â  function addRowToTable(tableBody, rowIndex, numCols) {
Â  Â  Â  Â  const row = tableBody.insertRow(rowIndex);
Â  Â  Â  Â  for (let i = 0; i < numCols; i++) { const cell = row.insertCell(); cell.contentEditable = 'true'; }
Â  Â  }
Â  Â  function addRowAboveToActiveTable() {
Â  Â  Â  Â  const table = document.getElementById(activeTableId);
Â  Â  Â  Â  if (!table || !table.tBodies[0] || table.rows.length === 0) return;
Â  Â  Â  Â  addRowToTable(table.tBodies[0], 0, table.rows[0].cells.length); 
Â  Â  Â  Â  rebuildAndRenderSummary();
Â  Â  }
Â  Â  function addRowBelowToActiveTable() {
Â  Â  Â  Â  const table = document.getElementById(activeTableId);
Â  Â  Â  Â  if (!table || !table.tBodies[0] || table.rows.length === 0) return;
Â  Â  Â  Â  addRowToTable(table.tBodies[0], -1, table.rows[0].cells.length); 
Â  Â  Â  Â  rebuildAndRenderSummary();
Â  Â  }
Â  Â  function addColumnToTable(table, colIndex) {
Â  Â  Â  Â  for (const row of table.rows) {
Â  Â  Â  Â  Â  Â  const isHeaderRow = row.parentElement.tagName === 'THEAD';
Â  Â  Â  Â  Â  Â  const cell = isHeaderRow ? document.createElement('th') : row.insertCell(colIndex === -1 ? row.cells.length : colIndex);
Â  Â  Â  Â  Â  Â  cell.contentEditable = 'true';
Â  Â  Â  Â  Â  Â  if (isHeaderRow) {
 Â  Â  Â  Â  Â  Â  Â  Â  if (colIndex === -1 || colIndex >= row.cells.length) row.appendChild(cell); else row.insertBefore(cell, row.cells[colIndex]);
 Â  Â  Â  Â  Â  Â  Â  Â  cell.textContent = "New Col"; 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
Â  Â  function addColumnLeftToActiveTable() {
Â  Â  Â  Â  const table = document.getElementById(activeTableId);
Â  Â  Â  Â  if (table) { addColumnToTable(table, 0); rebuildAndRenderSummary(); }
Â  Â  }
Â  Â  function addColumnRightToActiveTable() {
Â  Â  Â  Â  const table = document.getElementById(activeTableId);
Â  Â  Â  Â  if (table) { addColumnToTable(table, -1); rebuildAndRenderSummary(); }
Â  Â  }

Â  Â  // --- Cell Selection, Merging, Unmerging ---
Â  Â  function toggleCellSelectionMode() {
Â  Â  Â  Â  selectionMode = !selectionMode;
Â  Â  Â  Â  const btn = document.getElementById('selectBtn');
Â  Â  Â  Â  btn.classList.toggle('active', selectionMode);
Â  Â  Â  Â  btn.textContent = selectionMode ? 'âœ¨ Selecting...' : 'âœ¨ Select Cells';
Â  Â  Â  Â  if (!selectionMode) deselectAllTableCells();
Â  Â  }
Â  Â  function handleTableCellClick(event) {
Â  Â  Â  Â  const cell = event.target.closest('td, th'); 
Â  Â  Â  Â  if (!cell || !cell.closest(`#${activeTableId}`)) return; 
Â  Â  Â  Â  if (selectedNameFromList) { 
Â  Â  Â  Â  Â  Â  if (cell.tagName === 'TD' || (cell.tagName === 'TH' && cell.closest('tbody'))) {
Â  Â  Â  Â  Â  Â  Â  Â  cell.textContent = selectedNameFromList;
Â  Â  Â  Â  Â  Â  Â  Â  nameListContainer.querySelector('.highlighted')?.classList.remove('highlighted'); 
Â  Â  Â  Â  Â  Â  Â  Â  selectedNameFromList = null; 
Â  Â  Â  Â  Â  Â  Â  Â  rebuildAndRenderSummary(); 
Â  Â  Â  Â  Â  Â  Â  Â  toggleNameListModalVisibility(); 
Â  Â  Â  Â  Â  Â  } else { showMessage('Click an editable data cell to insert name.', 'info'); }
Â  Â  Â  Â  Â  Â  return; 
Â  Â  Â  Â  }
Â  Â  Â  Â  if (selectionMode) { 
Â  Â  Â  Â  Â  Â  cell.classList.toggle('selected');
Â  Â  Â  Â  Â  Â  if (cell.classList.contains('selected')) selectedCells.push(cell);
Â  Â  Â  Â  Â  Â  else selectedCells = selectedCells.filter(c => c !== cell);
Â  Â  Â  Â  }
Â  Â  }
Â  Â  function deselectAllTableCells() {
Â  Â  Â  Â  selectedCells.forEach(c => c.classList.remove('selected'));
Â  Â  Â  Â  selectedCells = [];
Â  Â  }
Â  Â  function mergeSelectedTableCells() {
Â  Â  Â  Â  if (selectedCells.length < 2) { showMessage('Select at least two cells to merge.', 'error'); return; }
Â  Â  Â  Â  const table = document.getElementById(activeTableId);
Â  Â  Â  Â  let minR = Infinity, maxR = -Infinity, minC = Infinity, maxC = -Infinity;
Â  Â  Â  Â  selectedCells.forEach(cell => {
Â  Â  Â  Â  Â  Â  const r = cell.parentNode.rowIndex; const c = cell.cellIndex;Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  minR = Math.min(minR, r); maxR = Math.max(maxR, r + (cell.rowSpan || 1) - 1); 
Â  Â  Â  Â  Â  Â  minC = Math.min(minC, c); maxC = Math.max(maxC, c + (cell.colSpan || 1) - 1); 
Â  Â  Â  Â  });
Â  Â  Â  Â  const firstCell = table.rows[minR]?.cells[minC]; 
Â  Â  Â  Â  if (!firstCell) { showMessage('Error finding merge starting cell.', 'error'); return; }
Â  Â  Â  Â  let contentToKeep = firstCell.innerHTML; 
Â  Â  Â  Â  let cellsToRemove = [];
Â  Â  Â  Â  for (let r = minR; r <= maxR; r++) {
Â  Â  Â  Â  Â  Â  for (let c = minC; c <= maxC; c++) {
Â  Â  Â  Â  Â  Â  Â  Â  if (table.rows[r]?.cells[c]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentCell = table.rows[r].cells[c];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentCell !== firstCell && selectedCells.includes(currentCell)) cellsToRemove.push(currentCell);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  cellsToRemove.forEach(cell => cell.remove()); 
Â  Â  Â  Â  firstCell.rowSpan = maxR - minR + 1; firstCell.colSpan = maxC - minC + 1;
Â  Â  Â  Â  firstCell.innerHTML = contentToKeep; firstCell.classList.add('merged');
Â  Â  Â  Â  deselectAllTableCells(); 
Â  Â  Â  Â  if (selectionMode) toggleCellSelectionMode(); 
Â  Â  Â  Â  rebuildAndRenderSummary(); showMessage('Cells merged.', 'success');
Â  Â  }
Â  Â  function unmergeActiveCellIfMerged() {
Â  Â  Â  Â  const activeCell = document.activeElement; 
Â  Â  Â  Â  if (activeCell && (activeCell.tagName === 'TD' || activeCell.tagName === 'TH') && (activeCell.rowSpan > 1 || activeCell.colSpan > 1) && activeCell.closest(`#${activeTableId}`)) {
Â  Â  Â  Â  Â  Â  unmergeGivenCell(activeCell);
Â  Â  Â  Â  } else if (selectedCells.length === 1 && (selectedCells[0].rowSpan > 1 || selectedCells[0].colSpan > 1)) {
 Â  Â  Â  Â  Â  Â  unmergeGivenCell(selectedCells[0]);
Â  Â  Â  Â  } else { showMessage('Click on a merged cell or select a single merged cell to unmerge.', 'error'); }
Â  Â  }
Â  Â  function unmergeGivenCell(cellToUnmerge) {
Â  Â  Â  Â  const table = cellToUnmerge.closest('table'); if (!table) return; 
Â  Â  Â  Â  const rSpan = cellToUnmerge.rowSpan || 1; const cSpan = cellToUnmerge.colSpan || 1;
Â  Â  Â  Â  if (rSpan === 1 && cSpan === 1) { showMessage('Cell is not merged.', 'info'); return; }
Â  Â  Â  Â  const startRowIndex = cellToUnmerge.parentNode.rowIndex; const startCellIndex = cellToUnmerge.cellIndex;
Â  Â  Â  Â  cellToUnmerge.rowSpan = 1; cellToUnmerge.colSpan = 1; cellToUnmerge.classList.remove('merged');
Â  Â  Â  Â  for (let r = 0; r < rSpan; r++) {
Â  Â  Â  Â  Â  Â  for (let c = 0; c < cSpan; c++) {
Â  Â  Â  Â  Â  Â  Â  Â  if (r === 0 && c === 0) continue; 
Â  Â  Â  Â  Â  Â  Â  Â  const targetRow = table.rows[startRowIndex + r];
Â  Â  Â  Â  Â  Â  Â  Â  if (targetRow) { const newCell = targetRow.insertCell(startCellIndex + c); newCell.contentEditable = 'true'; }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  deselectAllTableCells(); rebuildAndRenderSummary(); showMessage('Cell unmerged.', 'success');
Â  Â  }

Â  Â  // --- Name List Management (Modal) ---
Â  Â  function loadNames() { names = JSON.parse(localStorage.getItem(NAMES_KEY) || '["Teacher A", "Subject B", "Class C"]'); }
Â  Â  function saveNames() { localStorage.setItem(NAMES_KEY, JSON.stringify(names)); }
Â  Â  function toggleNameListModalVisibility() {
Â  Â  Â  Â  nameModal.style.display = nameModal.style.display === 'flex' ? 'none' : 'flex'; 
Â  Â  Â  Â  if (nameModal.style.display === 'flex') { renderNameList(); newNameInput.focus(); }
Â  Â  }
Â  Â  function renderNameList() {
Â  Â  Â  Â  nameListContainer.innerHTML = ''; 
Â  Â  Â  Â  if (names.length === 0) { nameListContainer.innerHTML = '<p>No names. Add some!</p>'; return; }
Â  Â  Â  Â  names.forEach(name => {
Â  Â  Â  Â  Â  Â  const itemDiv = document.createElement('div'); itemDiv.className = 'name-item';
Â  Â  Â  Â  Â  Â  itemDiv.innerHTML = `<span data-name="${name}">${name}</span><button>Delete</button>`;
Â  Â  Â  Â  Â  Â  nameListContainer.appendChild(itemDiv);
Â  Â  Â  Â  });
Â  Â  }
Â  Â  function addNewNameToList() {
Â  Â  Â  Â  const newName = newNameInput.value.trim();
Â  Â  Â  Â  if (!newName) { showMessage('Enter a name.', 'error'); return; }
Â  Â  Â  Â  if (names.includes(newName)) { showMessage('Name already exists.', 'error'); return; }
Â  Â  Â  Â  names.push(newName); saveNames(); renderNameList();
Â  Â  Â  Â  newNameInput.value = ''; newNameInput.focus(); 
Â  Â  Â  Â  rebuildAndRenderSummary(); showMessage(`"${newName}" added.`, 'success');
Â  Â  }
Â  Â  function deleteNameFromListAndStorage(nameToDelete) {
Â  Â  Â  Â  if (customConfirm(`Delete "${nameToDelete}"?`)) {
Â  Â  Â  Â  Â  Â  names = names.filter(n => n !== nameToDelete); saveNames(); renderNameList();
Â  Â  Â  Â  Â  Â  rebuildAndRenderSummary(); showMessage(`"${nameToDelete}" removed.`, 'success');
Â  Â  Â  Â  }
Â  Â  }
Â  Â  function selectNameForCellInsertion(name) {
Â  Â  Â  Â  nameListContainer.querySelectorAll('.name-item span').forEach(s => s.classList.remove('highlighted'));
Â  Â  Â  Â  nameListContainer.querySelector(`.name-item span[data-name="${name}"]`)?.classList.add('highlighted');
Â  Â  Â  Â  selectedNameFromList = name; 
Â  Â  Â  Â  showMessage(`Selected "${name}". Click cell to insert.`, 'info');
Â  Â  }

Â  Â  // --- Excel Export/Import ---
Â  Â  function handleExcelFileImport(event) {
Â  Â  Â  Â  const file = event.target.files[0]; if (!file) return;
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = (e) => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
Â  Â  Â  Â  Â  Â  Â  Â  const sheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[sheetName];
Â  Â  Â  Â  Â  Â  Â  Â  const htmlTableString = XLSX.utils.sheet_to_html(worksheet, { editable: true, raw: false });
Â  Â  Â  Â  Â  Â  Â  Â  tableCount++; 
Â  Â  Â  Â  Â  Â  Â  Â  const newTableId = `tbl_imported_${Date.now()}_${tableCount}`;
Â  Â  Â  Â  Â  Â  Â  Â  const importedTableName = file.name.replace(/\.xlsx?/i, '') || `Imported ${tableCount}`;
Â  Â  Â  Â  Â  Â  Â  Â  const tempDiv = document.createElement('div'); tempDiv.innerHTML = htmlTableString;
Â  Â  Â  Â  Â  Â  Â  Â  const importedTableElement = tempDiv.querySelector('table');
Â  Â  Â  Â  Â  Â  Â  Â  if (importedTableElement) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importedTableElement.id = newTableId; importedTableElement.dataset.tableName = importedTableName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importedTableElement.querySelectorAll('td, th').forEach(cell => cell.contentEditable = 'true');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tablesContainer.appendChild(importedTableElement); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addTabButton(newTableId, importedTableName); switchTable(newTableId); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage('Excel data imported into a new table!', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  } else { showMessage('Could not parse table from Excel.', 'error'); }
Â  Â  Â  Â  Â  Â  } catch (error) { console.error("Excel import error:", error); showMessage('Error processing Excel file.', 'error'); }
Â  Â  Â  Â  Â  Â  finally { event.target.value = ''; }
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.readAsArrayBuffer(file);
Â  Â  }
Â  Â  function exportActiveTableToExcel() {
Â  Â  Â  Â  const tableToExport = document.getElementById(activeTableId);
Â  Â  Â  Â  if (!tableToExport) { showMessage('No active table to export.', 'error'); return; }
Â  Â  Â  Â  const tableName = tableToExport.dataset.tableName || activeTableId; 
Â  Â  Â  Â  const wb = XLSX.utils.table_to_book(tableToExport, { sheet: tableName });
Â  Â  Â  Â  XLSX.writeFile(wb, `${tableName}_${new Date().toISOString().split('T')[0]}.xlsx`);
Â  Â  Â  Â  showMessage(`Table "${tableName}" exported.`, 'success');
Â  Â  }

Â  Â  // --- Summary Table Logic ---
Â  Â  function rebuildAndRenderSummary() { buildSummaryTableSkeleton(); updateSummaryTableData(); }
Â  Â  function buildSummaryTableSkeleton() {
Â  Â  Â  Â  if (!summaryTableElement) { console.error("Summary table element not found."); return; }
Â  Â  Â  Â  summaryTableElement.innerHTML = ''; 
Â  Â  Â  Â  const summaryRowItems = new Set(names); 
Â  Â  Â  Â  tablesContainer.querySelectorAll('table').forEach(table => {
Â  Â  Â  Â  Â  Â  table.querySelectorAll('tbody tr').forEach(dataRow => {
Â  Â  Â  Â  Â  Â  Â  Â  Array.from(dataRow.cells).forEach((cell, cellIndex) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cellIndex > 0) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const text = cell.textContent.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (text && isNaN(text) && text.length > 1) summaryRowItems.add(text);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  Â  const sortedSummaryRowHeaders = Array.from(summaryRowItems).sort();
Â  Â  Â  Â  const activeScheduleTable = document.getElementById(activeTableId);
Â  Â  Â  Â  let summaryColumnHeaders = ['Name/Subject']; 
Â  Â  Â  Â  if (activeScheduleTable?.tHead?.rows.length > 0) {
Â  Â  Â  Â  Â  Â  summaryColumnHeaders.push(...Array.from(activeScheduleTable.tHead.rows[0].cells).slice(1).map(th => th.textContent.trim() || 'Period')); 
Â  Â  Â  Â  } else { summaryColumnHeaders.push('Period 1', 'Period 2', 'Period 3', 'Period 4', 'Period 5'); }
Â  Â  Â  Â  const thead = summaryTableElement.createTHead();
Â  Â  Â  Â  const headerRowForSummary = thead.insertRow();
Â  Â  Â  Â  summaryColumnHeaders.forEach(headerText => { const th = document.createElement('th'); th.textContent = headerText; headerRowForSummary.appendChild(th); });
Â  Â  Â  Â  const tbody = summaryTableElement.createTBody();
Â  Â  Â  Â  if (sortedSummaryRowHeaders.length === 0) {
Â  Â  Â  Â  Â  Â  const tr = tbody.insertRow(); const td = tr.insertCell();
Â  Â  Â  Â  Â  Â  td.colSpan = summaryColumnHeaders.length || 1; 
Â  Â  Â  Â  Â  Â  td.textContent = 'No items to summarize.'; td.style.textAlign = 'center'; td.style.padding = '10px';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  sortedSummaryRowHeaders.forEach(name => {
Â  Â  Â  Â  Â  Â  Â  Â  const tr = tbody.insertRow(); tr.insertCell().textContent = name; 
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 1; i < summaryColumnHeaders.length; i++) tr.insertCell().textContent = ''; 
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  }
Â  Â  function updateSummaryTableData() {
Â  Â  Â  Â  if (!summaryTableElement?.tBodies[0] || summaryTableElement.tBodies[0].rows.length === 0) {
Â  Â  Â  Â  Â  Â  buildSummaryTableSkeleton(); 
Â  Â  Â  Â  Â  Â  if (!summaryTableElement?.tBodies[0] || summaryTableElement.tBodies[0].rows.length === 0 || (summaryTableElement.tBodies[0].rows[0].cells.length === 1 && summaryTableElement.tBodies[0].rows[0].cells[0].colSpan > 1) ) return; 
Â  Â  Â  Â  }
Â  Â  Â  Â  const summaryBody = summaryTableElement.tBodies[0];
Â  Â  Â  Â  const summaryTableActualColumnHeaders = Array.from(summaryTableElement.tHead.rows[0].cells).map(th => th.textContent.trim());
Â  Â  Â  Â  Array.from(summaryBody.rows).forEach(summaryRow => Array.from(summaryRow.cells).slice(1).forEach(cell => cell.textContent = '')); 
Â  Â  Â  Â  const activeScheduleTable = document.getElementById(activeTableId);
Â  Â  Â  Â  if (!activeScheduleTable || !activeScheduleTable.tHead?.rows.length > 0 || !activeScheduleTable.tBodies[0]) { console.warn("Active schedule table not found/malformed for summary."); return; }
Â  Â  Â  Â  const activeScheduleTableHeaders = Array.from(activeScheduleTable.tHead.rows[0].cells).map(th => th.textContent.trim());
Â  Â  Â  Â  Array.from(activeScheduleTable.tBodies[0].rows).forEach(scheduleDataRow => {
Â  Â  Â  Â  Â  Â  Array.from(scheduleDataRow.cells).forEach((scheduleCell, scheduleCellIndex) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (scheduleCellIndex === 0) return; 
Â  Â  Â  Â  Â  Â  Â  Â  const entryInScheduleCell = scheduleCell.textContent.trim(); 
Â  Â  Â  Â  Â  Â  Â  Â  if (entryInScheduleCell) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const targetSummaryRow = Array.from(summaryBody.rows).find(sr => sr.cells[0]?.textContent === entryInScheduleCell);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (targetSummaryRow) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentScheduleColumnHeader = activeScheduleTableHeaders[scheduleCellIndex];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const targetSummaryColumnCellIndex = summaryTableActualColumnHeaders.findIndex(h => h === currentScheduleColumnHeader);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (targetSummaryColumnCellIndex > 0) targetSummaryRow.cells[targetSummaryColumnCellIndex].textContent += 'âœ±'; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  }
</script>
</body>
</html>
