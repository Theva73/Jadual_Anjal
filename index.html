<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Weekly Schedule</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  /* ====== BASIC LAYOUT ====== */
  body{font-family:Arial,Helvetica,sans-serif;margin:28px}
  h2{margin:0 0 12px}
  table{border-collapse:collapse;width:100%;margin-top:10px;display:none}
  table.active{display:table}
  th,td{border:1px solid #999;padding:8px;text-align:center;min-width:90px}
  th{background:#f2f2f2}
  td.selected,th.selected{outline:3px solid #ffdf6a}
  .merged{font-style:italic}

  /* ====== BUTTON BAR ====== */
  .bar{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
  .bar button{padding:8px 12px;font-size:14px;border-radius:4px;cursor:pointer;border:1px solid #666;background:#fff}
  #excelBtn{background:#2e8b57;color:#fff;border:none}
  #saveDraftBtn{background:#0b65c2;color:#fff;border:none}
  #loadDraftBtn{background:#ff8c00;color:#fff;border:none}
  #mergeBtn{background:#6a5acd;color:#fff;border:none}
  #unmergeBtn{background:#cd5c5c;color:#fff;border:none}
  #selectBtn{background:#00ced1;color:#fff;border:none}
  #selectBtn.active{background:#ff4500}
  #addTableBtn{background:#ff69b4;color:#fff;border:none}
  #renameTableBtn{background:#4682b4;color:#fff;border:none}
  #deleteTableBtn{background:#dc143c;color:#fff;border:none}
  #nameListBtn{background:#32cd32;color:#fff;border:none}

  #msg{color:#c00;margin-top:10px;display:none}
  #draftList{margin-top:10px;padding:5px;border:1px solid #ccc;max-height:150px;overflow-y:auto;display:none}
  #draftList div{padding:5px;cursor:pointer}
  #draftList div:hover{background:#f0f0f0}

  .table-tabs{display:flex;gap:6px;margin-bottom:10px}
  .table-tabs button{padding:6px 12px;background:#ddd;border:1px solid #999;border-radius:4px}
  .table-tabs button.active{background:#4caf50;color:#fff}

  /* ====== MODAL ====== */
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:transparent;z-index:1000;pointer-events:none}
  .modal-content{pointer-events:auto;background:#fff;position:absolute;top:50px;right:50px;padding:20px;width:300px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.3)}
  .modal-header{cursor:move;padding-bottom:10px;border-bottom:1px solid #ddd}
  .name-item{display:flex;justify-content:space-between;align-items:center;padding:5px;border-bottom:1px solid #ddd}
  .name-item:hover{background:#f0f0f0}
  .name-item span{flex-grow:1;cursor:pointer}
  .name-item button{background:#ff4444;color:#fff;border:none;border-radius:3px}
  .highlighted{background:#ffff99}
</style>
</head>

<body>
<h2 contenteditable="true">Weekly Schedule</h2>

<!-- ===== ACTION BAR ===== -->
<div class="bar">
  <button id="excelBtn"        onclick="promptExcelExport()">üíæ Save to Excel</button>
  <input  type="file" id="fileInput" accept=".xlsx" onchange="handleExcelFile(event)">
  <button id="saveDraftBtn"    onclick="promptSaveDraft()">üí† Save Draft</button>
  <button id="loadDraftBtn"    onclick="toggleDraftList()">üìÇ Load Draft</button>
  <button                     onclick="clearDraft()">üóëÔ∏è Clear Draft</button>
  <button id="selectBtn"       onclick="toggleSelectionMode()">‚ú® Select</button>
  <button id="mergeBtn"        onclick="mergeCells()">üîó Merge Cells</button>
  <button id="deselectBtn"     onclick="deselectAll()">üö´ Deselect</button>
  <button id="unmergeBtn"      onclick="unmergeCells()">üîó Unmerge Cells</button>
  <button id="addTableBtn"     onclick="addNewTable()">‚ú® Add New Table</button>
  <button id="renameTableBtn"  onclick="promptRenameTable()">üìù Rename Table</button>
  <button id="deleteTableBtn"  onclick="promptDeleteTable()">‚ùå Delete Table</button>
  <button id="nameListBtn"     onclick="toggleNameList()">üë• Name List</button>
</div>

<div id="draftList"></div>
<div class="bar table-tabs" id="tableTabs"></div>

<!-- ===== FIRST TABLE (blank headers) ===== -->
<div id="tablesContainer">
  <table id="tbl_1" class="active">
    <thead><tr><th contenteditable="true"></th><th contenteditable="true"></th><th contenteditable="true"></th><th contenteditable="true"></th><th contenteditable="true"></th><th contenteditable="true"></th><th contenteditable="true"></th></tr></thead>
    <tbody>
      <tr><td contenteditable="true">5S1</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
      <tr><td contenteditable="true">5S2</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
      <tr><td contenteditable="true">5PT1</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
      <tr><td contenteditable="true">5PT2</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
      <tr><td contenteditable="true">4S1</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
    </tbody>
  </table>
</div>

<p id="msg">‚ö†Ô∏è SheetJS not found ‚Äì export disabled.</p>

<div class="bar">
  <button onclick="addRowAbove()">‚¨ÜÔ∏è Row Above</button>
  <button onclick="addRowBelow()">‚¨áÔ∏è Row Below</button>
  <button onclick="addColLeft()">‚¨ÖÔ∏è Col Left</button>
  <button onclick="addColRight()">‚û°Ô∏è Col Right</button>
</div>

<!-- ===== NAME LIST MODAL ===== -->
<div id="nameModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h3>Name List</h3></div>
    <div>
      <input type="text" id="newNameInput" placeholder="Add new name">
      <button onclick="addName()">Add</button>
    </div>
    <div id="nameList" style="margin-top:10px;max-height:200px;overflow-y:auto;"></div>
    <button onclick="closeNameList()" style="margin-top:10px;">Close</button>
  </div>
</div>

<!-- ===== MAIN SCRIPT ===== -->
<script>
/* ---------- GLOBALS ---------- */
const DRAFTS_KEY='jadual_drafts',NAMES_KEY='jadual_names';
let activeTableId='tbl_1',tableCount=1,selectionMode=false,selectedCells=[],selectedName=null;

const tablesContainer=document.getElementById('tablesContainer');
const tableTabs=document.getElementById('tableTabs');
const nameModal=document.getElementById('nameModal');
const nameListContainer=document.getElementById('nameList');
const newNameInput=document.getElementById('newNameInput');

/* ---------- INIT ---------- */
tableTabs.innerHTML='<button class="active" onclick="switchTable(\\'tbl_1\\')">Table 1</button>';
let names=JSON.parse(localStorage.getItem(NAMES_KEY)||'[]');
if(!names.length)names=['Teacher A','Teacher B','Teacher C'];

/* ---------- TABLE UTILITIES ---------- */
function switchTable(id){
  activeTableId=id;
  document.querySelectorAll('#tablesContainer table').forEach(t=>t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.table-tabs button').forEach(b=>b.classList.remove('active'));
  tableTabs.querySelector(`button[onclick="switchTable('${id}')"]`).classList.add('active');
  deselectAll();
}

function addNewTable(){
  tableCount++;
  const id='tbl_'+tableCount;
  const nm=prompt('Table name:','Table '+tableCount);
  if(!nm||!nm.trim()){tableCount--;return;}
  const t=document.createElement('table');t.id=id;
  t.innerHTML='<thead><tr>'+ '<th contenteditable="true"></th>'.repeat(7) +'</tr></thead>'+
              '<tbody>'+Array(4).fill('<tr>'+ '<td contenteditable="true"></td>'.repeat(7) +'</tr>').join('')+'</tbody>';
  tablesContainer.appendChild(t);
  tableTabs.insertAdjacentHTML('beforeend',`<button onclick="switchTable('${id}')">${nm.trim()}</button>`);
  switchTable(id);
}

/* ---------- ROW / COL QUICK OPS ---------- */
function addRowAbove(){const t=document.getElementById(activeTableId);const r=t.insertRow(1);for(let i=0;i<7;i++){const c=r.insertCell(-1);c.contentEditable='true';}}
function addRowBelow(){const t=document.getElementById(activeTableId);const r=t.insertRow(-1);for(let i=0;i<7;i++){const c=r.insertCell(-1);c.contentEditable='true';}}
function addColLeft(){const t=document.getElementById(activeTableId);for(const row of t.rows){const c=row.insertCell(1);row.rowIndex?c.contentEditable='true':c.outerHTML='<th contenteditable="true"></th>';}}
function addColRight(){const t=document.getElementById(activeTableId);for(const row of t.rows){const c=row.insertCell(-1);row.rowIndex?c.contentEditable='true':c.outerHTML='<th contenteditable="true"></th>';}}
function deselectAll(){selectedCells.forEach(c=>c.classList.remove('selected'));selectedCells=[];}

/* ---------- SELECTION / MERGE ---------- */
function toggleSelectionMode(){
  selectionMode=!selectionMode;
  const btn=document.getElementById('selectBtn');
  btn.classList.toggle('active',selectionMode);
  btn.innerText=selectionMode?'‚ú® Selecting...':'‚ú® Select';
  if(!selectionMode)deselectAll();
}

tablesContainer.addEventListener('click',e=>{
  if(e.target.tagName!=='TD'&&e.target.tagName!=='TH')return;
  const cell=e.target;

  /* === NAME-INSERT MODE === */
  if(selectedName!==null){
    if(cell.tagName==='TD'&&cell.isContentEditable){
      cell.innerText=selectedName;
      nameListContainer.querySelector('.highlighted')?.classList.remove('highlighted');
      selectedName=null;
    }else alert('Tap an editable cell.');
    return;
  }

  /* === NORMAL SELECTION === */
  if(selectionMode){
    cell.classList.toggle('selected');
    cell.classList.contains('selected')?selectedCells.push(cell):
      selectedCells.splice(selectedCells.indexOf(cell),1);
  }
});

function mergeCells(){
  if(selectedCells.length<2){alert('Select >=2 cells');return;}
  const [base,...rest]=selectedCells;
  rest.forEach(c=>c.remove());
  base.setAttribute('colspan',selectedCells.length);
  base.classList.add('merged');
  toggleSelectionMode();deselectAll();
}
function unmergeCells(){
  document.querySelectorAll('.merged').forEach(cell=>{
    const cs=+cell.getAttribute('colspan')||1;
    cell.removeAttribute('colspan');cell.classList.remove('merged');
    for(let i=1;i<cs;i++){const nc=cell.parentNode.insertCell(cell.cellIndex+i);nc.contentEditable='true';}
  });
}

/* ---------- NAME LIST ---------- */
function toggleNameList(){nameModal.style.display=nameModal.style.display==='block'?'none':'block';updateNameList();}
function closeNameList(){nameModal.style.display='none';}
function updateNameList(){
  nameListContainer.innerHTML='';
  names.forEach(n=>{
    const div=document.createElement('div');div.className='name-item';
    div.innerHTML=`<span data-name="${n}" onclick="selectName('${n}')">${n}</span><button onclick="deleteName('${n}')">Delete</button>`;
    nameListContainer.appendChild(div);
  });
}
function addName(){const n=newNameInput.value.trim();if(!n)return;if(names.includes(n)){alert('Exists');return;}names.push(n);updateNameList();newNameInput.value='';}
function deleteName(n){names=names.filter(x=>x!==n);updateNameList();}
function selectName(n){
  nameListContainer.querySelector('.highlighted')?.classList.remove('highlighted');
  const s=nameListContainer.querySelector(`span[data-name="${n}"]`);
  if(s)s.classList.add('highlighted');
  selectedName=n;
}

/* ---------- (Excel export, drafts etc. omitted for brevity) ---------- */
function promptExcelExport(){alert('Excel export code omitted in this trimmed demo.');}
function promptSaveDraft(){alert('Draft save omitted in this trimmed demo.');}
function toggleDraftList(){}
function clearDraft(){}

/* ---------- DRAGGABLE MODAL (mobile-friendly) ---------- */
const modalContent=document.querySelector('.modal-content');
const modalHeader=document.querySelector('.modal-header');
let drag=false,ix=0,iy=0,cx=50,cy=50;
modalContent.style.left=cx+'px';modalContent.style.top=cy+'px';
modalHeader.addEventListener('mousedown',e=>{drag=true;ix=e.clientX-cx;iy=e.clientY-cy;e.preventDefault();});
modalHeader.addEventListener('touchstart',e=>{drag=true;ix=e.touches[0].clientX-cx;iy=e.touches[0].clientY-cy;});
document.addEventListener('mousemove',e=>{if(!drag)return;cx=e.clientX-ix;cy=e.clientY-iy;modalContent.style.left=cx+'px';modalContent.style.top=cy+'px';});
document.addEventListener('touchmove',e=>{if(!drag)return;cx=e.touches[0].clientX-ix;cy=e.touches[0].clientY-iy;modalContent.style.left=cx+'px';modalContent.style.top=cy+'px';e.preventDefault();},{passive:false});
document.addEventListener('mouseup',()=>drag=false);
document.addEventListener('touchend',()=>drag=false);

/* ---------- STARTUP ---------- */
updateNameList();
</script>
</body>
</html>