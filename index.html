<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title> <!-- Empty title by default -->

  <!-- Load SheetJS via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 28px }
    h2 { margin: 0 0 12px }
    table { border-collapse: collapse; width: 100%; margin-top: 10px }
    th, td { border: 1px solid #999; padding: 8px; text-align: center; min-width: 90px }
    th { background: #f2f2f2 } /* Grey color for table header row */
    td.selected, th.selected { outline: 3px solid #ffdf6a }
    .bar { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px }
    .bar button { padding: 8px 12px; font-size: 14px; border-radius: 4px; cursor: pointer; border: 1px solid #666; background: #fff }
    #excelBtn { background: #2e8b57; color: #fff; border: none }
    #saveDraftBtn { background: #0b65c2; color: #fff; border: none }
    #loadDraftBtn { background: #ff8c00; color: #fff; border: none }
    #msg { color: #c00; margin-top: 10px; display: none }
    #draftList { margin-top: 10px; padding: 5px; border: 1px solid #ccc; max-height: 150px; overflow-y: auto; display: none; }
    #draftList div { padding: 5px; cursor: pointer; }
    #draftList div:hover { background: #f0f0f0; }
  </style>
</head>
<body>
  <!-- Page header, completely empty by default but editable -->
  <h2 contenteditable="true"></h2>

  <!-- ===== persistence & export ===== -->
  <div class="bar">
    <button id="excelBtn" onclick="toExcel()">üíæ Save to Excel</button>
    <button id="saveDraftBtn" onclick="promptSaveDraft()">üí† Save Draft</button>
    <button id="loadDraftBtn" onclick="toggleDraftList()">üìÇ Load Draft</button>
    <button onclick="clearDraft()">üóëÔ∏è Clear Draft</button>
  </div>

  <!-- Draft list for loading -->
  <div id="draftList"></div>

  <!-- ===== targeted actions ===== -->
  <div class="bar">
    <button onclick="addRowAbove()">‚¨ÜÔ∏è Row Above</button>
    <button onclick="addRowBelow()">‚¨áÔ∏è Row Below</button>
    <button onclick="deleteRow()">‚ùå Del Row</button>
    <button onclick="addColLeft()">‚¨ÖÔ∏è Col Left</button>
    <button onclick="addColRight()">‚û°Ô∏è Col Right</button>
    <button onclick="deleteCol()">‚ùå Del Col</button>
  </div>

  <!-- ===== quick add / delete on the end ===== -->
  <div class="bar">
    <button onclick="quickAddRow()">‚ûï Add Row (end)</button>
    <button onclick="quickDelRow()">‚ûñ Del Row (end)</button>
    <button onclick="quickAddCol()">‚ûï Add Col (end)</button>
    <button onclick="quickDelCol()">‚ûñ Del Col (end)</button>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <!-- Editable table header cells with default time slots -->
        <th contenteditable="true">7.15 ‚Äì 8.15</th>
        <th contenteditable="true">8.15 ‚Äì 9.15</th>
        <th contenteditable="true">9.15 ‚Äì 10.15</th>
        <th contenteditable="true">10.15 ‚Äì 10.30 (REHAT)</th>
        <th contenteditable="true">10.30 ‚Äì 11.30</th>
        <th contenteditable="true">11.30 ‚Äì 12.30</th>
        <th contenteditable="true">12.30 ‚Äì 13.00</th>
      </tr>
    </thead>
    <tbody>
      <!-- Default rows, all cells empty -->
      <tr>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
      </tr>
      <tr>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
      </tr>
      <tr>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
      </tr>
      <tr>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
        <td contenteditable="true"></td>
      </tr>
    </tbody>
  </table>

  <p id="msg">‚ö†Ô∏è SheetJS not found ‚Äì export disabled.</p>

  <script>
    const T = document.getElementById('tbl'),
          DRAFTS_KEY = 'jadual_drafts',
          pageHeader = document.querySelector('h2');
    let sel = { r: 0, c: 0 }; /* selected cell coords */

    /* ---------- selection highlight ---------- */
    T.addEventListener('click', e => {
      if (e.target.tagName !== 'TD' && e.target.tagName !== 'TH') return;
      [...T.querySelectorAll('.selected')].forEach(c => c.classList.remove('selected'));
      e.target.classList.add('selected');
      sel = { r: e.target.parentNode.rowIndex, c: e.target.cellIndex };
    });

    /* ---------- helper: create empty cell ---------- */
    function makeCell(row, isHeader = false) {
      const cell = isHeader ? row.insertCell(-1) : row.insertCell(-1);
      if (isHeader) cell.outerHTML = '<th contenteditable="true"></th>';
      else { cell.contentEditable = 'true'; cell.textContent = ''; }
    }

    /* ---------- targeted row / col ops ---------- */
    function addRowAbove() { const r = T.insertRow(sel.r); for (let i = 0; i < T.rows[0].cells.length; i++) makeCell(r); }
    function addRowBelow() { const r = T.insertRow(sel.r + 1); for (let i = 0; i < T.rows[0].cells.length; i++) makeCell(r); }
    function deleteRow() { if (T.rows.length > 2) T.deleteRow(sel.r); }
    function addColLeft() { for (const row of T.rows) { const c = row.insertCell(sel.c); if (row.rowIndex) c.contentEditable = 'true'; else c.outerHTML = '<th contenteditable="true"></th>'; } }
    function addColRight() { for (const row of T.rows) { const c = row.insertCell(sel.c + 1); if (row.rowIndex) c.contentEditable = 'true'; else c.outerHTML = '<th contenteditable="true"></th>'; } }
    function deleteCol() { if (T.rows[0].cells.length > 1) for (const row of T.rows) row.deleteCell(sel.c); }

    /* ---------- quick ops on table end ---------- */
    function quickAddRow() { const r = T.insertRow(-1); for (let i = 0; i < T.rows[0].cells.length; i++) makeCell(r); }
    function quickDelRow() { if (T.rows.length > 2) T.deleteRow(-1); }
    function quickAddCol() { for (const row of T.rows) { makeCell(row, row.rowIndex === 0); } }
    function quickDelCol() { const n = T.rows[0].cells.length; if (n > 1) for (const row of T.rows) row.deleteCell(-1); }

    /* ---------- localStorage draft management ---------- */
    function tblArray() { 
      return {
        table: [...T.rows].map(r => [...r.cells].map(c => c.innerText.trim())),
        header: pageHeader.innerText.trim()
      };
    }

    function arrayToTbl(a) {
      [...T.tBodies].forEach(tb => tb.remove());
      const tb = T.createTBody();
      for (let r = 1; r < a.table.length; r++) {
        const tr = tb.insertRow(-1);
        for (const v of a.table[r]) { const td = tr.insertCell(-1); td.contentEditable = 'true'; td.textContent = v; }
      }
      /* sync header width if draft had more cols */
      while (T.rows[0].cells.length < a.table[0].length) addColRight();
      /* Update the table header row with saved values */
      for (let c = 0; c < a.table[0].length; c++) {
        T.rows[0].cells[c].innerText = a.table[0][c];
      }
      /* Update the page header */
      pageHeader.innerText = a.header || '';
    }

    function getDrafts() {
      const drafts = localStorage.getItem(DRAFTS_KEY);
      return drafts ? JSON.parse(drafts) : {};
    }

    function saveDraft(title) {
      const drafts = getDrafts();
      drafts[title] = tblArray();
      localStorage.setItem(DRAFTS_KEY, JSON.stringify(drafts));
      alert(`Draft saved as "${title}"!`);
      updateDraftList();
    }

    function promptSaveDraft() {
      const title = prompt('Enter a title for this draft:');
      if (title && title.trim()) {
        saveDraft(title.trim());
      } else if (title !== null) {
        alert('Please enter a valid title.');
      }
    }

    function loadDraft(title) {
      const drafts = getDrafts();
      if (drafts[title]) {
        arrayToTbl(drafts[title]);
        alert(`Loaded draft "${title}"!`);
      }
      toggleDraftList(); // Hide the draft list after loading
    }

    function updateDraftList() {
      const drafts = getDrafts();
      const draftList = document.getElementById('draftList');
      draftList.innerHTML = '';
      const titles = Object.keys(drafts);
      if (titles.length === 0) {
        draftList.style.display = 'none';
        return;
      }
      titles.forEach(title => {
        const div = document.createElement('div');
        div.innerText = title;
        div.onclick = () => loadDraft(title);
        draftList.appendChild(div);
      });
      draftList.style.display = 'block';
    }

    function toggleDraftList() {
      const draftList = document.getElementById('draftList');
      if (draftList.style.display === 'block') {
        draftList.style.display = 'none';
      } else {
        updateDraftList();
      }
    }

    function clearDraft() {
      localStorage.removeItem(DRAFTS_KEY);
      alert('Draft cleared! Reverting to empty table...');
      // Clear all rows in tbody
      [...T.tBodies].forEach(tb => tb.remove());
      const tb = T.createTBody();
      // Clear the header row content (but keep the structure)
      for (let c = 0; c < T.rows[0].cells.length; c++) {
        T.rows[0].cells[c].innerText = '';
      }
      // Clear the page header
      pageHeader.innerText = '';
      // Hide the draft list
      document.getElementById('draftList').style.display = 'none';
    }

    /* ---------- Excel export ---------- */
    function toExcel() {
      const msg = document.getElementById('msg');
      msg.style.display = 'none'; // Hide the message initially
      if (typeof XLSX === 'undefined') {
        msg.style.display = 'block';
        return;
      }
      const aoa = [...T.rows].map(r => [...r.cells].map(c => c.innerText.trim())),
            ws = XLSX.utils.aoa_to_sheet(aoa);
      ws['!cols'] = Array(aoa[0].length).fill({ wch: 20 });
      ws['!pageSetup'] = { paperSize: 9, orientation: 'portrait', fitToWidth: 1, fitToHeight: 0 };
      const wb = XLSX.utils.book_new();
      const sheetName = pageHeader.innerText.trim() || 'Schedule'; // Use header title or default to 'Schedule'
      XLSX.utils.book_append_sheet(wb, ws, sheetName.slice(0, 31)); // Excel sheet names are limited to 31 chars
      const fileName = `${sheetName.replace(/[^a-zA-Z0-9]/g, '_') || 'Jadual'}_2025-05-22.xlsx`; // Fixed date based on current time
      XLSX.writeFile(wb, fileName);
    }

    // Test if SheetJS is loaded
    console.log('SheetJS loaded:', typeof XLSX !== 'undefined');
  </script>
</body>
</html>