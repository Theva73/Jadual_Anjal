<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Weekly Schedule</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 28px }
    h2 { margin: 0 0 12px }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; display: none }
    table.active { display: table }
    th, td { border: 1px solid #999; padding: 8px; text-align: center; min-width: 90px }
    th { background: #f2f2f2 }
    td.selected, th.selected { outline: 3px solid #ffdf6a }
    .merged { font-style: italic }
    .bar { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px }
    .bar button { padding: 8px 12px; font-size: 14px; border-radius: 4px; cursor: pointer; border: 1px solid #666; background: #fff }
    #excelBtn { background: #2e8b57; color: #fff; border: none }
    #saveDraftBtn { background: #0b65c2; color: #fff; border: none }
    #loadDraftBtn { background: #ff8c00; color: #fff; border: none }
    #mergeBtn { background: #6a5acd; color: #fff; border: none }
    #unmergeBtn { background: #cd5c5c; color: #fff; border: none }
    #selectBtn { background: #00ced1; color: #fff; border: none }
    #selectBtn.active { background: #ff4500; }
    #addTableBtn { background: #ff69b4; color: #fff; border: none }
    #renameTableBtn { background: #4682b4; color: #fff; border: none }
    #deleteTableBtn { background: #dc143c; color: #fff; border: none }
    #nameListBtn { background: #32cd32; color: #fff; border: none }
    #msg { color: #c00; margin-top: 10px; display: none }
    #draftList { margin-top: 10px; padding: 5px; border: 1px solid #ccc; max-height: 150px; overflow-y: auto; display: none }
    #draftList div { padding: 5px; cursor: pointer }
    #draftList div:hover { background: #f0f0f0 }
    #fileInput { display: none }
    .table-tabs { display: flex; gap: 6px; margin-bottom: 10px }
    .table-tabs button { padding: 6px 12px; background: #ddd; border: 1px solid #999; border-radius: 4px }
    .table-tabs button.active { background: #4CAF50; color: #fff }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      z-index: 1000;
      pointer-events: none;
    }
    .modal-content {
      pointer-events: auto;
      background: #fff;
      position: absolute;
      top: 50px;
      right: 50px;
      padding: 20px;
      width: 300px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .modal-header { cursor: move; padding-bottom: 10px; border-bottom: 1px solid #ddd }
    .modal-content h3 { margin: 0 }
    .modal-content input { width: 70%; padding: 5px; margin-right: 5px }
    .modal-content button { padding: 5px 10px; cursor: pointer }
    .name-item { display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px solid #ddd }
    .name-item:hover { background: #f0f0f0 }
    .name-item span { flex-grow: 1; cursor: pointer }
    .name-item button { background: #ff4444; color: #fff; border: none; border-radius: 3px }
    .highlighted { background-color: #ffff99; }
  </style>
</head>
<body>
  <h2 contenteditable="true">Weekly Schedule</h2>
  <div class="bar">
    <button id="excelBtn" onclick="promptExcelExport()">üíæ Save to Excel</button>
    <input type="file" id="fileInput" accept=".xlsx" onchange="handleExcelFile(event)" style="display: none" />
    <button id="saveDraftBtn" onclick="promptSaveDraft()">üí† Save Draft</button>
    <button id="loadDraftBtn" onclick="toggleDraftList()">üìÇ Load Draft</button>
    <button onclick="clearDraft()">üóëÔ∏è Clear Draft</button>
    <button id="selectBtn" onclick="toggleSelectionMode()">‚ú® Select</button>
    <button id="mergeBtn" onclick="mergeCells()">üîó Merge Cells</button>
    <button id="deselectBtn" onclick="deselectAll()">üö´ Deselect</button>
    <button id="unmergeBtn" onclick="unmergeCells()">üîó Unmerge Cells</button>
    <button id="addTableBtn" onclick="addNewTable()">‚ú® Add New Table</button>
    <button id="renameTableBtn" onclick="promptRenameTable()">üìù Rename Table</button>
    <button id="deleteTableBtn" onclick="promptDeleteTable()">‚ùå Delete Table</button>
    <button id="nameListBtn" onclick="toggleNameList()">üë• Name List</button>
  </div>
  <div id="draftList"></div>
  <div class="bar table-tabs" id="tableTabs"></div>
  <div id="tablesContainer">
    <table id="tbl_1" class="active">
      <thead>
        <tr>
          <th contenteditable="true">7.15 ‚Äì 8.15</th>
          <th contenteditable="true">8.15 ‚Äì 9.15</th>
          <th contenteditable="true">9.15 ‚Äì 10.15</th>
          <th contenteditable="true">10.15 ‚Äì 10.30 (REHAT)</th>
          <th contenteditable="true">10.30 ‚Äì 11.30</th>
          <th contenteditable="true">11.30 ‚Äì 12.30</th>
          <th contenteditable="true">12.30 ‚Äì 13.00</th>
        </tr>
      </thead>
      <tbody>
        <tr><td contenteditable="true">5S1</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
        <tr><td contenteditable="true">5S2</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
        <tr><td contenteditable="true">5PT1</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
        <tr><td contenteditable="true">5PT2</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
        <tr><td contenteditable="true">4S1</td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td></tr>
      </tbody>
    </table>
  </div>
  <p id="msg">‚ö†Ô∏è SheetJS not found ‚Äì export disabled.</p>
  <div class="bar">
    <button onclick="addRowAbove()">‚¨ÜÔ∏è Row Above</button>
    <button onclick="addRowBelow()">‚¨áÔ∏è Row Below</button>
    <button onclick="addColLeft()">‚¨ÖÔ∏è Col Left</button>
    <button onclick="addColRight()">‚û°Ô∏è Col Right</button>
  </div>
  <!-- Name List Modal -->
  <div id="nameModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Name List</h3>
      </div>
      <div>
        <input type="text" id="newNameInput" placeholder="Add new name">
        <button onclick="addName()">Add</button>
      </div>
      <div id="nameList" style="margin-top: 10px; max-height: 200px; overflow-y: auto;"></div>
      <button onclick="closeNameList()" style="margin-top: 10px;">Close</button>
    </div>
  </div>
  <script>
    /* --- All your original JS logic (abbreviated here for brevity) --- */
    /* Variables, initialization, selection, draft, table logic, merging, exporting, etc. */
    /* ---- Start abbreviated internal code ---- */
    const T = document.getElementById('tbl_1'), DRAFTS_KEY = 'jadual_drafts', pageHeader = document.querySelector('h2'),
        tablesContainer = document.getElementById('tablesContainer'), tableTabs = document.getElementById('tableTabs'),
        nameModal = document.getElementById('nameModal'), nameListContainer = document.getElementById('nameList'),
        newNameInput = document.getElementById('newNameInput'), NAMES_KEY = 'jadual_names';
    let sel = { r: 0, c: 0 }, lastFileName = null, selectedCells = [], activeTableId = 'tbl_1', tableCount = 1,
        selectedName = null, selectionMode = false;

    tableTabs.innerHTML = `<button class="active" onclick="switchTable('tbl_1')">Table 1</button>`;
    let names = JSON.parse(localStorage.getItem(NAMES_KEY)) || ['Teacher A', 'Teacher B', 'Teacher C'];

    /* (All original helper functions remain unchanged) */
    /* ---- End abbreviated internal code ---- */

    /* === Fixed draggable modal section === */
    const modalContent = document.querySelector('.modal-content');
    const modalHeader = document.querySelector('.modal-header');
    let isDragging = false, initialX = 0, initialY = 0, currentX = 50, currentY = 50;

    modalContent.style.position = 'absolute';
    modalContent.style.left = currentX + 'px';
    modalContent.style.top = currentY + 'px';
    modalContent.style.right = 'auto';

    modalHeader.addEventListener('mousedown', (e) => {
      isDragging = true;
      initialX = e.clientX - currentX;
      initialY = e.clientY - currentY;
      modalHeader.style.cursor = 'grabbing';
      e.preventDefault();
    });

    modalHeader.addEventListener('touchstart', (e) => {
      isDragging = true;
      const touch = e.touches[0];
      initialX = touch.clientX - currentX;
      initialY = touch.clientY - currentY;
    });

    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
        currentX = Math.max(0, Math.min(currentX, window.innerWidth - modalContent.offsetWidth));
        currentY = Math.max(0, Math.min(currentY, window.innerHeight - modalContent.offsetHeight));
        modalContent.style.left = currentX + 'px';
        modalContent.style.top = currentY + 'px';
      }
    });

    document.addEventListener('touchmove', (e) => {
      if (isDragging) {
        const touch = e.touches[0];
        currentX = touch.clientX - initialX;
        currentY = touch.clientY - initialY;
        modalContent.style.left = `${Math.max(0, Math.min(currentX, window.innerWidth - modalContent.offsetWidth))}px`;
        modalContent.style.top = `${Math.max(0, Math.min(currentY, window.innerHeight - modalContent.offsetHeight))}px`;
        e.preventDefault(); // Only prevent default while dragging
      }
    }, { passive: false });

    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        modalHeader.style.cursor = 'move';
      }
    });

    document.addEventListener('touchend', () => {
      isDragging = false;
    });
    /* === End fixed draggable modal section === */
  </script>
</body>
</html>
