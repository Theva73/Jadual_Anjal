<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Weekly Schedule with Firestore Names & Drafts</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .main-container {
            width: 100%;
            max-width: 1200px; /* Adjust as needed */
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h2, h3 {
            color: #333;
            text-align: center;
        }
        #userIdDisplay {
            text-align: center;
            font-size: 0.8em;
            color: #666;
            margin-bottom: 15px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background-color: #fff;
            table-layout: auto;
        }
        #tablesContainer {
            overflow-x: auto;
            position: relative;
        }
        #tablesContainer > table {
            display: none;
        }
        #tablesContainer > table.active {
            display: table;
        }
        #summaryTable {
            display: table;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
            min-width: 100px;
        }
        table th {
            background-color: #e9ecef;
            color: #495057;
            font-weight: bold;
            white-space: nowrap;
        }
        td.selected, th.selected {
            outline: 3px solid #007bff;
            background-color: #cfe2ff;
        }
        .bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            align-items: center;
            justify-content: center;
        }
        .bar button, .table-tabs button, .name-session-tabs button {
            padding: 10px 15px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #adb5bd;
            background-color: #fff;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .bar button:hover, .table-tabs button:hover, .name-session-tabs button:hover {
            background-color: #f1f3f5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .bar button:active, .table-tabs button:active, .name-session-tabs button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        #rowColManipulationBar button {
            background-image: linear-gradient(to bottom, #fdfbfb 0%, #ebedee 100%);
            border: 1px solid #ced4da;
            color: #343a40;
            box-shadow: 0 2px 3px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.2);
            padding: 8px 12px;
        }
        #rowColManipulationBar button:hover {
            background-image: linear-gradient(to bottom, #e2e6ea 0%, #d4d9df 100%);
            border-color: #b8c0c6;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.1);
        }
         #rowColManipulationBar button.delete-btn {
            background-image: linear-gradient(to bottom, #f8d7da 0%, #f1c6cb 100%);
            border-color: #f5c6cb;
            color: #721c24;
        }
        #rowColManipulationBar button.delete-btn:hover {
            background-image: linear-gradient(to bottom, #f5c6cb 0%, #ebaeb3 100%);
            border-color: #f1b0b7;
        }
        #directCopyFullHtmlBtn { background-color: #545b62; color: white; border-color: #545b62; }
        #excelBtnTrigger, #importExcelBtn { background-color: #28a745; color: white; border-color: #28a745;}
        #saveDraftBtn { background-color: #007bff; color: white; border-color: #007bff;}
        #loadDraftBtn { background-color: #ffc107; color: #212529; border-color: #ffc107;}
        #clearActiveTableContentBtn { background-color: #fd7e14; color: white; border-color: #fd7e14;}
        #selectBtn { background-color: #17a2b8; color: white; border-color: #17a2b8;}
        #selectBtn.active { background-color: #fd7e14; border-color: #fd7e14;}
        #mergeBtn { background-color: #6f42c1; color: white; border-color: #6f42c1;}
        #unmergeBtn { background-color: #e83e8c; color: white; border-color: #e83e8c;}
        #addTableBtn { background-color: #20c997; color: white; border-color: #20c997;}
        #renameTableBtn { background-color: #6c757d; color: white; border-color: #6c757d;}
        #deleteTableBtn { background-color: #dc3545; color: white; border-color: #dc3545;}
        #nameListBtn { background-color: #fd7e14; color: white; border-color: #fd7e14;}
        #deselectBtn { background-color: #6c757d; color: white; border-color: #6c757d;}
        #exportDraftsBtn { background-color: #4e54c8; color: white; border-color: #4e54c8;}
        #importDraftsBtn { background-color: #8f94fb; color: white; border-color: #8f94fb;}

        .table-tabs { margin-bottom: 10px; }
        .table-tabs button { background-color: #f8f9fa; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .table-tabs button.active { background-color: #007bff; color: white; border-color: #007bff; }
        
        .name-session-tabs { margin-bottom: 15px; border-bottom: 2px solid #dee2e6; padding-bottom: 5px; }
        .name-session-tabs button {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: none;
            margin-bottom: -2px; /* Overlap with parent border */
            padding: 8px 12px;
            font-size: 0.95em;
        }
        .name-session-tabs button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff #007bff #fff; /* Bottom border transparent to merge */
            font-weight: bold;
        }


        #summaryTable th { background-color: #ffeeba; }
        #summaryTable td { background-color: #fff3cd; }
        .highlight-conflict { background-color: #ffcdd2 !important; font-weight: bold; color: #c62828 !important; }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: rgba(0,0,0,0.4); align-items: center; justify-content: center;
            pointer-events: none;
        }
        .modal-content {
            background-color: #fff; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; 
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; pointer-events: auto;
        }
        .modal-content.dragging { transform: none; }
        .modal-header {
            padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px;
            font-size: 1.2em; color: #333; display: flex; justify-content: space-between; align-items: center;
            cursor: move; user-select: none;
        }
        .modal-close-btn {
            font-size: 1.5rem; font-weight: bold; line-height: 1; color: #000;
            text-shadow: 0 1px 0 #fff; opacity: .5; background: transparent; border: 0; cursor: pointer;
        }
        .modal-close-btn:hover { opacity: .75; }
        .name-item, .draft-item-firestore { /* Combined for similar styling */
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 5px; border-bottom: 1px solid #eee; break-inside: avoid-column; page-break-inside: avoid;
        }
        .name-item:last-child, .draft-item-firestore:last-child { border-bottom: none; }
        .name-item span, .draft-item-firestore span { flex-grow: 1; cursor: pointer; color: #007bff; }
        .name-item span:hover, .draft-item-firestore span:hover { text-decoration: underline; }
        .name-item button, .draft-item-firestore button { background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; font-size: 0.9em; }
        
        .highlighted { background-color: #cfe2ff !important; font-weight: bold; }
        
        #draftListContainer { /* Changed ID from draftList to avoid confusion with localStorage one if it were still there */
             border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; border-radius: 5px; 
             background-color: #fff; max-height: 300px; overflow-y: auto;
        }
        #newNameInput, #searchNameInput {
            padding: 8px; margin-right: 5px; border: 1px solid #ccc; border-radius: 4px; flex-grow: 1;
            width: calc(100% - 100px);
        }
         #searchNameInput { margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        .input-group { display: flex; margin-bottom: 10px; }
        .input-group button, #importNameListBtn {
            background-color: #28a745; color: white; border-color: #28a745; padding: 8px 12px;
            font-size: 1em; border-radius: 4px; cursor: pointer; flex-shrink: 0;
        }
        #importNameListBtn { margin-top: 10px; width: 100%; }
        #nameList { margin-top:10px; max-height:250px; overflow-y:auto; column-count: 2; column-gap: 20px; }
        .custom-message-box {
            display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background-color: #333; color: white; padding: 15px 25px; border-radius: 5px;
            z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 1em;
        }
        .custom-message-box.success { background-color: #28a745; }
        .custom-message-box.error { background-color: #dc3545; }
        .custom-message-box.info { background-color: #007bff; }
        .merged-cell-container { position: relative; z-index: 2; vertical-align: top; }
        .merged-cell-overlay {
            position: absolute; top: 0; left: 0; width: var(--merged-width); height: var(--merged-height);
            background-color: #f0f8ff; font-style: italic; border: 1px solid #add8e6;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            box-sizing: border-box; z-index: 5;
        }
        .subsumed-cell { visibility: hidden; }
        #loadingIndicatorModal, #loadingIndicatorDraftList { /* Added draft list loader */
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 10; 
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px; height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="main-container">
    <h2 contenteditable="true" id="scheduleTitle">Weekly Schedule</h2>
    <div id="userIdDisplay">User ID: Loading...</div>

    <div class="bar">
        <button id="directCopyFullHtmlBtn" title="Copy the entire page's HTML to clipboard">📋 Copy Full HTML (Direct)</button>
    </div>
    <div class="bar">
        <button id="excelBtnTrigger" title="Export the currently active table to an Excel file">💾 Export Active Table to Excel</button>
        <button id="importExcelBtn" title="Import data from an Excel file into a new table">📂 Import from Excel</button>
        <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none">
    </div>
    <div class="bar">
        <button id="saveDraftBtn" title="Save all current tables and their state as a named draft to Firestore">💠 Save All as Draft (Firestore)</button>
        <button id="loadDraftBtn" title="Show list of saved drafts from Firestore to load">📂 Load Draft (Firestore)</button>
        <button id="exportDraftsBtn" title="Export all saved drafts from Firestore to a JSON file">📤 Export All Drafts (Firestore)</button>
        <button id="importDraftsBtn" title="Import drafts from a JSON file to Firestore">📥 Import Drafts File (Firestore)</button>
        <input type="file" id="draftImportFile" accept=".json" style="display:none;">
        <button id="clearActiveTableContentBtn" title="Clear all data from the cells of the active table">🧹 Clear Active Table</button>
    </div>
    <div class="bar">
        <button id="selectBtn" title="Toggle cell selection mode on/off">✨ Select Cells</button>
        <button id="mergeBtn" title="Merge the currently selected cells">🔗 Merge Cells</button>
        <button id="deselectBtn" title="Clear current cell selection">🚫 Deselect All</button>
        <button id="unmergeBtn" title="Unmerge the cell that was last clicked if it's part of a merge">💔 Unmerge Cell</button>
    </div>
    <div class="bar">
        <button id="addTableBtn" title="Add a new, empty table/sheet">➕ Add New Table</button>
        <button id="renameTableBtn" title="Rename the currently active table/sheet">📝 Rename Active Table</button>
        <button id="deleteTableBtn" title="Delete the currently active table/sheet">❌ Delete Active Table</button>
        <button id="nameListBtn" title="Open a dialog to manage a list of names for quick insertion">👥 Manage Names (Firestore)</button>
    </div>

    <div id="draftListContainer" style="display:none; position:relative;"> <div id="loadingIndicatorDraftList" style="display:none;"><div class="spinner"></div></div>
        </div>
    <div class="bar table-tabs" id="tableTabs"></div>
    <div id="tablesContainer">
        <table id="tbl_1" class="active" data-table-name="Table 1">
            <thead>
                <tr>
                    <th contenteditable="true">Class</th> <th contenteditable="true">08:00</th>
                    <th contenteditable="true">09:00</th> <th contenteditable="true">10:00</th>
                    <th contenteditable="true">11:00</th> <th contenteditable="true">12:00</th>
                    <th contenteditable="true">13:00</th>
                </tr>
            </thead>
            <tbody>
                 <tr> <td contenteditable="true">5S1</td>
                    <td contenteditable="true"></td><td contenteditable="true">JAMES</td><td contenteditable="true"></td>
                    <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
                </tr>
                 <tr> <td contenteditable="true">5S2</td>
                    <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true">LILY</td>
                    <td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="bar" id="rowColManipulationBar">
        <button id="addRowAboveBtn" title="Add a new row above the currently selected/clicked row">⬆️ Add Row Above</button>
        <button id="addRowBelowBtn" title="Add a new row below the currently selected/clicked row">⬇️ Add Row Below</button>
        <button id="addColLeftBtn" title="Add a new column to the left of the currently selected/clicked column">⬅️ Add Column Left</button>
        <button id="addColRightBtn" title="Add a new column to the right of the currently selected/clicked column">➡️ Add Column Right</button>
        <button id="deleteRowBtn" class="delete-btn" title="Delete the currently selected/clicked row">🗑️ Delete Row</button>
        <button id="deleteColBtn" class="delete-btn" title="Delete the currently selected/clicked column">🗑️ Delete Column</button>
    </div>

    <div id="nameModal" class="modal">
        <div class="modal-content" id="nameModalContent">
            <div class="modal-header" id="nameModalHeader">
                <h3 id="nameModalTitle">Name List Manager</h3> <button type="button" class="modal-close-btn" id="closeNameModalBtnStandard" title="Close name manager">×</button>
            </div>
            <div class="name-session-tabs">
                <button id="namePagiTab" data-session="pagi" class="active">Pagi (Morning)</button>
                <button id="namePetangTab" data-session="petang">Petang (Afternoon)</button>
            </div>
             <div class="input-group">
                <input id="newNameInput" placeholder="Add new name to current session">
                <button id="addNameBtnInModal" title="Add the name to the list">Add</button>
            </div>
            <button id="importNameListBtn" title="Import names from a .txt file (one name per line) to current session">📂 Import Names (.txt) to Session</button>
            <input type="file" id="nameListImportFile" accept=".txt" style="display:none;">
            <input type="text" id="searchNameInput" placeholder="🔍 Search names in current session..." style="margin-top: 10px;" title="Filter the list of names">
            <div id="nameList" style="margin-top:10px;max-height:250px;overflow-y:auto;">
                </div>
            <div id="loadingIndicatorModal" style="display:none;"><div class="spinner"></div></div>
        </div>
    </div>

    <h3 style="margin-top:32px">Teacher/Subject Attendance Summary</h3>
    <table id="summaryTable"></table>
    <div id="customMessageBox" class="custom-message-box"></div>
</div>

<script type="module">
    // Firebase App (the core Firebase SDK) is always required and must be listed first
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    // Add SDKs for Firebase products that you want to use
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc, serverTimestamp, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Added collection, getDocs, deleteDoc, serverTimestamp, query, orderBy, getDoc

    // --- Firebase Configuration ---
    const userProvidedFirebaseConfig = {
      apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4",
      authDomain: "jadual-3f0aa.firebaseapp.com",
      projectId: "jadual-3f0aa",
      storageBucket: "jadual-3f0aa.firebasestorage.app",
      messagingSenderId: "496526436851",
      appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
    };

    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userProvidedFirebaseConfig;
    const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId;


    // --- Initialize Firebase ---
    let fbApp, fbAuth, fbDb;
    let fbUserId = null;
    let fbIsAuthReady = false;
    let unsubscribePagi = null;
    let unsubscribePetang = null;

    try {
        fbApp = initializeApp(firebaseConfig);
        fbAuth = getAuth(fbApp);
        fbDb = getFirestore(fbApp);
    } catch (e) {
        console.error("Error initializing Firebase:", e);
        showMessage("Critical Error: Firebase initialization failed. Core features will not work.", "error", 10000);
    }

    // --- Global State and Configuration ---
    // const DRAFTS_KEY = 'jadual_drafts_v3'; // REPLACED BY FIRESTORE FOR DRAFTS
    const SCHEDULE_TITLE_KEY = 'jadual_title_v3';
    let activeTableId = 'tbl_1';
    let tableCount = 1;
    let selectionMode = false;
    let selectedCells = [];
    let lastClickedCell = null;
    let selectedNameFromList = null; 

    // Firestore Name List State
    let currentNameListSession = 'pagi'; 
    let namesPagi = [];
    let namesPetang = [];

    let isDraggingModal = false;
    let modalDragOffsetX, modalDragOffsetY;

    // DOM Element Cache
    let scheduleTitleElement, tablesContainer, tableTabs, nameModal, nameModalContent, nameModalHeader, nameListContainer, newNameInput, draftListContainerElement, summaryTableElement, customMessageBox, fileInputElement, directCopyFullHtmlButtonElement, closeNameModalButtonStandardElement, nameListImportFileInputElement, searchNameInputElement, draftImportFileInputElement, userIdDisplayElement, namePagiTabElement, namePetangTabElement, loadingIndicatorModalElement, nameModalTitleElement, loadingIndicatorDraftListElement;

    // --- Utility Functions (Existing) ---
    function showMessage(message, type = 'info', duration = 3000) { /* ... existing code ... */ }
    function customPrompt(message, defaultValue = "") { /* ... existing code ... */ }
    function customConfirm(message) { /* ... existing code ... */ }
    
    // --- Firestore Name List Functions ---
    function showNameModalLoading(isLoading) { /* ... existing code ... */ }
    async function saveNameListToFirestore(session, namesArray) { /* ... existing code ... */ }
    async function addNameToCurrentSessionInFirestore(name) { /* ... existing code ... */ }
    async function deleteNameFromCurrentSessionInFirestore(nameToDelete) { /* ... existing code ... */ }
    function listenToNameList(sessionToListen) { /* ... existing code ... */ }

    // --- Firestore Draft Functions ---
    function showDraftListLoading(isLoading) {
        if (loadingIndicatorDraftListElement) {
            loadingIndicatorDraftListElement.style.display = isLoading ? 'flex' : 'none';
        }
    }

    async function saveDraftToFirestore() {
        if (!fbDb || !fbUserId || !fbIsAuthReady) {
            showMessage("Firebase not ready. Cannot save draft.", "error"); return;
        }
        if (tablesContainer.children.length === 0) {
            showMessage('No schedule data to save.', 'error'); return;
        }
        
        const draftName = customPrompt('Enter draft name:', `Draft ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`);
        if (!draftName || draftName.trim() === "") {
            showMessage('Draft name cannot be empty. Save cancelled.', 'info'); return;
        }

        showDraftListLoading(true); // Use general loader or create specific one if needed
        const allTablesData = tablesContainer.innerHTML;
        const allTableMeta = {};
        tablesContainer.querySelectorAll('table').forEach(table => {
            allTableMeta[table.id] = { name: table.dataset.tableName || table.id };
        });

        const draftData = {
            html: allTablesData,
            meta: allTableMeta,
            activeTableId: activeTableId,
            timestamp: serverTimestamp() // For ordering by date
        };

        const draftDocRef = doc(fbDb, "artifacts", appId, "users", fbUserId, "scheduleDrafts", draftName.trim());
        try {
            await setDoc(draftDocRef, draftData);
            showMessage(`Draft "${draftName.trim()}" saved to Firestore!`, 'success');
            if (draftListContainerElement.style.display === 'block') { // If list is visible, refresh it
                await renderDraftListFromFirestore();
            }
        } catch (error) {
            console.error("Error saving draft to Firestore:", error);
            showMessage(`Failed to save draft. Error: ${error.message}`, "error");
        } finally {
            showDraftListLoading(false);
        }
    }

    async function renderDraftListFromFirestore() {
        if (!fbDb || !fbUserId || !fbIsAuthReady) {
            draftListContainerElement.innerHTML = '<p>Firebase not ready. Cannot load drafts.</p>'; return;
        }
        showDraftListLoading(true);
        draftListContainerElement.innerHTML = ''; // Clear previous list (keep loader if it's separate)
        
        const draftsCollectionRef = collection(fbDb, "artifacts", appId, "users", fbUserId, "scheduleDrafts");
        // Order by timestamp, descending (newest first)
        const q = query(draftsCollectionRef, orderBy("timestamp", "desc"));

        try {
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                draftListContainerElement.innerHTML = '<p>No drafts saved in Firestore yet.</p>';
            } else {
                querySnapshot.forEach((docSnap) => {
                    const draftName = docSnap.id;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'draft-item-firestore'; // Use new class for styling if needed
                    itemDiv.innerHTML = `<span data-draft-name="${draftName}" title="Load draft: ${draftName}">${draftName}</span><button data-draft-delete="${draftName}" title="Delete draft '${draftName}' from Firestore">Delete</button>`;
                    draftListContainerElement.appendChild(itemDiv);
                });
            }
        } catch (error) {
            console.error("Error fetching drafts from Firestore:", error);
            draftListContainerElement.innerHTML = '<p>Error loading drafts. Check console.</p>';
            showMessage(`Failed to load drafts. Error: ${error.message}`, "error");
        } finally {
            showDraftListLoading(false);
        }
    }

    async function loadSelectedDraftFromFirestore(draftName) {
        if (!fbDb || !fbUserId || !fbIsAuthReady) {
            showMessage("Firebase not ready. Cannot load draft.", "error"); return;
        }
        showDraftListLoading(true);
        const draftDocRef = doc(fbDb, "artifacts", appId, "users", fbUserId, "scheduleDrafts", draftName);
        try {
            const docSnap = await getDoc(draftDocRef);
            if (docSnap.exists()) {
                const draftData = docSnap.data();
                tablesContainer.innerHTML = draftData.html;
                const tableMeta = draftData.meta || {};
                tableTabs.innerHTML = '';
                tablesContainer.querySelectorAll('table').forEach(table => {
                    const id = table.id;
                    const metaInfo = tableMeta[id] || {};
                    const name = metaInfo.name || `Table ${tableTabs.children.length + 1}`;
                    table.dataset.tableName = name;
                    addTabButton(id, name);
                    table.querySelectorAll('td, th').forEach(cell => cell.contentEditable = 'true');
                });
                activeTableId = draftData.activeTableId || tablesContainer.querySelector('table')?.id || 'tbl_1';

                if (document.getElementById(activeTableId)) {
                    switchTable(activeTableId);
                } else if (tablesContainer.querySelector('table')) {
                    switchTable(tablesContainer.querySelector('table').id);
                } else {
                    addNewTable(true); // Should ideally not happen if draft was valid
                }
                showMessage(`Draft "${draftName}" loaded from Firestore!`, 'success');
                draftListContainerElement.style.display = 'none';
                rebuildAndRenderSummary();
                updateAllMergeOverlays();
            } else {
                showMessage(`Draft "${draftName}" not found in Firestore.`, 'error');
            }
        } catch (error) {
            console.error("Error loading draft from Firestore:", error);
            showMessage(`Failed to load draft. Error: ${error.message}`, "error");
        } finally {
            showDraftListLoading(false);
        }
    }

    async function deleteDraftFromFirestore(draftName) {
        if (!fbDb || !fbUserId || !fbIsAuthReady) {
            showMessage("Firebase not ready. Cannot delete draft.", "error"); return;
        }
        if (await customConfirm(`Are you sure you want to delete draft "${draftName}" from Firestore? This action cannot be undone.`)) {
            showDraftListLoading(true);
            const draftDocRef = doc(fbDb, "artifacts", appId, "users", fbUserId, "scheduleDrafts", draftName);
            try {
                await deleteDoc(draftDocRef);
                showMessage(`Draft "${draftName}" deleted from Firestore.`, 'success');
                await renderDraftListFromFirestore(); // Refresh the list
            } catch (error) {
                console.error("Error deleting draft from Firestore:", error);
                showMessage(`Failed to delete draft. Error: ${error.message}`, "error");
            } finally {
                showDraftListLoading(false);
            }
        }
    }
    
    async function exportAllDraftsFromFirestore() {
        if (!fbDb || !fbUserId || !fbIsAuthReady) {
            showMessage("Firebase not ready. Cannot export drafts.", "error"); return;
        }
        showDraftListLoading(true); // Or a general page loader
        const draftsCollectionRef = collection(fbDb, "artifacts", appId, "users", fbUserId, "scheduleDrafts");
        const draftsToExport = {};
        try {
            const querySnapshot = await getDocs(draftsCollectionRef);
            if (querySnapshot.empty) {
                showMessage('No drafts in Firestore to export.', 'info');
                return;
            }
            querySnapshot.forEach((docSnap) => {
                draftsToExport[docSnap.id] = docSnap.data(); // Store data by draft name (doc ID)
            });

            const draftsJson = JSON.stringify(draftsToExport, (key, value) => {
                // Convert Firestore Timestamps to ISO strings for JSON compatibility
                if (value && typeof value.toDate === 'function') {
                    return value.toDate().toISOString();
                }
                return value;
            }, 2); // Pretty print JSON

            const blob = new Blob([draftsJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'firestore_schedule_drafts.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage('All drafts from Firestore exported successfully!', 'success');

        } catch (error) {
            console.error("Error exporting drafts from Firestore:", error);
            showMessage(`Failed to export drafts. Error: ${error.message}`, "error");
        } finally {
            showDraftListLoading(false);
        }
    }

    async function importDraftsToFirestore(event) {
        if (!fbDb || !fbUserId || !fbIsAuthReady) {
            showMessage("Firebase not ready. Cannot import drafts.", "error"); return;
        }
        const file = event.target.files[0];
        if (!file) { showMessage('No file selected for import.', 'info'); return; }
        if (file.type !== 'application/json') {
            showMessage('Invalid file type. Please select a .json file.', 'error');
            event.target.value = ''; return;
        }
        showDraftListLoading(true); // Or general loader
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const importedDraftsText = e.target.result;
                const importedDraftsData = JSON.parse(importedDraftsText);

                if (typeof importedDraftsData !== 'object' || importedDraftsData === null) {
                    showMessage('Invalid draft file format.', 'error'); return;
                }

                let importedCount = 0; let overwrittenCount = 0; let skippedCount = 0;
                const draftsCollectionRef = collection(fbDb, "artifacts", appId, "users", fbUserId, "scheduleDrafts");

                for (const draftName in importedDraftsData) {
                    if (Object.prototype.hasOwnProperty.call(importedDraftsData, draftName)) {
                        const draftData = importedDraftsData[draftName];
                        // Basic validation of draft data structure
                        if (draftData && typeof draftData.html === 'string' && typeof draftData.meta === 'object' && typeof draftData.activeTableId === 'string') {
                            
                            const draftDocRef = doc(draftsCollectionRef, draftName);
                            const docSnap = await getDoc(draftDocRef);

                            let dataToSave = { ...draftData };
                            // If timestamp was stringified, try to convert back or use serverTimestamp
                            if (typeof dataToSave.timestamp === 'string') {
                                // Attempt to parse, otherwise fallback to serverTimestamp
                                const parsedDate = new Date(dataToSave.timestamp);
                                if (!isNaN(parsedDate)) {
                                     // Firestore expects its own Timestamp objects, not JS Dates directly for setDoc
                                     // For simplicity, we'll let serverTimestamp handle new/overwritten ones.
                                     // If preserving exact imported timestamp is critical, convert JS Date to Firestore Timestamp.
                                     // For now, let's prioritize serverTimestamp on new save.
                                     dataToSave.timestamp = serverTimestamp();
                                } else {
                                    dataToSave.timestamp = serverTimestamp();
                                }
                            } else {
                                dataToSave.timestamp = serverTimestamp(); // Ensure timestamp field exists
                            }


                            if (docSnap.exists()) {
                                if (await customConfirm(`Draft "${draftName}" already exists in Firestore. Overwrite?`)) {
                                    await setDoc(draftDocRef, dataToSave);
                                    overwrittenCount++;
                                } else {
                                    skippedCount++;
                                }
                            } else {
                                await setDoc(draftDocRef, dataToSave);
                                importedCount++;
                            }
                        } else {
                            console.warn(`Skipping invalid draft data for "${draftName}" during import.`);
                            skippedCount++;
                        }
                    }
                }
                showMessage(`Firestore drafts import: ${importedCount} new, ${overwrittenCount} overwritten, ${skippedCount} skipped.`, 'success', 5000);
                if (draftListContainerElement.style.display === 'block' || importedCount > 0 || overwrittenCount > 0) {
                    await renderDraftListFromFirestore(); // Refresh list
                }
            } catch (error) {
                console.error("Error importing drafts to Firestore:", error);
                showMessage(`Error processing draft file for Firestore. Error: ${error.message}`, 'error', 5000);
            } finally {
                event.target.value = ''; // Reset file input
                showDraftListLoading(false);
            }
        };
        reader.onerror = () => {
            showMessage('Failed to read the draft file.', 'error');
            event.target.value = '';
            showDraftListLoading(false);
        };
        reader.readAsText(file);
    }


    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        // Cache DOM Elements
        scheduleTitleElement = document.getElementById('scheduleTitle');
        tablesContainer = document.getElementById('tablesContainer');
        tableTabs = document.getElementById('tableTabs');
        nameModal = document.getElementById('nameModal');
        nameModalContent = document.getElementById('nameModalContent');
        nameModalHeader = document.getElementById('nameModalHeader');
        nameListContainer = document.getElementById('nameList');
        newNameInput = document.getElementById('newNameInput');
        draftListContainerElement = document.getElementById('draftListContainer'); // Updated ID
        summaryTableElement = document.getElementById('summaryTable');
        customMessageBox = document.getElementById('customMessageBox');
        fileInputElement = document.getElementById('fileInput');
        directCopyFullHtmlButtonElement = document.getElementById('directCopyFullHtmlBtn');
        closeNameModalButtonStandardElement = document.getElementById('closeNameModalBtnStandard');
        nameListImportFileInputElement = document.getElementById('nameListImportFile');
        searchNameInputElement = document.getElementById('searchNameInput');
        draftImportFileInputElement = document.getElementById('draftImportFile');
        userIdDisplayElement = document.getElementById('userIdDisplay');
        namePagiTabElement = document.getElementById('namePagiTab');
        namePetangTabElement = document.getElementById('namePetangTab');
        loadingIndicatorModalElement = document.getElementById('loadingIndicatorModal');
        nameModalTitleElement = document.getElementById('nameModalTitle');
        loadingIndicatorDraftListElement = document.getElementById('loadingIndicatorDraftList');


        if (!tablesContainer || !tableTabs || !nameModal || !nameModalContent || !nameModalHeader || !summaryTableElement || !customMessageBox || !scheduleTitleElement || !fileInputElement || !directCopyFullHtmlButtonElement || !closeNameModalButtonStandardElement || !nameListImportFileInputElement || !searchNameInputElement || !draftImportFileInputElement || !userIdDisplayElement || !namePagiTabElement || !namePetangTabElement || !loadingIndicatorModalElement || !nameModalTitleElement || !draftListContainerElement || !loadingIndicatorDraftListElement) {
            console.error("Critical DOM elements missing. Application might not function correctly.");
            document.body.innerHTML = "<p style='color:red; text-align:center; font-size:1.2em; padding:20px;'>Error: Application failed to initialize due to missing page elements. Please ensure the HTML structure is correct.</p>";
            return;
        }

        if (fbAuth) {
            onAuthStateChanged(fbAuth, async (user) => {
                if (user) {
                    fbUserId = user.uid;
                    fbIsAuthReady = true;
                    if(userIdDisplayElement) userIdDisplayElement.textContent = `User ID: ${fbUserId}`;
                    console.log("Firebase User is signed in with UID:", fbUserId);

                    if (unsubscribePagi) unsubscribePagi();
                    if (unsubscribePetang) unsubscribePetang();

                    unsubscribePagi = listenToNameList('pagi');
                    unsubscribePetang = listenToNameList('petang');
                    
                    if (nameModal.style.display === 'flex') {
                        renderNameListFromFirestore(searchNameInputElement.value);
                    }
                    // If draft list is already visible on load (e.g. due to user action before full load)
                    if (draftListContainerElement.style.display === 'block') {
                        await renderDraftListFromFirestore();
                    }

                } else {
                    fbIsAuthReady = false;
                    fbUserId = null;
                    if(userIdDisplayElement) userIdDisplayElement.textContent = "User ID: Not authenticated";
                    console.log("Firebase User is signed out or auth not yet complete.");
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(fbAuth, __initial_auth_token);
                        } else {
                            await signInAnonymously(fbAuth);
                        }
                    } catch (error) {
                        console.error("Error during Firebase sign-in:", error);
                        showMessage("Firebase Authentication failed. Core features may not work.", "error", 5000);
                        if(userIdDisplayElement) userIdDisplayElement.textContent = `User ID: Auth Error`;
                    }
                }
            });
        } else {
             if(userIdDisplayElement) userIdDisplayElement.textContent = "User ID: Firebase Error";
        }


        loadScheduleTitle();
        initializeEventListeners();
        setupInitialTableState();
        rebuildAndRenderSummary(); 
        handleNameListSessionSwitch('pagi'); 
    });

    function setupInitialTableState() { /* ... existing code ... */ }
    function loadScheduleTitle() { /* ... existing code ... */ }
    function initializeEventListeners() {
        directCopyFullHtmlButtonElement.addEventListener('click', attemptDirectCopyToClipboard);
        closeNameModalButtonStandardElement.addEventListener('click', closeNameModal);
        nameModalHeader.addEventListener('mousedown', startDragModal);
        document.addEventListener('mousemove', dragModal);
        document.addEventListener('mouseup', stopDragModal);
        nameModalHeader.addEventListener('touchstart', startDragModal, { passive: false });
        document.addEventListener('touchmove', dragModal, { passive: false });
        document.addEventListener('touchend', stopDragModal);
        document.getElementById('excelBtnTrigger').addEventListener('click', exportActiveTableToExcel);
        document.getElementById('importExcelBtn').addEventListener('click', () => fileInputElement.click());
        fileInputElement.addEventListener('change', handleExcelFileImport);
        
        // Draft buttons now point to Firestore functions
        document.getElementById('saveDraftBtn').addEventListener('click', saveDraftToFirestore);
        document.getElementById('loadDraftBtn').addEventListener('click', async () => { // Modified for Firestore
            const isVisible = draftListContainerElement.style.display === 'block';
            draftListContainerElement.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                await renderDraftListFromFirestore();
            }
        });
        document.getElementById('exportDraftsBtn').addEventListener('click', exportAllDraftsFromFirestore);
        document.getElementById('importDraftsBtn').addEventListener('click', () => draftImportFileInputElement.click());
        draftImportFileInputElement.addEventListener('change', importDraftsToFirestore);


        document.getElementById('clearActiveTableContentBtn').addEventListener('click', confirmAndClearActiveTableContent);
        document.getElementById('selectBtn').addEventListener('click', toggleCellSelectionMode);
        document.getElementById('mergeBtn').addEventListener('click', mergeSelectedTableCells);
        document.getElementById('deselectBtn').addEventListener('click', deselectAllTableCells);
        document.getElementById('unmergeBtn').addEventListener('click', unmergeActiveCellIfMerged);
        document.getElementById('addTableBtn').addEventListener('click', () => addNewTable());
        document.getElementById('renameTableBtn').addEventListener('click', promptAndRenameActiveTable);
        document.getElementById('deleteTableBtn').addEventListener('click', confirmAndDeleteActiveTable);
        
        document.getElementById('nameListBtn').addEventListener('click', toggleNameListModalVisibility);
        document.getElementById('addNameBtnInModal').addEventListener('click', () => {
            if(newNameInput) addNameToCurrentSessionInFirestore(newNameInput.value);
        });
        document.getElementById('importNameListBtn').addEventListener('click', () => nameListImportFileInputElement.click());
        nameListImportFileInputElement.addEventListener('change', handleNameListImportFirestore);
        if(searchNameInputElement) searchNameInputElement.addEventListener('input', () => renderNameListFromFirestore(searchNameInputElement.value));
        
        namePagiTabElement.addEventListener('click', () => handleNameListSessionSwitch('pagi'));
        namePetangTabElement.addEventListener('click', () => handleNameListSessionSwitch('petang'));

        draftListContainerElement.addEventListener('click', async (e) => { // Event listener for Firestore draft list
            const targetSpan = e.target.closest('.draft-item-firestore span[data-draft-name]');
            const targetButton = e.target.closest('.draft-item-firestore button[data-draft-delete]');
            if (targetSpan) {
                await loadSelectedDraftFromFirestore(targetSpan.dataset.draftName);
            } else if (targetButton) {
                await deleteDraftFromFirestore(targetButton.dataset.draftDelete);
            }
        });
        nameListContainer.addEventListener('click', async (e) => { /* ... existing code ... */ });

        document.getElementById('addRowAboveBtn').addEventListener('click', addRowAboveToActiveTable);
        document.getElementById('addRowBelowBtn').addEventListener('click', addRowBelowToActiveTable);
        document.getElementById('addColLeftBtn').addEventListener('click', addColumnLeftToActiveTable);
        document.getElementById('addColRightBtn').addEventListener('click', addColumnRightToActiveTable);
        document.getElementById('deleteRowBtn').addEventListener('click', deleteClickedRowFromActiveTable);
        document.getElementById('deleteColBtn').addEventListener('click', deleteClickedColumnFromActiveTable);

        tablesContainer.addEventListener('click', handleTableCellClick);
        tablesContainer.addEventListener('blur', (e) => { /* ... existing code ... */ }, true);
        tablesContainer.addEventListener('input', (e) => { /* ... existing code ... */ });
        window.addEventListener('resize', updateAllMergeOverlays);
    }

    // --- Draggable Modal Functionality (Existing) ---
    function startDragModal(e) { /* ... existing code ... */ }
    function dragModal(e) { /* ... existing code ... */ }
    function stopDragModal() { /* ... existing code ... */ }

    // --- Direct Copy Full HTML Functionality (Existing) ---
    async function attemptDirectCopyToClipboard() { /* ... existing code ... */ }

    // --- Draft Management (MODIFIED FOR FIRESTORE) ---
    // promptAndSaveDraft -> saveDraftToFirestore
    // toggleDraftListVisibility -> Modified in initializeEventListeners to call renderDraftListFromFirestore
    // renderDraftList -> renderDraftListFromFirestore
    // loadSelectedDraft -> loadSelectedDraftFromFirestore
    // confirmAndDeleteDraft -> deleteDraftFromFirestore
    // exportAllDrafts -> exportAllDraftsFromFirestore
    // handleDraftsFileImport -> importDraftsToFirestore
    
    async function confirmAndClearActiveTableContent() { /* ... existing code ... */ }
    
    // --- Table Management (Existing, Unchanged) ---
    function addTabButton(id, label) { /* ... existing code ... */ }
    function switchTable(id) { /* ... existing code ... */ }
    function addNewTable(isInitial = false) { /* ... existing code ... */ }
    async function promptAndRenameActiveTable() { /* ... existing code ... */ }
    async function confirmAndDeleteActiveTable() { /* ... existing code ... */ }

    // --- Row/Column Operations (Existing, Unchanged) ---
    function addRowToTable(tableBody, rowIndex, numCols) { /* ... existing code ... */ }
    function addRowAboveToActiveTable() { /* ... existing code ... */ }
    function addRowBelowToActiveTable() { /* ... existing code ... */ }
    function addColumnToTable(table, colIndex) { /* ... existing code ... */ }
    function addColumnLeftToActiveTable() { /* ... existing code ... */ }
    function addColumnRightToActiveTable() { /* ... existing code ... */ }
    async function deleteClickedRowFromActiveTable() { /* ... existing code ... */ }
    async function deleteClickedColumnFromActiveTable() { /* ... existing code ... */ }

    // --- Cell Selection, Merging, Unmerging (Existing, Unchanged) ---
    function toggleCellSelectionMode() { /* ... existing code ... */ }
    function handleTableCellClick(event) { /* ... existing code ... */ }
    function deselectAllTableCells() { /* ... existing code ... */ }
    function mergeSelectedTableCells() { /* ... existing code ... */ }
    function unmergeActiveCellIfMerged() { /* ... existing code ... */ }
    function updateAllMergeOverlays() { /* ... existing code ... */ }

    // --- Name List Management (Modal) - Firestore (Existing) ---
    function handleNameListSessionSwitch(session) { /* ... existing code ... */ }
    function highlightSelectedNameInList(nameToHighlight) { /* ... existing code ... */ }
    function clearNameSelection() { /* ... existing code ... */ }
    function closeNameModal() { /* ... existing code ... */ }
    function toggleNameListModalVisibility() { /* ... existing code ... */ }
    function renderNameListFromFirestore(filterText = '') { /* ... existing code ... */ }
    function selectNameForCellInsertion(name) { /* ... existing code ... */ }
    function handleNameListImportFirestore(event) { /* ... existing code ... */ }

    // --- Excel Export/Import (Existing, Unchanged) ---
    function handleExcelFileImport(event) { /* ... existing code ... */ }
    function exportActiveTableToExcel() { /* ... existing code ... */ }

    // --- Summary Table Logic (Existing, Unchanged by draft storage method) ---
    function rebuildAndRenderSummary() { /* ... existing code ... */ }
    function parseTimeToMinutes(timeStr) { /* ... existing code ... */ }
    function buildSummaryTableSkeleton(allAvailableNames) { /* ... existing code ... */ }
    function updateSummaryTableData(allAvailableNames) { /* ... existing code ... */ }

    // Ensure existing utility functions are complete in the actual script
    // For brevity, their full code is not repeated here if unchanged.
    // Make sure showMessage, customPrompt, customConfirm are fully present.

</script>
</body>
</html>