<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.1, maximum-scale=5.0">
    <title>Enhanced Shared Weekly Schedule with Firestore</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
            margin: 0;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
            min-height: 100vh;
        }
        .main-container {
            width: 100%;
            max-width: 1400px;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            box-sizing: border-box;
        }
        h2, h3 {
            color: #1c1e21;
            text-align: center;
            margin-bottom: 20px;
        }
        #scheduleTitle {
            font-size: 2em;
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 10px;
        }
        #userIdDisplay {
            text-align: center;
            font-size: 0.9em;
            color: #555;
            margin-bottom: 15px;
            min-height: 1.2em;
            word-break: break-all;
        }

```
    /* --- Top Action Buttons Bar --- */
    #topActionButtonsBar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: stretch;
        justify-content: center;
        margin-bottom: 20px;
        width: 100%;
    }

    .top-action-btn {
        padding: 10px 15px;
        font-size: 0.9em;
        font-weight: 500;
        border-radius: 8px;
        cursor: pointer;
        border: 1px solid transparent;
        color: #ffffff;
        transition: all 0.25s ease-out;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.03);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        white-space: nowrap;
        flex-grow: 1;
        flex-basis: 150px;
        text-align: center;
        min-height: 40px;
        box-sizing: border-box;
    }

    #controlsToggler.top-action-btn {
        background-image: linear-gradient(to right, #007bff 0%, #0056b3 100%);
    }
    #controlsToggler.top-action-btn:hover {
        background-image: linear-gradient(to right, #0069d9 0%, #004085 100%);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
        transform: translateY(-1px);
    }

    #manualSaveBtn.top-action-btn {
        background-image: linear-gradient(to right, #17a2b8 0%, #117a8b 100%);
    }
    #manualSaveBtn.top-action-btn:hover {
        background-image: linear-gradient(to right, #138496 0%, #0c6270 100%);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
        transform: translateY(-1px);
    }

    #downloadPdfBtn.top-action-btn {
         background-image: linear-gradient(to right, #28a745 0%, #1e7e34 100%);
    }
    #downloadPdfBtn.top-action-btn:hover {
         background-image: linear-gradient(to right, #218838 0%, #155724 100%);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
        transform: translateY(-1px);
    }
    
    #clearScheduledNamesBtn.top-action-btn {
        background-image: linear-gradient(to right, #6f42c1 0%, #563d7c 100%);
    }
    #clearScheduledNamesBtn.top-action-btn:hover {
        background-image: linear-gradient(to right, #5a2a9e 0%, #452863 100%);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
        transform: translateY(-1px);
    }

    .top-action-btn:active {
        transform: translateY(0px);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    #controlsToggler .toggler-icon {
        transition: transform 0.3s ease-out;
        width: 18px;
        height: 18px;
    }
    #controlsToggler[aria-expanded="false"] .toggler-icon {
        transform: rotate(180deg);
    }
     #controlsToggler[aria-expanded="true"] .toggler-icon {
        transform: rotate(0deg);
    }

    /* --- Collapsible Button Bars --- */
    #collapsibleButtonBars {
        max-height: 1000px;
        overflow: hidden;
        transition: max-height 0.4s ease-in-out, margin-top 0.4s ease-in-out, padding-top 0.4s ease-in-out, padding-bottom 0.4s ease-in-out;
        padding-top: 5px;
        padding-bottom: 5px;
        width: 100%;
    }
    #collapsibleButtonBars:not(.open) {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        margin-top: 0;
    }

    .bar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px;
        align-items: stretch;
        justify-content: center;
    }
    .bar button {
        padding: 10px 15px;
        font-size: 0.9em;
        font-weight: 500;
        border-radius: 8px;
        cursor: pointer;
        border: 1px solid #ced4da;
        background-color: #f8f9fa;
        color: #212529;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        flex-grow: 1;
        flex-basis: 120px;
        text-align: center;
        min-width: 100px;
    }
    .bar button:hover {
        border-color: #adb5bd;
        background-color: #e9ecef;
        box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        transform: translateY(-1px);
    }
    .bar button:active {
        transform: translateY(0px);
        background-color: #dee2e6;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.06);
    }

    #directCopyFullHtmlBtn { background-color: #545b62; color: white; border-color: #4e555b;}
    #excelBtnTrigger, #importExcelBtn, #importNameListBtn, .input-group button { background-color: #28a745; color: white; border-color: #23923d;}
    #saveSharedScheduleBtn { background-color: #007bff; color: white; border-color: #0069d9;}
    #loadSharedScheduleBtn { background-color: #ffc107; color: #212529; border-color: #e0a800;}
    #restoreBackupBtn { background-color: #fd7e0f; color: white; border-color: #df6e0d; }
    #clearAndResetScheduleBtn, #nameListBtn { background-color: #fd7e14; color: white; border-color: #e66a04;}
    #selectBtn { background-color: #17a2b8; color: white; border-color: #117a8b;}
    #selectBtn.active { background-color: #e66a04; border-color: #d05f03;}
    #mergeBtn { background-color: #6f42c1; color: white; border-color: #5d37a2;}
    #unmergeBtn { background-color: #e83e8c; color: white; border-color: #d9307b;}
    #addTableBtn { background-color: #20c997; color: white; border-color: #1aa87f;}
    #addIndependentTableBtn { background-color: #fd7e14; color: white; border-color: #e66a04;}
    #renameTableBtn, #deselectBtn { background-color: #6c757d; color: white; border-color: #5a6268;}
    #deleteTableBtn, #rowColManipulationBar button.delete-btn { background-color: #dc3545; color: white; border-color: #c82333;}
    #exportSharedSchedulesBtn { background-color: #4e54c8; color: white; border-color: #3b40a0;}
    #importSharedSchedulesBtn { background-color: #8f94fb; color: white; border-color: #7076f9;}
    
    #directCopyFullHtmlBtn:hover { background-color: #434a50; }
    #excelBtnTrigger:hover, #importExcelBtn:hover, #importNameListBtn:hover, .input-group button:hover { background-color: #1e7e34; }
    #saveSharedScheduleBtn:hover { background-color: #0056b3; }
    #loadSharedScheduleBtn:hover { background-color: #d39e00; }
    #restoreBackupBtn:hover { background-color: #e07010; }
    #clearAndResetScheduleBtn:hover, #nameListBtn:hover { background-color: #d05f03; }
    #selectBtn:hover { background-color: #0f6674; }
    #selectBtn.active:hover { background-color: #c25202;}
    #mergeBtn:hover { background-color: #563299; }
    #unmergeBtn:hover { background-color: #d9307b; }
    #addTableBtn:hover { background-color: #178d6f; }
    #addIndependentTableBtn:hover { background-color: #d05f03; }
    #renameTableBtn:hover, #deselectBtn:hover { background-color: #545b62; }
    #deleteTableBtn:hover, #rowColManipulationBar button.delete-btn:hover { background-color: #b21f2d; }
    #exportSharedSchedulesBtn:hover { background-color: #3b40a0; }
    #importSharedSchedulesBtn:hover { background-color: #7076f9; }

    #rowColManipulationBar button { padding: 8px 12px; font-size: 0.85em; }

    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        background-color: #fff;
        table-layout: auto; 
    }
    #tablesContainer, #summaryTableContainer {
        overflow-x: auto;
        position: relative;
        width: 100%;
    }
    #tablesContainer > table { display: none; }
    #tablesContainer > table.active { display: table; }
    #summaryTable { margin-top: 25px; }

    th, td {
        border: 1px solid #dee2e6;
        padding: 10px 12px;
        text-align: center;
        min-width: 90px; 
        box-sizing: border-box;
        position: relative;
        font-size: 0.9em;
    }
    table th {
        background-color: #f8f9fa;
        color: #343a40;
        font-weight: 600;
        white-space: nowrap;
    }
    #tablesContainer > table > thead > tr:not(.date-header-row) > th {
        font-weight: bold;
        background-color: #e9ecef;
        color: #343a40;
    }
    #tablesContainer > table > thead > tr:not(.date-header-row) > th:first-child,
    #tablesContainer > table > tbody > tr > td:first-child,
    #tablesContainer > table > tbody > tr > th:first-child {
        font-weight: bold;
        background-color: #e6f7ff; 
        color: #1c1e21;
    }

    #tablesContainer > table > thead > tr.date-header-row > th.date-header-cell {
        font-weight: bold;
        background-color: #cce0ff; 
        color: #1c1e21;
        white-space: normal;
    }
    #tablesContainer > table > thead > tr.date-header-row > th.date-header-cell.merged-cell-container .merged-cell-overlay {
        background-color: #cce0ff; 
        font-weight: bold;
        color: #1c1e21;
    }


    #summaryTable > thead > tr > th {
        font-weight: bold;
        background-color: #e9ecef; 
        color: #212529;
    }
    #summaryTable > thead > tr > th:first-child,
    #summaryTable > tbody > tr > td:first-child {
        font-weight: bold;
        background-color: #e6f7ff !important; 
        color: #1c1e21;
    }
    #summaryTable td.summary-merged-cell {
        background-color: #f0f8ff !important; 
    }
    #summaryTable td { background-color: #fff9e6; } 
    
    td.selected, th.selected {
        outline: 3px solid #007bff;
        background-color: #d1e7fd;
    }
    
    .table-tabs {
        margin-bottom: 15px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 0;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
    .table-tabs button {
        background-color: transparent; border: none;
        border-bottom: 3px solid transparent; border-radius: 6px 6px 0 0;
        color: #0056b3; font-weight: 500; padding: 10px 15px;
        transition: all 0.2s ease;
        position: relative;
    }
    .table-tabs button.active {
        background-color: #007bff; color: white;
        border-color: #0056b3;
    }
    .table-tabs button:hover:not(.active) {
        background-color: #e9f5ff; color: #004494;
    }
    
    /* Independent table styling */
    .table-tabs button.independent-table {
        border-top: 3px solid #fd7e14;
        border-left: 3px solid #fd7e14;
        border-right: 3px solid #fd7e14;
        border-bottom: 3px solid transparent;
        background-color: #fff3e0;
        color: #e65100;
    }
    .table-tabs button.independent-table.active {
        background-color: #fd7e14;
        color: white;
        border-color: #e66a04;
    }
    .table-tabs button.independent-table:hover:not(.active) {
        background-color: #fff8f2;
        color: #d84315;
    }
    
    /* Independent table indicator */
    .table-tabs button.independent-table::after {
        content: "üìä";
        position: absolute;
        top: -2px;
        right: -2px;
        font-size: 12px;
        background-color: #fd7e14;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
    }
    .table-tabs button.independent-table.active::after {
        background-color: #fff;
        color: #fd7e14;
    }

    .name-session-tabs {
        margin-bottom: 20px; border-bottom: 2px solid #dee2e6;
        padding-bottom: 8px; display: flex; flex-wrap: wrap; gap: 5px;
    }
    .name-session-tabs button {
        border-bottom-left-radius: 0; border-bottom-right-radius: 0;
        border-bottom: none; margin-bottom: -2px;
        padding: 10px 15px; font-size: 1em;
        background-color: #f8f9fa; border: 1px solid #dee2e6;
        border-bottom: 1px solid #dee2e6;
    }
    .name-session-tabs button.active {
        background-color: #ffffff; color: #007bff;
        border-color: #dee2e6 #dee2e6 #ffffff;
        border-bottom: 1px solid #ffffff;
        font-weight: bold; position: relative; z-index: 1;
    }
    
    .highlight-conflict {
        background-color: #f8d7da !important; font-weight: bold;
        color: #721c24 !important;
    }
    #summaryTable > tbody > tr > td.highlight-conflict:first-child {
        background-color: #e6f7ff !important; 
        color: #721c24 !important; 
    }
    .modal {
        display: none; position: fixed; z-index: 1000; left: 0; top: 0;
        width: 100%; height: 100%; overflow: hidden;
        background-color: rgba(0,0,0,0.5);
        align-items: center; justify-content: center;
        pointer-events: none;
    }
    .modal-content {
        background-color: #fff; padding: 25px; border: 1px solid #ccc;
        width: 90%; max-width: 650px; border-radius: 10px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3); position: relative;
        pointer-events: auto; max-height: 90vh; overflow-y: auto;
        box-sizing: border-box;
    }
    .modal-content.dragging { transform: none; }
    .modal-header {
        padding-bottom: 15px; border-bottom: 1px solid #e9ecef; margin-bottom: 20px;
        font-size: 1.3em; color: #333; display: flex;
        justify-content: space-between; align-items: center;
        cursor: move; user-select: none;
    }
    .modal-close-btn {
        font-size: 1.8rem; font-weight: bold; line-height: 1; color: #555;
        text-shadow: none; opacity: .7; background: transparent; border: 0;
        cursor: pointer; padding: 0 5px; transition: color 0.2s;
    }
    .modal-close-btn:hover { opacity: 1; color: #dc3545; }
    .name-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px 8px; border-bottom: 1px solid #f1f3f5;
        transition: background-color 0.2s;
    }
    .name-item:hover { background-color: #f8f9fa; }
    .name-item:last-child { border-bottom: none; }
    .name-item span {
        flex-grow: 1; cursor: pointer; color: #007bff; font-weight: 500;
    }
    .name-item span:hover { text-decoration: none; color: #0056b3; }
    .name-item button {
        background-color: #dc3545; color: white; border: none; border-radius: 5px;
        padding: 6px 12px; font-size: 0.9em; transition: background-color 0.2s;
    }
    .name-item button:hover { background-color: #c82333; }
    .highlighted { background-color: #cfe2ff !important; font-weight: bold; }
    
    #sharedScheduleListContainer, #restoreBackupListContainer {
        border: 1px solid #ddd; padding: 15px; margin-bottom: 20px;
        border-radius: 8px; background-color: #f8f9fa;
        max-height: 300px; overflow-y: auto;
    }
    .shared-schedule-item, .backup-schedule-item {
        display: flex; flex-direction: column;
        padding: 10px 8px; border-bottom: 1px solid #e9ecef;
    }
    .shared-schedule-item:last-child, .backup-schedule-item:last-child { border-bottom: none; }

    .schedule-item-main-line {
        display: flex; justify-content: space-between; align-items: center; width: 100%;
    }
    .schedule-item-main-line span {
        cursor: pointer; color: #007bff; flex-grow: 1; margin-right: 10px;
        font-weight: 500;
    }
    .schedule-item-main-line span:hover { text-decoration: underline; }
    .schedule-item-main-line button {
        background-color: #dc3545; color: white; border: none; border-radius: 5px;
        padding: 6px 12px; font-size: 0.9em; flex-shrink: 0;
    }
    .schedule-item-details {
        font-size: 0.8em; color: #6c757d; margin-top: 4px;
        display: flex; flex-direction: column;
        gap: 2px;
    }
    .schedule-item-details .schedule-date,
    .schedule-item-details .original-schedule-name {
         white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }


    #newNameInput, #searchNameInput {
        padding: 10px; margin-right: 8px; border: 1px solid #ccc;
        border-radius: 5px; flex-grow: 1; width: calc(100% - 120px);
        box-sizing: border-box;
    }
     #searchNameInput {
        margin-bottom: 15px; width: 100%; box-sizing: border-box; margin-right: 0;
     }
    .input-group { display: flex; margin-bottom: 15px; width: 100%; }
    .input-group button { padding: 10px 15px; }
    #importNameListBtn { margin-top: 10px; width: 100%; }
    #nameList { margin-top:15px; max-height:250px; overflow-y:auto; }
    @media (min-width: 480px) {
        #nameList { column-count: 2; column-gap: 20px; }
    }
    .custom-message-box {
        display: none; position: fixed; top: 20px; left: 50%;
        transform: translateX(-50%); background-color: #333; color: white;
        padding: 15px 25px; border-radius: 8px; z-index: 2000;
        box-shadow: 0 4px 15px rgba(0,0,0,0.25); font-size: 1.05em;
        text-align: center; width: 90%; max-width: 400px;
    }
    .custom-message-box.success { background-color: #28a745; }
    .custom-message-box.error { background-color: #dc3545; }
    .custom-message-box.info { background-color: #007bff; }
    .merged-cell-container { position: relative; z-index: 2; vertical-align: top; }
    .merged-cell-overlay {
        position: absolute; top: 0; left: 0;
        width: var(--merged-width); height: var(--merged-height);
        background-color: rgba(240, 248, 255, 0.95); 
        font-style: italic; border: 1px solid #add8e6;
        display: flex; align-items: center; justify-content: center;
        overflow: hidden; box-sizing: border-box; z-index: 5;
    }
    .subsumed-cell { visibility: hidden; }
    #loadingIndicatorModal, #generalLoadingIndicator, #loadingIndicatorRestoreModal {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(255, 255, 255, 0.85);
        display: flex; align-items: center; justify-content: center;
        z-index: 10; border-radius: 10px;
    }
    #generalLoadingIndicator { position: fixed; z-index: 3000; border-radius: 0; }
    .spinner {
        border: 5px solid rgba(0, 0, 0, 0.1); width: 40px; height: 40px;
        border-radius: 50%; border-left-color: #007bff;
        animation: spin 1s ease infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    input[type="file"][style*="display:none"],
    input[type="file"][style*="display: none"] {
        position: absolute; left: -9999px; width: 1px; height: 1px; opacity: 0;
    }
    #autocompleteSuggestions {
        display: none; position: absolute; border: 1px solid #ccc;
        background-color: white; z-index: 1001; max-height: 150px;
        overflow-y: auto; min-width: 120px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.15); border-radius: 4px;
    }
    .suggestion-item {
        padding: 8px 10px; cursor: pointer; font-size: 0.9em; white-space: nowrap;
    }
    .suggestion-item:hover, .suggestion-item.active-suggestion {
        background-color: #e9ecef; color: #0056b3;
    }

    /* Summary Table Notice */
    .summary-notice {
        background-color: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 15px;
        font-size: 0.9em;
        color: #0056b3;
        text-align: center;
    }
    .summary-notice.hidden {
        display: none;
    }

    /* PDF Specific Styles */
    #pdfContent {
        padding: 5mm; background-color: #fff; color: #333;
        font-family: 'Arial', sans-serif; box-sizing: border-box;
        width: 100%; display: none;
    }
    #pdfContent .pdf-page-wrapper {
        page-break-inside: avoid !important; padding-bottom: 10mm;
        box-sizing: border-box; margin-bottom: 5mm;
    }
     #pdfContent .pdf-page-wrapper:not(:first-child) { page-break-before: always !important; }
    #pdfContent .pdf-page-wrapper:last-child { page-break-after: auto !important; }
    #pdfContent h2 {
        text-align: center; color: #000; margin-bottom: 5mm; font-size: 14pt;
        page-break-after: avoid !important; page-break-inside: avoid !important;
    }
    #pdfContent h3 {
        text-align: center; color: #000; margin-top: 2mm; margin-bottom: 3mm;
        font-size: 11pt; page-break-after: avoid !important; page-break-inside: avoid !important;
    }
    #pdfContent table {
        width: 100% !important; border-collapse: collapse !important;
        margin-bottom: 5mm; box-shadow: none; background-color: #fff;
        table-layout: fixed !important; font-size: 7pt;
        page-break-inside: avoid !important;
    }
    #pdfContent th, #pdfContent td {
        border: 0.5pt solid #333 !important; padding: 1mm 1.5mm;
        text-align: center; word-wrap: break-word; overflow-wrap: break-word;
        background-color: #fff !important; page-break-inside: avoid !important;
    }
    #pdfContent th {
        background-color: #f0f0f0 !important; color: #000; font-weight: bold;
    }
    #pdfContent table thead tr.date-header-row th.date-header-cell {
        background-color: #b8d6ff !important;
        font-weight: bold !important;
        color: #000 !important;
        white-space: normal !important;
    }
    #pdfContent table thead tr:not(.date-header-row) th:first-child,
    #pdfContent table tbody tr td:first-child {
        background-color: #e6f7ff !important; font-weight: bold; white-space: normal;
    }
     #pdfContent table tr { page-break-inside: avoid !important; }
    #pdfContent .pdf-footnote {
        text-align: right; font-size: 6pt; color: #333; margin-top: 3mm;
        padding-top: 2mm; border-top: 0.5pt solid #ccc; width: 100%;
        box-sizing: border-box;
    }

    @media (max-width: 768px) {
        .main-container { padding: 15px; }
        #scheduleTitle { font-size: 1.8em; }
        h3 { font-size: 1.1em; }
        .top-action-btn {
            font-size: 0.85em;
            padding: 8px 12px;
            flex-basis: calc(25% - 6px);
            min-width: 0;
        }
        .bar button { font-size: 0.85em; padding: 8px 12px; flex-basis: 100px; }
        th, td { padding: 8px 10px; min-width: 70px; font-size: 0.85em; }
        .table-tabs button, .name-session-tabs button { padding: 8px 10px; font-size: 0.9em; }
    }
    @media (max-width: 600px) {
         .top-action-btn {
            flex-basis: calc(50% - 4px);
        }
    }
    @media (max-width: 480px) {
        body { padding: 5px; }
        .main-container { padding: 10px; }
        #scheduleTitle { font-size: 1.5em; }
        #controlsToggler .toggler-icon { width: 16px; height: 16px; }
         .bar button { font-size: 0.8em; padding: 6px 10px; gap: 4px; flex-basis: calc(50% - 4px); }
        th, td { padding: 6px 8px; min-width: 60px; font-size: 0.8em; }
         #nameList { column-count: 1; }
    }
</style>
```

</head>
<body>
<div class="main-container">
    <h2 contenteditable="true" id="scheduleTitle">Jadual Anjal</h2>
    <div id="userIdDisplay">User ID: Loading...</div>

```
<div id="topActionButtonsBar">
    <button id="controlsToggler" class="top-action-btn" aria-expanded="false" aria-controls="collapsibleButtonBars" title="Toggle button controls visibility">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="toggler-icon"><polyline points="18 15 12 9 6 15"></polyline></svg>
        <span>Show Controls</span>
    </button>
    <button id="manualSaveBtn" class="top-action-btn" title="Manually save current page state to Cloud (also creates a backup)">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
        <span>Save Page</span>
    </button>
    <button id="downloadPdfBtn" class="top-action-btn" title="Download schedule tables as PDF">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        <span>PDF</span>
    </button>
    <button id="clearScheduledNamesBtn" class="top-action-btn" title="Clear scheduled names from the ACTIVE table (retains merged cell content)">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><line x1="17" y1="8" x2="22" y2="13"></line><line x1="22" y1="8" x2="17" y2="13"></line></svg>
        <span>Clear Names (Active Table)</span>
    </button>
</div>

<div id="collapsibleButtonBars">
    <div class="bar">
        <button id="directCopyFullHtmlBtn" title="Copy the entire page's HTML to clipboard">üìã Copy HTML</button>
    </div>
    <div class="bar">
        <button id="excelBtnTrigger" title="Export the currently active table to an Excel file">üíæ Export Excel</button>
        <button id="importExcelBtn" title="Import data from an Excel file into a new table">üìÇ Import Excel</button>
        <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none">
    </div>
    <div class="bar">
        <button id="saveSharedScheduleBtn" title="Save current schedule to the shared Cloud space (also creates a backup)">üí† Save Shared</button>
        <button id="loadSharedScheduleBtn" title="Show list of shared schedules from Cloud to load">‚òÅÔ∏è Load Shared</button>
        <button id="restoreBackupBtn" title="Restore a schedule from a backup copy">üõ°Ô∏è Restore Backup</button>
        <button id="exportSharedSchedulesBtn" title="Export all shared schedules from Cloud to a JSON file">üì§ Export All</button>
        <button id="importSharedSchedulesBtn" title="Import schedules from a JSON file to the shared Cloud space">üì• Import All</button>
        <input type="file" id="sharedScheduleImportFile" accept=".json" style="display:none;">
        <button id="clearAndResetScheduleBtn" title="Clear all data and start a new schedule">üßπ Clear & New</button>
    </div>
    <div class="bar">
        <button id="selectBtn" title="Toggle cell selection mode on/off">‚ú® Select Cells</button>
        <button id="mergeBtn" title="Merge the currently selected cells">üîó Merge</button>
        <button id="deselectBtn" title="Clear current cell selection">üö´ Deselect</button>
        <button id="unmergeBtn" title="Unmerge the cell that was last clicked if it's part of a merge">üíî Unmerge</button>
    </div>
    <div class="bar">
        <button id="addTableBtn" title="Add a new schedule table (included in summary)">‚ûï Add Schedule Table</button>
        <button id="addIndependentTableBtn" title="Add an independent table (not included in summary)">üìä Add Independent Table</button>
        <button id="renameTableBtn" title="Rename the currently active table/sheet">üìù Rename Table</button>
        <button id="deleteTableBtn" title="Delete the currently active table/sheet">‚ùå Delete Table</button>
        <button id="nameListBtn" title="Open a dialog to manage the shared list of names (Firestore)">üë• Names</button>
    </div>
    <div class="bar" id="rowColManipulationBar">
        <button id="addRowAboveBtn" title="Add a new row above the currently selected/clicked row">‚¨ÜÔ∏è Row Above</button>
        <button id="addRowBelowBtn" title="Add a new row below the currently selected/clicked row">‚¨áÔ∏è Row Below</button>
        <button id="addColLeftBtn" title="Add a new column to the left of the currently selected/clicked column">‚¨ÖÔ∏è Col Left</button>
        <button id="addColRightBtn" title="Add a new column to the right of the currently selected/clicked column">‚û°Ô∏è Col Right</button>
        <button id="deleteRowBtn" class="delete-btn" title="Delete the currently selected/clicked row">üóëÔ∏è Del Row</button>
        <button id="deleteColBtn" class="delete-btn" title="Delete the currently selected/clicked column">üóëÔ∏è Del Col</button>
    </div>
</div>
<div id="sharedScheduleListContainer" style="display:none;"></div>

<div id="restoreBackupModal" class="modal">
    <div class="modal-content" id="restoreBackupModalContent">
        <div class="modal-header" id="restoreBackupModalHeader">
            <h3 id="restoreBackupModalTitle">Restore Schedule from Backup</h3>
            <button type="button" class="modal-close-btn" id="closeRestoreBackupModalBtn" title="Close restore backup">√ó</button>
        </div>
        <div id="restoreBackupListContainer"></div>
        <div id="loadingIndicatorRestoreModal" style="display:none;"><div class="spinner"></div></div>
    </div>
</div>

<div class="bar table-tabs" id="tableTabs"></div>
<div id="tablesContainer">
    <table id="tbl_1" class="active" data-table-name="Kelas 3 & 5">
        <thead>
            <tr class="date-header-row">
                <th class="date-header-cell" contenteditable="true">Thursday, 22 May 2025</th>
                <th class="date-header-cell" contenteditable="true"></th>
                <th class="date-header-cell" contenteditable="true"></th>
                <th class="date-header-cell date-header-cell merged-cell-container" contenteditable="true" data-merge-id="date_rehat_tbl1_col4">
                    <div class="merged-cell-overlay" style="--merged-width: 200px; --merged-height: 40px;" contenteditable="true">DAY INFO</div>
                </th>
                <th class="date-header-cell subsumed-cell" contenteditable="true" data-merge-id="date_rehat_tbl1_col4"></th>
                <th class="date-header-cell" contenteditable="true"></th>
                <th class="date-header-cell" contenteditable="true"></th>
            </tr>
            <tr>
                <th contenteditable="true">Class</th>
                <th contenteditable="true">08:00</th>
                <th contenteditable="true">09:00</th>
                <th contenteditable="true">10:00</th>
                <th contenteditable="true" data-merge-id="rehat_tbl1_col4" class="merged-cell-container">
                    <div class="merged-cell-overlay" style="--merged-width: 200px; --merged-height: 50px;" contenteditable="true">10:15-10:30<br>REHAT</div>
                </th>
                <th contenteditable="true" data-merge-id="rehat_tbl1_col4" class="subsumed-cell">11:00</th>
                <th contenteditable="true">12:00</th>
                <th contenteditable="true">13:00</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td contenteditable="true">5S1</td>
                <td contenteditable="true"></td><td contenteditable="true">JAMES *ReportDue // Sick leave</td><td contenteditable="true"></td>
                <td contenteditable="true" data-merge-id="rehat_tbl1_col4_row1" class="merged-cell-container">
                     <div class="merged-cell-overlay" style="--merged-width: 200px; --merged-height: 50px;" contenteditable="true"></div>
                </td>
                <td contenteditable="true" data-merge-id="rehat_tbl1_col4_row1" class="subsumed-cell"></td>
                <td contenteditable="true"></td><td contenteditable="true"></td>
            </tr>
             <tr>
                <td contenteditable="true">5S2</td>
                <td contenteditable="true">*SpecialAssembly</td><td contenteditable="true"></td><td contenteditable="true">LILY</td>
                 <td contenteditable="true" data-merge-id="rehat_tbl1_col4_row2" class="merged-cell-container">
                     <div class="merged-cell-overlay" style="--merged-width: 200px; --merged-height: 50px;" contenteditable="true"></div>
                </td>
                <td contenteditable="true" data-merge-id="rehat_tbl1_col4_row2" class="subsumed-cell"></td>
                <td contenteditable="true"></td><td contenteditable="true"></td>
            </tr>
        </tbody>
    </table>
</div>

<div id="nameModal" class="modal">
    <div class="modal-content" id="nameModalContent">
        <div class="modal-header" id="nameModalHeader">
            <h3 id="nameModalTitle">Shared Name List Manager</h3>
            <button type="button" class="modal-close-btn" id="closeNameModalBtnStandard" title="Close name manager">√ó</button>
        </div>
        <div class="name-session-tabs">
            <button id="namePagiTab" data-session="pagi" class="active">Pagi (Morning)</button>
            <button id="namePetangTab" data-session="petang">Petang (Afternoon)</button>
        </div>
         <div class="input-group">
            <input id="newNameInput" placeholder="Add new name to current shared session">
            <button id="addNameBtnInModal" title="Add the name to the shared list">Add</button>
         </div>
        <button id="importNameListBtn" title="Import names from a .txt file (one name per line) to current shared session">üìÇ Import Names (.txt) to Shared Session</button>
        <input type="file" id="nameListImportFile" accept=".txt" style="display:none;">
        <input type="text" id="searchNameInput" placeholder="üîç Search names in current shared session..." title="Filter the list of names">
        <div id="nameList"></div>
        <div id="loadingIndicatorModal" style="display:none;"><div class="spinner"></div></div>
    </div>
</div>

<div class="summary-notice" id="summaryNotice">
    üìä Summary shows only Schedule Tables. Independent tables are excluded from attendance tracking.
</div>
<h3 style="margin-top:32px">Teacher/Subject Attendance Summary</h3>
<div id="summaryTableContainer">
    <table id="summaryTable"></table>
</div>
<div id="customMessageBox" class="custom-message-box"></div>
<div id="generalLoadingIndicator" style="display:none;"><div class="spinner"></div></div>
```

</div>

<div id="pdfContent"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, getDocs, getDoc, deleteDoc, updateDoc, query, serverTimestamp, orderBy, where, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- User-provided Firebase Config (Fallback) ---
    const userProvidedFirebaseConfig = {
      apiKey: "AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4",
      authDomain: "jadual-3f0aa.firebaseapp.com",
      projectId: "jadual-3f0aa",
      storageBucket: "jadual-3f0aa.firebasestorage.app",
      messagingSenderId: "496526436851",
      appId: "1:496526436851:web:78ff48b28bfc8c31f14a86"
    };

    // --- Firebase Initialization ---
    let firebaseConfig;
    if (typeof __firebase_config !== 'undefined' && __firebase_config !== null && __firebase_config.trim() !== '') {
        try {
            firebaseConfig = JSON.parse(__firebase_config);
            console.log("Using injected Firebase config (__firebase_config).");
        } catch (e) {
            console.error("Error parsing injected __firebase_config. Falling back. Error:", e);
            firebaseConfig = userProvidedFirebaseConfig;
        }
    } else {
        firebaseConfig = userProvidedFirebaseConfig;
        console.log("Using Firebase config defined in the script.");
    }
    
    if (firebaseConfig.apiKey === "AIzaSyEXAMPLE-API-KEYdQquIEx4" || firebaseConfig.apiKey === "YOUR_API_KEY" || firebaseConfig.apiKey.includes("AIzaSyBgvyb95-jujtCC2HPiHXLdYMJgQquIEx4")) {
        console.warn("Firebase Auth: Update Firebase API Key if you see this in production.");
    }
    
    const appId = typeof __app_id !== 'undefined' ? __app_id : (firebaseConfig.appId || 'default-shared-scheduler-app');
    if (typeof __app_id === 'undefined') {
        console.warn("Firebase Auth: __app_id is not defined. Using App ID from Firebase config or default.");
    }

    let fbApp, fbAuth, fbDb;
    let fbUserId = null;
    let fbIsAuthReady = false;
    let unsubscribePagiShared = null;
    let unsubscribePetangShared = null;

    try {
        fbApp = initializeApp(firebaseConfig);
        fbAuth = getAuth(fbApp);
        fbDb = getFirestore(fbApp);
        console.log("Firebase services initialized for Shared Scheduler with Project ID:", firebaseConfig.projectId);
    } catch (e) {
        console.error("CRITICAL Error initializing Firebase services:", e);
        const userIdDisplayInitError = document.getElementById('userIdDisplay');
        if (userIdDisplayInitError) userIdDisplayInitError.textContent = "User ID: Firebase Init Error!";
    }

    // --- Global Variables & Constants ---
    const SCHEDULE_TITLE_KEY = `shared_jadual_title_${appId}`;
    const LAST_ACTIVE_SCHEDULE_ID_KEY = `last_active_schedule_id_${appId}`;
    
    let activeTableId = 'tbl_1';
    let tableCount = 1;
    let selectionMode = false;
    let selectedCells = [];
    let lastClickedCell = null;
    let selectedNameFromList = null;
    let currentNameListSession = 'pagi';
    let namesPagiShared = [];
    let namesPetangShared = [];
    let isDraggingModal = false;
    let modalDragOffsetX, modalDragOffsetY;
    let autocompleteSuggestionsDiv = null;
    let activeCellForAutocomplete = null;
    let currentAutocompleteIndex = -1;
    
    let currentWorkingScheduleDocId = null;
    let autoSaveIntervalId = null;
    const AUTO_SAVE_INTERVAL = 60000;
    let isAutoSaving = false;
    let lastSavedState = null;
    let isInitialStateSet = false;

    // --- DOM Element References (initialized in DOMContentLoaded) ---
    let scheduleTitleElement, tablesContainer, tableTabs, nameModal, nameModalContent, nameModalHeader,
        nameListContainer, newNameInput, sharedScheduleListContainerElement, summaryTableElement,
        summaryTableContainerElement, customMessageBox, fileInputElement, directCopyFullHtmlButtonElement,
        closeNameModalButtonStandardElement, nameListImportFileInputElement, searchNameInputElement,
        sharedScheduleImportFileInputElement, userIdDisplayElement, namePagiTabElement, namePetangTabElement,
        loadingIndicatorModalElement, nameModalTitleElement, generalLoadingIndicatorElement,
        controlsTogglerElement, collapsibleButtonBarsElement, downloadPdfButtonElement, pdfContentElement,
        clearAndResetScheduleBtnElement, manualSaveBtnElement, clearScheduledNamesBtnElement,
        restoreBackupBtnElement, restoreBackupModalElement, restoreBackupModalContentElement,
        restoreBackupModalHeaderElement, closeRestoreBackupModalBtnElement, restoreBackupListContainerElement,
        loadingIndicatorRestoreModalElement, summaryNoticeElement;

    // --- ALL FUNCTION DEFINITIONS START HERE ---

    // --- Utility Functions ---
    function showMessage(message, type = 'info', duration = 3000) {
        if (!customMessageBox) {
            customMessageBox = document.getElementById('customMessageBox');
            if (!customMessageBox) { console.warn("showMessage: customMessageBox not found. Msg:", message); return; }
        }
        customMessageBox.textContent = message;
        customMessageBox.className = `custom-message-box ${type}`;
        customMessageBox.style.display = 'block';
        setTimeout(() => { if (customMessageBox) customMessageBox.style.display = 'none'; }, duration);
    }

    function customPrompt(message, defaultValue = "") { return prompt(message, defaultValue); }

    function customConfirm(message) {
        return new Promise((resolve) => {
            const confirmModalId = 'customConfirmModal';
            let existingModal = document.getElementById(confirmModalId);
            if (existingModal) existingModal.remove();
            const modal = document.createElement('div');
            modal.id = confirmModalId;
            modal.style.cssText = `display: flex; position: fixed; z-index: 2001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;`;
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `background-color: #fff; padding: 25px; border-radius: 8px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); min-width: 300px; max-width: 90%;`;
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.style.marginBottom = '20px'; messageP.style.fontSize = '1.1em';
            const yesButton = document.createElement('button');
            yesButton.textContent = 'Yes';
            yesButton.style.cssText = `padding: 10px 20px; margin: 0 10px; border-radius: 5px; cursor: pointer; background-color: #28a745; color: white; border: none; font-size: 1em;`;
            const noButton = document.createElement('button');
            noButton.textContent = 'No';
            noButton.style.cssText = `padding: 10px 20px; margin: 0 10px; border-radius: 5px; cursor: pointer; background-color: #dc3545; color: white; border: none; font-size: 1em;`;
            const closeModal = (value) => { modal.remove(); resolve(value); };
            yesButton.onclick = () => closeModal(true);
            noButton.onclick = () => closeModal(false);
            modalContent.appendChild(messageP); modalContent.appendChild(yesButton); modalContent.appendChild(noButton);
            modal.appendChild(modalContent); document.body.appendChild(modal);
        });
    }
    
    function showGeneralLoading(isLoading) {
        if (generalLoadingIndicatorElement) generalLoadingIndicatorElement.style.display = isLoading ? 'flex' : 'none';
    }

    function toggleButtonBarsVisibility() {
        if (!collapsibleButtonBarsElement || !controlsTogglerElement) return;
        const isOpen = collapsibleButtonBarsElement.classList.toggle('open');
        controlsTogglerElement.setAttribute('aria-expanded', isOpen.toString());
        const textSpan = controlsTogglerElement.querySelector('span');
        if (textSpan) textSpan.textContent = isOpen ? 'Hide Controls' : 'Show Controls';
    }

    function showNameModalLoading(isLoading) {
        if (loadingIndicatorModalElement) loadingIndicatorModalElement.style.display = isLoading ? 'flex' : 'none';
    }
    function showRestoreBackupModalLoading(isLoading) {
        if (loadingIndicatorRestoreModalElement) loadingIndicatorRestoreModalElement.style.display = isLoading ? 'flex' : 'none';
    }
    
    function ensureDateHeaderRowExists(tableElement) {
        if (!tableElement || !tableElement.tHead) return;
        let numCols = 0;
        const timeSlotHeaderRow = Array.from(tableElement.tHead.rows).find(row => !row.classList.contains('date-header-row'));
        if (timeSlotHeaderRow) {
            numCols = timeSlotHeaderRow.cells.length;
        } else if (tableElement.rows.length > 0 && tableElement.rows[0].cells.length > 0) {
            const firstMeaningfulRow = Array.from(tableElement.rows).find(r => !r.classList.contains('date-header-row'));
            numCols = firstMeaningfulRow ? firstMeaningfulRow.cells.length : 1;
        } else {
            numCols = 1;
        }
        let dateRow = tableElement.tHead.querySelector('tr.date-header-row');
        if (!dateRow) {
            dateRow = document.createElement('tr');
            dateRow.className = 'date-header-row';
            for (let i = 0; i < numCols; i++) {
                const th = document.createElement('th');
                th.className = 'date-header-cell';
                th.contentEditable = 'true';
                dateRow.appendChild(th);
            }
            if (tableElement.tHead.firstChild) {
                tableElement.tHead.insertBefore(dateRow, tableElement.tHead.firstChild);
            } else {
                tableElement.tHead.appendChild(dateRow);
            }
        } else {
            const currentCellCount = dateRow.cells.length;
            if (currentCellCount < numCols) {
                for (let i = currentCellCount; i < numCols; i++) {
                    const th = document.createElement('th');
                    th.className = 'date-header-cell';
                    th.contentEditable = 'true';
                    dateRow.appendChild(th);
                }
            } else if (currentCellCount > numCols && numCols > 0) {
                for (let i = currentCellCount - 1; i >= numCols; i--) {
                    if(dateRow.cells[i]) dateRow.cells[i].remove();
                }
            }
        }
    }

    function captureCurrentState() {
        if (!tablesContainer || !scheduleTitleElement) {
            console.warn("captureCurrentState: Critical elements (tablesContainer or scheduleTitleElement) not found. Returning null.");
            return null;
        }
        const state = {
            html: tablesContainer.innerHTML,
            tableMeta: {},
            activeTableId: activeTableId,
            scheduleTitle: scheduleTitleElement.textContent || ''
        };
        tablesContainer.querySelectorAll('table').forEach(table => {
            state.tableMeta[table.id] = {
                name: table.dataset.tableName || table.id,
                rowCount: table.rows.length,
                colCount: table.rows[0]?.cells.length || 0,
                isIndependent: table.dataset.isIndependent === 'true'
            };
        });
        return JSON.stringify(state);
    }

    function hasStateChanged(currentStateStringified) {
        if (!isInitialStateSet || !lastSavedState) return true;
        if (!currentStateStringified) return false;
        return currentStateStringified !== lastSavedState;
    }

    function _updateLocalStateAfterSave(docId, scheduleName, isAutoDraft, operationType) {
        const capturedStateStringified = captureCurrentState();
        if (!capturedStateStringified) {
            console.error(`_updateLocalStateAfterSave (${operationType}): Failed to capture current state. Local state NOT updated.`);
        } else {
            lastSavedState = capturedStateStringified;
        }
        currentWorkingScheduleDocId = docId;
        if (docId) sessionStorage.setItem(LAST_ACTIVE_SCHEDULE_ID_KEY, docId);
        else sessionStorage.removeItem(LAST_ACTIVE_SCHEDULE_ID_KEY);
        const timestamp = new Date().toLocaleTimeString();
        console.log(`%cStateUpdate (${operationType}): ID: ${docId || 'N/A'}, Name: "${scheduleName || 'N/A'}", Draft: ${isAutoDraft}. last